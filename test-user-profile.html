<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用戶資料更新測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>家庭記帳系統 - 用戶資料更新測試</h1>
    
    <div class="test-section info">
        <h3>測試說明</h3>
        <p>這個頁面用來測試家庭記帳系統的用戶資料更新功能。</p>
        <p>請先使用下方的「使用 Google 登入」按鈕登入，然後點擊測試按鈕。</p>
    </div>
    
    <div class="test-section">
        <h3>登入/登出</h3>
        <button id="loginBtn" onclick="loginWithGoogle()" style="background: #28a745;">使用 Google 登入</button>
        <button id="logoutBtn" onclick="logout()" style="background: #dc3545; display: none;">登出</button>
        <div id="userInfo" style="margin-top: 10px; display: none;">
            <strong>已登入用戶：</strong><span id="userEmail"></span>
        </div>
    </div>
    
    <div class="test-section">
        <h3>測試步驟</h3>
        <button onclick="testFirebaseConnection()">1. 測試 Firebase 連線</button>
        <button onclick="testUserProfileUpdate()">2. 測試用戶資料更新</button>
        <button onclick="checkUserInFirestore()">3. 檢查 Firestore 中的用戶資料</button>
        <button onclick="clearLog()">清除日誌</button>
    </div>
    
    <div class="test-section">
        <h3>測試日誌</h3>
        <div id="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDfHs1XXsCXGMSVF3NFJUtFMcslTzTd-EU",
            authDomain: "expenses-91280.firebaseapp.com",
            projectId: "expenses-91280",
            storageBucket: "expenses-91280.firebasestorage.app",
            messagingSenderId: "777956465315",
            appId: "1:777956465315:web:04f85f2b22f2468eb2fd16",
            measurementId: "G-1LE7YTKHGT"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        
        // 監聽認證狀態
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userInfo = document.getElementById('userInfo');
            const userEmail = document.getElementById('userEmail');
            
            if (user) {
                log(`✅ 用戶已登入: ${user.email} (${user.uid})`, 'success');
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                userInfo.style.display = 'block';
                userEmail.textContent = user.email;
            } else {
                log('❌ 用戶未登入', 'error');
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                userInfo.style.display = 'none';
            }
        });
        
        // 日誌函數
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // 更新測試區域的樣式
            const testSection = document.querySelector('.test-section:last-of-type');
            if (type === 'success') {
                testSection.classList.add('success');
            } else if (type === 'error') {
                testSection.classList.add('error');
            }
        }
        
        // 測試 Firebase 連線
        window.testFirebaseConnection = function() {
            log('開始測試 Firebase 連線...');
            
            try {
                log(`Firebase App: ${app.name}`);
                log(`Auth: ${auth.app.name}`);
                log(`Firestore: ${db.app.name}`);
                log('✅ Firebase 連線正常', 'success');
            } catch (error) {
                log(`❌ Firebase 連線失敗: ${error.message}`, 'error');
            }
        };
        
        // 測試用戶資料更新
        window.testUserProfileUpdate = async function() {
            if (!currentUser) {
                log('❌ 請先登入', 'error');
                return;
            }
            
            log('開始測試用戶資料更新...');
            log(`用戶 UID: ${currentUser.uid}`);
            log(`用戶 Email: ${currentUser.email}`);
            
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                log('用戶參考已建立');
                
                // 檢查用戶是否已存在
                const existingUserDoc = await getDoc(userRef);
                const isNewUser = !existingUserDoc.exists();
                log(`用戶是否為新用戶: ${isNewUser}`);
                
                // 準備用戶資料
                const userData = {
                    uid: currentUser.uid,
                    email: currentUser.email ?? null,
                    displayName: currentUser.displayName ?? null,
                    photoURL: currentUser.photoURL ?? null,
                    providerId: currentUser.providerData?.[0]?.providerId ?? null,
                    lastLoginAt: serverTimestamp()
                };
                
                if (isNewUser) {
                    log('新用戶，設定預設狀態');
                    userData.isActive = false;
                    userData.createdAt = serverTimestamp();
                } else {
                    log('現有用戶，保持原有狀態');
                    const existingData = existingUserDoc.data();
                    log(`現有 isActive 狀態: ${existingData?.isActive}`);
                }
                
                log('準備寫入的用戶資料:');
                log(JSON.stringify(userData, null, 2));
                
                // 執行更新
                await setDoc(userRef, userData, { merge: true });
                log('✅ 用戶資料更新成功！', 'success');
                
            } catch (error) {
                log(`❌ 用戶資料更新失敗: ${error.message}`, 'error');
                log(`錯誤代碼: ${error.code}`, 'error');
                log(`錯誤詳情: ${JSON.stringify(error)}`, 'error');
            }
        };
        
        // 檢查 Firestore 中的用戶資料
        window.checkUserInFirestore = async function() {
            if (!currentUser) {
                log('❌ 請先登入', 'error');
                return;
            }
            
            log('檢查 Firestore 中的用戶資料...');
            
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    log('✅ 找到用戶資料:', 'success');
                    log(JSON.stringify(userData, null, 2));
                } else {
                    log('❌ 用戶資料不存在', 'error');
                }
                
            } catch (error) {
                log(`❌ 檢查用戶資料失敗: ${error.message}`, 'error');
            }
        };
        
        // Google 登入
        window.loginWithGoogle = async function() {
            try {
                log('開始 Google 登入...');
                const result = await signInWithPopup(auth, provider);
                log(`✅ Google 登入成功: ${result.user.email}`, 'success');
            } catch (error) {
                log(`❌ Google 登入失敗: ${error.message}`, 'error');
                if (error.code === 'auth/popup-closed-by-user') {
                    log('登入視窗被用戶關閉', 'error');
                } else if (error.code === 'auth/popup-blocked') {
                    log('登入視窗被瀏覽器阻擋，請允許彈出視窗', 'error');
                }
            }
        };
        
        // 登出
        window.logout = async function() {
            try {
                log('開始登出...');
                await signOut(auth);
                log('✅ 登出成功', 'success');
            } catch (error) {
                log(`❌ 登出失敗: ${error.message}`, 'error');
            }
        };
        
        // 清除日誌
        window.clearLog = function() {
            document.getElementById('log').textContent = '';
            const testSection = document.querySelector('.test-section:last-of-type');
            testSection.classList.remove('success', 'error');
        };
        
        log('測試頁面已載入，等待用戶登入...');
    </script>
</body>
</html>
