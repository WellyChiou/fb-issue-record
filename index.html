<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QA Tracker</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* é è¨­å…ˆéš±è—ï¼Œé¿å…å°šæœªæª¢æŸ¥ç™»å…¥æ™‚é–ƒå‡ºç•«é¢ */
    body { 
      display: none; 
      font-family: 'Inter', 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3' }
          },
          boxShadow: { 
            soft: '0 2px 10px rgba(0,0,0,.06)',
            'soft-lg': '0 10px 25px rgba(0,0,0,.08)'
          }
        }
      }
    }
  </script>

  <!-- Firebase SDKs (Modular v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Replace with your own if needed
    const firebaseConfig = {
      apiKey: "AIzaSyCuTlQfSUTlgig_NF7bKV448v35UEuB0aA",
      authDomain: "fb-issue-record.firebaseapp.com",
      projectId: "fb-issue-record",
      storageBucket: "fb-issue-record.firebasestorage.app",
      messagingSenderId: "892738349977",
      appId: "1:892738349977:web:004b30f804e2937692c108"
    };

    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
    window.auth = getAuth(app);
    window.GoogleAuthProvider = GoogleAuthProvider;
    window.signInWithPopup = signInWithPopup;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;

  // === èªè­‰æª¢æŸ¥çµæŸ ===
  </script>

  <style>
    /* === åŸºç¤æŒ‰éˆ•æ¨£å¼ === */
    .btn {
      padding: .75rem 1.25rem;
      border-radius: .75rem;
      font-weight: 600;
      font-size: .875rem;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      white-space: nowrap;
      min-height: 2.5rem;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    
    /* æŒ‰éˆ•è‰²ç³» */
    .btn-primary { 
      background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
    }
    .btn-primary:hover { box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); }
    
    .btn-success { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    .btn-success:hover { box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
    
    .btn-info { 
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
    }
    .btn-info:hover { box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4); }
    
    .btn-warning { 
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    .btn-warning:hover { box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); }
    
    .btn-danger { 
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    .btn-danger:hover { box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
    
    .btn-secondary { 
      padding: .75rem 1.25rem !important;
      border-radius: .75rem;
      border: 1.5px solid #cbd5e1;
      background: #fff;
      color: #475569;
      font-weight: 600;
      font-size: .875rem;
      transition: all 0.2s ease;
      cursor: pointer;
      min-height: 2.5rem !important;
      width: auto !important;
      height: auto !important;
      flex-shrink: 0;
    }
    .btn-secondary:hover { 
      background: #f8fafc;
      border-color: #94a3b8;
      transform: translateY(-1px);
    }
    
    /* åˆ†é æŒ‰éˆ•ç‰¹æ®Šæ¨£å¼ */
    #btnPrev, #btnNext {
      padding: .75rem 1.25rem !important;
      min-height: 2.5rem !important;
      font-size: .875rem !important;
      font-weight: 600 !important;
      white-space: nowrap !important;
      flex-shrink: 0 !important;
    }
    
    .btn-outline { 
      border: 1.5px solid #cbd5e1;
      background: #fff;
      color: #334155;
      padding: .5rem 1rem;
      border-radius: .75rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    
    .btn-outline-red { 
      border: 1.5px solid #fecaca;
      color: #991b1b;
      background: #fff;
      padding: .5rem 1rem;
      border-radius: .75rem;
      font-weight: 600;
    }
    .btn-outline-red:hover { background: #fef2f2; }

    /* === è¼¸å…¥æ¡†æ¨£å¼ === */
    .inp {
      width: 100%;
      padding: .625rem .875rem;
      border-radius: .75rem;
      border: 1.5px solid #cbd5e1;
      outline: none;
      background: #fff;
      transition: all 0.2s ease;
      font-size: .875rem;
    }
    .inp:focus {
      box-shadow: 0 0 0 3px rgba(79, 70, 229, .15);
      border-color: #818cf8;
    }
    .inp:hover:not(:focus) {
      border-color: #94a3b8;
    }

    /* === æ¨™ç±¤æ¨£å¼ === */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .25rem .625rem;
      border-radius: 9999px;
      font-size: .75rem;
      font-weight: 600;
    }
    .chip-green { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
    .chip-gray { background: #f1f5f9; color: #334155; border: 1px solid #e2e8f0; }
    .chip-red { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    .chip-indigo { background: #eef2ff; color: #3730a3; border: 1px solid #c7d2fe; }
    .chip-amber { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }

    /* === è¡¨æ ¼æ¨£å¼ === */
    #tableWrap table {
      table-layout: fixed;
    }
    .table-head th {
      position: sticky;
      top: 0;
      background: #f8fafc;
      white-space: nowrap;
      font-weight: 600;
      z-index: 10;
    }
    #tableWrap tbody td {
      white-space: normal;
      word-break: break-word;
    }
    .row {
      border-bottom: 1px solid #e2e8f0;
      transition: background-color 0.15s ease;
    }
    .row:hover {
      background-color: #f8fafc !important;
    }
    
    /* === è¼‰å…¥å‹•ç•« === */
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, .9);
      backdrop-filter: saturate(180%) blur(4px);
      z-index: 50;
    }

    /* === éŸ¿æ‡‰å¼èª¿æ•´ === */
    @media (max-width: 768px) {
      .btn {
        padding: .5rem .75rem;
        font-size: .8rem;
      }
      .chip {
        font-size: .7rem;
        padding: .2rem .5rem;
      }
    }
    
    /* === å¼·åˆ¶æŒ‰éˆ•æ¨£å¼ === */
    button.btn-secondary {
      padding: .75rem 1.25rem !important;
      min-height: 2.5rem !important;
      font-size: .875rem !important;
      font-weight: 600 !important;
      white-space: nowrap !important;
      flex-shrink: 0 !important;
      width: auto !important;
      height: auto !important;
      max-width: none !important;
      max-height: none !important;
    }
    
    /* åˆ†é æŒ‰éˆ•ç‰¹æ®Šè™•ç† */
    #btnPrev, #btnNext {
      padding: .75rem 1.25rem !important;
      min-height: 2.5rem !important;
      font-size: .875rem !important;
      font-weight: 600 !important;
      white-space: nowrap !important;
      flex-shrink: 0 !important;
      width: auto !important;
      height: auto !important;
      max-width: none !important;
      max-height: none !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: .5rem !important;
    }
    
    /* å¼·åˆ¶å³ä¸Šè§’æ°´å¹³æ’åˆ— */
    #userDisplayName {
      flex-direction: row !important;
      display: flex !important;
      align-items: center !important;
      flex-wrap: nowrap !important;
    }
    
    #userDisplayName > * {
      flex-shrink: 0 !important;
      white-space: nowrap !important;
    }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-gradient-to-r from-brand-600 via-brand-700 to-brand-800 text-white shadow-lg sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-3.5 md:py-4 flex items-center justify-between" style="min-width: 0; overflow: visible;">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 md:w-10 md:h-10 rounded-xl bg-white/20 backdrop-blur-sm grid place-items-center font-bold text-base md:text-lg shadow-md">QA</div>
        <div>
          <h1 class="text-lg md:text-2xl font-bold tracking-tight">QA Tracker</h1>
          <p class="text-xs text-white/80 hidden md:block">å·¥ä½œè¨˜éŒ„è¿½è¹¤ç³»çµ±</p>
        </div>
      </div>
      <div id="authArea" class="flex items-center gap-2 md:gap-3">
        <div id="userDisplayName" class="hidden flex items-center gap-2 md:gap-3" style="flex-direction: row !important; display: flex !important;">
          <!-- ä½¿ç”¨è€…è³‡è¨Šå¡ç‰‡ -->
          <div class="flex items-center gap-2 bg-white/10 backdrop-blur-sm px-2 md:px-3 py-1.5 md:py-2 rounded-lg" style="flex-shrink: 0;">
            <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
            </svg>
            <span id="userEmail" class="text-xs md:text-sm font-medium"></span>
          </div>
          
          <!-- ç™»å‡ºæŒ‰éˆ• -->
          <button id="btnSignOut" class="btn-secondary text-xs md:text-sm" style="padding: 0.5rem 0.75rem; min-height: 2rem; flex-shrink: 0;">ç™»å‡º</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 md:px-6 py-4 md:py-6 space-y-4 md:space-y-6">
  
	<!-- Modalï¼šå»ºç«‹ / ç·¨è¼¯è³‡æ–™ -->
	<div id="recordModal" class="fixed inset-0 z-[100] hidden" aria-hidden="true">
	  <!-- èƒŒæ™¯ -->
	  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

	  <!-- é¢æ¿ -->
	  <div class="relative w-full h-full grid place-items-center p-4 overflow-y-auto">
		<div data-modal-panel
			 class="w-full max-w-4xl bg-white rounded-2xl shadow-soft-lg border border-slate-200 my-8">
		  <!-- Header -->
		  <div class="flex items-center justify-between px-5 md:px-6 py-4 border-b bg-gradient-to-r from-slate-50 to-white rounded-t-2xl">
			<div>
			  <h2 id="modalTitle" class="text-xl md:text-2xl font-bold text-slate-800">å»ºç«‹ / ç·¨è¼¯è³‡æ–™</h2>
			  <div class="text-xs text-slate-500 mt-1">* Issue Number ç‚ºå¿…å¡«ï¼Œå…¶é¤˜æ¬„ä½çš†ç‚ºé¸å¡«</div>
			</div>
			<button id="btnModalClose" class="btn-secondary text-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
              é—œé–‰
            </button>
		  </div>

		  <!-- Bodyï¼ˆæ²¿ç”¨ä½ çš„ form èˆ‡æ¬„ä½ï¼‰ -->
		  <div class="p-5 md:p-6">
			<form id="recordForm" class="grid md:grid-cols-4 gap-4">
			  <!-- === ä»¥ä¸‹ä¿ç•™ä½ çš„åŸæ¬„ä½å€å¡Šå³å¯ === -->
			  <!-- Row 1 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">ç‹€æ…‹</label>
				<select id="status" class="inp">
				  <option value="1" selected>åŸ·è¡Œä¸­</option>
				  <option value="0">åŸ·è¡Œä¸­æ­¢</option>
				  <option value="2">å®Œæˆ</option>
				</select>
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">å®Œæˆæ—¥æœŸ</label>
				<input id="completed_at" type="date" class="inp" />
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">Issue Number</label>
				<input id="issue_number" type="number" class="inp" placeholder="ä¾‹å¦‚ 1234" />
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">Test Plan</label>
				<select id="test_plan" class="inp">
				  <option value="0" selected>å¦</option>
				  <option value="1">æ˜¯</option>
				</select>
			  </div>

			  <!-- Row 2 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">é¡å‹</label>
				<select id="category" class="inp">
				  <option value="1" selected>BUG</option>
				  <option value="2">æ”¹å–„</option>
				  <option value="3">å„ªåŒ–</option>
				  <option value="4">æ¨¡çµ„</option>
				  <option value="5">QA</option>
				</select>
			  </div>
			  <div class="md:col-span-3">
				<label class="block text-sm text-slate-600 mb-1">åŠŸèƒ½</label>
				<input id="feature" type="text" class="inp" placeholder="æ–‡å­—æè¿°" />
			  </div>

			  <!-- Row 3 -->
			  <div class="md:col-span-4">
				<label class="block text-sm text-slate-600 mb-1">Memo</label>
				<textarea id="memo" class="inp" rows="2" placeholder="å‚™è¨»ï¼ˆéå¿…å¡«ï¼‰"></textarea>
			  </div>

			  <!-- Row 4 -->
			  <div class="md:col-span-2">
				<label class="block text-sm text-slate-600 mb-1">é–‹å§‹æ¸¬è©¦æ—¥æœŸ</label>
				<input id="test_start_date" type="date" class="inp" />
			  </div>
			  <div class="md:col-span-2">
				<label class="block text-sm text-slate-600 mb-1">é è¨ˆäº¤ä»˜æ—¥æœŸ</label>
				<input id="eta_date" type="date" class="inp" />
			  </div>

			  <!-- Row 5 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">é©—è­‰å¤±æ•—</label>
				<select id="verify_failed" class="inp">
				  <option value="0" selected>å¦</option>
				  <option value="1">æ˜¯</option>
				</select>
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">æ¸¬è©¦æ¡ˆä¾‹</label>
				<input id="test_cases" type="number" class="inp" value="0" />
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">æª”æ¡ˆæ•¸é‡</label>
				<input id="file_count" type="number" class="inp" value="0" />
			  </div>
			  <div class="md:col-span-1"></div>

			  <!-- Row 6 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">ç™¼ç¾ BUG</label>
				<select id="bug_found" class="inp">
				  <option value="0" selected>å¦</option>
				  <option value="1">æ˜¯</option>
				</select>
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">å¯å„ªåŒ–é …ç›®</label>
				<input id="optimization_points" type="number" class="inp" placeholder="æ•¸å­—ï¼›åƒ…åœ¨ ç™¼ç¾BUG=1 æ™‚å¯å¡«" min="0" step="1" disabled />
			  </div>
			  <div class="md:col-span-2"></div>

			  <!-- Row 7 -->
			  <div class="md:col-span-4 flex flex-wrap gap-3 items-end">
				<button id="btnSave" class="btn" type="submit">å„²å­˜</button>
				<button id="btnReset" class="btn-secondary" type="button">é‡è¨­</button>
				<span id="saveMsg" class="ml-2 text-sm text-green-600"></span>
				<a id="issue_link_preview" class="text-brand-700 font-semibold underline hidden"
				   href="#" target="_blank" rel="noopener">æ‰“é–‹ Issue</a>
			  </div>
			</form>
		  </div>
		</div>
	  </div>
	</div>

  
  
    <!-- List Card -->
    <section id="listSection" class="relative bg-white rounded-2xl shadow-soft-lg p-4 md:p-6 border border-slate-200">
      <!-- Title row -->
      <div class="mb-4 pb-3 border-b border-slate-200">
        <div class="flex items-center gap-2">
          <svg class="w-6 h-6 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          <h2 class="text-xl md:text-2xl font-bold text-slate-800">è³‡æ–™åˆ—è¡¨</h2>
        </div>
      </div>

	<!-- Filters block -->
	<div class="bg-slate-50 rounded-xl p-4 md:p-5 mb-4 border border-slate-200">
      <div class="flex items-center gap-2 mb-3">
        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
        </svg>
        <h3 class="font-semibold text-slate-700">ç¯©é¸æ¢ä»¶</h3>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4">
	  <!-- é—œéµå­— -->
        <div class="flex flex-col md:col-span-3 lg:col-span-2">
          <label for="q_keyword" class="text-sm text-slate-600 font-medium mb-1.5">é—œéµå­—æœå°‹</label>
          <input id="q_keyword" type="text" class="inp" placeholder="æœå°‹åŠŸèƒ½ã€å‚™è¨»æˆ– Issue ç·¨è™Ÿ..."/>
	  </div>

	  <!-- ç‹€æ…‹ -->
	  <div class="flex flex-col">
          <label for="q_status" class="text-sm text-slate-600 font-medium mb-1.5">ç‹€æ…‹</label>
		<select id="q_status" class="inp">
		  <option value="" selected>å…¨éƒ¨</option>
		  <option value="1">åŸ·è¡Œä¸­</option>
		  <option value="0">åŸ·è¡Œä¸­æ­¢</option>
		  <option value="2">å®Œæˆ</option>
		</select>
	  </div>

	  <!-- é¡å‹ -->
	  <div class="flex flex-col">
          <label for="q_category" class="text-sm text-slate-600 font-medium mb-1.5">é¡å‹</label>
		<select id="q_category" class="inp">
		  <option value="" selected>å…¨éƒ¨</option>
		  <option value="1">BUG</option>
		  <option value="2">æ”¹å–„</option>
		  <option value="3">å„ªåŒ–</option>
		  <option value="4">æ¨¡çµ„</option>
		  <option value="5">QA</option>
		</select>
	  </div>

	  <!-- Test Plan -->
	  <div class="flex flex-col">
          <label for="q_test_plan" class="text-sm text-slate-600 font-medium mb-1.5">Test Plan</label>
		<select id="q_test_plan" class="inp">
		  <option value="" selected>å…¨éƒ¨</option>
		  <option value="1">æ˜¯</option>
		  <option value="0">å¦</option>
		</select>
	  </div>

	  <!-- ç™¼ç¾BUG -->
	  <div class="flex flex-col">
          <label for="q_bug_found" class="text-sm text-slate-600 font-medium mb-1.5">ç™¼ç¾BUG</label>
		<select id="q_bug_found" class="inp">
		  <option value="" selected>å…¨éƒ¨</option>
		  <option value="1">æ˜¯</option>
		  <option value="0">å¦</option>
		</select>
	  </div>
      </div>
	</div>


      <!-- Buttons row -->
	<div class="flex flex-col md:flex-row md:justify-between items-stretch md:items-center gap-3 mb-4">
      <!-- å·¦å´ï¼šä¸»è¦æ“ä½œ -->
      <div class="flex flex-wrap gap-2">
        <button id="btnCreate" class="btn btn-primary flex-1 md:flex-initial">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          æ–°å¢ Issue
        </button>
        <button id="btnSearch" class="btn btn-info flex-1 md:flex-initial">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          æœå°‹
        </button>
        <button id="btnClear" class="btn btn-secondary flex-1 md:flex-initial">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          æ¸…ç©º
        </button>
      </div>
      
      <!-- å³å´ï¼šæ¬¡è¦æ“ä½œ -->
      <div class="flex flex-wrap gap-2">
        <button id="btnExportExcel" class="btn btn-success flex-1 md:flex-initial">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          åŒ¯å‡º Excel
        </button>
        <button id="btnGitlabIssues" class="btn btn-warning flex-1 md:flex-initial">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M23.546 10.93L13.067.452c-.604-.603-1.582-.603-2.188 0L.452 10.93c-.6.605-.6 1.584 0 2.189l10.48 10.477c.604.604 1.582.604 2.186 0l10.428-10.477c.603-.603.603-1.582 0-2.189z"/>
          </svg>
          GitLab Issues
        </button>
	  <button id="btnBulkUpdate" class="btn btn-warning" hidden>æ›´æ–°ç¾æœ‰è³‡æ–™</button>
      </div>
	</div>


      <!-- Overlay (center big) -->
      <div id="loadingOverlay" class="overlay hidden">
        <div class="flex flex-col items-center gap-3 bg-white/80 rounded-2xl px-6 py-6 shadow-soft border border-slate-200">
          <svg class="animate-spin h-8 w-8 text-brand-700" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <div class="text-slate-700 font-medium">æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
        </div>
      </div>

      <div id="tableWrap" class="overflow-x-auto border rounded-2xl">
        <table class="table-fixed min-w-[1600px] text-sm">
			    <!-- âœ… æŠŠ colgroup æ”¾åœ¨é€™è£¡ï¼ˆthead å‰é¢ï¼‰ -->
				<colgroup>
				  <col style="width:60px" />  <!-- åºè™Ÿ -->
				  <col style="width:50px" />  <!-- Issue# -->
				  <col style="width:70px" />  <!-- ç‹€æ…‹ -->
				  <col style="width:70px" />  <!-- é¡å‹ -->
				  <col style="width:120px" />  <!-- åŠŸèƒ½ -->
				  <col style="width:120px" />  <!-- é–‹å§‹æ¸¬è©¦æ—¥æœŸ -->
				  <col style="width:120px" />  <!-- é è¨ˆäº¤ä»˜æ—¥æœŸ -->
				  <col style="width:120px" />  <!-- å®Œæˆæ—¥æœŸ -->
				  <col style="width:50px" />  <!-- æ¸¬è©¦æ¡ˆä¾‹ -->
				  <col style="width:400px" />  <!-- Memo -->
				  <col style="width:140px" />  <!-- æ“ä½œ -->
				</colgroup>

				<thead class="table-head text-slate-600 text-xs uppercase tracking-wide">
					<tr>
					  <th class="px-3 py-2 text-left">#</th>
					  <th class="px-3 py-2 text-left">Issue#</th>
					  <th class="px-3 py-2 text-left">ç‹€æ…‹</th>
					  <th class="px-3 py-2 text-left">é¡å‹</th>
					  <th class="px-3 py-2 text-left">åŠŸèƒ½</th>
					  <th class="px-3 py-2 text-left">é–‹å§‹æ¸¬è©¦æ—¥æœŸ</th>
					  <th class="px-3 py-2 text-left">é è¨ˆäº¤ä»˜æ—¥æœŸ</th>
					  <th class="px-3 py-2 text-left">å®Œæˆæ—¥æœŸ</th>
					  <th class="px-3 py-2 text-left">æ¸¬è©¦æ¡ˆä¾‹</th>
					  <th class="px-3 py-2 text-left">Memo</th>
					  <th class="px-3 py-2 text-left">æ“ä½œ</th>
					</tr>
			  </thead>
          <tbody id="recordsTbody"></tbody>
        </table>
      </div>

		<div id="pager" class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-4 pt-3 border-t border-slate-200" style="min-width: 0; overflow: visible;">
          <!-- å·¦å´ï¼šæ¯é ç­†æ•¸ -->
          <div class="flex items-center gap-2">
            <label for="pageSize" class="text-sm font-medium text-slate-600">é¡¯ç¤ºç­†æ•¸ï¼š</label>
		  <select id="pageSize" class="inp w-24">
			<option value="10" selected>10</option>
			<option value="20">20</option>
			<option value="50">50</option>
			<option value="100">100</option>
			<option value="all">å…¨éƒ¨</option>
		  </select>
            <span id="pageInfo" class="text-sm text-slate-600 ml-2"></span>
          </div>
          
          <!-- å³å´ï¼šåˆ†é æ§åˆ¶ -->
          <div class="flex flex-wrap items-center gap-3" style="flex-shrink: 0; min-width: 0;">
            <button id="btnPrev" class="btn-secondary text-sm font-medium" style="padding: 0.75rem 1.25rem; min-height: 2.5rem;">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
              ä¸Šä¸€é 
            </button>
            
            <!-- è·³é  -->
            <div class="flex items-center gap-2 px-4 py-2.5 bg-slate-50 rounded-lg border border-slate-200">
              <span class="text-sm font-medium text-slate-600">åˆ°ç¬¬</span>
              <input id="pageInput" type="number" min="1" step="1" class="inp w-20 !py-2 !px-2 text-center font-medium" placeholder="é "/>
              <span class="text-sm font-medium text-slate-600">é </span>
            </div>
            
            <button id="btnNext" class="btn-secondary text-sm font-medium" style="padding: 0.75rem 1.25rem; min-height: 2.5rem;">
              ä¸‹ä¸€é 
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
          </div>
		</div>

    </section>
	
	<!-- ğŸŸ¢ GitLab Issues Modal -->
	<div id="gitlabModal" class="fixed inset-0 z-[120] hidden">
	  <!-- èƒŒæ™¯ -->
	  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

	  <!-- é¢æ¿ -->
	  <div class="relative w-full h-full grid place-items-center p-4 overflow-y-auto">
		<div class="bg-white rounded-2xl shadow-soft-lg border border-slate-200 w-full max-w-4xl my-8">
			<!-- GitLab Issues Modal Header -->
			<div class="px-5 md:px-6 py-4 border-b bg-gradient-to-r from-orange-50 to-white rounded-t-2xl space-y-3">
			  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
				<div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-xl bg-orange-100 grid place-items-center">
                    <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M23.546 10.93L13.067.452c-.604-.603-1.582-.603-2.188 0L.452 10.93c-.6.605-.6 1.584 0 2.189l10.48 10.477c.604.604 1.582.604 2.186 0l10.428-10.477c.603-.603.603-1.582 0-2.189z"/>
                    </svg>
				</div>
                  <div>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">GitLab Issues</h2>
                    <p class="text-xs text-slate-500">æŸ¥è©¢ä¸¦åŒ¯å…¥ GitLab å°ˆæ¡ˆçš„ Issues</p>
			  </div>
				</div>
				<div class="flex flex-wrap items-center gap-2">
				  <span id="gitlabSelectedCount" class="text-sm font-medium text-slate-600 px-3 py-1.5 bg-slate-100 rounded-lg">å·²é¸ 0 ç­†</span>
				  <button id="btnToggleSelectAll" class="btn-outline text-sm">å…¨é¸</button>
				  <button id="btnImportSelected" class="btn btn-primary text-sm">åŒ¯å…¥é¸å–</button>
				  <button id="btnCloseGitlabModal" class="btn-secondary text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    é—œé–‰
                  </button>
				</div>
			  </div>
			  <div class="bg-white rounded-xl p-4 border border-slate-200">
			  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
				<div>
                    <label class="block text-sm font-medium text-slate-600 mb-1.5">Assignee</label>
				  <input id="glAssignee" class="inp" placeholder="ä¾‹å¦‚ï¼šWelly.Chiu" />
				</div>
				<div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-600 mb-1.5">Project è·¯å¾‘</label>
                    <input id="glProject" class="inp" placeholder="ä¾‹å¦‚ï¼škh/imp æˆ– gitlab.com/group/project" />
				</div>
                </div>
                <div class="mt-3 flex justify-end">
                  <button id="btnSearchGitlab" class="btn btn-info">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    æŸ¥è©¢ Issues
                  </button>
				</div>
			  </div>
			</div>


			<div id="gitlabIssuesBody" class="p-5 md:p-6 max-h-[60vh] overflow-y-auto bg-slate-50">
			  <div class="text-center py-12">
                <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="text-slate-500 text-sm">è«‹è¼¸å…¥æŸ¥è©¢æ¢ä»¶ä¸¦æŒ‰ã€ŒæŸ¥è©¢ Issuesã€</p>
			  </div>
			</div>
		</div>
	  </div>
	</div>

  </main>

  <!-- App logic -->
  <script type="module">
    import {
      collection, addDoc, serverTimestamp, query, orderBy, limit, startAfter, getDocs,
      updateDoc, doc, deleteDoc, getDoc, where, writeBatch, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

	// Auth UI
    const btnSignOut = document.getElementById('btnSignOut');
    const userDisplayName = document.getElementById('userDisplayName');
    const userEmail = document.getElementById('userEmail');
	
	// Git Token
	let GITLAB_TOKEN = null;
	
	onAuthStateChanged(auth, (user) => {
		if (user) {
			document.body.style.display = 'block'; // é¡¯ç¤º body å…§å®¹
			userDisplayName.classList.remove('hidden');
			const displayName = user.displayName || user.email;
			userEmail.textContent = displayName;
			// â˜… ç™»å…¥å¾Œï¼šè¨˜éŒ„/æ›´æ–°ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™ï¼ˆæœ€å°å¹…åº¦ï¼‰
			setDoc(doc(db, 'users', user.uid), {
			  uid: user.uid,
			  email: user.email ?? null,
			  displayName: user.displayName ?? null,
			  photoURL: user.photoURL ?? null,
			  providerId: user.providerData?.[0]?.providerId ?? null,
			  lastLoginAt: serverTimestamp()
			}, { merge: true }).catch(console.error);
			reload();
			loadGitlabToken().catch(console.error); // é æŠ“ tokenï¼ˆå¿«å–åœ¨è¨˜æ†¶é«”ï¼‰
		} else {
			// å·²ç¶“ç™»å‡º â†’ ç›´æ¥å°å‘çµ±ä¸€ç™»å…¥å…¥å£
			location.href = "enter_login.html";
		}
	});

    btnSignOut.addEventListener('click', async ()=>{
      await signOut(auth);
    });
	
	async function loadGitlabToken() {
	  if (GITLAB_TOKEN) return GITLAB_TOKEN; // å·²è¼‰å…¥å°±ç”¨å¿«å–
	  // è®€ Firestoreï¼šconfig/gitlab æ–‡ä»¶
	  const ref = doc(db, 'config', 'gitlab');
	  const snap = await getDoc(ref);
	  if (!snap.exists()) throw new Error('Firestore æœªæ‰¾åˆ° config/gitlab');
	  const token = snap.data()?.token;
	  if (!token) throw new Error('config/gitlab ç„¡ token æ¬„ä½');
	  GITLAB_TOKEN = token;
	  return token;
	}


	// === Modal æ§åˆ¶ ===
	const recordModal   = document.getElementById('recordModal');
	const modalPanel    = recordModal.querySelector('[data-modal-panel]');
	const btnModalClose = document.getElementById('btnModalClose');
	const btnCreate     = document.getElementById('btnCreate');
	const modalTitle    = document.getElementById('modalTitle');
	
	function openModal(mode = 'create') {
	  modalTitle.textContent = (mode === 'edit') ? 'ç·¨è¼¯è³‡æ–™' : 'æ–°å¢ Issue';
	  recordModal.classList.remove('hidden');
	  document.body.classList.add('overflow-hidden');
	  // èšç„¦ç¬¬ä¸€å€‹æ¬„ä½
	  setTimeout(() => document.getElementById('issue_number')?.focus(), 0);
	}
	function closeModal() {
	  recordModal.classList.add('hidden');
	  document.body.classList.remove('overflow-hidden');
	}

	btnModalClose.addEventListener('click', closeModal);
	recordModal.addEventListener('click', (e) => {
	  if (!modalPanel.contains(e.target)) closeModal();
	});
	document.addEventListener('keydown', (e) => {
	  if (e.key === 'Escape' && !recordModal.classList.contains('hidden')) closeModal();
	});

	// æ–°å¢ Issueï¼šæ¸…è¡¨å–® â†’ æ‰“é–‹ Modal
	btnCreate.addEventListener('click', () => {
	  editingId = null;
	  form.reset();
	  setDefaultsIfEmpty();
	  updateIssuePreview();
	  openModal('create');
	});
	
	
	
    // Form refs
    const form = document.getElementById('recordForm');
    const saveMsg = document.getElementById('saveMsg');
    const previewLink = document.getElementById('issue_link_preview');

    const fields = {
      status: document.getElementById('status'),
      completed_at: document.getElementById('completed_at'),
      issue_number: document.getElementById('issue_number'),
      test_plan: document.getElementById('test_plan'),
      category: document.getElementById('category'),
      feature: document.getElementById('feature'),
      memo: document.getElementById('memo'),
      test_start_date: document.getElementById('test_start_date'),
      eta_date: document.getElementById('eta_date'),
      bug_found: document.getElementById('bug_found'),
      optimization_points: document.getElementById('optimization_points'),
      verify_failed: document.getElementById('verify_failed'),
      test_cases: document.getElementById('test_cases'),
      file_count: document.getElementById('file_count')
    };

    // Conditional enable for optimization_points
    fields.bug_found.addEventListener('change', ()=>{
      const enabled = fields.bug_found.value === '1';
      fields.optimization_points.disabled = !enabled;
      if(!enabled) fields.optimization_points.value = '';
    });

    // Dynamic issue link preview
    const ISSUE_BASE = "https://gitlab.fb-tek.com/kh/imp/-/issues/";
    function updateIssuePreview(){
      const n = fields.issue_number.value?.trim();
      if(n){
        previewLink.href = ISSUE_BASE + n;
        previewLink.classList.remove('hidden');
      }else{
        previewLink.classList.add('hidden');
      }
    }
    fields.issue_number.addEventListener('input', updateIssuePreview);
	
	// ç‹€æ…‹=å®Œæˆ(2) æ™‚ï¼Œè‡ªå‹•å¸¶å…¥ä»Šå¤©çš„æ—¥æœŸï¼ˆè‹¥å°šæœªå¡«ï¼‰
	fields.status.addEventListener('change', () => {
	  if (String(fields.status.value) === '2' && !fields.completed_at.value) {
		fields.completed_at.value = formatDateInput(new Date());
	  }else{
		fields.completed_at.value = '';
	  }
	});

    // Save / Update logic
    let editingId = null;

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      // é©—è­‰ issue_number æ˜¯å¦æœ‰å¡«
	  if (!fields.issue_number.value || fields.issue_number.value.trim() === '') {
		showMsg('éŒ¯èª¤: è«‹å¡«å¯« Issue Number', true);
		fields.issue_number.focus();
		return; // ä¸­æ–·ï¼Œä¸é€²è¡Œå„²å­˜
	  }
      const payload = buildPayload();
      const u = auth.currentUser;
      try{
        showLoading(true);
        if(editingId){
          await updateDoc(doc(db, 'records', editingId), { ...payload, updated_by_uid: u?.uid ?? null, updated_at: serverTimestamp() });
          showMsg('å·²æ›´æ–°');
        }else{
          await addDoc(collection(db, 'records'), { ...payload, created_by_uid: u?.uid ?? null, created_at: serverTimestamp() });
          showMsg('å·²å„²å­˜');
        }
        form.reset();
        setDefaultsIfEmpty();
        updateIssuePreview();
        editingId = null;
        closeModal(); // æˆåŠŸå°±é—œé–‰ Modal
        await reload();
      }catch(err){
        console.error(err);
        showMsg('éŒ¯èª¤: ' + err.message, true);
      } finally{
        showLoading(false);
      }
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      editingId = null;
      form.reset();
      setDefaultsIfEmpty();
      updateIssuePreview();
      fields.optimization_points.disabled = fields.bug_found.value !== '1';
    });

    function buildPayload(){
      const toNum = (v)=> {
        if (v === '' || v === null || v === undefined) return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      };
      const toStr = (v)=> v?.trim() || null;
      const toDate = (v)=> v ? new Date(v) : null;

      if (!['0','1','2'].includes(String(fields.status.value))) {
        fields.status.value = '1';
      }
      if (!['1','0'].includes(String(fields.test_plan.value))) {
        fields.test_plan.value = '0';
      }

      const issue_number = toNum(fields.issue_number.value);
      const issue_link = issue_number ? (ISSUE_BASE + issue_number) : null;

      const bugFoundIsYes = String(fields.bug_found.value) === '1';
      const optimization_points = bugFoundIsYes ? toNum(fields.optimization_points.value) : 0;

      return {
        status: toNum(fields.status.value),
        completed_at: toDate(fields.completed_at.value),
        issue_number,
        test_plan: toStr(fields.test_plan.value),
        category: toNum(fields.category.value),
        feature: toStr(fields.feature.value),
        issue_link,
        memo: toStr(fields.memo.value),
        test_start_date: toDate(fields.test_start_date.value),
        eta_date: toDate(fields.eta_date.value),
        bug_found: toNum(fields.bug_found.value) ?? 0,
        optimization_points,
        verify_failed: toNum(fields.verify_failed.value) ?? 0,
        test_cases: toNum(fields.test_cases.value),
        file_count: toNum(fields.file_count.value)
      };
    }

    function showMsg(text, isErr=false){
      saveMsg.textContent = text;
      saveMsg.classList.toggle('text-red-600', !!isErr);
      saveMsg.classList.toggle('text-green-600', !isErr);
      setTimeout(()=>{ saveMsg.textContent=''; }, 5000);
    }

    // Table + pagination
    const listSection = document.getElementById('listSection');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const tableWrap = document.getElementById('tableWrap');
    const pager = document.getElementById('pager');
    const tbody = document.getElementById('recordsTbody');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const pageInfo = document.getElementById('pageInfo');
    const pageSizeSel = document.getElementById('pageSize'); 
	const pageInput = document.getElementById('pageInput');

    const qKeyword = document.getElementById('q_keyword');
    const qStatus = document.getElementById('q_status');
    const qCategory = document.getElementById('q_category');
	const qTestPlan = document.getElementById('q_test_plan');
	const qBugFound  = document.getElementById('q_bug_found');
    const btnSearch = document.getElementById('btnSearch');
	const btnClear = document.getElementById('btnClear');
	const btnExportExcel = document.getElementById('btnExportExcel');

    let pageSize = Number(pageSizeSel.value);  // ä¸€é–‹å§‹å°±è½‰æˆ number
    let lastVisible = null;
    let firstVisible = null;
    let prevStack = [];
	let _cacheRows = [];   // å…¨éƒ¨æŸ¥å›å¾Œã€å·²æ’åºçš„å…¨é›†è³‡æ–™
	let _pageIndex = 0;    // ç›®å‰é ç¢¼ï¼ˆ0-basedï¼‰

    function showLoading(show){
      if(show){
        loadingOverlay.classList.remove('hidden');
        tableWrap.classList.add('invisible');
        pager.classList.add('invisible');
      }else{
        loadingOverlay.classList.add('hidden');
        tableWrap.classList.remove('invisible');
        pager.classList.remove('invisible');
      }
    }
	
	// å°å·¥å…·ï¼šå®‰å…¨å–å¾— created_at çš„æ¯«ç§’å€¼
	function _toMillis(v){
	  if (!v) return 0;
	  if (typeof v.toMillis === 'function') return v.toMillis();
	  if (typeof v.toDate === 'function') return v.toDate().getTime();
	  if (v instanceof Date) return v.getTime();
	  if (typeof v === 'number') return v;
	  return 0;
	}


	async function fetchPage(forward = true) {
	  showLoading(true);
	  try {
		// 1) è’é›†æŸ¥è©¢æ¢ä»¶ï¼ˆä¸ä½¿ç”¨ orderByã€ä¸ç”¨æ¸¸æ¨™ï¼‰
		const constraints = [ limit(10000) ]; // è¦–è³‡æ–™é‡èª¿æ•´
		if (qStatus.value !== '')   constraints.push(where('status', '==', Number(qStatus.value)));
		if (qCategory.value !== '') constraints.push(where('category', '==', Number(qCategory.value)));
		if (qTestPlan.value !== '') constraints.push(where('test_plan', '==', qTestPlan.value)); // test_plan ç‚º '0'/'1'ï¼ˆå­—ä¸²ï¼‰
		if (qBugFound.value !== '') constraints.push(where('bug_found', '==', Number(qBugFound.value))); // bug_found ç‚ºæ•¸å­— 0/1
		
		// åªèƒ½æŸ¥åˆ°è‡ªå·±å»ºç«‹çš„è³‡æ–™
		const u = auth.currentUser;
		if (u?.uid) constraints.push(where('created_by_uid', '==', u.uid)); // â˜… æ–°å¢é€™è¡Œ
		
		const kw = (qKeyword?.value ?? '').trim();
		const kwIsNumber = kw !== '' && !Number.isNaN(Number(kw));
		const kwIsText   = kw !== '' && !kwIsNumber;

		if (kwIsNumber) {
		  constraints.push(where('issue_number', '==', Number(kw)));
		} 

		// 2) ä¸€æ¬¡æ’ˆå›
		const qBase = query(collection(db, 'records'), ...constraints);
		const snap  = await getDocs(qBase);
		let rows    = snap.docs.map(d => ({ id: d.id, ...d.data() }));

		// 3) ï¼ˆå¯é¸ï¼‰æ–‡å­—é—œéµå­—å†åšä¸€æ¬¡å‰ç«¯åŒ…å«éæ¿¾ï¼Œç¸®å°çµæœ
		if (kwIsText) {
		  const low = kw.toLowerCase();
		  rows = rows.filter(r => {
			const featureMatch = (r.feature || '').toLowerCase().includes(low);
			const memoMatch    = (r.memo || '').toLowerCase().includes(low);
			const issueMatch   = (r.issue_number ?? '').toString().toLowerCase().includes(low);
			return featureMatch || memoMatch || issueMatch;
		  });
		}


		// 4) å‰ç«¯æ’åºï¼šissue_number â†“ã€status â†“ã€created_at â†“
		rows.sort((a, b) => {
		  const n1 = Number(a.issue_number ?? 0);
		  const n2 = Number(b.issue_number ?? 0);
		  if (n1 !== n2) return n2 - n1; // issue_number å¤§çš„åœ¨å‰

		  const s1 = Number(a.status ?? 0);
		  const s2 = Number(b.status ?? 0);
		  if (s1 !== s2) return s2 - s1; // status å¤§çš„åœ¨å‰

		  return _toMillis(b.created_at) - _toMillis(a.created_at); // æ–°çš„åœ¨å‰
		});

		// 5) å¿«å– + é¡¯ç¤ºç¬¬ä¸€é 
		_cacheRows = rows;
		_pageIndex = 0;
		renderPage();
	  } catch (err) {
		console.error('Query error:', err);
		showMsg('æŸ¥è©¢éŒ¯èª¤ï¼š' + (err?.message || err), true);
		renderRows([]);
		pageInfo.textContent = 'å…± 0 ç­†';
	  } finally {
		showLoading(false);
	  }
	}

    const statusChip = (v)=>{
      if(v === 1) return '<span class="chip chip-green">åŸ·è¡Œä¸­</span>';
      if(v === 0) return '<span class="chip chip-gray">åŸ·è¡Œä¸­æ­¢</span>';
      if(v === 2) return '<span class="chip chip-amber">å®Œæˆ</span>';
      return '';
    };
    const categoryChip = (v)=>{
      const map = {
        1: ['BUG','chip-red'],
        2: ['æ”¹å–„','chip-indigo'],
        3: ['å„ªåŒ–','chip-indigo'],
        4: ['æ¨¡çµ„','chip-gray'],
        5: ['QA','chip-gray']
      };
      const item = map[v];
      return item ? `<span class="chip ${item[1]}">${item[0]}</span>` : '';
    };
	
	function renderPage() {
	  const size = (pageSize === Number.MAX_SAFE_INTEGER) ? Number.MAX_SAFE_INTEGER : Number(pageSize);
	  const total = _cacheRows.length;
	  const totalPages = (size === Number.MAX_SAFE_INTEGER)
		? 1
		: Math.max(1, Math.ceil(total / size));

	  const start = (size === Number.MAX_SAFE_INTEGER) ? 0 : _pageIndex * size;
	  const end   = (size === Number.MAX_SAFE_INTEGER) ? total : start + size;

	  // â˜… é‡è¦ï¼šæŠŠ start å‚³ä¸‹å»ï¼Œåºè™Ÿæ‰æœƒæ¥çºŒ
	  renderRows(_cacheRows.slice(start, end), start);
  
	  pageInfo.textContent = `å…± ${total} ç­†ï¼ˆç¬¬ ${Math.min(_pageIndex + 1, totalPages)} / ${totalPages} é ï¼‰`;
	}
	
	const toYN = (v) => (v === 1 || v === '1' || String(v).toUpperCase() === 'Y') ? 'Y' : 'N';
	
	function renderRows(rows, startIndex = 0){
	  tbody.innerHTML = '';
	  rows.forEach((r, i) => {
		const tr = document.createElement('tr');
		const seq = startIndex + i + 1; // â˜… é€£çºŒåºè™Ÿï¼ˆè·¨é ï¼‰

		const isTP  = String(r.test_plan) === '1';
		const isBug = String(r.bug_found) === '1';
		const isVF  = String(r.verify_failed) === '1';

		let rowColor = '';
		if (qTestPlan.value === '1' && isTP) {
		  rowColor = 'bg-purple-100';
		} else if (isVF) {
		  rowColor = 'bg-red-100';
		} else if (isBug) {
		  rowColor = 'bg-yellow-100';
		} else if (isTP) {
		  rowColor = 'bg-purple-100';
		}
		tr.className = `row ${rowColor}`;

		const issueDisplay = r.issue_link
		  ? `<a class="text-brand-700 underline font-medium" href="${r.issue_link}" target="_blank" rel="noopener">${r.issue_number ?? ''}</a>`
		  : (r.issue_number ?? '');

		tr.innerHTML = `
		  <td class="px-3 py-2 text-slate-500">${seq}</td>
		  <td class="px-3 py-2">${issueDisplay}</td>
		  <td class="px-3 py-2">${statusChip(r.status)}</td>
		  <td class="px-3 py-2">${categoryChip(r.category)}</td>
		  <td class="px-3 py-2">${r.feature ?? ''}</td>
		  <td class="px-3 py-2">${fmtDate(r.test_start_date)}</td>
		  <td class="px-3 py-2">${fmtDate(r.eta_date)}</td>
		  <td class="px-3 py-2">${fmtDate(r.completed_at)}</td>
		  <td class="px-3 py-2">${r.test_cases ?? ''}</td>
		  <td class="px-3 py-2 whitespace-pre-wrap break-words">${r.memo ?? ''}</td>
		  <td class="px-3 py-2">
			<div class="flex gap-2">
				<button class="text-blue-600 hover:underline" data-edit="${r.id}">âœï¸</button>
				<button class="text-red-500 hover:underline" data-del="${r.id}">ğŸ—‘ï¸</button>
			</div>
		  </td>
		`;
		tbody.appendChild(tr);
	  });

	  tbody.querySelectorAll('button[data-edit]').forEach(btn=>{
		btn.addEventListener('click', async ()=>{
		  const id = btn.getAttribute('data-edit');
		  const ref = doc(db, 'records', id);
		  const snap = await getDoc(ref);
		  if(snap.exists()){
			loadToForm(id, snap.data());
			openModal('edit'); 
		  }
		});
	  });

	  tbody.querySelectorAll('button[data-del]').forEach(btn=>{
		btn.addEventListener('click', async ()=>{
		  const id = btn.getAttribute('data-del');
		  if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†è³‡æ–™ï¼Ÿ')){
			await deleteDoc(doc(db, 'records', id));
			await reload();
		  }
		});
	  });
	}

    function fmtDate(v){
      if(!v) return '';
      try{
        if(v.toDate) v = v.toDate();
        const yyyy = v.getFullYear();
        const mm = String(v.getMonth()+1).padStart(2,'0');
        const dd = String(v.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }catch(_){
        return '';
      }
    }

    function loadToForm(id, data){
      editingId = id;
      fields.status.value = data.status ?? '1';
      fields.completed_at.value = data.completed_at ? fmtDate(data.completed_at) : '';
      fields.issue_number.value = data.issue_number ?? '';
      fields.test_plan.value = data.test_plan ?? '0';
      fields.category.value = data.category ?? '';
      fields.feature.value = data.feature ?? '';
      fields.memo.value = data.memo ?? '';
      fields.test_start_date.value = data.test_start_date ? fmtDate(data.test_start_date) : '';
      fields.eta_date.value = data.eta_date ? fmtDate(data.eta_date) : '';
      fields.bug_found.value = data.bug_found ?? 0;
      fields.verify_failed.value = data.verify_failed ?? 0;
      fields.test_cases.value = data.test_cases ?? '';
      fields.file_count.value = data.file_count ?? '';
      fields.optimization_points.disabled = String(fields.bug_found.value) !== '1';
      fields.optimization_points.value = (data.optimization_points === 0 || data.optimization_points == null) ? '' : data.optimization_points;
      updateIssuePreview();
    }

    // Pagination & search
	
	pageSizeSel.addEventListener('change', () => {
	  const v = pageSizeSel.value;
	  pageSize = (v === 'all') ? Number.MAX_SAFE_INTEGER : Number(v);
	  _pageIndex = 0;     // è®Šæ›´æ¯é ç­†æ•¸å¾Œå›åˆ°ç¬¬1é 
	  renderPage();
	});
	
	pageInput.addEventListener('keydown', (e) => {
	  if (e.key === 'Enter'){
		if (_cacheRows.length === 0) return;
		  if (pageSize === Number.MAX_SAFE_INTEGER) return; // å…¨éƒ¨æ¨¡å¼ä¸éœ€è·³é 
		  const totalPages = Math.max(1, Math.ceil(_cacheRows.length / pageSize));
		  const v = Number(pageInput.value);
		  if (!Number.isInteger(v) || v < 1) return;
		  _pageIndex = Math.min(v - 1, totalPages - 1);
		  renderPage();
	  }
	});
	
	btnNext.addEventListener('click', () => {
	  if (_cacheRows.length === 0) return;
	  if (pageSize === Number.MAX_SAFE_INTEGER) return; // é¡¯ç¤ºå…¨éƒ¨æ™‚ä¸éœ€è¦ç¿»é 

	  const totalPages = Math.max(1, Math.ceil(_cacheRows.length / pageSize));
	  _pageIndex = Math.min(_pageIndex + 1, totalPages - 1);
	  renderPage();
	});

	btnPrev.addEventListener('click', () => {
	  if (_cacheRows.length === 0) return;
	  if (pageSize === Number.MAX_SAFE_INTEGER) return;

	  _pageIndex = Math.max(_pageIndex - 1, 0);
	  renderPage();
	});
	
	// æ¸…ç©ºæŸ¥è©¢æ¢ä»¶
	btnClear.addEventListener('click', () => {
	  // æ¸…ç©ºè¼¸å…¥æ¡†
	  qKeyword.value = '';
	  qStatus.value = '';
	  qCategory.value = '';
	  qTestPlan.value = '';
	  qBugFound.value = '';

	  // é‡è¼‰æŸ¥è©¢çµæœ
	  _pageIndex = 0;
	  _cacheRows = [];
	  reload();
	});
	
	// ã€Œæœå°‹ã€ç¶­æŒåŸæœ¬è¡Œç‚ºï¼šé‡ç½®ä¸¦é‡æ–°æŸ¥è©¢
	btnSearch.addEventListener('click', async () => {
		_pageIndex = 0;
		_cacheRows = [];
		await reload(); // å…§éƒ¨æœƒå‘¼å« fetchPage()ï¼Œä¸¦é‡å»ºå¿«å–
	});

    async function reload(forward=true){
      await fetchPage(forward);
    }

	// é—œéµå­—æŸ¥è©¢ç¶å®š Enter æŒ‰éµ
	qKeyword.addEventListener('keydown', (e) => {
	  if (e.key === 'Enter') {
		e.preventDefault();
		btnSearch.click();
	  }
	});

    // Excel export (current table)
	btnExportExcel.addEventListener('click', () => {
	  // 1) ç”¢ç”Ÿè¡¨é ­ï¼ˆå»æ‰æœ€å¾Œçš„ã€Œæ“ä½œã€ï¼‰
	  let headers = ['ISSUE#','ç‹€æ…‹','é¡å‹','åŠŸèƒ½','Test Plan','BUG','é©—è­‰å¤±æ•—','é–‹å§‹æ¸¬è©¦æ—¥æœŸ','é è¨ˆäº¤ä»˜æ—¥æœŸ','å®Œæˆæ—¥æœŸ','æ¸¬è©¦æ¡ˆä¾‹','MEMO'];

	  if (headers[headers.length - 1] === 'æ“ä½œ') headers = headers.slice(0, -1);

	  // 2) è½‰æ›å·¥å…·ï¼ˆèˆ‡åŸæœ¬ä¸€è‡´ï¼‰
	  const statusText = (v) => {
		const n = Number(v);
		if (n === 1) return 'åŸ·è¡Œä¸­';
		if (n === 0) return 'åŸ·è¡Œä¸­æ­¢';
		if (n === 2) return 'å®Œæˆ';
		return '';
	  };
	  const categoryText = (v) => {
		const map = {1:'BUG', 2:'æ”¹å–„', 3:'å„ªåŒ–', 4:'æ¨¡çµ„', 5:'QA'};
		return map[Number(v)] || '';
	  };
	  const toYN = (v) => (v === 1 || v === '1' || String(v).toUpperCase() === 'Y') ? 'Y' : 'N';
	  const fmt = (v) => {
		if (!v) return '';
		try {
		  if (typeof v.toDate === 'function') v = v.toDate();
		  const yyyy = v.getFullYear();
		  const mm = String(v.getMonth()+1).padStart(2,'0');
		  const dd = String(v.getDate()).padStart(2,'0');
		  return `${yyyy}-${mm}-${dd}`;
		} catch { return ''; }
	  };

	  // 3) å–å¾—ç”¨ä¾†åˆ¤æ–·å­£åº¦çš„æ—¥æœŸï¼ˆèˆ‡æ‘˜è¦é‚è¼¯ä¸€è‡´ï¼‰
	  const pickDate = (r) => {
		let d = r?.test_start_date || r?.completed_at || r?.created_at;
		if (!d) return null;
		return (typeof d.toDate === 'function') ? d.toDate() : d;
	  };
	  const getQuarter = (d) => {
		if (!(d instanceof Date) || isNaN(d)) return null;
		const m = d.getMonth() + 1; // 1~12
		if (m >= 1 && m <= 3)  return 'Q1';
		if (m >= 4 && m <= 6)  return 'Q2';
		if (m >= 7 && m <= 9)  return 'Q3';
		if (m >= 10 && m <= 12) return 'Q4';
		return null;
	  };

	  // 4) æŠŠ rows ä¾å­£åº¦åˆ†æ¡¶
	  const buckets = { Q1: [], Q2: [], Q3: [], Q4: [] };
	  for (const r of _cacheRows) {
		const d = pickDate(r);
		const q = getQuarter(d) || 'Q1'; // æ²’æ—¥æœŸå°±å…ˆæ­¸ Q1ï¼Œé¿å…éºæ¼
		const row = [
		  r.issue_number ?? '',
		  statusText(r.status),
		  categoryText(r.category),
		  r.feature ?? '',
		  toYN(r.test_plan),
		  toYN(r.bug_found),
		  toYN(r.verify_failed),
		  fmt(r.test_start_date),
		  fmt(r.eta_date),
		  fmt(r.completed_at),
		  r.test_cases ?? '',
		  (r.memo ?? '').toString().replaceAll('\n',' '),
		  '' // æ“ä½œæ¬„ï¼ˆåŒ¯å‡ºä¸éœ€è¦ï¼‰
		];
		buckets[q].push(row);
	  }

	  // 5) ç”¢ç”Ÿå››å€‹å­£åº¦çš„ sheet
	  const wb = XLSX.utils.book_new();
	  const wsQ1 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q1]);
	  const wsQ2 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q2]);
	  const wsQ3 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q3]);
	  const wsQ4 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q4]);
	  XLSX.utils.book_append_sheet(wb, wsQ1, 'Q1åˆ—è¡¨');
	  XLSX.utils.book_append_sheet(wb, wsQ2, 'Q2åˆ—è¡¨');
	  XLSX.utils.book_append_sheet(wb, wsQ3, 'Q3åˆ—è¡¨');
	  XLSX.utils.book_append_sheet(wb, wsQ4, 'Q4åˆ—è¡¨');

	  // === (åŸæœ¬çš„ã€Œæ‘˜è¦ã€sheet é‚è¼¯ä¿ç•™) ===
	  // ä¾é–‹å§‹æ¸¬è©¦æ—¥æœŸåˆ†æœˆ + å­£åº¦å½™ç¸½ï¼Œé™å®šç‹€æ…‹=å®Œæˆ
	  const monthly = new Map(); // key: 'YYYY-MM' -> {A..G}
	  for (const r of _cacheRows) {
		if (Number(r.status) !== 2) continue; // åƒ…çµ±è¨ˆå®Œæˆ

		let d = r?.test_start_date || r?.completed_at || r?.created_at;
		if (!d) continue;
		d = (typeof d.toDate === 'function') ? d.toDate() : d;
		if (!(d instanceof Date) || isNaN(d)) continue;

		const y = d.getFullYear();
		const m = d.getMonth() + 1;
		const key = `${y}-${String(m).padStart(2,'0')}`;

		if (!monthly.has(key)) monthly.set(key, { A:0, B:0, C:0, D:0, E:0, F:0, G:0 });
		const acc = monthly.get(key);

		const bug   = Number(r.bug_found ?? 0);
		const tp    = (r.test_plan === 1 || r.test_plan === '1') ? 1 : 0;
		const opt   = Number(r.optimization_points ?? 0);
		const cases = Number(r.test_cases ?? 0);
		const vf    = Number(r.verify_failed ?? 0);
		const files = Number(r.file_count ?? 0);

		if (bug === 1) acc.A += 1;                // A: ç™¼ç¾BUG=1 çš„ç­†æ•¸
		acc.B += Number.isFinite(opt) ? opt : 0;  // B: å¯å„ªåŒ–é …ç›®æ•¸
		if (tp === 1) acc.C += 1;                 // C: Test Plan=1 çš„ç­†æ•¸
		if (bug === 0 && tp === 0) acc.D += 1;    // D: BUG=0 ä¸” TP=0 çš„ç­†æ•¸
		acc.E += Number.isFinite(cases) ? cases : 0; // E: æ¸¬è©¦æ¡ˆä¾‹ç¸½æ•¸
		if (vf === 1) acc.F += 1;                 // F: é©—è­‰å¤±æ•—=1 çš„ç­†æ•¸
		acc.G += Number.isFinite(files) ? files : 0; // G: æª”æ¡ˆæ•¸ç¸½æ•¸
	  }

	  const lines = [['Monthly Summary']];
	  const sortedMonths = Array.from(monthly.entries()).sort((a,b) => a[0].localeCompare(b[0]));
	  for (const [key, v] of sortedMonths) {
		const monthNum = Number(key.slice(5));
		const text = `${monthNum}æœˆ ç™¼ç¾ ${v.B} å€‹å¯å„ªåŒ–é …ç›®ï¼Œé–‹ç«‹ ${v.A} å¼µå„ªåŒ– issuesï½œ ç”¢ç”Ÿ ${v.C} ä»½æ¸¬è©¦å ±å‘Šï½œ ${v.D} å¼µé©—è­‰å–®ï¼Œè¤‡é©— ${v.F} å¼µå–®ï½œ å»ºç«‹ ${v.G} å€‹æ¸¬è©¦ç¯„æœ¬ã€${v.E} é …æ¸¬è©¦æ¡ˆä¾‹`;
		lines.push([text]);
	  }

	  function quarterOf(month) { return Math.floor((month - 1) / 3) + 1; }
	  const quarterly = new Map(); // key: 'YYYY-Qn' -> {A..G}
	  for (const [ym, v] of sortedMonths) {
		const y = ym.slice(0, 4);
		const m = Number(ym.slice(5));
		const qKey = `${y}-Q${quarterOf(m)}`;
		if (!quarterly.has(qKey)) quarterly.set(qKey, { A:0, B:0, C:0, D:0, E:0, F:0, G:0 });
		const acc = quarterly.get(qKey);
		acc.A += v.A; acc.B += v.B; acc.C += v.C; acc.D += v.D; acc.E += v.E; acc.F += v.F; acc.G += v.G;
	  }

	  lines.push([''], ['Quarterly Summary']);
	  const sortedQuarters = Array.from(quarterly.entries()).sort((a,b) => a[0].localeCompare(b[0]));
	  for (const [qKey, v] of sortedQuarters) {
		const [year, qLabel] = qKey.split('-');
		const textQ = `${qLabel}: ç™¼ç¾ ${v.B} å€‹å¯å„ªåŒ–é …ç›®ï¼Œé–‹ç«‹ ${v.A} å¼µå„ªåŒ– issuesï½œ ç”¢ç”Ÿ ${v.C} ä»½æ¸¬è©¦å ±å‘Šï½œ ${v.D} å¼µé©—è­‰å–®ï¼Œè¤‡é©— ${v.F} å¼µå–®ï½œ å»ºç«‹ ${v.G} å€‹æ¸¬è©¦ç¯„æœ¬ã€${v.E} é …æ¸¬è©¦æ¡ˆä¾‹`;
		lines.push([`${year} ${textQ}`]);
	  }

	  const wsSummary = XLSX.utils.aoa_to_sheet(lines);
	  XLSX.utils.book_append_sheet(wb, wsSummary, 'æ‘˜è¦');

	  // 6) è¼¸å‡º
	  XLSX.writeFile(wb, 'records.xlsx');
	});


    // ---------- Defaults on load ----------
    function formatDateInput(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function thisFriday(from = new Date()) {
      const d = new Date(from);
      const day = d.getDay();
      const map = {0:7,1:1,2:2,3:3,4:4,5:5,6:6};
      const dow = map[day];
      const delta = 5 - dow;
      d.setDate(d.getDate() + delta);
      return d;
    }

    function toggleOptimizationPoints() {
      const enabled = fields.bug_found.value === '1';
      fields.optimization_points.disabled = !enabled;
      if (!enabled) {
        fields.optimization_points.value = '';
      }

	  // ç™¼ç¾ BUG = æ˜¯ æ™‚çš„è‡ªå‹•æ¬„ä½è™•ç†
	  if (fields.bug_found.value === '1') {
		// æ¸…ç©ºé–‹å§‹æ¸¬è©¦æ—¥æœŸã€é è¨ˆäº¤ä»˜æ—¥æœŸ
		fields.test_start_date.value = '';
		fields.eta_date.value = '';

		// å®Œæˆæ—¥æœŸå¸¶å…¥ä»Šæ—¥
		const today = new Date();
		const yyyy = today.getFullYear();
		const mm = String(today.getMonth() + 1).padStart(2, '0');
		const dd = String(today.getDate()).padStart(2, '0');
		fields.completed_at.value = `${yyyy}-${mm}-${dd}`;
		// é è¨­å®Œæˆ
		fields.status.value = '2';
		
	  }else{
		const today = new Date();
		fields.completed_at.value = '';
	
		if (!fields.test_start_date.value) {
			fields.test_start_date.value = formatDateInput(today);
		}
		if (!fields.eta_date.value) {
			fields.eta_date.value = formatDateInput(thisFriday(today));
		}
		// åŸ·è¡Œä¸­
		fields.status.value = '1';
		
	  }
    }

	// === ğŸŸ¢ GitLab Issues Integration ===
	const btnGitlabIssues = document.getElementById('btnGitlabIssues');
	const gitlabModal = document.getElementById('gitlabModal');
	const btnCloseGitlabModal = document.getElementById('btnCloseGitlabModal');
	const gitlabIssuesBody = document.getElementById('gitlabIssuesBody');
	const glAssigneeInput = document.getElementById('glAssignee');
	const glProjectInput  = document.getElementById('glProject');
	const btnSearchGitlab = document.getElementById('btnSearchGitlab');
	const GITLAB_BASE = "https://gitlab.fb-tek.com/api/v4";
	
	// é–‹çª—ï¼šå¸¶å…¥å¸¸ç”¨é è¨­ï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰
	btnGitlabIssues.addEventListener('click', async () => {
	  gitlabModal.classList.remove('hidden');
	  // é è¨­å€¼ï¼ˆè‹¥ç©ºç™½æ™‚æ‰å¡«ï¼‰
	  if (!glAssigneeInput.value) glAssigneeInput.value = "Welly.Chiu";
	  if (!glProjectInput.value)  glProjectInput.value  = "kh/imp";
	  gitlabIssuesBody.innerHTML = `<p class="text-slate-500 text-sm">è«‹æŒ‰ã€ŒæŸ¥è©¢ã€è¼‰å…¥è³‡æ–™</p>`;
	  searchGitlabIssues();
	});
	// é—œé–‰
	btnCloseGitlabModal.addEventListener('click', () => {
	  gitlabModal.classList.add('hidden');
	});
	gitlabModal.addEventListener('click', (e) => {
	  if (e.target === gitlabModal) gitlabModal.classList.add('hidden');
	});
	
	async function searchGitlabIssues() {
	  gitlabIssuesBody.innerHTML = `<p class="text-slate-500 text-sm">è®€å–ä¸­...</p>`;
	  try {
		const TOKEN = await loadGitlabToken();                 // å¾ Firestore è®€å–ã€å¿«å–
		const project = encodeURIComponent(glProjectInput.value.trim());
		const assignee = glAssigneeInput.value.trim();

		// åªæœ‰ project æ˜¯å¿…å¡«ï¼›assignee å¯ç©ºï¼ˆæŸ¥å…¨å°ˆæ¡ˆé–‹å•Ÿä¸­çš„ issueï¼‰
		const params = new URLSearchParams({ state: "opened", per_page: "50" });
		if (assignee) params.set("assignee_username", assignee);

		const url = `${GITLAB_BASE}/projects/${project}/issues?${params.toString()}`;
		const res = await fetch(url, {
		  headers: { "PRIVATE-TOKEN": TOKEN, "Accept": "application/json" }
		});
		if (!res.ok) throw new Error("GitLab API éŒ¯èª¤ï¼š" + res.status);

		const issues = await res.json();
		if (!Array.isArray(issues) || issues.length === 0) {
		  gitlabIssuesBody.innerHTML = `<p class="text-slate-600 text-sm">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ Issueã€‚</p>`;
		  return;
		}

		// æ¸²æŸ“ï¼ˆç”¨ç¬¬ 2 æ­¥æä¾›çš„æ¨£æ¿ï¼‰
		gitlabIssuesBody.innerHTML = `
		  <ul class="divide-y divide-slate-200">
			${issues.map(i => `
			  <li class="py-3">
				<div class="flex items-start gap-3">
				  <input type="checkbox"
						 class="gl-select mt-1"
						 data-iid="${i.iid}"
						 data-title="${i.title?.replace(/"/g, '&quot;') || ''}"
						 data-url="${i.web_url}">
				  <div class="flex-1">
					<div class="flex items-start justify-between gap-3">
					  <div>
						<a href="${i.web_url}" target="_blank" class="text-brand-700 font-semibold underline">#${i.iid} ${i.title}</a>
						<div class="text-xs text-slate-500 mt-1">
						  å°ˆæ¡ˆï¼š${i.references?.full || ''}<br>
						  æ›´æ–°æ™‚é–“ï¼š${new Date(i.updated_at).toLocaleString()}
						</div>
					  </div>
					  <button class="btn-secondary text-sm px-3 py-1.5 gl-detail-btn"
							  data-iid="${i.iid}">è©³ç´°è³‡è¨Š</button>
					</div>
					<div class="gl-detail-panel mt-3 hidden" id="gl-detail-${i.iid}">
					  <div class="text-slate-500 text-sm">è®€å–ç•™è¨€ä¸­â€¦</div>
					</div>
				  </div>
				</div>
			  </li>
			`).join('')}
		  </ul>`;
		updateSelectedCount();

	  } catch (err) {
		console.error(err);
		gitlabIssuesBody.innerHTML = `<p class="text-red-600 text-sm">è¼‰å…¥å¤±æ•—ï¼š${err.message}</p>`;
	  }
	}

	// ç¶å®šæŸ¥è©¢æŒ‰éˆ•èˆ‡ Enter
	btnSearchGitlab.addEventListener('click', searchGitlabIssues);
	glAssigneeInput.addEventListener('keydown', e => { if (e.key==='Enter') searchGitlabIssues(); });
	glProjectInput.addEventListener('keydown',  e => { if (e.key==='Enter') searchGitlabIssues(); });

	// ä»£ç†äº‹ä»¶ï¼šé»ã€Œè©³ç´°è³‡è¨Šã€æŠ“ç•™è¨€ï¼ˆnotesï¼‰
	gitlabIssuesBody.addEventListener('click', async (e) => {
	  const btn = e.target.closest('.gl-detail-btn');
	  if (!btn) return;

	  const iid = btn.dataset.iid;
	  const panel = document.getElementById(`gl-detail-${iid}`);

	  // æŠ˜ç–Š/å±•é–‹
	  if (!panel.classList.contains('hidden')) {
		panel.classList.add('hidden');
		return;
	  }
	  panel.classList.remove('hidden');
	  panel.innerHTML = `<div class="text-slate-500 text-sm">è®€å–ç•™è¨€ä¸­â€¦</div>`;

	  try {
		const TOKEN = await loadGitlabToken();
		const project = encodeURIComponent(glProjectInput.value.trim());
		const url = `${GITLAB_BASE}/projects/${project}/issues/${iid}/notes?per_page=100`;
		const res = await fetch(url, {
		  headers: { "PRIVATE-TOKEN": TOKEN, "Accept": "application/json" }
		});
		if (!res.ok) throw new Error(`è®€å–ç•™è¨€å¤±æ•—ï¼š${res.status}`);

		const notes = await res.json();
		if (!Array.isArray(notes) || notes.length === 0) {
		  panel.innerHTML = `<div class="text-slate-600 text-sm">æ²’æœ‰ç•™è¨€ã€‚</div>`;
		  return;
		}

		// ç°¡å–®æ’é™¤ç³»çµ±è¨Šæ¯ï¼ˆå¯é¸ï¼‰
		const humanNotes = notes.filter(n => !n.system);

		panel.innerHTML = `
		  <div class="border rounded-xl p-3 bg-slate-50">
			${humanNotes.map(n => `
			  <div class="mb-3">
				<div class="text-sm font-medium text-slate-700">${n.author?.name || n.author?.username || 'æœªçŸ¥'}</div>
				<div class="text-xs text-slate-500">${new Date(n.created_at).toLocaleString()}</div>
				<div class="mt-1 whitespace-pre-wrap text-slate-800">${escapeHtml(n.body || '')}</div>
			  </div>
			`).join('')}
		  </div>
		`;
	  } catch (err) {
		console.error(err);
		panel.innerHTML = `<div class="text-red-600 text-sm">è®€å–ç•™è¨€å¤±æ•—ï¼š${err.message}</div>`;
	  }
	});

	// ç°¡æ˜“ XSS é¿å…
	function escapeHtml(s){
	  return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c]));
	}


	btnCloseGitlabModal.addEventListener('click', () => {
	  gitlabModal.classList.add('hidden');
	});

	gitlabModal.addEventListener('click', (e) => {
	  if (e.target === gitlabModal) gitlabModal.classList.add('hidden');
	});

	// === é¸å–/è¨ˆæ•¸ ===
	const selectedCountEl = document.getElementById('gitlabSelectedCount');
	const btnToggleSelectAll = document.getElementById('btnToggleSelectAll');
	const btnImportSelected = document.getElementById('btnImportSelected');

	function getAllCheckboxes() {
	  return Array.from(gitlabIssuesBody.querySelectorAll('.gl-select'));
	}
	function getSelected() {
	  return getAllCheckboxes().filter(cb => cb.checked);
	}
	function updateSelectedCount() {
	  selectedCountEl.textContent = `å·²é¸ ${getSelected().length} ç­†`;
	}
	gitlabIssuesBody.addEventListener('change', (e) => {
	  if (e.target.classList.contains('gl-select')) updateSelectedCount();
	});

	let _allSelected = false;
	btnToggleSelectAll.addEventListener('click', () => {
	  _allSelected = !_allSelected;
	  getAllCheckboxes().forEach(cb => cb.checked = _allSelected);
	  btnToggleSelectAll.textContent = _allSelected ? 'å…¨ä¸é¸' : 'å…¨é¸';
	  updateSelectedCount();
	});

	// === åŒ¯å…¥è‡³ records ===
	// è¦æ ¼ï¼ˆä½ æå‡ºçš„é è¨­å€¼ï¼‰ï¼š
	// ç‹€æ…‹ = åŸ·è¡Œä¸­(1)
	// issue_number = GitLab çš„ iid
	// test_plan = '0'ï¼ˆå­—ä¸²ï¼Œç¬¦åˆä½ ç¾æœ‰æ¬„ä½æ…£ä¾‹ï¼‰
	// memo = GitLab æ¨™é¡Œ
	// test_start_date = ä»Šå¤©ã€eta_date = æœ¬é€±äº”
	// verify_failed/test_cases/file_count/bug_found/optimization_points = 0
	// feature = 'é€éç³»çµ±åŒ¯å…¥è«‹æ‰‹å‹•èª¿æ•´'
	// completed_at = nullï¼ˆç©ºï¼‰
	// issue_link = GitLab çš„ web_url
	btnImportSelected.addEventListener('click', async () => {
	  const picks = getSelected();
	  if (picks.length === 0) {
		alert('è«‹å…ˆå‹¾é¸è¦åŒ¯å…¥çš„è³‡æ–™');
		return;
	  }

	  const u = auth.currentUser;
	  if (!u) {
		alert('è«‹å…ˆç™»å…¥å†åŒ¯å…¥');
		return;
	  }

	  btnImportSelected.disabled = true;
	  btnImportSelected.textContent = 'åŒ¯å…¥ä¸­...';

	  try {
		const today = new Date();
		let successCount = 0;
		let skippedCount = 0;
		let failCount = 0;

		// é€ç­†æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¾ issue_numberï¼‰
		for (const cb of picks) {
		  const iid = Number(cb.dataset.iid);
		  const title = cb.dataset.title || '';
		  const url = cb.dataset.url || '';

		  // æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒ issue_number çš„ç´€éŒ„
		  const qExist = query(
			collection(db, 'records'),
			where('issue_number', '==', iid)
		  );
		  const snap = await getDocs(qExist);
		  if (!snap.empty) {
			console.log(`Issue ${iid} å·²å­˜åœ¨ï¼Œç•¥éåŒ¯å…¥`);
			skippedCount++;
			continue; // å·²å­˜åœ¨å°±è·³é
		  }

		  const payload = {
			status: 1,
			completed_at: null,
			issue_number: iid,
			test_plan: '0',
			category: null,
			feature: 'é€éç³»çµ±åŒ¯å…¥è«‹æ‰‹å‹•èª¿æ•´',
			memo: title,
			test_start_date: today,
			eta_date: thisFriday(today),
			bug_found: 0,
			optimization_points: 0,
			verify_failed: 0,
			test_cases: 0,
			file_count: 0,
			issue_link: url,
			created_by_uid: u.uid,
			created_at: serverTimestamp()
		  };

		  try {
			await addDoc(collection(db, 'records'), payload);
			successCount++;
		  } catch (err) {
			console.error(`åŒ¯å…¥ Issue ${iid} å¤±æ•—ï¼š`, err);
			failCount++;
		  }
		}

		alert(`åŒ¯å…¥å®Œæˆï¼š
	æˆåŠŸ ${successCount} ç­†
	ç•¥éï¼ˆå·²å­˜åœ¨ï¼‰ ${skippedCount} ç­†
	å¤±æ•— ${failCount} ç­†`);

		gitlabModal.classList.add('hidden');
		_allSelected = false;
		btnToggleSelectAll.textContent = 'å…¨é¸';
		await reload(); // é‡æ–°è¼‰å…¥è¡¨æ ¼
	  } catch (err) {
		console.error(err);
		alert('åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š' + (err.message || err));
	  } finally {
		btnImportSelected.disabled = false;
		btnImportSelected.textContent = 'åŒ¯å…¥é¸å–';
	  }
	});




    function setDefaultsIfEmpty() {
      if (!['0','1','2'].includes(String(fields.status.value))) {
        fields.status.value = '1';
      }
      if (!['1','0'].includes(String(fields.test_plan.value))) {
        fields.test_plan.value = '0';
      }
      const today = new Date();
      //if (!fields.completed_at.value) {
       // fields.completed_at.value = formatDateInput(today);
      //}
      if (!fields.test_start_date.value) {
        fields.test_start_date.value = formatDateInput(today);
      }
      if (!fields.eta_date.value) {
        fields.eta_date.value = formatDateInput(thisFriday(today));
      }
      toggleOptimizationPoints();
    }

    // åˆæ¬¡è¼‰å…¥ï¼šå¥—é è¨­ + ç«‹åˆ»æŸ¥è©¢
    setDefaultsIfEmpty();
    fields.bug_found.addEventListener('change', toggleOptimizationPoints);
	
	
	
	
	// é‡å°ã€Œç›®å‰æŸ¥è©¢çµæœã€é€ç­†æ›´æ–°
	async function bulkUpdateCurrentCache() {
	  const u = auth.currentUser;
	  if (!u) throw new Error('æœªç™»å…¥');
	  if (!_cacheRows || _cacheRows.length === 0) return;

	  // 500 ç­†ä¸€å€‹æ‰¹æ¬¡
	  for (let i = 0; i < _cacheRows.length; i += 500) {
		const chunk = _cacheRows.slice(i, i + 500);
		const batch = writeBatch(db);
		chunk.forEach(row => {
		  batch.update(doc(db, 'records', row.id), {
			created_by_uid: u.uid,
			created_at: serverTimestamp(),
			updated_by_uid: u.uid,
			updated_at: serverTimestamp(),
		  });
		});
		await batch.commit();
	  }
	  await reload(); // ä½ åŸæœ¬çš„é‡æŸ¥å‡½å¼:contentReference[oaicite:2]{index=2}
	}
	document.getElementById('btnBulkUpdate').addEventListener('click', bulkUpdateCurrentCache);
  </script>
</body>
</html>
