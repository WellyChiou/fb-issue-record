<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QA Tracker</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* 預設先隱藏，避免尚未檢查登入時閃出畫面 */
    body { display: none; }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 600: '#4f46e5', 700: '#4338ca' }
          },
          boxShadow: { soft: '0 2px 10px rgba(0,0,0,.06)' }
        }
      }
    }
  </script>

  <!-- Firebase SDKs (Modular v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Replace with your own if needed
    const firebaseConfig = {
      apiKey: "AIzaSyCuTlQfSUTlgig_NF7bKV448v35UEuB0aA",
      authDomain: "fb-issue-record.firebaseapp.com",
      projectId: "fb-issue-record",
      storageBucket: "fb-issue-record.firebasestorage.app",
      messagingSenderId: "892738349977",
      appId: "1:892738349977:web:004b30f804e2937692c108"
    };

    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
    window.auth = getAuth(app);
    window.GoogleAuthProvider = GoogleAuthProvider;
    window.signInWithPopup = signInWithPopup;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;

  // === 認證檢查結束 ===
  </script>

  <style>
    .btn{ padding:.6rem 1rem; border-radius:1rem; background:#0f172a; color:#fff; font-weight:600; box-shadow:0 1px 3px rgba(0,0,0,.15); }
    .btn:hover{ opacity:.95 }
    .btn-secondary{ padding:.55rem 1rem; border-radius:1rem; border:1px solid #cbd5e1; background:#fff; color:#334155; }
    .btn-secondary:hover{ background:#f8fafc }
    .inp{ width:100%; padding:.55rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; outline:none; background:#fff; }
    .inp:focus{ box-shadow:0 0 0 3px rgba(79,70,229,.2); border-color:#a5b4fc; }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; border-radius:9999px; font-size:.75rem; font-weight:600; }
    .chip-green{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .chip-gray{ background:#f1f5f9; color:#334155; border:1px solid #e2e8f0; }
    .chip-red{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .chip-indigo{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }
    .chip-amber{ background:#fffbeb; color:#92400e; border:1px solid #fde68a; }
    .table-head th{
	  position:sticky; top:0; background:#f8fafc;
	  white-space: nowrap;           /* 表頭不換行 */
	}
	#tableWrap tbody td{
	  white-space: normal;     /* 允許自動換行 */
	  word-break: break-word;  /* 長字/URL 也能斷行 */
	}
    .row{ border-bottom:1px solid #e2e8f0; }
    /* 原本：.row:nth-child(even){ background:#fcfcfd; } */
    .row.striped:nth-child(even){ background:#fcfcfd; }
    .overlay {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.8); backdrop-filter:saturate(180%) blur(2px);
    }
	/* 固定欄寬：由 table-fixed + colgroup 決定 */
	#tableWrap table { table-layout: fixed; }

	/* 表頭單行顯示（完整看到標題） */
	.table-head th { white-space: nowrap; }

	/* 內容遇到長字/URL 會自動斷行，不撐寬 */
	#tableWrap tbody td{
	  white-space: normal;
	  word-break: break-word;
	}
	  /* 實心色系 */
	.btn-primary{ background:#4f46e5; color:#fff; }   /* 品牌靛藍 */
	.btn-primary:hover{ background:#4338ca; }

	.btn-success{ background:#10b981; color:#fff; }   /* 綠：匯出成功感 */
	.btn-success:hover{ background:#059669; }

	.btn-info{ background:#0ea5e9; color:#fff; }      /* 藍：動作/搜尋 */
	.btn-info:hover{ background:#0284c7; }

	.btn-warning{ background:#f59e0b; color:#fff; }   /* 橘：提醒/批次更新 */
	.btn-warning:hover{ background:#d97706; }

	.btn-danger{ background:#ef4444; color:#fff; }    /* 紅：危險/清空 */
	.btn-danger:hover{ background:#dc2626; }

	/* 描邊（淡色） */
	.btn-outline{ border:1px solid #cbd5e1; background:#fff; color:#334155; }
	.btn-outline-red{ border:1px solid #fecaca; color:#991b1b; background:#fff; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-gradient-to-r from-brand-600 to-brand-700 text-white shadow">
    <div class="max-w-7xl mx-auto px-5 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-white/15 grid place-items-center font-bold">QA</div>
        <h1 class="text-xl md:text-2xl font-semibold">QA Tracker</h1>
      </div>
		<div id="authArea" class="flex items-center gap-3">
		  <!-- <button id="btnSignIn" class="btn bg-white text-brand-700">使用 Google 登入</button> -->
		  <div id="userDisplayName" class="hidden items-center gap-3">
			<span id="userEmail" class="text-sm opacity-90"></span>
			<button id="btnSignOut" class="btn-secondary">登出</button>
		  </div>
		</div>

    </div>
  </header>

  <main class="max-w-7xl mx-auto px-5 py-6 space-y-6">
  
	<!-- Modal：建立 / 編輯資料 -->
	<div id="recordModal" class="fixed inset-0 z-[100] hidden" aria-hidden="true">
	  <!-- 背景 -->
	  <div class="absolute inset-0 bg-black/40"></div>

	  <!-- 面板 -->
	  <div class="relative w-full h-full grid place-items-center p-4">
		<div data-modal-panel
			 class="w-full max-w-4xl bg-white rounded-2xl shadow-soft border border-slate-100">
		  <!-- Header -->
		  <div class="flex items-center justify-between px-5 py-4 border-b">
			<div>
			  <h2 id="modalTitle" class="text-lg md:text-xl font-semibold">建立 / 編輯資料</h2>
			  <div class="text-xs text-slate-500">* 全部欄位皆為非必填</div>
			</div>
			<button id="btnModalClose" class="btn-secondary">關閉</button>
		  </div>

		  <!-- Body（沿用你的 form 與欄位） -->
		  <div class="p-5 md:p-6">
			<form id="recordForm" class="grid md:grid-cols-4 gap-4">
			  <!-- === 以下保留你的原欄位區塊即可 === -->
			  <!-- Row 1 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">狀態</label>
				<select id="status" class="inp">
				  <option value="1" selected>執行中</option>
				  <option value="0">執行中止</option>
				  <option value="2">完成</option>
				</select>
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">完成日期</label>
				<input id="completed_at" type="date" class="inp" />
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">Issue Number</label>
				<input id="issue_number" type="number" class="inp" placeholder="例如 1234" />
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">Test Plan</label>
				<select id="test_plan" class="inp">
				  <option value="0" selected>否</option>
				  <option value="1">是</option>
				</select>
			  </div>

			  <!-- Row 2 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">類型</label>
				<select id="category" class="inp">
				  <option value="1" selected>BUG</option>
				  <option value="2">改善</option>
				  <option value="3">優化</option>
				  <option value="4">模組</option>
				  <option value="5">QA</option>
				</select>
			  </div>
			  <div class="md:col-span-3">
				<label class="block text-sm text-slate-600 mb-1">功能</label>
				<input id="feature" type="text" class="inp" placeholder="文字描述" />
			  </div>

			  <!-- Row 3 -->
			  <div class="md:col-span-4">
				<label class="block text-sm text-slate-600 mb-1">Memo</label>
				<textarea id="memo" class="inp" rows="2" placeholder="備註（非必填）"></textarea>
			  </div>

			  <!-- Row 4 -->
			  <div class="md:col-span-2">
				<label class="block text-sm text-slate-600 mb-1">開始測試日期</label>
				<input id="test_start_date" type="date" class="inp" />
			  </div>
			  <div class="md:col-span-2">
				<label class="block text-sm text-slate-600 mb-1">預計交付日期</label>
				<input id="eta_date" type="date" class="inp" />
			  </div>

			  <!-- Row 5 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">驗證失敗</label>
				<select id="verify_failed" class="inp">
				  <option value="0" selected>否</option>
				  <option value="1">是</option>
				</select>
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">測試案例</label>
				<input id="test_cases" type="number" class="inp" value="0" />
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">檔案數量</label>
				<input id="file_count" type="number" class="inp" value="0" />
			  </div>
			  <div class="md:col-span-1"></div>

			  <!-- Row 6 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">發現 BUG</label>
				<select id="bug_found" class="inp">
				  <option value="0" selected>否</option>
				  <option value="1">是</option>
				</select>
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">可優化項目</label>
				<input id="optimization_points" type="number" class="inp" placeholder="數字；僅在 發現BUG=1 時可填" min="0" step="1" disabled />
			  </div>
			  <div class="md:col-span-2"></div>

			  <!-- Row 7 -->
			  <div class="md:col-span-4 flex flex-wrap gap-3 items-end">
				<button id="btnSave" class="btn" type="submit">儲存</button>
				<button id="btnReset" class="btn-secondary" type="button">重設</button>
				<span id="saveMsg" class="ml-2 text-sm text-green-600"></span>
				<a id="issue_link_preview" class="text-brand-700 font-semibold underline hidden"
				   href="#" target="_blank" rel="noopener">打開 Issue</a>
			  </div>
			</form>
		  </div>
		</div>
	  </div>
	</div>

  
  
    <!-- List Card -->
    <section id="listSection" class="relative bg-white rounded-2xl shadow-soft p-5 md:p-6 border border-slate-100">
      <!-- Title row -->
      <div class="mb-3">
        <h2 class="text-lg md:text-xl font-semibold">資料列表</h2>
      </div>

	<!-- Filters block -->
	<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">

	  <!-- 關鍵字 -->
	  <div class="flex flex-col">
		<label for="q_keyword" class="text-sm text-slate-600 font-medium mb-1">關鍵字</label>
		<input id="q_keyword" type="text" class="inp" placeholder="搜尋 功能/Memo/Issue#"/>
	  </div>

	  <!-- 狀態 -->
	  <div class="flex flex-col">
		<label for="q_status" class="text-sm text-slate-600 font-medium mb-1">狀態</label>
		<select id="q_status" class="inp">
		  <option value="" selected>全部</option>
		  <option value="1">執行中</option>
		  <option value="0">執行中止</option>
		  <option value="2">完成</option>
		</select>
	  </div>

	  <!-- 類型 -->
	  <div class="flex flex-col">
		<label for="q_category" class="text-sm text-slate-600 font-medium mb-1">類型</label>
		<select id="q_category" class="inp">
		  <option value="" selected>全部</option>
		  <option value="1">BUG</option>
		  <option value="2">改善</option>
		  <option value="3">優化</option>
		  <option value="4">模組</option>
		  <option value="5">QA</option>
		</select>
	  </div>

	  <!-- Test Plan -->
	  <div class="flex flex-col">
		<label for="q_test_plan" class="text-sm text-slate-600 font-medium mb-1">Test Plan</label>
		<select id="q_test_plan" class="inp">
		  <option value="" selected>全部</option>
		  <option value="1">是</option>
		  <option value="0">否</option>
		</select>
	  </div>

	  <!-- 發現BUG -->
	  <div class="flex flex-col">
		<label for="q_bug_found" class="text-sm text-slate-600 font-medium mb-1">發現BUG</label>
		<select id="q_bug_found" class="inp">
		  <option value="" selected>全部</option>
		  <option value="1">是</option>
		  <option value="0">否</option>
		</select>
	  </div>

	</div>


      <!-- Buttons row (right aligned) -->
	<div class="flex justify-end gap-2 mb-3">
	  <button id="btnCreate" class="btn btn-primary">新增 Issue</button>
	  <button id="btnSearch" class="btn btn-info">搜尋</button>
	  <button id="btnClear" class="btn btn-secondary">清空</button>
	  <button id="btnExportExcel" class="btn btn-success">匯出 Excel</button>
	  <button id="btnGitlabIssues" class="btn btn-warning">查看 GitLab Issues</button>
	  <button id="btnBulkUpdate" class="btn btn-warning" hidden>更新現有資料</button>
	</div>


      <!-- Overlay (center big) -->
      <div id="loadingOverlay" class="overlay hidden">
        <div class="flex flex-col items-center gap-3 bg-white/80 rounded-2xl px-6 py-6 shadow-soft border border-slate-200">
          <svg class="animate-spin h-8 w-8 text-brand-700" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <div class="text-slate-700 font-medium">查詢中，請稍候…</div>
        </div>
      </div>

      <div id="tableWrap" class="overflow-x-auto border rounded-2xl">
		<div id="tableWrap" class="overflow-x-auto border rounded-2xl">
			<table class="table-fixed min-w-[1600px] text-sm">
			    <!-- ✅ 把 colgroup 放在這裡（thead 前面） -->
				<colgroup>
				  <col style="width:60px" />  <!-- 序號 -->
				  <col style="width:50px" />  <!-- Issue# -->
				  <col style="width:70px" />  <!-- 狀態 -->
				  <col style="width:60px" />  <!-- 類型 -->
				  <col style="width:120px" />  <!-- 功能 -->
				  <col style="width:120px" />  <!-- 開始測試日期 -->
				  <col style="width:120px" />  <!-- 預計交付日期 -->
				  <col style="width:120px" />  <!-- 完成日期 -->
				  <col style="width:50px" />  <!-- 測試案例 -->
				  <col style="width:400px" />  <!-- Memo -->
				  <col style="width:140px" />  <!-- 操作 -->
				</colgroup>

				<thead class="table-head text-slate-600 text-xs uppercase tracking-wide">
					<tr>
					  <th class="px-3 py-2 text-left">#</th>
					  <th class="px-3 py-2 text-left">Issue#</th>
					  <th class="px-3 py-2 text-left">狀態</th>
					  <th class="px-3 py-2 text-left">類型</th>
					  <th class="px-3 py-2 text-left">功能</th>
					  <th class="px-3 py-2 text-left">開始測試日期</th>
					  <th class="px-3 py-2 text-left">預計交付日期</th>
					  <th class="px-3 py-2 text-left">完成日期</th>
					  <th class="px-3 py-2 text-left">測試案例</th>
					  <th class="px-3 py-2 text-left">Memo</th>
					  <th class="px-3 py-2 text-left">操作</th>
					</tr>
			  </thead>
          <tbody id="recordsTbody"></tbody>
        </table>
      </div>

		<div id="pager" class="flex flex-wrap items-center justify-end mt-3 gap-2">
		  <label for="pageSize" class="text-sm text-slate-600">每頁</label>
		  <select id="pageSize" class="inp w-24">
			<option value="10" selected>10</option>
			<option value="20">20</option>
			<option value="50">50</option>
			<option value="100">100</option>
			<option value="all">全部</option>
		  </select>

		  <button id="btnPrev" class="btn-secondary">上一頁</button>
		  <span id="pageInfo" class="text-sm text-slate-600 self-center"></span>
		  
		  <!-- 新增：手動輸入頁碼與跳轉 -->
		  <div class="flex items-center gap-2">
			<span class="text-sm text-slate-600">到第</span>
			<input id="pageInput" type="number" min="1" step="1" class="inp w-20" placeholder="頁碼"/>
			<span class="text-sm text-slate-600">頁</span>
		  </div>
		  
		  
		  <button id="btnNext" class="btn-secondary">下一頁</button>
		</div>

    </section>
	
	<!-- 🟢 GitLab Issues Modal -->
	<div id="gitlabModal" class="fixed inset-0 z-[120] hidden">
	  <!-- 背景 -->
	  <div class="absolute inset-0 bg-black/40"></div>

	  <!-- 面板 -->
	  <div class="relative w-full h-full grid place-items-center p-4">
		<div class="bg-white rounded-2xl shadow-soft border border-slate-100 w-full max-w-3xl">
			<!-- GitLab Issues Modal（標題列：加入查詢欄位） -->
			<div class="px-5 py-4 border-b space-y-3">
			  <div class="flex items-center justify-between">
				<h2 class="text-lg md:text-xl font-semibold">GitLab Issues 查詢</h2>
				<div class="flex items-center gap-2">
				  <span id="gitlabSelectedCount" class="text-sm text-slate-600">已選 0 筆</span>
				  <button id="btnToggleSelectAll" class="btn-outline">全選</button>
				  <button id="btnImportSelected" class="btn btn-primary">匯入選取</button>
				  <button id="btnCloseGitlabModal" class="btn-secondary">關閉</button>
				</div>
			  </div>
			  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
				<div>
				  <label class="block text-xs text-slate-600 mb-1">Assignee（使用者名稱）</label>
				  <input id="glAssignee" class="inp" placeholder="例如：Welly.Chiu" />
				</div>
				<div class="md:col-span-2">
				  <label class="block text-xs text-slate-600 mb-1">Project（路徑）</label>
				  <input id="glProject" class="inp" placeholder="例如：kh/imp；也可填 gitlab.com 的 other/group/project" />
				</div>
				<div class="md:col-span-3 flex justify-end">
				  <button id="btnSearchGitlab" class="btn btn-info">查詢</button>
				</div>
			  </div>
			</div>


			<div id="gitlabIssuesBody" class="p-5 max-h-[70vh] overflow-y-auto">
			<p class="text-slate-500 text-sm">尚未載入</p>
			</div>
		</div>
	  </div>
	</div>

  </main>

  <!-- App logic -->
  <script type="module">
    import {
      collection, addDoc, serverTimestamp, query, orderBy, limit, startAfter, getDocs,
      updateDoc, doc, deleteDoc, getDoc, where, writeBatch, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Auth UI
    const btnSignOut = document.getElementById('btnSignOut');
    const userDisplayName = document.getElementById('userDisplayName');
    const userEmail = document.getElementById('userEmail');
	
	// Git Token
	let GITLAB_TOKEN = null;
	
	onAuthStateChanged(auth, (user) => {
		if (user) {
			document.body.style.display = 'block'; // 顯示 body 內容
			userDisplayName.classList.remove('hidden');
			userEmail.textContent = user.displayName || user.email;
			// ★ 登入後：記錄/更新使用者基本資料（最小幅度）
			setDoc(doc(db, 'users', user.uid), {
			  uid: user.uid,
			  email: user.email ?? null,
			  displayName: user.displayName ?? null,
			  photoURL: user.photoURL ?? null,
			  providerId: user.providerData?.[0]?.providerId ?? null,
			  lastLoginAt: serverTimestamp()
			}, { merge: true }).catch(console.error);
			reload();
			loadGitlabToken().catch(console.error); // 預抓 token（快取在記憶體）
		} else {
			// 已經登出 → 直接導向 login.html
			location.href = "login.html";
		}
	});

    btnSignOut.addEventListener('click', async ()=>{
      await signOut(auth);
    });
	
	async function loadGitlabToken() {
	  if (GITLAB_TOKEN) return GITLAB_TOKEN; // 已載入就用快取
	  // 讀 Firestore：config/gitlab 文件
	  const ref = doc(db, 'config', 'gitlab');
	  const snap = await getDoc(ref);
	  if (!snap.exists()) throw new Error('Firestore 未找到 config/gitlab');
	  const token = snap.data()?.token;
	  if (!token) throw new Error('config/gitlab 無 token 欄位');
	  GITLAB_TOKEN = token;
	  return token;
	}


	// === Modal 控制 ===
	const recordModal   = document.getElementById('recordModal');
	const modalPanel    = recordModal.querySelector('[data-modal-panel]');
	const btnModalClose = document.getElementById('btnModalClose');
	const btnCreate     = document.getElementById('btnCreate');
	const modalTitle    = document.getElementById('modalTitle');
	
	function openModal(mode = 'create') {
	  modalTitle.textContent = (mode === 'edit') ? '編輯資料' : '新增 Issue';
	  recordModal.classList.remove('hidden');
	  document.body.classList.add('overflow-hidden');
	  // 聚焦第一個欄位
	  setTimeout(() => document.getElementById('issue_number')?.focus(), 0);
	}
	function closeModal() {
	  recordModal.classList.add('hidden');
	  document.body.classList.remove('overflow-hidden');
	}

	btnModalClose.addEventListener('click', closeModal);
	recordModal.addEventListener('click', (e) => {
	  if (!modalPanel.contains(e.target)) closeModal();
	});
	document.addEventListener('keydown', (e) => {
	  if (e.key === 'Escape' && !recordModal.classList.contains('hidden')) closeModal();
	});

	// 新增 Issue：清表單 → 打開 Modal
	btnCreate.addEventListener('click', () => {
	  editingId = null;
	  form.reset();
	  setDefaultsIfEmpty();
	  updateIssuePreview();
	  openModal('create');
	});
	
	
	
    // Form refs
    const form = document.getElementById('recordForm');
    const saveMsg = document.getElementById('saveMsg');
    const previewLink = document.getElementById('issue_link_preview');

    const fields = {
      status: document.getElementById('status'),
      completed_at: document.getElementById('completed_at'),
      issue_number: document.getElementById('issue_number'),
      test_plan: document.getElementById('test_plan'),
      category: document.getElementById('category'),
      feature: document.getElementById('feature'),
      memo: document.getElementById('memo'),
      test_start_date: document.getElementById('test_start_date'),
      eta_date: document.getElementById('eta_date'),
      bug_found: document.getElementById('bug_found'),
      optimization_points: document.getElementById('optimization_points'),
      verify_failed: document.getElementById('verify_failed'),
      test_cases: document.getElementById('test_cases'),
      file_count: document.getElementById('file_count')
    };

    // Conditional enable for optimization_points
    fields.bug_found.addEventListener('change', ()=>{
      const enabled = fields.bug_found.value === '1';
      fields.optimization_points.disabled = !enabled;
      if(!enabled) fields.optimization_points.value = '';
    });

    // Dynamic issue link preview
    const ISSUE_BASE = "https://gitlab.fb-tek.com/kh/imp/-/issues/";
    function updateIssuePreview(){
      const n = fields.issue_number.value?.trim();
      if(n){
        previewLink.href = ISSUE_BASE + n;
        previewLink.classList.remove('hidden');
      }else{
        previewLink.classList.add('hidden');
      }
    }
    fields.issue_number.addEventListener('input', updateIssuePreview);
	
	// 狀態=完成(2) 時，自動帶入今天的日期（若尚未填）
	fields.status.addEventListener('change', () => {
	  if (String(fields.status.value) === '2' && !fields.completed_at.value) {
		fields.completed_at.value = formatDateInput(new Date());
	  }else{
		fields.completed_at.value = '';
	  }
	});

    // Save / Update logic
    let editingId = null;

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      // 驗證 issue_number 是否有填
	  if (!fields.issue_number.value || fields.issue_number.value.trim() === '') {
		showMsg('錯誤: 請填寫 Issue Number', true);
		fields.issue_number.focus();
		return; // 中斷，不進行儲存
	  }
      const payload = buildPayload();
      const u = auth.currentUser;
      try{
        showLoading(true);
        if(editingId){
          await updateDoc(doc(db, 'records', editingId), { ...payload, updated_by_uid: u?.uid ?? null, updated_at: serverTimestamp() });
          showMsg('已更新');
        }else{
          await addDoc(collection(db, 'records'), { ...payload, created_by_uid: u?.uid ?? null, created_at: serverTimestamp() });
          showMsg('已儲存');
        }
        form.reset();
        setDefaultsIfEmpty();
        updateIssuePreview();
        editingId = null;
        closeModal(); // 成功就關閉 Modal
        await reload();
      }catch(err){
        console.error(err);
        showMsg('錯誤: ' + err.message, true);
      } finally{
        showLoading(false);
      }
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      editingId = null;
      form.reset();
      setDefaultsIfEmpty();
      updateIssuePreview();
      fields.optimization_points.disabled = fields.bug_found.value !== '1';
    });

    function buildPayload(){
      const toNum = (v)=> {
        if (v === '' || v === null || v === undefined) return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      };
      const toStr = (v)=> v?.trim() || null;
      const toDate = (v)=> v ? new Date(v) : null;

      if (!['0','1','2'].includes(String(fields.status.value))) {
        fields.status.value = '1';
      }
      if (!['1','0'].includes(String(fields.test_plan.value))) {
        fields.test_plan.value = '0';
      }

      const issue_number = toNum(fields.issue_number.value);
      const issue_link = issue_number ? (ISSUE_BASE + issue_number) : null;

      const bugFoundIsYes = String(fields.bug_found.value) === '1';
      const optimization_points = bugFoundIsYes ? toNum(fields.optimization_points.value) : 0;

      return {
        status: toNum(fields.status.value),
        completed_at: toDate(fields.completed_at.value),
        issue_number,
        test_plan: toStr(fields.test_plan.value),
        category: toNum(fields.category.value),
        feature: toStr(fields.feature.value),
        issue_link,
        memo: toStr(fields.memo.value),
        test_start_date: toDate(fields.test_start_date.value),
        eta_date: toDate(fields.eta_date.value),
        bug_found: toNum(fields.bug_found.value) ?? 0,
        optimization_points,
        verify_failed: toNum(fields.verify_failed.value) ?? 0,
        test_cases: toNum(fields.test_cases.value),
        file_count: toNum(fields.file_count.value)
      };
    }

    function showMsg(text, isErr=false){
      saveMsg.textContent = text;
      saveMsg.classList.toggle('text-red-600', !!isErr);
      saveMsg.classList.toggle('text-green-600', !isErr);
      setTimeout(()=>{ saveMsg.textContent=''; }, 5000);
    }

    // Table + pagination
    const listSection = document.getElementById('listSection');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const tableWrap = document.getElementById('tableWrap');
    const pager = document.getElementById('pager');
    const tbody = document.getElementById('recordsTbody');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const pageInfo = document.getElementById('pageInfo');
    const pageSizeSel = document.getElementById('pageSize'); 
	const pageInput = document.getElementById('pageInput');

    const qKeyword = document.getElementById('q_keyword');
    const qStatus = document.getElementById('q_status');
    const qCategory = document.getElementById('q_category');
	const qTestPlan = document.getElementById('q_test_plan');
	const qBugFound  = document.getElementById('q_bug_found');
    const btnSearch = document.getElementById('btnSearch');
	const btnClear = document.getElementById('btnClear');
	const btnExportExcel = document.getElementById('btnExportExcel');

    let pageSize = Number(pageSizeSel.value);  // 一開始就轉成 number
    let lastVisible = null;
    let firstVisible = null;
    let prevStack = [];
	let _cacheRows = [];   // 全部查回後、已排序的全集資料
	let _pageIndex = 0;    // 目前頁碼（0-based）

    function showLoading(show){
      if(show){
        loadingOverlay.classList.remove('hidden');
        tableWrap.classList.add('invisible');
        pager.classList.add('invisible');
      }else{
        loadingOverlay.classList.add('hidden');
        tableWrap.classList.remove('invisible');
        pager.classList.remove('invisible');
      }
    }
	
	// 小工具：安全取得 created_at 的毫秒值
	function _toMillis(v){
	  if (!v) return 0;
	  if (typeof v.toMillis === 'function') return v.toMillis();
	  if (typeof v.toDate === 'function') return v.toDate().getTime();
	  if (v instanceof Date) return v.getTime();
	  if (typeof v === 'number') return v;
	  return 0;
	}


	async function fetchPage(forward = true) {
	  showLoading(true);
	  try {
		// 1) 蒐集查詢條件（不使用 orderBy、不用游標）
		const constraints = [ limit(10000) ]; // 視資料量調整
		if (qStatus.value !== '')   constraints.push(where('status', '==', Number(qStatus.value)));
		if (qCategory.value !== '') constraints.push(where('category', '==', Number(qCategory.value)));
		if (qTestPlan.value !== '') constraints.push(where('test_plan', '==', qTestPlan.value)); // test_plan 為 '0'/'1'（字串）
		if (qBugFound.value !== '') constraints.push(where('bug_found', '==', Number(qBugFound.value))); // bug_found 為數字 0/1
		
		// 只能查到自己建立的資料
		const u = auth.currentUser;
		if (u?.uid) constraints.push(where('created_by_uid', '==', u.uid)); // ★ 新增這行
		
		const kw = (qKeyword?.value ?? '').trim();
		const kwIsNumber = kw !== '' && !Number.isNaN(Number(kw));
		const kwIsText   = kw !== '' && !kwIsNumber;

		if (kwIsNumber) {
		  constraints.push(where('issue_number', '==', Number(kw)));
		} 

		// 2) 一次撈回
		const qBase = query(collection(db, 'records'), ...constraints);
		const snap  = await getDocs(qBase);
		let rows    = snap.docs.map(d => ({ id: d.id, ...d.data() }));

		// 3) （可選）文字關鍵字再做一次前端包含過濾，縮小結果
		if (kwIsText) {
		  const low = kw.toLowerCase();
		  rows = rows.filter(r => {
			const featureMatch = (r.feature || '').toLowerCase().includes(low);
			const memoMatch    = (r.memo || '').toLowerCase().includes(low);
			const issueMatch   = (r.issue_number ?? '').toString().toLowerCase().includes(low);
			return featureMatch || memoMatch || issueMatch;
		  });
		}


		// 4) 前端排序：issue_number ↓、status ↓、created_at ↓
		rows.sort((a, b) => {
		  const n1 = Number(a.issue_number ?? 0);
		  const n2 = Number(b.issue_number ?? 0);
		  if (n1 !== n2) return n2 - n1; // issue_number 大的在前

		  const s1 = Number(a.status ?? 0);
		  const s2 = Number(b.status ?? 0);
		  if (s1 !== s2) return s2 - s1; // status 大的在前

		  return _toMillis(b.created_at) - _toMillis(a.created_at); // 新的在前
		});

		// 5) 快取 + 顯示第一頁
		_cacheRows = rows;
		_pageIndex = 0;
		renderPage();
	  } catch (err) {
		console.error('Query error:', err);
		showMsg('查詢錯誤：' + (err?.message || err), true);
		renderRows([]);
		pageInfo.textContent = '共 0 筆';
	  } finally {
		showLoading(false);
	  }
	}

    const statusChip = (v)=>{
      if(v === 1) return '<span class="chip chip-green">執行中</span>';
      if(v === 0) return '<span class="chip chip-gray">執行中止</span>';
      if(v === 2) return '<span class="chip chip-amber">完成</span>';
      return '';
    };
    const categoryChip = (v)=>{
      const map = {
        1: ['BUG','chip-red'],
        2: ['改善','chip-indigo'],
        3: ['優化','chip-indigo'],
        4: ['模組','chip-gray'],
        5: ['QA','chip-gray']
      };
      const item = map[v];
      return item ? `<span class="chip ${item[1]}">${item[0]}</span>` : '';
    };
	
	function renderPage() {
	  const size = (pageSize === Number.MAX_SAFE_INTEGER) ? Number.MAX_SAFE_INTEGER : Number(pageSize);
	  const total = _cacheRows.length;
	  const totalPages = (size === Number.MAX_SAFE_INTEGER)
		? 1
		: Math.max(1, Math.ceil(total / size));

	  const start = (size === Number.MAX_SAFE_INTEGER) ? 0 : _pageIndex * size;
	  const end   = (size === Number.MAX_SAFE_INTEGER) ? total : start + size;

	  // ★ 重要：把 start 傳下去，序號才會接續
	  renderRows(_cacheRows.slice(start, end), start);
  
	  pageInfo.textContent = `共 ${total} 筆（第 ${Math.min(_pageIndex + 1, totalPages)} / ${totalPages} 頁）`;
	}
	
	const toYN = (v) => (v === 1 || v === '1' || String(v).toUpperCase() === 'Y') ? 'Y' : 'N';
	
	function renderRows(rows, startIndex = 0){
	  tbody.innerHTML = '';
	  rows.forEach((r, i) => {
		const tr = document.createElement('tr');
		const seq = startIndex + i + 1; // ★ 連續序號（跨頁）

		const isTP  = String(r.test_plan) === '1';
		const isBug = String(r.bug_found) === '1';
		const isVF  = String(r.verify_failed) === '1';

		let rowColor = '';
		if (qTestPlan.value === '1' && isTP) {
		  rowColor = 'bg-purple-100';
		} else if (isVF) {
		  rowColor = 'bg-red-100';
		} else if (isBug) {
		  rowColor = 'bg-yellow-100';
		} else if (isTP) {
		  rowColor = 'bg-purple-100';
		}
		tr.className = `row ${rowColor}`;

		const issueDisplay = r.issue_link
		  ? `<a class="text-brand-700 underline font-medium" href="${r.issue_link}" target="_blank" rel="noopener">${r.issue_number ?? ''}</a>`
		  : (r.issue_number ?? '');

		tr.innerHTML = `
		  <td class="px-3 py-2 text-slate-500">${seq}</td>
		  <td class="px-3 py-2">${issueDisplay}</td>
		  <td class="px-3 py-2">${statusChip(r.status)}</td>
		  <td class="px-3 py-2">${categoryChip(r.category)}</td>
		  <td class="px-3 py-2">${r.feature ?? ''}</td>
		  <td class="px-3 py-2">${fmtDate(r.test_start_date)}</td>
		  <td class="px-3 py-2">${fmtDate(r.eta_date)}</td>
		  <td class="px-3 py-2">${fmtDate(r.completed_at)}</td>
		  <td class="px-3 py-2">${r.test_cases ?? ''}</td>
		  <td class="px-3 py-2 whitespace-pre-wrap break-words">${r.memo ?? ''}</td>
		  <td class="px-3 py-2">
			<div class="flex gap-2">
			  <button class="btn text-xs" data-edit="${r.id}">編輯</button>
			  <button class="btn btn-danger text-xs" data-del="${r.id}">刪除</button>
			</div>
		  </td>
		`;
		tbody.appendChild(tr);
	  });

	  tbody.querySelectorAll('button[data-edit]').forEach(btn=>{
		btn.addEventListener('click', async ()=>{
		  const id = btn.getAttribute('data-edit');
		  const ref = doc(db, 'records', id);
		  const snap = await getDoc(ref);
		  if(snap.exists()){
			loadToForm(id, snap.data());
			openModal('edit'); 
		  }
		});
	  });

	  tbody.querySelectorAll('button[data-del]').forEach(btn=>{
		btn.addEventListener('click', async ()=>{
		  const id = btn.getAttribute('data-del');
		  if(confirm('確定刪除這筆資料？')){
			await deleteDoc(doc(db, 'records', id));
			await reload();
		  }
		});
	  });
	}

    function fmtDate(v){
      if(!v) return '';
      try{
        if(v.toDate) v = v.toDate();
        const yyyy = v.getFullYear();
        const mm = String(v.getMonth()+1).padStart(2,'0');
        const dd = String(v.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }catch(_){
        return '';
      }
    }

    function loadToForm(id, data){
      editingId = id;
      fields.status.value = data.status ?? '1';
      fields.completed_at.value = data.completed_at ? fmtDate(data.completed_at) : '';
      fields.issue_number.value = data.issue_number ?? '';
      fields.test_plan.value = data.test_plan ?? '0';
      fields.category.value = data.category ?? '';
      fields.feature.value = data.feature ?? '';
      fields.memo.value = data.memo ?? '';
      fields.test_start_date.value = data.test_start_date ? fmtDate(data.test_start_date) : '';
      fields.eta_date.value = data.eta_date ? fmtDate(data.eta_date) : '';
      fields.bug_found.value = data.bug_found ?? 0;
      fields.verify_failed.value = data.verify_failed ?? 0;
      fields.test_cases.value = data.test_cases ?? '';
      fields.file_count.value = data.file_count ?? '';
      fields.optimization_points.disabled = String(fields.bug_found.value) !== '1';
      fields.optimization_points.value = (data.optimization_points === 0 || data.optimization_points == null) ? '' : data.optimization_points;
      updateIssuePreview();
    }

    // Pagination & search
	
	pageSizeSel.addEventListener('change', () => {
	  const v = pageSizeSel.value;
	  pageSize = (v === 'all') ? Number.MAX_SAFE_INTEGER : Number(v);
	  _pageIndex = 0;     // 變更每頁筆數後回到第1頁
	  renderPage();
	});
	
	pageInput.addEventListener('keydown', (e) => {
	  if (e.key === 'Enter'){
		if (_cacheRows.length === 0) return;
		  if (pageSize === Number.MAX_SAFE_INTEGER) return; // 全部模式不需跳頁
		  const totalPages = Math.max(1, Math.ceil(_cacheRows.length / pageSize));
		  const v = Number(pageInput.value);
		  if (!Number.isInteger(v) || v < 1) return;
		  _pageIndex = Math.min(v - 1, totalPages - 1);
		  renderPage();
	  }
	});
	
	btnNext.addEventListener('click', () => {
	  if (_cacheRows.length === 0) return;
	  if (pageSize === Number.MAX_SAFE_INTEGER) return; // 顯示全部時不需要翻頁

	  const totalPages = Math.max(1, Math.ceil(_cacheRows.length / pageSize));
	  _pageIndex = Math.min(_pageIndex + 1, totalPages - 1);
	  renderPage();
	});

	btnPrev.addEventListener('click', () => {
	  if (_cacheRows.length === 0) return;
	  if (pageSize === Number.MAX_SAFE_INTEGER) return;

	  _pageIndex = Math.max(_pageIndex - 1, 0);
	  renderPage();
	});
	
	// 清空查詢條件
	btnClear.addEventListener('click', () => {
	  // 清空輸入框
	  qKeyword.value = '';
	  qStatus.value = '';
	  qCategory.value = '';
	  qTestPlan.value = '';
	  qBugFound.value = '';

	  // 重載查詢結果
	  _pageIndex = 0;
	  _cacheRows = [];
	  reload();
	});
	
	// 「搜尋」維持原本行為：重置並重新查詢
	btnSearch.addEventListener('click', async () => {
		_pageIndex = 0;
		_cacheRows = [];
		await reload(); // 內部會呼叫 fetchPage()，並重建快取
	});

    async function reload(forward=true){
      await fetchPage(forward);
    }

	// 關鍵字查詢綁定 Enter 按鍵
	qKeyword.addEventListener('keydown', (e) => {
	  if (e.key === 'Enter') {
		e.preventDefault();
		btnSearch.click();
	  }
	});

    // Excel export (current table)
	btnExportExcel.addEventListener('click', () => {
	  // 1) 產生表頭（去掉最後的「操作」）
	  let headers = ['ISSUE#','狀態','類型','功能','Test Plan','BUG','驗證失敗','開始測試日期','預計交付日期','完成日期','測試案例','MEMO'];

	  if (headers[headers.length - 1] === '操作') headers = headers.slice(0, -1);

	  // 2) 轉換工具（與原本一致）
	  const statusText = (v) => {
		const n = Number(v);
		if (n === 1) return '執行中';
		if (n === 0) return '執行中止';
		if (n === 2) return '完成';
		return '';
	  };
	  const categoryText = (v) => {
		const map = {1:'BUG', 2:'改善', 3:'優化', 4:'模組', 5:'QA'};
		return map[Number(v)] || '';
	  };
	  const toYN = (v) => (v === 1 || v === '1' || String(v).toUpperCase() === 'Y') ? 'Y' : 'N';
	  const fmt = (v) => {
		if (!v) return '';
		try {
		  if (typeof v.toDate === 'function') v = v.toDate();
		  const yyyy = v.getFullYear();
		  const mm = String(v.getMonth()+1).padStart(2,'0');
		  const dd = String(v.getDate()).padStart(2,'0');
		  return `${yyyy}-${mm}-${dd}`;
		} catch { return ''; }
	  };

	  // 3) 取得用來判斷季度的日期（與摘要邏輯一致）
	  const pickDate = (r) => {
		let d = r?.test_start_date || r?.completed_at || r?.created_at;
		if (!d) return null;
		return (typeof d.toDate === 'function') ? d.toDate() : d;
	  };
	  const getQuarter = (d) => {
		if (!(d instanceof Date) || isNaN(d)) return null;
		const m = d.getMonth() + 1; // 1~12
		if (m >= 1 && m <= 3)  return 'Q1';
		if (m >= 4 && m <= 6)  return 'Q2';
		if (m >= 7 && m <= 9)  return 'Q3';
		if (m >= 10 && m <= 12) return 'Q4';
		return null;
	  };

	  // 4) 把 rows 依季度分桶
	  const buckets = { Q1: [], Q2: [], Q3: [], Q4: [] };
	  for (const r of _cacheRows) {
		const d = pickDate(r);
		const q = getQuarter(d) || 'Q1'; // 沒日期就先歸 Q1，避免遺漏
		const row = [
		  r.issue_number ?? '',
		  statusText(r.status),
		  categoryText(r.category),
		  r.feature ?? '',
		  toYN(r.test_plan),
		  toYN(r.bug_found),
		  toYN(r.verify_failed),
		  fmt(r.test_start_date),
		  fmt(r.eta_date),
		  fmt(r.completed_at),
		  r.test_cases ?? '',
		  (r.memo ?? '').toString().replaceAll('\n',' '),
		  '' // 操作欄（匯出不需要）
		];
		buckets[q].push(row);
	  }

	  // 5) 產生四個季度的 sheet
	  const wb = XLSX.utils.book_new();
	  const wsQ1 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q1]);
	  const wsQ2 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q2]);
	  const wsQ3 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q3]);
	  const wsQ4 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q4]);
	  XLSX.utils.book_append_sheet(wb, wsQ1, 'Q1列表');
	  XLSX.utils.book_append_sheet(wb, wsQ2, 'Q2列表');
	  XLSX.utils.book_append_sheet(wb, wsQ3, 'Q3列表');
	  XLSX.utils.book_append_sheet(wb, wsQ4, 'Q4列表');

	  // === (原本的「摘要」sheet 邏輯保留) ===
	  // 依開始測試日期分月 + 季度彙總，限定狀態=完成
	  const monthly = new Map(); // key: 'YYYY-MM' -> {A..G}
	  for (const r of _cacheRows) {
		if (Number(r.status) !== 2) continue; // 僅統計完成

		let d = r?.test_start_date || r?.completed_at || r?.created_at;
		if (!d) continue;
		d = (typeof d.toDate === 'function') ? d.toDate() : d;
		if (!(d instanceof Date) || isNaN(d)) continue;

		const y = d.getFullYear();
		const m = d.getMonth() + 1;
		const key = `${y}-${String(m).padStart(2,'0')}`;

		if (!monthly.has(key)) monthly.set(key, { A:0, B:0, C:0, D:0, E:0, F:0, G:0 });
		const acc = monthly.get(key);

		const bug   = Number(r.bug_found ?? 0);
		const tp    = (r.test_plan === 1 || r.test_plan === '1') ? 1 : 0;
		const opt   = Number(r.optimization_points ?? 0);
		const cases = Number(r.test_cases ?? 0);
		const vf    = Number(r.verify_failed ?? 0);
		const files = Number(r.file_count ?? 0);

		if (bug === 1) acc.A += 1;                // A: 發現BUG=1 的筆數
		acc.B += Number.isFinite(opt) ? opt : 0;  // B: 可優化項目數
		if (tp === 1) acc.C += 1;                 // C: Test Plan=1 的筆數
		if (bug === 0 && tp === 0) acc.D += 1;    // D: BUG=0 且 TP=0 的筆數
		acc.E += Number.isFinite(cases) ? cases : 0; // E: 測試案例總數
		if (vf === 1) acc.F += 1;                 // F: 驗證失敗=1 的筆數
		acc.G += Number.isFinite(files) ? files : 0; // G: 檔案數總數
	  }

	  const lines = [['Monthly Summary']];
	  const sortedMonths = Array.from(monthly.entries()).sort((a,b) => a[0].localeCompare(b[0]));
	  for (const [key, v] of sortedMonths) {
		const monthNum = Number(key.slice(5));
		const text = `${monthNum}月 發現 ${v.B} 個可優化項目，開立 ${v.A} 張優化 issues｜ 產生 ${v.C} 份測試報告｜ ${v.D} 張驗證單，複驗 ${v.F} 張單｜ 建立 ${v.G} 個測試範本、${v.E} 項測試案例`;
		lines.push([text]);
	  }

	  function quarterOf(month) { return Math.floor((month - 1) / 3) + 1; }
	  const quarterly = new Map(); // key: 'YYYY-Qn' -> {A..G}
	  for (const [ym, v] of sortedMonths) {
		const y = ym.slice(0, 4);
		const m = Number(ym.slice(5));
		const qKey = `${y}-Q${quarterOf(m)}`;
		if (!quarterly.has(qKey)) quarterly.set(qKey, { A:0, B:0, C:0, D:0, E:0, F:0, G:0 });
		const acc = quarterly.get(qKey);
		acc.A += v.A; acc.B += v.B; acc.C += v.C; acc.D += v.D; acc.E += v.E; acc.F += v.F; acc.G += v.G;
	  }

	  lines.push([''], ['Quarterly Summary']);
	  const sortedQuarters = Array.from(quarterly.entries()).sort((a,b) => a[0].localeCompare(b[0]));
	  for (const [qKey, v] of sortedQuarters) {
		const [year, qLabel] = qKey.split('-');
		const textQ = `${qLabel}: 發現 ${v.B} 個可優化項目，開立 ${v.A} 張優化 issues｜ 產生 ${v.C} 份測試報告｜ ${v.D} 張驗證單，複驗 ${v.F} 張單｜ 建立 ${v.G} 個測試範本、${v.E} 項測試案例`;
		lines.push([`${year} ${textQ}`]);
	  }

	  const wsSummary = XLSX.utils.aoa_to_sheet(lines);
	  XLSX.utils.book_append_sheet(wb, wsSummary, '摘要');

	  // 6) 輸出
	  XLSX.writeFile(wb, 'records.xlsx');
	});


    // ---------- Defaults on load ----------
    function formatDateInput(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function thisFriday(from = new Date()) {
      const d = new Date(from);
      const day = d.getDay();
      const map = {0:7,1:1,2:2,3:3,4:4,5:5,6:6};
      const dow = map[day];
      const delta = 5 - dow;
      d.setDate(d.getDate() + delta);
      return d;
    }

    function toggleOptimizationPoints() {
      const enabled = fields.bug_found.value === '1';
      fields.optimization_points.disabled = !enabled;
      if (!enabled) {
        fields.optimization_points.value = '';
      }

	  // 發現 BUG = 是 時的自動欄位處理
	  if (fields.bug_found.value === '1') {
		// 清空開始測試日期、預計交付日期
		fields.test_start_date.value = '';
		fields.eta_date.value = '';

		// 完成日期帶入今日
		const today = new Date();
		const yyyy = today.getFullYear();
		const mm = String(today.getMonth() + 1).padStart(2, '0');
		const dd = String(today.getDate()).padStart(2, '0');
		fields.completed_at.value = `${yyyy}-${mm}-${dd}`;
		// 預設完成
		fields.status.value = '2';
		
	  }else{
		const today = new Date();
		fields.completed_at.value = '';
	
		if (!fields.test_start_date.value) {
			fields.test_start_date.value = formatDateInput(today);
		}
		if (!fields.eta_date.value) {
			fields.eta_date.value = formatDateInput(thisFriday(today));
		}
		// 執行中
		fields.status.value = '1';
		
	  }
    }

	// === 🟢 GitLab Issues Integration ===
	const btnGitlabIssues = document.getElementById('btnGitlabIssues');
	const gitlabModal = document.getElementById('gitlabModal');
	const btnCloseGitlabModal = document.getElementById('btnCloseGitlabModal');
	const gitlabIssuesBody = document.getElementById('gitlabIssuesBody');
	const glAssigneeInput = document.getElementById('glAssignee');
	const glProjectInput  = document.getElementById('glProject');
	const btnSearchGitlab = document.getElementById('btnSearchGitlab');
	const GITLAB_BASE = "https://gitlab.fb-tek.com/api/v4";
	
	// 開窗：帶入常用預設（可自行調整）
	btnGitlabIssues.addEventListener('click', async () => {
	  gitlabModal.classList.remove('hidden');
	  // 預設值（若空白時才填）
	  if (!glAssigneeInput.value) glAssigneeInput.value = "Welly.Chiu";
	  if (!glProjectInput.value)  glProjectInput.value  = "kh/imp";
	  gitlabIssuesBody.innerHTML = `<p class="text-slate-500 text-sm">請按「查詢」載入資料</p>`;
	  searchGitlabIssues();
	});
	// 關閉
	btnCloseGitlabModal.addEventListener('click', () => {
	  gitlabModal.classList.add('hidden');
	});
	gitlabModal.addEventListener('click', (e) => {
	  if (e.target === gitlabModal) gitlabModal.classList.add('hidden');
	});
	
	async function searchGitlabIssues() {
	  gitlabIssuesBody.innerHTML = `<p class="text-slate-500 text-sm">讀取中...</p>`;
	  try {
		const TOKEN = await loadGitlabToken();                 // 從 Firestore 讀取、快取
		const project = encodeURIComponent(glProjectInput.value.trim());
		const assignee = glAssigneeInput.value.trim();

		// 只有 project 是必填；assignee 可空（查全專案開啟中的 issue）
		const params = new URLSearchParams({ state: "opened", per_page: "50" });
		if (assignee) params.set("assignee_username", assignee);

		const url = `${GITLAB_BASE}/projects/${project}/issues?${params.toString()}`;
		const res = await fetch(url, {
		  headers: { "PRIVATE-TOKEN": TOKEN, "Accept": "application/json" }
		});
		if (!res.ok) throw new Error("GitLab API 錯誤：" + res.status);

		const issues = await res.json();
		if (!Array.isArray(issues) || issues.length === 0) {
		  gitlabIssuesBody.innerHTML = `<p class="text-slate-600 text-sm">沒有符合條件的 Issue。</p>`;
		  return;
		}

		// 渲染（用第 2 步提供的樣板）
		gitlabIssuesBody.innerHTML = `
		  <ul class="divide-y divide-slate-200">
			${issues.map(i => `
			  <li class="py-3">
				<div class="flex items-start gap-3">
				  <input type="checkbox"
						 class="gl-select mt-1"
						 data-iid="${i.iid}"
						 data-title="${i.title?.replace(/"/g, '&quot;') || ''}"
						 data-url="${i.web_url}">
				  <div class="flex-1">
					<div class="flex items-start justify-between gap-3">
					  <div>
						<a href="${i.web_url}" target="_blank" class="text-brand-700 font-semibold underline">#${i.iid} ${i.title}</a>
						<div class="text-xs text-slate-500 mt-1">
						  專案：${i.references?.full || ''}<br>
						  更新時間：${new Date(i.updated_at).toLocaleString()}
						</div>
					  </div>
					  <button class="btn-secondary text-sm px-3 py-1.5 gl-detail-btn"
							  data-iid="${i.iid}">詳細資訊</button>
					</div>
					<div class="gl-detail-panel mt-3 hidden" id="gl-detail-${i.iid}">
					  <div class="text-slate-500 text-sm">讀取留言中…</div>
					</div>
				  </div>
				</div>
			  </li>
			`).join('')}
		  </ul>`;
		updateSelectedCount();

	  } catch (err) {
		console.error(err);
		gitlabIssuesBody.innerHTML = `<p class="text-red-600 text-sm">載入失敗：${err.message}</p>`;
	  }
	}

	// 綁定查詢按鈕與 Enter
	btnSearchGitlab.addEventListener('click', searchGitlabIssues);
	glAssigneeInput.addEventListener('keydown', e => { if (e.key==='Enter') searchGitlabIssues(); });
	glProjectInput.addEventListener('keydown',  e => { if (e.key==='Enter') searchGitlabIssues(); });

	// 代理事件：點「詳細資訊」抓留言（notes）
	gitlabIssuesBody.addEventListener('click', async (e) => {
	  const btn = e.target.closest('.gl-detail-btn');
	  if (!btn) return;

	  const iid = btn.dataset.iid;
	  const panel = document.getElementById(`gl-detail-${iid}`);

	  // 折疊/展開
	  if (!panel.classList.contains('hidden')) {
		panel.classList.add('hidden');
		return;
	  }
	  panel.classList.remove('hidden');
	  panel.innerHTML = `<div class="text-slate-500 text-sm">讀取留言中…</div>`;

	  try {
		const TOKEN = await loadGitlabToken();
		const project = encodeURIComponent(glProjectInput.value.trim());
		const url = `${GITLAB_BASE}/projects/${project}/issues/${iid}/notes?per_page=100`;
		const res = await fetch(url, {
		  headers: { "PRIVATE-TOKEN": TOKEN, "Accept": "application/json" }
		});
		if (!res.ok) throw new Error(`讀取留言失敗：${res.status}`);

		const notes = await res.json();
		if (!Array.isArray(notes) || notes.length === 0) {
		  panel.innerHTML = `<div class="text-slate-600 text-sm">沒有留言。</div>`;
		  return;
		}

		// 簡單排除系統訊息（可選）
		const humanNotes = notes.filter(n => !n.system);

		panel.innerHTML = `
		  <div class="border rounded-xl p-3 bg-slate-50">
			${humanNotes.map(n => `
			  <div class="mb-3">
				<div class="text-sm font-medium text-slate-700">${n.author?.name || n.author?.username || '未知'}</div>
				<div class="text-xs text-slate-500">${new Date(n.created_at).toLocaleString()}</div>
				<div class="mt-1 whitespace-pre-wrap text-slate-800">${escapeHtml(n.body || '')}</div>
			  </div>
			`).join('')}
		  </div>
		`;
	  } catch (err) {
		console.error(err);
		panel.innerHTML = `<div class="text-red-600 text-sm">讀取留言失敗：${err.message}</div>`;
	  }
	});

	// 簡易 XSS 避免
	function escapeHtml(s){
	  return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c]));
	}


	btnCloseGitlabModal.addEventListener('click', () => {
	  gitlabModal.classList.add('hidden');
	});

	gitlabModal.addEventListener('click', (e) => {
	  if (e.target === gitlabModal) gitlabModal.classList.add('hidden');
	});

	// === 選取/計數 ===
	const selectedCountEl = document.getElementById('gitlabSelectedCount');
	const btnToggleSelectAll = document.getElementById('btnToggleSelectAll');
	const btnImportSelected = document.getElementById('btnImportSelected');

	function getAllCheckboxes() {
	  return Array.from(gitlabIssuesBody.querySelectorAll('.gl-select'));
	}
	function getSelected() {
	  return getAllCheckboxes().filter(cb => cb.checked);
	}
	function updateSelectedCount() {
	  selectedCountEl.textContent = `已選 ${getSelected().length} 筆`;
	}
	gitlabIssuesBody.addEventListener('change', (e) => {
	  if (e.target.classList.contains('gl-select')) updateSelectedCount();
	});

	let _allSelected = false;
	btnToggleSelectAll.addEventListener('click', () => {
	  _allSelected = !_allSelected;
	  getAllCheckboxes().forEach(cb => cb.checked = _allSelected);
	  btnToggleSelectAll.textContent = _allSelected ? '全不選' : '全選';
	  updateSelectedCount();
	});

	// === 匯入至 records ===
	// 規格（你提出的預設值）：
	// 狀態 = 執行中(1)
	// issue_number = GitLab 的 iid
	// test_plan = '0'（字串，符合你現有欄位慣例）
	// memo = GitLab 標題
	// test_start_date = 今天、eta_date = 本週五
	// verify_failed/test_cases/file_count/bug_found/optimization_points = 0
	// feature = '透過系統匯入請手動調整'
	// completed_at = null（空）
	// issue_link = GitLab 的 web_url
	btnImportSelected.addEventListener('click', async () => {
	  const picks = getSelected();
	  if (picks.length === 0) {
		alert('請先勾選要匯入的資料');
		return;
	  }

	  const u = auth.currentUser;
	  if (!u) {
		alert('請先登入再匯入');
		return;
	  }

	  btnImportSelected.disabled = true;
	  btnImportSelected.textContent = '匯入中...';

	  try {
		const today = new Date();
		let successCount = 0;
		let skippedCount = 0;
		let failCount = 0;

		// 逐筆檢查是否已存在（依 issue_number）
		for (const cb of picks) {
		  const iid = Number(cb.dataset.iid);
		  const title = cb.dataset.title || '';
		  const url = cb.dataset.url || '';

		  // 查是否已有相同 issue_number 的紀錄
		  const qExist = query(
			collection(db, 'records'),
			where('issue_number', '==', iid)
		  );
		  const snap = await getDocs(qExist);
		  if (!snap.empty) {
			console.log(`Issue ${iid} 已存在，略過匯入`);
			skippedCount++;
			continue; // 已存在就跳過
		  }

		  const payload = {
			status: 1,
			completed_at: null,
			issue_number: iid,
			test_plan: '0',
			category: null,
			feature: '透過系統匯入請手動調整',
			memo: title,
			test_start_date: today,
			eta_date: thisFriday(today),
			bug_found: 0,
			optimization_points: 0,
			verify_failed: 0,
			test_cases: 0,
			file_count: 0,
			issue_link: url,
			created_by_uid: u.uid,
			created_at: serverTimestamp()
		  };

		  try {
			await addDoc(collection(db, 'records'), payload);
			successCount++;
		  } catch (err) {
			console.error(`匯入 Issue ${iid} 失敗：`, err);
			failCount++;
		  }
		}

		alert(`匯入完成：
	成功 ${successCount} 筆
	略過（已存在） ${skippedCount} 筆
	失敗 ${failCount} 筆`);

		gitlabModal.classList.add('hidden');
		_allSelected = false;
		btnToggleSelectAll.textContent = '全選';
		await reload(); // 重新載入表格
	  } catch (err) {
		console.error(err);
		alert('匯入發生錯誤：' + (err.message || err));
	  } finally {
		btnImportSelected.disabled = false;
		btnImportSelected.textContent = '匯入選取';
	  }
	});




    function setDefaultsIfEmpty() {
      if (!['0','1','2'].includes(String(fields.status.value))) {
        fields.status.value = '1';
      }
      if (!['1','0'].includes(String(fields.test_plan.value))) {
        fields.test_plan.value = '0';
      }
      const today = new Date();
      //if (!fields.completed_at.value) {
       // fields.completed_at.value = formatDateInput(today);
      //}
      if (!fields.test_start_date.value) {
        fields.test_start_date.value = formatDateInput(today);
      }
      if (!fields.eta_date.value) {
        fields.eta_date.value = formatDateInput(thisFriday(today));
      }
      toggleOptimizationPoints();
    }

    // 初次載入：套預設 + 立刻查詢
    setDefaultsIfEmpty();
    fields.bug_found.addEventListener('change', toggleOptimizationPoints);
	
	
	
	
	// 針對「目前查詢結果」逐筆更新
	async function bulkUpdateCurrentCache() {
	  const u = auth.currentUser;
	  if (!u) throw new Error('未登入');
	  if (!_cacheRows || _cacheRows.length === 0) return;

	  // 500 筆一個批次
	  for (let i = 0; i < _cacheRows.length; i += 500) {
		const chunk = _cacheRows.slice(i, i + 500);
		const batch = writeBatch(db);
		chunk.forEach(row => {
		  batch.update(doc(db, 'records', row.id), {
			created_by_uid: u.uid,
			created_at: serverTimestamp(),
			updated_by_uid: u.uid,
			updated_at: serverTimestamp(),
		  });
		});
		await batch.commit();
	  }
	  await reload(); // 你原本的重查函式:contentReference[oaicite:2]{index=2}
	}
	document.getElementById('btnBulkUpdate').addEventListener('click', bulkUpdateCurrentCache);
  </script>
</body>
</html>
