<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QA Tracker</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* é è¨­å…ˆéš±è—ï¼Œé¿å…å°šæœªæª¢æŸ¥ç™»å…¥æ™‚é–ƒå‡ºç•«é¢ */
    body { display: none; }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 600: '#4f46e5', 700: '#4338ca' }
          },
          boxShadow: { soft: '0 2px 10px rgba(0,0,0,.06)' }
        }
      }
    }
  </script>

  <!-- Firebase SDKs (Modular v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Replace with your own if needed
    const firebaseConfig = {
      apiKey: "AIzaSyCuTlQfSUTlgig_NF7bKV448v35UEuB0aA",
      authDomain: "fb-issue-record.firebaseapp.com",
      projectId: "fb-issue-record",
      storageBucket: "fb-issue-record.firebasestorage.app",
      messagingSenderId: "892738349977",
      appId: "1:892738349977:web:004b30f804e2937692c108"
    };

    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
    window.auth = getAuth(app);
    window.GoogleAuthProvider = GoogleAuthProvider;
    window.signInWithPopup = signInWithPopup;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;

  // === èªè­‰æª¢æŸ¥çµæŸ ===
  </script>

  <style>
    .btn{ padding:.6rem 1rem; border-radius:1rem; background:#0f172a; color:#fff; font-weight:600; box-shadow:0 1px 3px rgba(0,0,0,.15); }
    .btn:hover{ opacity:.95 }
    .btn-secondary{ padding:.55rem 1rem; border-radius:1rem; border:1px solid #cbd5e1; background:#fff; color:#334155; }
    .btn-secondary:hover{ background:#f8fafc }
    .inp{ width:100%; padding:.55rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; outline:none; background:#fff; }
    .inp:focus{ box-shadow:0 0 0 3px rgba(79,70,229,.2); border-color:#a5b4fc; }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; border-radius:9999px; font-size:.75rem; font-weight:600; }
    .chip-green{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .chip-gray{ background:#f1f5f9; color:#334155; border:1px solid #e2e8f0; }
    .chip-red{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .chip-indigo{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }
    .chip-amber{ background:#fffbeb; color:#92400e; border:1px solid #fde68a; }
    .table-head th{
	  position:sticky; top:0; background:#f8fafc;
	  white-space: nowrap;           /* è¡¨é ­ä¸æ›è¡Œ */
	}
	#tableWrap tbody td{
	  white-space: normal;     /* å…è¨±è‡ªå‹•æ›è¡Œ */
	  word-break: break-word;  /* é•·å­—/URL ä¹Ÿèƒ½æ–·è¡Œ */
	}
    .row{ border-bottom:1px solid #e2e8f0; }
    /* åŸæœ¬ï¼š.row:nth-child(even){ background:#fcfcfd; } */
    .row.striped:nth-child(even){ background:#fcfcfd; }
    .overlay {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.8); backdrop-filter:saturate(180%) blur(2px);
    }
	/* å›ºå®šæ¬„å¯¬ï¼šç”± table-fixed + colgroup æ±ºå®š */
	#tableWrap table { table-layout: fixed; }

	/* è¡¨é ­å–®è¡Œé¡¯ç¤ºï¼ˆå®Œæ•´çœ‹åˆ°æ¨™é¡Œï¼‰ */
	.table-head th { white-space: nowrap; }

	/* å…§å®¹é‡åˆ°é•·å­—/URL æœƒè‡ªå‹•æ–·è¡Œï¼Œä¸æ’å¯¬ */
	#tableWrap tbody td{
	  white-space: normal;
	  word-break: break-word;
	}
	  /* å¯¦å¿ƒè‰²ç³» */
	.btn-primary{ background:#4f46e5; color:#fff; }   /* å“ç‰Œé›è— */
	.btn-primary:hover{ background:#4338ca; }

	.btn-success{ background:#10b981; color:#fff; }   /* ç¶ ï¼šåŒ¯å‡ºæˆåŠŸæ„Ÿ */
	.btn-success:hover{ background:#059669; }

	.btn-info{ background:#0ea5e9; color:#fff; }      /* è—ï¼šå‹•ä½œ/æœå°‹ */
	.btn-info:hover{ background:#0284c7; }

	.btn-warning{ background:#f59e0b; color:#fff; }   /* æ©˜ï¼šæé†’/æ‰¹æ¬¡æ›´æ–° */
	.btn-warning:hover{ background:#d97706; }

	.btn-danger{ background:#ef4444; color:#fff; }    /* ç´…ï¼šå±éšª/æ¸…ç©º */
	.btn-danger:hover{ background:#dc2626; }

	/* æé‚Šï¼ˆæ·¡è‰²ï¼‰ */
	.btn-outline{ border:1px solid #cbd5e1; background:#fff; color:#334155; }
	.btn-outline-red{ border:1px solid #fecaca; color:#991b1b; background:#fff; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-gradient-to-r from-brand-600 to-brand-700 text-white shadow">
    <div class="max-w-7xl mx-auto px-5 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-white/15 grid place-items-center font-bold">QA</div>
        <h1 class="text-xl md:text-2xl font-semibold">QA Tracker</h1>
      </div>
		<div id="authArea" class="flex items-center gap-3">
		  <!-- <button id="btnSignIn" class="btn bg-white text-brand-700">ä½¿ç”¨ Google ç™»å…¥</button> -->
		  <div id="userDisplayName" class="hidden items-center gap-3">
			<span id="userEmail" class="text-sm opacity-90"></span>
			<button id="btnSignOut" class="btn-secondary">ç™»å‡º</button>
		  </div>
		</div>

    </div>
  </header>

  <main class="max-w-7xl mx-auto px-5 py-6 space-y-6">
  
	<!-- Modalï¼šå»ºç«‹ / ç·¨è¼¯è³‡æ–™ -->
	<div id="recordModal" class="fixed inset-0 z-[100] hidden" aria-hidden="true">
	  <!-- èƒŒæ™¯ -->
	  <div class="absolute inset-0 bg-black/40"></div>

	  <!-- é¢æ¿ -->
	  <div class="relative w-full h-full grid place-items-center p-4">
		<div data-modal-panel
			 class="w-full max-w-4xl bg-white rounded-2xl shadow-soft border border-slate-100">
		  <!-- Header -->
		  <div class="flex items-center justify-between px-5 py-4 border-b">
			<div>
			  <h2 id="modalTitle" class="text-lg md:text-xl font-semibold">å»ºç«‹ / ç·¨è¼¯è³‡æ–™</h2>
			  <div class="text-xs text-slate-500">* å…¨éƒ¨æ¬„ä½çš†ç‚ºéå¿…å¡«</div>
			</div>
			<button id="btnModalClose" class="btn-secondary">é—œé–‰</button>
		  </div>

		  <!-- Bodyï¼ˆæ²¿ç”¨ä½ çš„ form èˆ‡æ¬„ä½ï¼‰ -->
		  <div class="p-5 md:p-6">
			<form id="recordForm" class="grid md:grid-cols-4 gap-4">
			  <!-- === ä»¥ä¸‹ä¿ç•™ä½ çš„åŸæ¬„ä½å€å¡Šå³å¯ === -->
			  <!-- Row 1 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">ç‹€æ…‹</label>
				<select id="status" class="inp">
				  <option value="1" selected>åŸ·è¡Œä¸­</option>
				  <option value="0">åŸ·è¡Œä¸­æ­¢</option>
				  <option value="2">å®Œæˆ</option>
				</select>
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">å®Œæˆæ—¥æœŸ</label>
				<input id="completed_at" type="date" class="inp" />
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">Issue Number</label>
				<input id="issue_number" type="number" class="inp" placeholder="ä¾‹å¦‚ 1234" />
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">Test Plan</label>
				<select id="test_plan" class="inp">
				  <option value="0" selected>å¦</option>
				  <option value="1">æ˜¯</option>
				</select>
			  </div>

			  <!-- Row 2 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">é¡å‹</label>
				<select id="category" class="inp">
				  <option value="1" selected>BUG</option>
				  <option value="2">æ”¹å–„</option>
				  <option value="3">å„ªåŒ–</option>
				  <option value="4">æ¨¡çµ„</option>
				  <option value="5">QA</option>
				</select>
			  </div>
			  <div class="md:col-span-3">
				<label class="block text-sm text-slate-600 mb-1">åŠŸèƒ½</label>
				<input id="feature" type="text" class="inp" placeholder="æ–‡å­—æè¿°" />
			  </div>

			  <!-- Row 3 -->
			  <div class="md:col-span-4">
				<label class="block text-sm text-slate-600 mb-1">Memo</label>
				<textarea id="memo" class="inp" rows="2" placeholder="å‚™è¨»ï¼ˆéå¿…å¡«ï¼‰"></textarea>
			  </div>

			  <!-- Row 4 -->
			  <div class="md:col-span-2">
				<label class="block text-sm text-slate-600 mb-1">é–‹å§‹æ¸¬è©¦æ—¥æœŸ</label>
				<input id="test_start_date" type="date" class="inp" />
			  </div>
			  <div class="md:col-span-2">
				<label class="block text-sm text-slate-600 mb-1">é è¨ˆäº¤ä»˜æ—¥æœŸ</label>
				<input id="eta_date" type="date" class="inp" />
			  </div>

			  <!-- Row 5 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">é©—è­‰å¤±æ•—</label>
				<select id="verify_failed" class="inp">
				  <option value="0" selected>å¦</option>
				  <option value="1">æ˜¯</option>
				</select>
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">æ¸¬è©¦æ¡ˆä¾‹</label>
				<input id="test_cases" type="number" class="inp" value="0" />
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">æª”æ¡ˆæ•¸é‡</label>
				<input id="file_count" type="number" class="inp" value="0" />
			  </div>
			  <div class="md:col-span-1"></div>

			  <!-- Row 6 -->
			  <div>
				<label class="block text-sm text-slate-600 mb-1">ç™¼ç¾ BUG</label>
				<select id="bug_found" class="inp">
				  <option value="0" selected>å¦</option>
				  <option value="1">æ˜¯</option>
				</select>
			  </div>
			  <div>
				<label class="block text-sm text-slate-600 mb-1">å¯å„ªåŒ–é …ç›®</label>
				<input id="optimization_points" type="number" class="inp" placeholder="æ•¸å­—ï¼›åƒ…åœ¨ ç™¼ç¾BUG=1 æ™‚å¯å¡«" min="0" step="1" disabled />
			  </div>
			  <div class="md:col-span-2"></div>

			  <!-- Row 7 -->
			  <div class="md:col-span-4 flex flex-wrap gap-3 items-end">
				<button id="btnSave" class="btn" type="submit">å„²å­˜</button>
				<button id="btnReset" class="btn-secondary" type="button">é‡è¨­</button>
				<span id="saveMsg" class="ml-2 text-sm text-green-600"></span>
				<a id="issue_link_preview" class="text-brand-700 font-semibold underline hidden"
				   href="#" target="_blank" rel="noopener">æ‰“é–‹ Issue</a>
			  </div>
			</form>
		  </div>
		</div>
	  </div>
	</div>

  
  
    <!-- List Card -->
    <section id="listSection" class="relative bg-white rounded-2xl shadow-soft p-5 md:p-6 border border-slate-100">
      <!-- Title row -->
      <div class="mb-3">
        <h2 class="text-lg md:text-xl font-semibold">è³‡æ–™åˆ—è¡¨</h2>
      </div>

	<!-- Filters block -->
	<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">

	  <!-- é—œéµå­— -->
	  <div class="flex flex-col">
		<label for="q_keyword" class="text-sm text-slate-600 font-medium mb-1">é—œéµå­—</label>
		<input id="q_keyword" type="text" class="inp" placeholder="æœå°‹ åŠŸèƒ½/Memo/Issue#"/>
	  </div>

	  <!-- ç‹€æ…‹ -->
	  <div class="flex flex-col">
		<label for="q_status" class="text-sm text-slate-600 font-medium mb-1">ç‹€æ…‹</label>
		<select id="q_status" class="inp">
		  <option value="" selected>å…¨éƒ¨</option>
		  <option value="1">åŸ·è¡Œä¸­</option>
		  <option value="0">åŸ·è¡Œä¸­æ­¢</option>
		  <option value="2">å®Œæˆ</option>
		</select>
	  </div>

	  <!-- é¡å‹ -->
	  <div class="flex flex-col">
		<label for="q_category" class="text-sm text-slate-600 font-medium mb-1">é¡å‹</label>
		<select id="q_category" class="inp">
		  <option value="" selected>å…¨éƒ¨</option>
		  <option value="1">BUG</option>
		  <option value="2">æ”¹å–„</option>
		  <option value="3">å„ªåŒ–</option>
		  <option value="4">æ¨¡çµ„</option>
		  <option value="5">QA</option>
		</select>
	  </div>

	  <!-- Test Plan -->
	  <div class="flex flex-col">
		<label for="q_test_plan" class="text-sm text-slate-600 font-medium mb-1">Test Plan</label>
		<select id="q_test_plan" class="inp">
		  <option value="" selected>å…¨éƒ¨</option>
		  <option value="1">æ˜¯</option>
		  <option value="0">å¦</option>
		</select>
	  </div>

	  <!-- ç™¼ç¾BUG -->
	  <div class="flex flex-col">
		<label for="q_bug_found" class="text-sm text-slate-600 font-medium mb-1">ç™¼ç¾BUG</label>
		<select id="q_bug_found" class="inp">
		  <option value="" selected>å…¨éƒ¨</option>
		  <option value="1">æ˜¯</option>
		  <option value="0">å¦</option>
		</select>
	  </div>

	</div>


      <!-- Buttons row (right aligned) -->
	<div class="flex justify-end gap-2 mb-3">
	  <button id="btnCreate" class="btn btn-primary">æ–°å¢ Issue</button>
	  <button id="btnSearch" class="btn btn-info">æœå°‹</button>
	  <button id="btnClear" class="btn btn-secondary">æ¸…ç©º</button>
	  <button id="btnExportExcel" class="btn btn-success">åŒ¯å‡º Excel</button>
	  <button id="btnGitlabIssues" class="btn btn-warning">æŸ¥çœ‹ GitLab Issues</button>
	  <button id="btnBulkUpdate" class="btn btn-warning" hidden>æ›´æ–°ç¾æœ‰è³‡æ–™</button>
	</div>


      <!-- Overlay (center big) -->
      <div id="loadingOverlay" class="overlay hidden">
        <div class="flex flex-col items-center gap-3 bg-white/80 rounded-2xl px-6 py-6 shadow-soft border border-slate-200">
          <svg class="animate-spin h-8 w-8 text-brand-700" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <div class="text-slate-700 font-medium">æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
        </div>
      </div>

      <div id="tableWrap" class="overflow-x-auto border rounded-2xl">
		<div id="tableWrap" class="overflow-x-auto border rounded-2xl">
			<table class="table-fixed min-w-[1600px] text-sm">
			    <!-- âœ… æŠŠ colgroup æ”¾åœ¨é€™è£¡ï¼ˆthead å‰é¢ï¼‰ -->
				<colgroup>
				  <col style="width:60px" />  <!-- åºè™Ÿ -->
				  <col style="width:50px" />  <!-- Issue# -->
				  <col style="width:70px" />  <!-- ç‹€æ…‹ -->
				  <col style="width:60px" />  <!-- é¡å‹ -->
				  <col style="width:120px" />  <!-- åŠŸèƒ½ -->
				  <col style="width:120px" />  <!-- é–‹å§‹æ¸¬è©¦æ—¥æœŸ -->
				  <col style="width:120px" />  <!-- é è¨ˆäº¤ä»˜æ—¥æœŸ -->
				  <col style="width:120px" />  <!-- å®Œæˆæ—¥æœŸ -->
				  <col style="width:50px" />  <!-- æ¸¬è©¦æ¡ˆä¾‹ -->
				  <col style="width:400px" />  <!-- Memo -->
				  <col style="width:140px" />  <!-- æ“ä½œ -->
				</colgroup>

				<thead class="table-head text-slate-600 text-xs uppercase tracking-wide">
					<tr>
					  <th class="px-3 py-2 text-left">#</th>
					  <th class="px-3 py-2 text-left">Issue#</th>
					  <th class="px-3 py-2 text-left">ç‹€æ…‹</th>
					  <th class="px-3 py-2 text-left">é¡å‹</th>
					  <th class="px-3 py-2 text-left">åŠŸèƒ½</th>
					  <th class="px-3 py-2 text-left">é–‹å§‹æ¸¬è©¦æ—¥æœŸ</th>
					  <th class="px-3 py-2 text-left">é è¨ˆäº¤ä»˜æ—¥æœŸ</th>
					  <th class="px-3 py-2 text-left">å®Œæˆæ—¥æœŸ</th>
					  <th class="px-3 py-2 text-left">æ¸¬è©¦æ¡ˆä¾‹</th>
					  <th class="px-3 py-2 text-left">Memo</th>
					  <th class="px-3 py-2 text-left">æ“ä½œ</th>
					</tr>
			  </thead>
          <tbody id="recordsTbody"></tbody>
        </table>
      </div>

		<div id="pager" class="flex flex-wrap items-center justify-end mt-3 gap-2">
		  <label for="pageSize" class="text-sm text-slate-600">æ¯é </label>
		  <select id="pageSize" class="inp w-24">
			<option value="10" selected>10</option>
			<option value="20">20</option>
			<option value="50">50</option>
			<option value="100">100</option>
			<option value="all">å…¨éƒ¨</option>
		  </select>

		  <button id="btnPrev" class="btn-secondary">ä¸Šä¸€é </button>
		  <span id="pageInfo" class="text-sm text-slate-600 self-center"></span>
		  
		  <!-- æ–°å¢ï¼šæ‰‹å‹•è¼¸å…¥é ç¢¼èˆ‡è·³è½‰ -->
		  <div class="flex items-center gap-2">
			<span class="text-sm text-slate-600">åˆ°ç¬¬</span>
			<input id="pageInput" type="number" min="1" step="1" class="inp w-20" placeholder="é ç¢¼"/>
			<span class="text-sm text-slate-600">é </span>
		  </div>
		  
		  
		  <button id="btnNext" class="btn-secondary">ä¸‹ä¸€é </button>
		</div>

    </section>
	
	<!-- ğŸŸ¢ GitLab Issues Modal -->
	<div id="gitlabModal" class="fixed inset-0 z-[120] hidden">
	  <!-- èƒŒæ™¯ -->
	  <div class="absolute inset-0 bg-black/40"></div>

	  <!-- é¢æ¿ -->
	  <div class="relative w-full h-full grid place-items-center p-4">
		<div class="bg-white rounded-2xl shadow-soft border border-slate-100 w-full max-w-3xl">
			<!-- GitLab Issues Modalï¼ˆæ¨™é¡Œåˆ—ï¼šåŠ å…¥æŸ¥è©¢æ¬„ä½ï¼‰ -->
			<div class="px-5 py-4 border-b space-y-3">
			  <div class="flex items-center justify-between">
				<h2 class="text-lg md:text-xl font-semibold">GitLab Issues æŸ¥è©¢</h2>
				<div class="flex items-center gap-2">
				  <span id="gitlabSelectedCount" class="text-sm text-slate-600">å·²é¸ 0 ç­†</span>
				  <button id="btnToggleSelectAll" class="btn-outline">å…¨é¸</button>
				  <button id="btnImportSelected" class="btn btn-primary">åŒ¯å…¥é¸å–</button>
				  <button id="btnCloseGitlabModal" class="btn-secondary">é—œé–‰</button>
				</div>
			  </div>
			  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
				<div>
				  <label class="block text-xs text-slate-600 mb-1">Assigneeï¼ˆä½¿ç”¨è€…åç¨±ï¼‰</label>
				  <input id="glAssignee" class="inp" placeholder="ä¾‹å¦‚ï¼šWelly.Chiu" />
				</div>
				<div class="md:col-span-2">
				  <label class="block text-xs text-slate-600 mb-1">Projectï¼ˆè·¯å¾‘ï¼‰</label>
				  <input id="glProject" class="inp" placeholder="ä¾‹å¦‚ï¼škh/impï¼›ä¹Ÿå¯å¡« gitlab.com çš„ other/group/project" />
				</div>
				<div class="md:col-span-3 flex justify-end">
				  <button id="btnSearchGitlab" class="btn btn-info">æŸ¥è©¢</button>
				</div>
			  </div>
			</div>


			<div id="gitlabIssuesBody" class="p-5 max-h-[70vh] overflow-y-auto">
			<p class="text-slate-500 text-sm">å°šæœªè¼‰å…¥</p>
			</div>
		</div>
	  </div>
	</div>

  </main>

  <!-- App logic -->
  <script type="module">
    import {
      collection, addDoc, serverTimestamp, query, orderBy, limit, startAfter, getDocs,
      updateDoc, doc, deleteDoc, getDoc, where, writeBatch, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Auth UI
    const btnSignOut = document.getElementById('btnSignOut');
    const userDisplayName = document.getElementById('userDisplayName');
    const userEmail = document.getElementById('userEmail');
	
	// Git Token
	let GITLAB_TOKEN = null;
	
	onAuthStateChanged(auth, (user) => {
		if (user) {
			document.body.style.display = 'block'; // é¡¯ç¤º body å…§å®¹
			userDisplayName.classList.remove('hidden');
			userEmail.textContent = user.displayName || user.email;
			// â˜… ç™»å…¥å¾Œï¼šè¨˜éŒ„/æ›´æ–°ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™ï¼ˆæœ€å°å¹…åº¦ï¼‰
			setDoc(doc(db, 'users', user.uid), {
			  uid: user.uid,
			  email: user.email ?? null,
			  displayName: user.displayName ?? null,
			  photoURL: user.photoURL ?? null,
			  providerId: user.providerData?.[0]?.providerId ?? null,
			  lastLoginAt: serverTimestamp()
			}, { merge: true }).catch(console.error);
			reload();
			loadGitlabToken().catch(console.error); // é æŠ“ tokenï¼ˆå¿«å–åœ¨è¨˜æ†¶é«”ï¼‰
		} else {
			// å·²ç¶“ç™»å‡º â†’ ç›´æ¥å°å‘ login.html
			location.href = "login.html";
		}
	});

    btnSignOut.addEventListener('click', async ()=>{
      await signOut(auth);
    });
	
	async function loadGitlabToken() {
	  if (GITLAB_TOKEN) return GITLAB_TOKEN; // å·²è¼‰å…¥å°±ç”¨å¿«å–
	  // è®€ Firestoreï¼šconfig/gitlab æ–‡ä»¶
	  const ref = doc(db, 'config', 'gitlab');
	  const snap = await getDoc(ref);
	  if (!snap.exists()) throw new Error('Firestore æœªæ‰¾åˆ° config/gitlab');
	  const token = snap.data()?.token;
	  if (!token) throw new Error('config/gitlab ç„¡ token æ¬„ä½');
	  GITLAB_TOKEN = token;
	  return token;
	}


	// === Modal æ§åˆ¶ ===
	const recordModal   = document.getElementById('recordModal');
	const modalPanel    = recordModal.querySelector('[data-modal-panel]');
	const btnModalClose = document.getElementById('btnModalClose');
	const btnCreate     = document.getElementById('btnCreate');
	const modalTitle    = document.getElementById('modalTitle');
	
	function openModal(mode = 'create') {
	  modalTitle.textContent = (mode === 'edit') ? 'ç·¨è¼¯è³‡æ–™' : 'æ–°å¢ Issue';
	  recordModal.classList.remove('hidden');
	  document.body.classList.add('overflow-hidden');
	  // èšç„¦ç¬¬ä¸€å€‹æ¬„ä½
	  setTimeout(() => document.getElementById('issue_number')?.focus(), 0);
	}
	function closeModal() {
	  recordModal.classList.add('hidden');
	  document.body.classList.remove('overflow-hidden');
	}

	btnModalClose.addEventListener('click', closeModal);
	recordModal.addEventListener('click', (e) => {
	  if (!modalPanel.contains(e.target)) closeModal();
	});
	document.addEventListener('keydown', (e) => {
	  if (e.key === 'Escape' && !recordModal.classList.contains('hidden')) closeModal();
	});

	// æ–°å¢ Issueï¼šæ¸…è¡¨å–® â†’ æ‰“é–‹ Modal
	btnCreate.addEventListener('click', () => {
	  editingId = null;
	  form.reset();
	  setDefaultsIfEmpty();
	  updateIssuePreview();
	  openModal('create');
	});
	
	
	
    // Form refs
    const form = document.getElementById('recordForm');
    const saveMsg = document.getElementById('saveMsg');
    const previewLink = document.getElementById('issue_link_preview');

    const fields = {
      status: document.getElementById('status'),
      completed_at: document.getElementById('completed_at'),
      issue_number: document.getElementById('issue_number'),
      test_plan: document.getElementById('test_plan'),
      category: document.getElementById('category'),
      feature: document.getElementById('feature'),
      memo: document.getElementById('memo'),
      test_start_date: document.getElementById('test_start_date'),
      eta_date: document.getElementById('eta_date'),
      bug_found: document.getElementById('bug_found'),
      optimization_points: document.getElementById('optimization_points'),
      verify_failed: document.getElementById('verify_failed'),
      test_cases: document.getElementById('test_cases'),
      file_count: document.getElementById('file_count')
    };

    // Conditional enable for optimization_points
    fields.bug_found.addEventListener('change', ()=>{
      const enabled = fields.bug_found.value === '1';
      fields.optimization_points.disabled = !enabled;
      if(!enabled) fields.optimization_points.value = '';
    });

    // Dynamic issue link preview
    const ISSUE_BASE = "https://gitlab.fb-tek.com/kh/imp/-/issues/";
    function updateIssuePreview(){
      const n = fields.issue_number.value?.trim();
      if(n){
        previewLink.href = ISSUE_BASE + n;
        previewLink.classList.remove('hidden');
      }else{
        previewLink.classList.add('hidden');
      }
    }
    fields.issue_number.addEventListener('input', updateIssuePreview);
	
	// ç‹€æ…‹=å®Œæˆ(2) æ™‚ï¼Œè‡ªå‹•å¸¶å…¥ä»Šå¤©çš„æ—¥æœŸï¼ˆè‹¥å°šæœªå¡«ï¼‰
	fields.status.addEventListener('change', () => {
	  if (String(fields.status.value) === '2' && !fields.completed_at.value) {
		fields.completed_at.value = formatDateInput(new Date());
	  }else{
		fields.completed_at.value = '';
	  }
	});

    // Save / Update logic
    let editingId = null;

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      // é©—è­‰ issue_number æ˜¯å¦æœ‰å¡«
	  if (!fields.issue_number.value || fields.issue_number.value.trim() === '') {
		showMsg('éŒ¯èª¤: è«‹å¡«å¯« Issue Number', true);
		fields.issue_number.focus();
		return; // ä¸­æ–·ï¼Œä¸é€²è¡Œå„²å­˜
	  }
      const payload = buildPayload();
      const u = auth.currentUser;
      try{
        showLoading(true);
        if(editingId){
          await updateDoc(doc(db, 'records', editingId), { ...payload, updated_by_uid: u?.uid ?? null, updated_at: serverTimestamp() });
          showMsg('å·²æ›´æ–°');
        }else{
          await addDoc(collection(db, 'records'), { ...payload, created_by_uid: u?.uid ?? null, created_at: serverTimestamp() });
          showMsg('å·²å„²å­˜');
        }
        form.reset();
        setDefaultsIfEmpty();
        updateIssuePreview();
        editingId = null;
        closeModal(); // æˆåŠŸå°±é—œé–‰ Modal
        await reload();
      }catch(err){
        console.error(err);
        showMsg('éŒ¯èª¤: ' + err.message, true);
      } finally{
        showLoading(false);
      }
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      editingId = null;
      form.reset();
      setDefaultsIfEmpty();
      updateIssuePreview();
      fields.optimization_points.disabled = fields.bug_found.value !== '1';
    });

    function buildPayload(){
      const toNum = (v)=> {
        if (v === '' || v === null || v === undefined) return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      };
      const toStr = (v)=> v?.trim() || null;
      const toDate = (v)=> v ? new Date(v) : null;

      if (!['0','1','2'].includes(String(fields.status.value))) {
        fields.status.value = '1';
      }
      if (!['1','0'].includes(String(fields.test_plan.value))) {
        fields.test_plan.value = '0';
      }

      const issue_number = toNum(fields.issue_number.value);
      const issue_link = issue_number ? (ISSUE_BASE + issue_number) : null;

      const bugFoundIsYes = String(fields.bug_found.value) === '1';
      const optimization_points = bugFoundIsYes ? toNum(fields.optimization_points.value) : 0;

      return {
        status: toNum(fields.status.value),
        completed_at: toDate(fields.completed_at.value),
        issue_number,
        test_plan: toStr(fields.test_plan.value),
        category: toNum(fields.category.value),
        feature: toStr(fields.feature.value),
        issue_link,
        memo: toStr(fields.memo.value),
        test_start_date: toDate(fields.test_start_date.value),
        eta_date: toDate(fields.eta_date.value),
        bug_found: toNum(fields.bug_found.value) ?? 0,
        optimization_points,
        verify_failed: toNum(fields.verify_failed.value) ?? 0,
        test_cases: toNum(fields.test_cases.value),
        file_count: toNum(fields.file_count.value)
      };
    }

    function showMsg(text, isErr=false){
      saveMsg.textContent = text;
      saveMsg.classList.toggle('text-red-600', !!isErr);
      saveMsg.classList.toggle('text-green-600', !isErr);
      setTimeout(()=>{ saveMsg.textContent=''; }, 5000);
    }

    // Table + pagination
    const listSection = document.getElementById('listSection');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const tableWrap = document.getElementById('tableWrap');
    const pager = document.getElementById('pager');
    const tbody = document.getElementById('recordsTbody');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const pageInfo = document.getElementById('pageInfo');
    const pageSizeSel = document.getElementById('pageSize'); 
	const pageInput = document.getElementById('pageInput');

    const qKeyword = document.getElementById('q_keyword');
    const qStatus = document.getElementById('q_status');
    const qCategory = document.getElementById('q_category');
	const qTestPlan = document.getElementById('q_test_plan');
	const qBugFound  = document.getElementById('q_bug_found');
    const btnSearch = document.getElementById('btnSearch');
	const btnClear = document.getElementById('btnClear');
	const btnExportExcel = document.getElementById('btnExportExcel');

    let pageSize = Number(pageSizeSel.value);  // ä¸€é–‹å§‹å°±è½‰æˆ number
    let lastVisible = null;
    let firstVisible = null;
    let prevStack = [];
	let _cacheRows = [];   // å…¨éƒ¨æŸ¥å›å¾Œã€å·²æ’åºçš„å…¨é›†è³‡æ–™
	let _pageIndex = 0;    // ç›®å‰é ç¢¼ï¼ˆ0-basedï¼‰

    function showLoading(show){
      if(show){
        loadingOverlay.classList.remove('hidden');
        tableWrap.classList.add('invisible');
        pager.classList.add('invisible');
      }else{
        loadingOverlay.classList.add('hidden');
        tableWrap.classList.remove('invisible');
        pager.classList.remove('invisible');
      }
    }
	
	// å°å·¥å…·ï¼šå®‰å…¨å–å¾— created_at çš„æ¯«ç§’å€¼
	function _toMillis(v){
	  if (!v) return 0;
	  if (typeof v.toMillis === 'function') return v.toMillis();
	  if (typeof v.toDate === 'function') return v.toDate().getTime();
	  if (v instanceof Date) return v.getTime();
	  if (typeof v === 'number') return v;
	  return 0;
	}


	async function fetchPage(forward = true) {
	  showLoading(true);
	  try {
		// 1) è’é›†æŸ¥è©¢æ¢ä»¶ï¼ˆä¸ä½¿ç”¨ orderByã€ä¸ç”¨æ¸¸æ¨™ï¼‰
		const constraints = [ limit(10000) ]; // è¦–è³‡æ–™é‡èª¿æ•´
		if (qStatus.value !== '')   constraints.push(where('status', '==', Number(qStatus.value)));
		if (qCategory.value !== '') constraints.push(where('category', '==', Number(qCategory.value)));
		if (qTestPlan.value !== '') constraints.push(where('test_plan', '==', qTestPlan.value)); // test_plan ç‚º '0'/'1'ï¼ˆå­—ä¸²ï¼‰
		if (qBugFound.value !== '') constraints.push(where('bug_found', '==', Number(qBugFound.value))); // bug_found ç‚ºæ•¸å­— 0/1
		
		// åªèƒ½æŸ¥åˆ°è‡ªå·±å»ºç«‹çš„è³‡æ–™
		const u = auth.currentUser;
		if (u?.uid) constraints.push(where('created_by_uid', '==', u.uid)); // â˜… æ–°å¢é€™è¡Œ
		
		const kw = (qKeyword?.value ?? '').trim();
		const kwIsNumber = kw !== '' && !Number.isNaN(Number(kw));
		const kwIsText   = kw !== '' && !kwIsNumber;

		if (kwIsNumber) {
		  constraints.push(where('issue_number', '==', Number(kw)));
		} 

		// 2) ä¸€æ¬¡æ’ˆå›
		const qBase = query(collection(db, 'records'), ...constraints);
		const snap  = await getDocs(qBase);
		let rows    = snap.docs.map(d => ({ id: d.id, ...d.data() }));

		// 3) ï¼ˆå¯é¸ï¼‰æ–‡å­—é—œéµå­—å†åšä¸€æ¬¡å‰ç«¯åŒ…å«éæ¿¾ï¼Œç¸®å°çµæœ
		if (kwIsText) {
		  const low = kw.toLowerCase();
		  rows = rows.filter(r => {
			const featureMatch = (r.feature || '').toLowerCase().includes(low);
			const memoMatch    = (r.memo || '').toLowerCase().includes(low);
			const issueMatch   = (r.issue_number ?? '').toString().toLowerCase().includes(low);
			return featureMatch || memoMatch || issueMatch;
		  });
		}


		// 4) å‰ç«¯æ’åºï¼šissue_number â†“ã€status â†“ã€created_at â†“
		rows.sort((a, b) => {
		  const n1 = Number(a.issue_number ?? 0);
		  const n2 = Number(b.issue_number ?? 0);
		  if (n1 !== n2) return n2 - n1; // issue_number å¤§çš„åœ¨å‰

		  const s1 = Number(a.status ?? 0);
		  const s2 = Number(b.status ?? 0);
		  if (s1 !== s2) return s2 - s1; // status å¤§çš„åœ¨å‰

		  return _toMillis(b.created_at) - _toMillis(a.created_at); // æ–°çš„åœ¨å‰
		});

		// 5) å¿«å– + é¡¯ç¤ºç¬¬ä¸€é 
		_cacheRows = rows;
		_pageIndex = 0;
		renderPage();
	  } catch (err) {
		console.error('Query error:', err);
		showMsg('æŸ¥è©¢éŒ¯èª¤ï¼š' + (err?.message || err), true);
		renderRows([]);
		pageInfo.textContent = 'å…± 0 ç­†';
	  } finally {
		showLoading(false);
	  }
	}

    const statusChip = (v)=>{
      if(v === 1) return '<span class="chip chip-green">åŸ·è¡Œä¸­</span>';
      if(v === 0) return '<span class="chip chip-gray">åŸ·è¡Œä¸­æ­¢</span>';
      if(v === 2) return '<span class="chip chip-amber">å®Œæˆ</span>';
      return '';
    };
    const categoryChip = (v)=>{
      const map = {
        1: ['BUG','chip-red'],
        2: ['æ”¹å–„','chip-indigo'],
        3: ['å„ªåŒ–','chip-indigo'],
        4: ['æ¨¡çµ„','chip-gray'],
        5: ['QA','chip-gray']
      };
      const item = map[v];
      return item ? `<span class="chip ${item[1]}">${item[0]}</span>` : '';
    };
	
	function renderPage() {
	  const size = (pageSize === Number.MAX_SAFE_INTEGER) ? Number.MAX_SAFE_INTEGER : Number(pageSize);
	  const total = _cacheRows.length;
	  const totalPages = (size === Number.MAX_SAFE_INTEGER)
		? 1
		: Math.max(1, Math.ceil(total / size));

	  const start = (size === Number.MAX_SAFE_INTEGER) ? 0 : _pageIndex * size;
	  const end   = (size === Number.MAX_SAFE_INTEGER) ? total : start + size;

	  // â˜… é‡è¦ï¼šæŠŠ start å‚³ä¸‹å»ï¼Œåºè™Ÿæ‰æœƒæ¥çºŒ
	  renderRows(_cacheRows.slice(start, end), start);
  
	  pageInfo.textContent = `å…± ${total} ç­†ï¼ˆç¬¬ ${Math.min(_pageIndex + 1, totalPages)} / ${totalPages} é ï¼‰`;
	}
	
	const toYN = (v) => (v === 1 || v === '1' || String(v).toUpperCase() === 'Y') ? 'Y' : 'N';
	
	function renderRows(rows, startIndex = 0){
	  tbody.innerHTML = '';
	  rows.forEach((r, i) => {
		const tr = document.createElement('tr');
		const seq = startIndex + i + 1; // â˜… é€£çºŒåºè™Ÿï¼ˆè·¨é ï¼‰

		const isTP  = String(r.test_plan) === '1';
		const isBug = String(r.bug_found) === '1';
		const isVF  = String(r.verify_failed) === '1';

		let rowColor = '';
		if (qTestPlan.value === '1' && isTP) {
		  rowColor = 'bg-purple-100';
		} else if (isVF) {
		  rowColor = 'bg-red-100';
		} else if (isBug) {
		  rowColor = 'bg-yellow-100';
		} else if (isTP) {
		  rowColor = 'bg-purple-100';
		}
		tr.className = `row ${rowColor}`;

		const issueDisplay = r.issue_link
		  ? `<a class="text-brand-700 underline font-medium" href="${r.issue_link}" target="_blank" rel="noopener">${r.issue_number ?? ''}</a>`
		  : (r.issue_number ?? '');

		tr.innerHTML = `
		  <td class="px-3 py-2 text-slate-500">${seq}</td>
		  <td class="px-3 py-2">${issueDisplay}</td>
		  <td class="px-3 py-2">${statusChip(r.status)}</td>
		  <td class="px-3 py-2">${categoryChip(r.category)}</td>
		  <td class="px-3 py-2">${r.feature ?? ''}</td>
		  <td class="px-3 py-2">${fmtDate(r.test_start_date)}</td>
		  <td class="px-3 py-2">${fmtDate(r.eta_date)}</td>
		  <td class="px-3 py-2">${fmtDate(r.completed_at)}</td>
		  <td class="px-3 py-2">${r.test_cases ?? ''}</td>
		  <td class="px-3 py-2 whitespace-pre-wrap break-words">${r.memo ?? ''}</td>
		  <td class="px-3 py-2">
			<div class="flex gap-2">
			  <button class="btn text-xs" data-edit="${r.id}">ç·¨è¼¯</button>
			  <button class="btn btn-danger text-xs" data-del="${r.id}">åˆªé™¤</button>
			</div>
		  </td>
		`;
		tbody.appendChild(tr);
	  });

	  tbody.querySelectorAll('button[data-edit]').forEach(btn=>{
		btn.addEventListener('click', async ()=>{
		  const id = btn.getAttribute('data-edit');
		  const ref = doc(db, 'records', id);
		  const snap = await getDoc(ref);
		  if(snap.exists()){
			loadToForm(id, snap.data());
			openModal('edit'); 
		  }
		});
	  });

	  tbody.querySelectorAll('button[data-del]').forEach(btn=>{
		btn.addEventListener('click', async ()=>{
		  const id = btn.getAttribute('data-del');
		  if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†è³‡æ–™ï¼Ÿ')){
			await deleteDoc(doc(db, 'records', id));
			await reload();
		  }
		});
	  });
	}

    function fmtDate(v){
      if(!v) return '';
      try{
        if(v.toDate) v = v.toDate();
        const yyyy = v.getFullYear();
        const mm = String(v.getMonth()+1).padStart(2,'0');
        const dd = String(v.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }catch(_){
        return '';
      }
    }

    function loadToForm(id, data){
      editingId = id;
      fields.status.value = data.status ?? '1';
      fields.completed_at.value = data.completed_at ? fmtDate(data.completed_at) : '';
      fields.issue_number.value = data.issue_number ?? '';
      fields.test_plan.value = data.test_plan ?? '0';
      fields.category.value = data.category ?? '';
      fields.feature.value = data.feature ?? '';
      fields.memo.value = data.memo ?? '';
      fields.test_start_date.value = data.test_start_date ? fmtDate(data.test_start_date) : '';
      fields.eta_date.value = data.eta_date ? fmtDate(data.eta_date) : '';
      fields.bug_found.value = data.bug_found ?? 0;
      fields.verify_failed.value = data.verify_failed ?? 0;
      fields.test_cases.value = data.test_cases ?? '';
      fields.file_count.value = data.file_count ?? '';
      fields.optimization_points.disabled = String(fields.bug_found.value) !== '1';
      fields.optimization_points.value = (data.optimization_points === 0 || data.optimization_points == null) ? '' : data.optimization_points;
      updateIssuePreview();
    }

    // Pagination & search
	
	pageSizeSel.addEventListener('change', () => {
	  const v = pageSizeSel.value;
	  pageSize = (v === 'all') ? Number.MAX_SAFE_INTEGER : Number(v);
	  _pageIndex = 0;     // è®Šæ›´æ¯é ç­†æ•¸å¾Œå›åˆ°ç¬¬1é 
	  renderPage();
	});
	
	pageInput.addEventListener('keydown', (e) => {
	  if (e.key === 'Enter'){
		if (_cacheRows.length === 0) return;
		  if (pageSize === Number.MAX_SAFE_INTEGER) return; // å…¨éƒ¨æ¨¡å¼ä¸éœ€è·³é 
		  const totalPages = Math.max(1, Math.ceil(_cacheRows.length / pageSize));
		  const v = Number(pageInput.value);
		  if (!Number.isInteger(v) || v < 1) return;
		  _pageIndex = Math.min(v - 1, totalPages - 1);
		  renderPage();
	  }
	});
	
	btnNext.addEventListener('click', () => {
	  if (_cacheRows.length === 0) return;
	  if (pageSize === Number.MAX_SAFE_INTEGER) return; // é¡¯ç¤ºå…¨éƒ¨æ™‚ä¸éœ€è¦ç¿»é 

	  const totalPages = Math.max(1, Math.ceil(_cacheRows.length / pageSize));
	  _pageIndex = Math.min(_pageIndex + 1, totalPages - 1);
	  renderPage();
	});

	btnPrev.addEventListener('click', () => {
	  if (_cacheRows.length === 0) return;
	  if (pageSize === Number.MAX_SAFE_INTEGER) return;

	  _pageIndex = Math.max(_pageIndex - 1, 0);
	  renderPage();
	});
	
	// æ¸…ç©ºæŸ¥è©¢æ¢ä»¶
	btnClear.addEventListener('click', () => {
	  // æ¸…ç©ºè¼¸å…¥æ¡†
	  qKeyword.value = '';
	  qStatus.value = '';
	  qCategory.value = '';
	  qTestPlan.value = '';
	  qBugFound.value = '';

	  // é‡è¼‰æŸ¥è©¢çµæœ
	  _pageIndex = 0;
	  _cacheRows = [];
	  reload();
	});
	
	// ã€Œæœå°‹ã€ç¶­æŒåŸæœ¬è¡Œç‚ºï¼šé‡ç½®ä¸¦é‡æ–°æŸ¥è©¢
	btnSearch.addEventListener('click', async () => {
		_pageIndex = 0;
		_cacheRows = [];
		await reload(); // å…§éƒ¨æœƒå‘¼å« fetchPage()ï¼Œä¸¦é‡å»ºå¿«å–
	});

    async function reload(forward=true){
      await fetchPage(forward);
    }

	// é—œéµå­—æŸ¥è©¢ç¶å®š Enter æŒ‰éµ
	qKeyword.addEventListener('keydown', (e) => {
	  if (e.key === 'Enter') {
		e.preventDefault();
		btnSearch.click();
	  }
	});

    // Excel export (current table)
	btnExportExcel.addEventListener('click', () => {
	  // 1) ç”¢ç”Ÿè¡¨é ­ï¼ˆå»æ‰æœ€å¾Œçš„ã€Œæ“ä½œã€ï¼‰
	  let headers = ['ISSUE#','ç‹€æ…‹','é¡å‹','åŠŸèƒ½','Test Plan','BUG','é©—è­‰å¤±æ•—','é–‹å§‹æ¸¬è©¦æ—¥æœŸ','é è¨ˆäº¤ä»˜æ—¥æœŸ','å®Œæˆæ—¥æœŸ','æ¸¬è©¦æ¡ˆä¾‹','MEMO'];

	  if (headers[headers.length - 1] === 'æ“ä½œ') headers = headers.slice(0, -1);

	  // 2) è½‰æ›å·¥å…·ï¼ˆèˆ‡åŸæœ¬ä¸€è‡´ï¼‰
	  const statusText = (v) => {
		const n = Number(v);
		if (n === 1) return 'åŸ·è¡Œä¸­';
		if (n === 0) return 'åŸ·è¡Œä¸­æ­¢';
		if (n === 2) return 'å®Œæˆ';
		return '';
	  };
	  const categoryText = (v) => {
		const map = {1:'BUG', 2:'æ”¹å–„', 3:'å„ªåŒ–', 4:'æ¨¡çµ„', 5:'QA'};
		return map[Number(v)] || '';
	  };
	  const toYN = (v) => (v === 1 || v === '1' || String(v).toUpperCase() === 'Y') ? 'Y' : 'N';
	  const fmt = (v) => {
		if (!v) return '';
		try {
		  if (typeof v.toDate === 'function') v = v.toDate();
		  const yyyy = v.getFullYear();
		  const mm = String(v.getMonth()+1).padStart(2,'0');
		  const dd = String(v.getDate()).padStart(2,'0');
		  return `${yyyy}-${mm}-${dd}`;
		} catch { return ''; }
	  };

	  // 3) å–å¾—ç”¨ä¾†åˆ¤æ–·å­£åº¦çš„æ—¥æœŸï¼ˆèˆ‡æ‘˜è¦é‚è¼¯ä¸€è‡´ï¼‰
	  const pickDate = (r) => {
		let d = r?.test_start_date || r?.completed_at || r?.created_at;
		if (!d) return null;
		return (typeof d.toDate === 'function') ? d.toDate() : d;
	  };
	  const getQuarter = (d) => {
		if (!(d instanceof Date) || isNaN(d)) return null;
		const m = d.getMonth() + 1; // 1~12
		if (m >= 1 && m <= 3)  return 'Q1';
		if (m >= 4 && m <= 6)  return 'Q2';
		if (m >= 7 && m <= 9)  return 'Q3';
		if (m >= 10 && m <= 12) return 'Q4';
		return null;
	  };

	  // 4) æŠŠ rows ä¾å­£åº¦åˆ†æ¡¶
	  const buckets = { Q1: [], Q2: [], Q3: [], Q4: [] };
	  for (const r of _cacheRows) {
		const d = pickDate(r);
		const q = getQuarter(d) || 'Q1'; // æ²’æ—¥æœŸå°±å…ˆæ­¸ Q1ï¼Œé¿å…éºæ¼
		const row = [
		  r.issue_number ?? '',
		  statusText(r.status),
		  categoryText(r.category),
		  r.feature ?? '',
		  toYN(r.test_plan),
		  toYN(r.bug_found),
		  toYN(r.verify_failed),
		  fmt(r.test_start_date),
		  fmt(r.eta_date),
		  fmt(r.completed_at),
		  r.test_cases ?? '',
		  (r.memo ?? '').toString().replaceAll('\n',' '),
		  '' // æ“ä½œæ¬„ï¼ˆåŒ¯å‡ºä¸éœ€è¦ï¼‰
		];
		buckets[q].push(row);
	  }

	  // 5) ç”¢ç”Ÿå››å€‹å­£åº¦çš„ sheet
	  const wb = XLSX.utils.book_new();
	  const wsQ1 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q1]);
	  const wsQ2 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q2]);
	  const wsQ3 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q3]);
	  const wsQ4 = XLSX.utils.aoa_to_sheet([headers, ...buckets.Q4]);
	  XLSX.utils.book_append_sheet(wb, wsQ1, 'Q1åˆ—è¡¨');
	  XLSX.utils.book_append_sheet(wb, wsQ2, 'Q2åˆ—è¡¨');
	  XLSX.utils.book_append_sheet(wb, wsQ3, 'Q3åˆ—è¡¨');
	  XLSX.utils.book_append_sheet(wb, wsQ4, 'Q4åˆ—è¡¨');

	  // === (åŸæœ¬çš„ã€Œæ‘˜è¦ã€sheet é‚è¼¯ä¿ç•™) ===
	  // ä¾é–‹å§‹æ¸¬è©¦æ—¥æœŸåˆ†æœˆ + å­£åº¦å½™ç¸½ï¼Œé™å®šç‹€æ…‹=å®Œæˆ
	  const monthly = new Map(); // key: 'YYYY-MM' -> {A..G}
	  for (const r of _cacheRows) {
		if (Number(r.status) !== 2) continue; // åƒ…çµ±è¨ˆå®Œæˆ

		let d = r?.test_start_date || r?.completed_at || r?.created_at;
		if (!d) continue;
		d = (typeof d.toDate === 'function') ? d.toDate() : d;
		if (!(d instanceof Date) || isNaN(d)) continue;

		const y = d.getFullYear();
		const m = d.getMonth() + 1;
		const key = `${y}-${String(m).padStart(2,'0')}`;

		if (!monthly.has(key)) monthly.set(key, { A:0, B:0, C:0, D:0, E:0, F:0, G:0 });
		const acc = monthly.get(key);

		const bug   = Number(r.bug_found ?? 0);
		const tp    = (r.test_plan === 1 || r.test_plan === '1') ? 1 : 0;
		const opt   = Number(r.optimization_points ?? 0);
		const cases = Number(r.test_cases ?? 0);
		const vf    = Number(r.verify_failed ?? 0);
		const files = Number(r.file_count ?? 0);

		if (bug === 1) acc.A += 1;                // A: ç™¼ç¾BUG=1 çš„ç­†æ•¸
		acc.B += Number.isFinite(opt) ? opt : 0;  // B: å¯å„ªåŒ–é …ç›®æ•¸
		if (tp === 1) acc.C += 1;                 // C: Test Plan=1 çš„ç­†æ•¸
		if (bug === 0 && tp === 0) acc.D += 1;    // D: BUG=0 ä¸” TP=0 çš„ç­†æ•¸
		acc.E += Number.isFinite(cases) ? cases : 0; // E: æ¸¬è©¦æ¡ˆä¾‹ç¸½æ•¸
		if (vf === 1) acc.F += 1;                 // F: é©—è­‰å¤±æ•—=1 çš„ç­†æ•¸
		acc.G += Number.isFinite(files) ? files : 0; // G: æª”æ¡ˆæ•¸ç¸½æ•¸
	  }

	  const lines = [['Monthly Summary']];
	  const sortedMonths = Array.from(monthly.entries()).sort((a,b) => a[0].localeCompare(b[0]));
	  for (const [key, v] of sortedMonths) {
		const monthNum = Number(key.slice(5));
		const text = `${monthNum}æœˆ ç™¼ç¾ ${v.B} å€‹å¯å„ªåŒ–é …ç›®ï¼Œé–‹ç«‹ ${v.A} å¼µå„ªåŒ– issuesï½œ ç”¢ç”Ÿ ${v.C} ä»½æ¸¬è©¦å ±å‘Šï½œ ${v.D} å¼µé©—è­‰å–®ï¼Œè¤‡é©— ${v.F} å¼µå–®ï½œ å»ºç«‹ ${v.G} å€‹æ¸¬è©¦ç¯„æœ¬ã€${v.E} é …æ¸¬è©¦æ¡ˆä¾‹`;
		lines.push([text]);
	  }

	  function quarterOf(month) { return Math.floor((month - 1) / 3) + 1; }
	  const quarterly = new Map(); // key: 'YYYY-Qn' -> {A..G}
	  for (const [ym, v] of sortedMonths) {
		const y = ym.slice(0, 4);
		const m = Number(ym.slice(5));
		const qKey = `${y}-Q${quarterOf(m)}`;
		if (!quarterly.has(qKey)) quarterly.set(qKey, { A:0, B:0, C:0, D:0, E:0, F:0, G:0 });
		const acc = quarterly.get(qKey);
		acc.A += v.A; acc.B += v.B; acc.C += v.C; acc.D += v.D; acc.E += v.E; acc.F += v.F; acc.G += v.G;
	  }

	  lines.push([''], ['Quarterly Summary']);
	  const sortedQuarters = Array.from(quarterly.entries()).sort((a,b) => a[0].localeCompare(b[0]));
	  for (const [qKey, v] of sortedQuarters) {
		const [year, qLabel] = qKey.split('-');
		const textQ = `${qLabel}: ç™¼ç¾ ${v.B} å€‹å¯å„ªåŒ–é …ç›®ï¼Œé–‹ç«‹ ${v.A} å¼µå„ªåŒ– issuesï½œ ç”¢ç”Ÿ ${v.C} ä»½æ¸¬è©¦å ±å‘Šï½œ ${v.D} å¼µé©—è­‰å–®ï¼Œè¤‡é©— ${v.F} å¼µå–®ï½œ å»ºç«‹ ${v.G} å€‹æ¸¬è©¦ç¯„æœ¬ã€${v.E} é …æ¸¬è©¦æ¡ˆä¾‹`;
		lines.push([`${year} ${textQ}`]);
	  }

	  const wsSummary = XLSX.utils.aoa_to_sheet(lines);
	  XLSX.utils.book_append_sheet(wb, wsSummary, 'æ‘˜è¦');

	  // 6) è¼¸å‡º
	  XLSX.writeFile(wb, 'records.xlsx');
	});


    // ---------- Defaults on load ----------
    function formatDateInput(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function thisFriday(from = new Date()) {
      const d = new Date(from);
      const day = d.getDay();
      const map = {0:7,1:1,2:2,3:3,4:4,5:5,6:6};
      const dow = map[day];
      const delta = 5 - dow;
      d.setDate(d.getDate() + delta);
      return d;
    }

    function toggleOptimizationPoints() {
      const enabled = fields.bug_found.value === '1';
      fields.optimization_points.disabled = !enabled;
      if (!enabled) {
        fields.optimization_points.value = '';
      }

	  // ç™¼ç¾ BUG = æ˜¯ æ™‚çš„è‡ªå‹•æ¬„ä½è™•ç†
	  if (fields.bug_found.value === '1') {
		// æ¸…ç©ºé–‹å§‹æ¸¬è©¦æ—¥æœŸã€é è¨ˆäº¤ä»˜æ—¥æœŸ
		fields.test_start_date.value = '';
		fields.eta_date.value = '';

		// å®Œæˆæ—¥æœŸå¸¶å…¥ä»Šæ—¥
		const today = new Date();
		const yyyy = today.getFullYear();
		const mm = String(today.getMonth() + 1).padStart(2, '0');
		const dd = String(today.getDate()).padStart(2, '0');
		fields.completed_at.value = `${yyyy}-${mm}-${dd}`;
		// é è¨­å®Œæˆ
		fields.status.value = '2';
		
	  }else{
		const today = new Date();
		fields.completed_at.value = '';
	
		if (!fields.test_start_date.value) {
			fields.test_start_date.value = formatDateInput(today);
		}
		if (!fields.eta_date.value) {
			fields.eta_date.value = formatDateInput(thisFriday(today));
		}
		// åŸ·è¡Œä¸­
		fields.status.value = '1';
		
	  }
    }

	// === ğŸŸ¢ GitLab Issues Integration ===
	const btnGitlabIssues = document.getElementById('btnGitlabIssues');
	const gitlabModal = document.getElementById('gitlabModal');
	const btnCloseGitlabModal = document.getElementById('btnCloseGitlabModal');
	const gitlabIssuesBody = document.getElementById('gitlabIssuesBody');
	const glAssigneeInput = document.getElementById('glAssignee');
	const glProjectInput  = document.getElementById('glProject');
	const btnSearchGitlab = document.getElementById('btnSearchGitlab');
	const GITLAB_BASE = "https://gitlab.fb-tek.com/api/v4";
	
	// é–‹çª—ï¼šå¸¶å…¥å¸¸ç”¨é è¨­ï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰
	btnGitlabIssues.addEventListener('click', async () => {
	  gitlabModal.classList.remove('hidden');
	  // é è¨­å€¼ï¼ˆè‹¥ç©ºç™½æ™‚æ‰å¡«ï¼‰
	  if (!glAssigneeInput.value) glAssigneeInput.value = "Welly.Chiu";
	  if (!glProjectInput.value)  glProjectInput.value  = "kh/imp";
	  gitlabIssuesBody.innerHTML = `<p class="text-slate-500 text-sm">è«‹æŒ‰ã€ŒæŸ¥è©¢ã€è¼‰å…¥è³‡æ–™</p>`;
	  searchGitlabIssues();
	});
	// é—œé–‰
	btnCloseGitlabModal.addEventListener('click', () => {
	  gitlabModal.classList.add('hidden');
	});
	gitlabModal.addEventListener('click', (e) => {
	  if (e.target === gitlabModal) gitlabModal.classList.add('hidden');
	});
	
	async function searchGitlabIssues() {
	  gitlabIssuesBody.innerHTML = `<p class="text-slate-500 text-sm">è®€å–ä¸­...</p>`;
	  try {
		const TOKEN = await loadGitlabToken();                 // å¾ Firestore è®€å–ã€å¿«å–
		const project = encodeURIComponent(glProjectInput.value.trim());
		const assignee = glAssigneeInput.value.trim();

		// åªæœ‰ project æ˜¯å¿…å¡«ï¼›assignee å¯ç©ºï¼ˆæŸ¥å…¨å°ˆæ¡ˆé–‹å•Ÿä¸­çš„ issueï¼‰
		const params = new URLSearchParams({ state: "opened", per_page: "50" });
		if (assignee) params.set("assignee_username", assignee);

		const url = `${GITLAB_BASE}/projects/${project}/issues?${params.toString()}`;
		const res = await fetch(url, {
		  headers: { "PRIVATE-TOKEN": TOKEN, "Accept": "application/json" }
		});
		if (!res.ok) throw new Error("GitLab API éŒ¯èª¤ï¼š" + res.status);

		const issues = await res.json();
		if (!Array.isArray(issues) || issues.length === 0) {
		  gitlabIssuesBody.innerHTML = `<p class="text-slate-600 text-sm">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ Issueã€‚</p>`;
		  return;
		}

		// æ¸²æŸ“ï¼ˆç”¨ç¬¬ 2 æ­¥æä¾›çš„æ¨£æ¿ï¼‰
		gitlabIssuesBody.innerHTML = `
		  <ul class="divide-y divide-slate-200">
			${issues.map(i => `
			  <li class="py-3">
				<div class="flex items-start gap-3">
				  <input type="checkbox"
						 class="gl-select mt-1"
						 data-iid="${i.iid}"
						 data-title="${i.title?.replace(/"/g, '&quot;') || ''}"
						 data-url="${i.web_url}">
				  <div class="flex-1">
					<div class="flex items-start justify-between gap-3">
					  <div>
						<a href="${i.web_url}" target="_blank" class="text-brand-700 font-semibold underline">#${i.iid} ${i.title}</a>
						<div class="text-xs text-slate-500 mt-1">
						  å°ˆæ¡ˆï¼š${i.references?.full || ''}<br>
						  æ›´æ–°æ™‚é–“ï¼š${new Date(i.updated_at).toLocaleString()}
						</div>
					  </div>
					  <button class="btn-secondary text-sm px-3 py-1.5 gl-detail-btn"
							  data-iid="${i.iid}">è©³ç´°è³‡è¨Š</button>
					</div>
					<div class="gl-detail-panel mt-3 hidden" id="gl-detail-${i.iid}">
					  <div class="text-slate-500 text-sm">è®€å–ç•™è¨€ä¸­â€¦</div>
					</div>
				  </div>
				</div>
			  </li>
			`).join('')}
		  </ul>`;
		updateSelectedCount();

	  } catch (err) {
		console.error(err);
		gitlabIssuesBody.innerHTML = `<p class="text-red-600 text-sm">è¼‰å…¥å¤±æ•—ï¼š${err.message}</p>`;
	  }
	}

	// ç¶å®šæŸ¥è©¢æŒ‰éˆ•èˆ‡ Enter
	btnSearchGitlab.addEventListener('click', searchGitlabIssues);
	glAssigneeInput.addEventListener('keydown', e => { if (e.key==='Enter') searchGitlabIssues(); });
	glProjectInput.addEventListener('keydown',  e => { if (e.key==='Enter') searchGitlabIssues(); });

	// ä»£ç†äº‹ä»¶ï¼šé»ã€Œè©³ç´°è³‡è¨Šã€æŠ“ç•™è¨€ï¼ˆnotesï¼‰
	gitlabIssuesBody.addEventListener('click', async (e) => {
	  const btn = e.target.closest('.gl-detail-btn');
	  if (!btn) return;

	  const iid = btn.dataset.iid;
	  const panel = document.getElementById(`gl-detail-${iid}`);

	  // æŠ˜ç–Š/å±•é–‹
	  if (!panel.classList.contains('hidden')) {
		panel.classList.add('hidden');
		return;
	  }
	  panel.classList.remove('hidden');
	  panel.innerHTML = `<div class="text-slate-500 text-sm">è®€å–ç•™è¨€ä¸­â€¦</div>`;

	  try {
		const TOKEN = await loadGitlabToken();
		const project = encodeURIComponent(glProjectInput.value.trim());
		const url = `${GITLAB_BASE}/projects/${project}/issues/${iid}/notes?per_page=100`;
		const res = await fetch(url, {
		  headers: { "PRIVATE-TOKEN": TOKEN, "Accept": "application/json" }
		});
		if (!res.ok) throw new Error(`è®€å–ç•™è¨€å¤±æ•—ï¼š${res.status}`);

		const notes = await res.json();
		if (!Array.isArray(notes) || notes.length === 0) {
		  panel.innerHTML = `<div class="text-slate-600 text-sm">æ²’æœ‰ç•™è¨€ã€‚</div>`;
		  return;
		}

		// ç°¡å–®æ’é™¤ç³»çµ±è¨Šæ¯ï¼ˆå¯é¸ï¼‰
		const humanNotes = notes.filter(n => !n.system);

		panel.innerHTML = `
		  <div class="border rounded-xl p-3 bg-slate-50">
			${humanNotes.map(n => `
			  <div class="mb-3">
				<div class="text-sm font-medium text-slate-700">${n.author?.name || n.author?.username || 'æœªçŸ¥'}</div>
				<div class="text-xs text-slate-500">${new Date(n.created_at).toLocaleString()}</div>
				<div class="mt-1 whitespace-pre-wrap text-slate-800">${escapeHtml(n.body || '')}</div>
			  </div>
			`).join('')}
		  </div>
		`;
	  } catch (err) {
		console.error(err);
		panel.innerHTML = `<div class="text-red-600 text-sm">è®€å–ç•™è¨€å¤±æ•—ï¼š${err.message}</div>`;
	  }
	});

	// ç°¡æ˜“ XSS é¿å…
	function escapeHtml(s){
	  return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c]));
	}


	btnCloseGitlabModal.addEventListener('click', () => {
	  gitlabModal.classList.add('hidden');
	});

	gitlabModal.addEventListener('click', (e) => {
	  if (e.target === gitlabModal) gitlabModal.classList.add('hidden');
	});

	// === é¸å–/è¨ˆæ•¸ ===
	const selectedCountEl = document.getElementById('gitlabSelectedCount');
	const btnToggleSelectAll = document.getElementById('btnToggleSelectAll');
	const btnImportSelected = document.getElementById('btnImportSelected');

	function getAllCheckboxes() {
	  return Array.from(gitlabIssuesBody.querySelectorAll('.gl-select'));
	}
	function getSelected() {
	  return getAllCheckboxes().filter(cb => cb.checked);
	}
	function updateSelectedCount() {
	  selectedCountEl.textContent = `å·²é¸ ${getSelected().length} ç­†`;
	}
	gitlabIssuesBody.addEventListener('change', (e) => {
	  if (e.target.classList.contains('gl-select')) updateSelectedCount();
	});

	let _allSelected = false;
	btnToggleSelectAll.addEventListener('click', () => {
	  _allSelected = !_allSelected;
	  getAllCheckboxes().forEach(cb => cb.checked = _allSelected);
	  btnToggleSelectAll.textContent = _allSelected ? 'å…¨ä¸é¸' : 'å…¨é¸';
	  updateSelectedCount();
	});

	// === åŒ¯å…¥è‡³ records ===
	// è¦æ ¼ï¼ˆä½ æå‡ºçš„é è¨­å€¼ï¼‰ï¼š
	// ç‹€æ…‹ = åŸ·è¡Œä¸­(1)
	// issue_number = GitLab çš„ iid
	// test_plan = '0'ï¼ˆå­—ä¸²ï¼Œç¬¦åˆä½ ç¾æœ‰æ¬„ä½æ…£ä¾‹ï¼‰
	// memo = GitLab æ¨™é¡Œ
	// test_start_date = ä»Šå¤©ã€eta_date = æœ¬é€±äº”
	// verify_failed/test_cases/file_count/bug_found/optimization_points = 0
	// feature = 'é€éç³»çµ±åŒ¯å…¥è«‹æ‰‹å‹•èª¿æ•´'
	// completed_at = nullï¼ˆç©ºï¼‰
	// issue_link = GitLab çš„ web_url
	btnImportSelected.addEventListener('click', async () => {
	  const picks = getSelected();
	  if (picks.length === 0) {
		alert('è«‹å…ˆå‹¾é¸è¦åŒ¯å…¥çš„è³‡æ–™');
		return;
	  }

	  const u = auth.currentUser;
	  if (!u) {
		alert('è«‹å…ˆç™»å…¥å†åŒ¯å…¥');
		return;
	  }

	  btnImportSelected.disabled = true;
	  btnImportSelected.textContent = 'åŒ¯å…¥ä¸­...';

	  try {
		const today = new Date();
		let successCount = 0;
		let skippedCount = 0;
		let failCount = 0;

		// é€ç­†æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¾ issue_numberï¼‰
		for (const cb of picks) {
		  const iid = Number(cb.dataset.iid);
		  const title = cb.dataset.title || '';
		  const url = cb.dataset.url || '';

		  // æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒ issue_number çš„ç´€éŒ„
		  const qExist = query(
			collection(db, 'records'),
			where('issue_number', '==', iid)
		  );
		  const snap = await getDocs(qExist);
		  if (!snap.empty) {
			console.log(`Issue ${iid} å·²å­˜åœ¨ï¼Œç•¥éåŒ¯å…¥`);
			skippedCount++;
			continue; // å·²å­˜åœ¨å°±è·³é
		  }

		  const payload = {
			status: 1,
			completed_at: null,
			issue_number: iid,
			test_plan: '0',
			category: null,
			feature: 'é€éç³»çµ±åŒ¯å…¥è«‹æ‰‹å‹•èª¿æ•´',
			memo: title,
			test_start_date: today,
			eta_date: thisFriday(today),
			bug_found: 0,
			optimization_points: 0,
			verify_failed: 0,
			test_cases: 0,
			file_count: 0,
			issue_link: url,
			created_by_uid: u.uid,
			created_at: serverTimestamp()
		  };

		  try {
			await addDoc(collection(db, 'records'), payload);
			successCount++;
		  } catch (err) {
			console.error(`åŒ¯å…¥ Issue ${iid} å¤±æ•—ï¼š`, err);
			failCount++;
		  }
		}

		alert(`åŒ¯å…¥å®Œæˆï¼š
	æˆåŠŸ ${successCount} ç­†
	ç•¥éï¼ˆå·²å­˜åœ¨ï¼‰ ${skippedCount} ç­†
	å¤±æ•— ${failCount} ç­†`);

		gitlabModal.classList.add('hidden');
		_allSelected = false;
		btnToggleSelectAll.textContent = 'å…¨é¸';
		await reload(); // é‡æ–°è¼‰å…¥è¡¨æ ¼
	  } catch (err) {
		console.error(err);
		alert('åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š' + (err.message || err));
	  } finally {
		btnImportSelected.disabled = false;
		btnImportSelected.textContent = 'åŒ¯å…¥é¸å–';
	  }
	});




    function setDefaultsIfEmpty() {
      if (!['0','1','2'].includes(String(fields.status.value))) {
        fields.status.value = '1';
      }
      if (!['1','0'].includes(String(fields.test_plan.value))) {
        fields.test_plan.value = '0';
      }
      const today = new Date();
      //if (!fields.completed_at.value) {
       // fields.completed_at.value = formatDateInput(today);
      //}
      if (!fields.test_start_date.value) {
        fields.test_start_date.value = formatDateInput(today);
      }
      if (!fields.eta_date.value) {
        fields.eta_date.value = formatDateInput(thisFriday(today));
      }
      toggleOptimizationPoints();
    }

    // åˆæ¬¡è¼‰å…¥ï¼šå¥—é è¨­ + ç«‹åˆ»æŸ¥è©¢
    setDefaultsIfEmpty();
    fields.bug_found.addEventListener('change', toggleOptimizationPoints);
	
	
	
	
	// é‡å°ã€Œç›®å‰æŸ¥è©¢çµæœã€é€ç­†æ›´æ–°
	async function bulkUpdateCurrentCache() {
	  const u = auth.currentUser;
	  if (!u) throw new Error('æœªç™»å…¥');
	  if (!_cacheRows || _cacheRows.length === 0) return;

	  // 500 ç­†ä¸€å€‹æ‰¹æ¬¡
	  for (let i = 0; i < _cacheRows.length; i += 500) {
		const chunk = _cacheRows.slice(i, i + 500);
		const batch = writeBatch(db);
		chunk.forEach(row => {
		  batch.update(doc(db, 'records', row.id), {
			created_by_uid: u.uid,
			created_at: serverTimestamp(),
			updated_by_uid: u.uid,
			updated_at: serverTimestamp(),
		  });
		});
		await batch.commit();
	  }
	  await reload(); // ä½ åŸæœ¬çš„é‡æŸ¥å‡½å¼:contentReference[oaicite:2]{index=2}
	}
	document.getElementById('btnBulkUpdate').addEventListener('click', bulkUpdateCurrentCache);
  </script>
</body>
</html>
