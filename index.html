<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QA Tracker</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* 預設先隱藏，避免尚未檢查登入時閃出畫面 */
    body { display: none; }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 600: '#4f46e5', 700: '#4338ca' }
          },
          boxShadow: { soft: '0 2px 10px rgba(0,0,0,.06)' }
        }
      }
    }
  </script>

  <!-- Firebase SDKs (Modular v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Replace with your own if needed
    const firebaseConfig = {
      apiKey: "AIzaSyCuTlQfSUTlgig_NF7bKV448v35UEuB0aA",
      authDomain: "fb-issue-record.firebaseapp.com",
      projectId: "fb-issue-record",
      storageBucket: "fb-issue-record.firebasestorage.app",
      messagingSenderId: "892738349977",
      appId: "1:892738349977:web:004b30f804e2937692c108"
    };

    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
    window.auth = getAuth(app);
    window.GoogleAuthProvider = GoogleAuthProvider;
    window.signInWithPopup = signInWithPopup;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;

  // === 認證檢查結束 ===
  </script>

  <style>
    .btn{ padding:.6rem 1rem; border-radius:1rem; background:#0f172a; color:#fff; font-weight:600; box-shadow:0 1px 3px rgba(0,0,0,.15); }
    .btn:hover{ opacity:.95 }
    .btn-secondary{ padding:.55rem 1rem; border-radius:1rem; border:1px solid #cbd5e1; background:#fff; color:#334155; }
    .btn-secondary:hover{ background:#f8fafc }
    .inp{ width:100%; padding:.55rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; outline:none; background:#fff; }
    .inp:focus{ box-shadow:0 0 0 3px rgba(79,70,229,.2); border-color:#a5b4fc; }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; border-radius:9999px; font-size:.75rem; font-weight:600; }
    .chip-green{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .chip-gray{ background:#f1f5f9; color:#334155; border:1px solid #e2e8f0; }
    .chip-red{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .chip-indigo{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }
    .chip-amber{ background:#fffbeb; color:#92400e; border:1px solid #fde68a; }
    .table-head th{ position:sticky; top:0; background:#f8fafc; }
    .row{ border-bottom:1px solid #e2e8f0; }
    .row:nth-child(even){ background:#fcfcfd; }
    .overlay {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.8); backdrop-filter:saturate(180%) blur(2px);
    }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-gradient-to-r from-brand-600 to-brand-700 text-white shadow">
    <div class="max-w-7xl mx-auto px-5 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-white/15 grid place-items-center font-bold">QA</div>
        <h1 class="text-xl md:text-2xl font-semibold">QA Tracker</h1>
      </div>
		<div id="authArea" class="flex items-center gap-3">
		  <!-- <button id="btnSignIn" class="btn bg-white text-brand-700">使用 Google 登入</button> -->
		  <div id="userInfo" class="hidden items-center gap-3">
			<span id="userEmail" class="text-sm opacity-90"></span>
			<button id="btnSignOut" class="btn-secondary">登出</button>
		  </div>
		</div>

    </div>
  </header>

  <main class="max-w-7xl mx-auto px-5 py-6 space-y-6">
    <!-- Create/Edit Card -->
    <section class="bg-white rounded-2xl shadow-soft p-5 md:p-6 border border-slate-100">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg md:text-xl font-semibold">建立 / 編輯資料</h2>
        <div class="text-xs text-slate-500">* 全部欄位皆為非必填</div>
      </div>

      <form id="recordForm" class="grid md:grid-cols-4 gap-4">
        <!-- Row 1 -->
        <div>
          <label class="block text-sm text-slate-600 mb-1">狀態</label>
          <select id="status" class="inp">
            <option value="1" selected>執行中</option>
            <option value="0">執行中止</option>
            <option value="2">完成</option>
          </select>
        </div>

        <div>
          <label class="block text-sm text-slate-600 mb-1">完成日期</label>
          <input id="completed_at" type="date" class="inp" />
        </div>

        <div>
          <label class="block text-sm text-slate-600 mb-1">Issue Number</label>
          <input id="issue_number" type="number" class="inp" placeholder="例如 1234" />
        </div>

        <div>
          <label class="block text-sm text-slate-600 mb-1">Test Plan</label>
          <select id="test_plan" class="inp">
            <option value="0" selected>否</option>
            <option value="1">是</option>
          </select>
        </div>

        <!-- Row 2 -->
        <div>
          <label class="block text-sm text-slate-600 mb-1">類型</label>
          <select id="category" class="inp">
            <option value="1" selected>BUG</option>
            <option value="2">改善</option>
            <option value="3">優化</option>
            <option value="4">模組</option>
            <option value="5">QA</option>
          </select>
        </div>

        <div class="md:col-span-3">
          <label class="block text-sm text-slate-600 mb-1">功能</label>
          <input id="feature" type="text" class="inp" placeholder="文字描述" />
        </div>

        <!-- Row 3 -->
        <div class="md:col-span-4">
          <label class="block text-sm text-slate-600 mb-1">Memo</label>
          <textarea id="memo" class="inp" rows="2" placeholder="備註（非必填）"></textarea>
        </div>

        <!-- Row 4 -->
        <div class="md:col-span-2">
          <label class="block text-sm text-slate-600 mb-1">開始測試日期</label>
          <input id="test_start_date" type="date" class="inp" />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm text-slate-600 mb-1">預計交付日期</label>
          <input id="eta_date" type="date" class="inp" />
        </div>
		

        <!-- Row 5 -->
        <div>
          <label class="block text-sm text-slate-600 mb-1">驗證失敗</label>
          <select id="verify_failed" class="inp">
            <option value="0" selected>否</option>
            <option value="1">是</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">測試案例</label>
          <input id="test_cases" type="number" class="inp" value="0" />
        </div>

        <div>
          <label class="block text-sm text-slate-600 mb-1">檔案數量</label>
          <input id="file_count" type="number" class="inp" value="0" />
        </div>

        <div class="md:col-span-1">
		</div>
        <!-- Row 6 -->

        <div>
          <label class="block text-sm text-slate-600 mb-1">發現 BUG</label>
          <select id="bug_found" class="inp">
            <option value="0" selected>否</option>
            <option value="1">是</option>
          </select>
        </div>

        <div>
          <label class="block text-sm text-slate-600 mb-1">可優化項目</label>
          <input id="optimization_points" type="number" class="inp" placeholder="數字；僅在 發現BUG=1 時可填" min="0" step="1" disabled />
        </div>
        <div class="md:col-span-2">
		</div>

        <!-- Row 7 -->
        <div class="md:col-span-4 flex flex-wrap gap-3 items-end">
          <button id="btnSave" class="btn" type="submit">儲存</button>
          <button id="btnReset" class="btn-secondary" type="button">重設</button>
          <span id="saveMsg" class="ml-2 text-sm text-green-600"></span>
          <a id="issue_link_preview" class="text-brand-700 font-semibold underline hidden" href="#" target="_blank" rel="noopener">打開 Issue</a>
        </div>
      </form>
    </section>

    <!-- List Card -->
    <section id="listSection" class="relative bg-white rounded-2xl shadow-soft p-5 md:p-6 border border-slate-100">
      <!-- Title row -->
      <div class="mb-3">
        <h2 class="text-lg md:text-xl font-semibold">資料列表</h2>
      </div>

	<!-- Filters block -->
	<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">

	  <!-- 關鍵字 -->
	  <div class="flex flex-col">
		<label for="q_keyword" class="text-sm text-slate-600 font-medium mb-1">關鍵字</label>
		<input id="q_keyword" type="text" class="inp" placeholder="搜尋 功能/Memo/Issue#"/>
	  </div>

	  <!-- 狀態 -->
	  <div class="flex flex-col">
		<label for="q_status" class="text-sm text-slate-600 font-medium mb-1">狀態</label>
		<select id="q_status" class="inp">
		  <option value="" selected>全部</option>
		  <option value="1">執行中</option>
		  <option value="0">執行中止</option>
		  <option value="2">完成</option>
		</select>
	  </div>

	  <!-- 類型 -->
	  <div class="flex flex-col">
		<label for="q_category" class="text-sm text-slate-600 font-medium mb-1">類型</label>
		<select id="q_category" class="inp">
		  <option value="" selected>全部</option>
		  <option value="1">BUG</option>
		  <option value="2">改善</option>
		  <option value="3">優化</option>
		  <option value="4">模組</option>
		  <option value="5">QA</option>
		</select>
	  </div>

	  <!-- Test Plan -->
	  <div class="flex flex-col">
		<label for="q_test_plan" class="text-sm text-slate-600 font-medium mb-1">Test Plan</label>
		<select id="q_test_plan" class="inp">
		  <option value="" selected>全部</option>
		  <option value="1">是</option>
		  <option value="0">否</option>
		</select>
	  </div>

	  <!-- 發現BUG -->
	  <div class="flex flex-col">
		<label for="q_bug_found" class="text-sm text-slate-600 font-medium mb-1">發現BUG</label>
		<select id="q_bug_found" class="inp">
		  <option value="" selected>全部</option>
		  <option value="1">是</option>
		  <option value="0">否</option>
		</select>
	  </div>

	</div>


      <!-- Buttons row (right aligned) -->
      <div class="flex justify-end gap-2 mb-3">
        <button id="btnSearch" class="btn">搜尋</button>
		<button id="btnClear" class="btn-secondary">清空</button>
        <button id="btnExportExcel" class="btn-secondary">匯出 Excel</button>
      </div>

      <!-- Overlay (center big) -->
      <div id="loadingOverlay" class="overlay hidden">
        <div class="flex flex-col items-center gap-3 bg-white/80 rounded-2xl px-6 py-6 shadow-soft border border-slate-200">
          <svg class="animate-spin h-8 w-8 text-brand-700" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <div class="text-slate-700 font-medium">查詢中，請稍候…</div>
        </div>
      </div>

      <div id="tableWrap" class="overflow-auto border rounded-2xl">
        <table class="min-w-full text-sm">
          <thead class="table-head text-slate-600 text-xs uppercase tracking-wide">
            <tr>
              <th class="px-3 py-2 text-left">Issue#</th>
              <th class="px-3 py-2 text-left">連結</th>
              <th class="px-3 py-2 text-left">狀態</th>
              <th class="px-3 py-2 text-left">類型</th>
              <th class="px-3 py-2 text-left">功能</th>
              <th class="px-3 py-2 text-left">Test Plan</th>
              <th class="px-3 py-2 text-left">BUG</th>
              <th class="px-3 py-2 text-left">驗證失敗</th>
              <th class="px-3 py-2 text-left">開始測試日期</th>
              <th class="px-3 py-2 text-left">預計交付日期</th>
              <th class="px-3 py-2 text-left">完成日期</th>
              <th class="px-3 py-2 text-left">測試案例</th>
              <th class="px-3 py-2 text-left">Memo</th>
              <th class="px-3 py-2 text-left">操作</th>
            </tr>
          </thead>
          <tbody id="recordsTbody"></tbody>
        </table>
      </div>

      <div id="pager" class="flex justify-end mt-3 gap-2">
        <button id="btnPrev" class="btn-secondary">上一頁</button>
        <span id="pageInfo" class="text-sm text-slate-600 self-center"></span>
        <button id="btnNext" class="btn-secondary">下一頁</button>
      </div>
    </section>
  </main>

  <!-- App logic -->
  <script type="module">
    import {
      collection, addDoc, serverTimestamp, query, orderBy, limit, startAfter, getDocs,
      updateDoc, doc, deleteDoc, getDoc, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Auth UI
    const btnSignOut = document.getElementById('btnSignOut');
    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');

	onAuthStateChanged(auth, (user) => {
	 console.log('user',user)
	 if (user) {
		document.body.style.display = 'block'; // 顯示 body 內容
		userInfo.classList.remove('hidden');
		userEmail.textContent = user.email || user.uid;
	 } else {
		// 已經登出 → 直接導向 login.html
		location.href = "login.html";
	 }
	});

    btnSignOut.addEventListener('click', async ()=>{
      await signOut(auth);
    });

    // Form refs
    const form = document.getElementById('recordForm');
    const saveMsg = document.getElementById('saveMsg');
    const previewLink = document.getElementById('issue_link_preview');

    const fields = {
      status: document.getElementById('status'),
      completed_at: document.getElementById('completed_at'),
      issue_number: document.getElementById('issue_number'),
      test_plan: document.getElementById('test_plan'),
      category: document.getElementById('category'),
      feature: document.getElementById('feature'),
      memo: document.getElementById('memo'),
      test_start_date: document.getElementById('test_start_date'),
      eta_date: document.getElementById('eta_date'),
      bug_found: document.getElementById('bug_found'),
      optimization_points: document.getElementById('optimization_points'),
      verify_failed: document.getElementById('verify_failed'),
      test_cases: document.getElementById('test_cases'),
      file_count: document.getElementById('file_count')
    };

    // Conditional enable for optimization_points
    fields.bug_found.addEventListener('change', ()=>{
      const enabled = fields.bug_found.value === '1';
      fields.optimization_points.disabled = !enabled;
      if(!enabled) fields.optimization_points.value = '';
    });

    // Dynamic issue link preview
    const ISSUE_BASE = "https://gitlab.fb-tek.com/kh/imp/-/issues/";
    function updateIssuePreview(){
      const n = fields.issue_number.value?.trim();
      if(n){
        previewLink.href = ISSUE_BASE + n;
        previewLink.classList.remove('hidden');
      }else{
        previewLink.classList.add('hidden');
      }
    }
    fields.issue_number.addEventListener('input', updateIssuePreview);

    // Save / Update logic
    let editingId = null;

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      // 驗證 issue_number 是否有填
	  if (!fields.issue_number.value || fields.issue_number.value.trim() === '') {
		showMsg('錯誤: 請填寫 Issue Number', true);
		fields.issue_number.focus();
		return; // 中斷，不進行儲存
	  }
      const payload = buildPayload();
      try{
        showLoading(true);
        if(editingId){
          await updateDoc(doc(db, 'records', editingId), payload);
          showMsg('已更新');
        }else{
          await addDoc(collection(db, 'records'), { ...payload, created_at: serverTimestamp() });
          showMsg('已儲存');
        }
        form.reset();
        setDefaultsIfEmpty();
        updateIssuePreview();
        editingId = null;
        await reload();
      }catch(err){
        console.error(err);
        showMsg('錯誤: ' + err.message, true);
      } finally{
        showLoading(false);
      }
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      editingId = null;
      form.reset();
      setDefaultsIfEmpty();
      updateIssuePreview();
      fields.optimization_points.disabled = fields.bug_found.value !== '1';
    });

    function buildPayload(){
      const toNum = (v)=> {
        if (v === '' || v === null || v === undefined) return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      };
      const toStr = (v)=> v?.trim() || null;
      const toDate = (v)=> v ? new Date(v) : null;

      if (!['0','1','2'].includes(String(fields.status.value))) {
        fields.status.value = '1';
      }
      if (!['1','0'].includes(String(fields.test_plan.value))) {
        fields.test_plan.value = '0';
      }

      const issue_number = toNum(fields.issue_number.value);
      const issue_link = issue_number ? (ISSUE_BASE + issue_number) : null;

      const bugFoundIsYes = String(fields.bug_found.value) === '1';
      const optimization_points = bugFoundIsYes ? toNum(fields.optimization_points.value) : 0;

      return {
        status: toNum(fields.status.value),
        completed_at: toDate(fields.completed_at.value),
        issue_number,
        test_plan: toStr(fields.test_plan.value),
        category: toNum(fields.category.value),
        feature: toStr(fields.feature.value),
        issue_link,
        memo: toStr(fields.memo.value),
        test_start_date: toDate(fields.test_start_date.value),
        eta_date: toDate(fields.eta_date.value),
        bug_found: toNum(fields.bug_found.value) ?? 0,
        optimization_points,
        verify_failed: toNum(fields.verify_failed.value) ?? 0,
        test_cases: toNum(fields.test_cases.value),
        file_count: toNum(fields.file_count.value)
      };
    }

    function showMsg(text, isErr=false){
      saveMsg.textContent = text;
      saveMsg.classList.toggle('text-red-600', !!isErr);
      saveMsg.classList.toggle('text-green-600', !isErr);
      setTimeout(()=>{ saveMsg.textContent=''; }, 5000);
    }

    // Table + pagination
    const listSection = document.getElementById('listSection');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const tableWrap = document.getElementById('tableWrap');
    const pager = document.getElementById('pager');
    const tbody = document.getElementById('recordsTbody');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const pageInfo = document.getElementById('pageInfo');

    const qKeyword = document.getElementById('q_keyword');
    const qStatus = document.getElementById('q_status');
    const qCategory = document.getElementById('q_category');
	const qTestPlan = document.getElementById('q_test_plan');
	const qBugFound  = document.getElementById('q_bug_found');
    const btnSearch = document.getElementById('btnSearch');
	const btnClear = document.getElementById('btnClear');
	const btnExportExcel = document.getElementById('btnExportExcel');

    let pageSize = 20;
    let lastVisible = null;
    let firstVisible = null;
    let prevStack = [];
	let _cacheRows = [];   // 全部查回後、已排序的全集資料
	let _pageIndex = 0;    // 目前頁碼（0-based）

    function showLoading(show){
      if(show){
        loadingOverlay.classList.remove('hidden');
        tableWrap.classList.add('invisible');
        pager.classList.add('invisible');
      }else{
        loadingOverlay.classList.add('hidden');
        tableWrap.classList.remove('invisible');
        pager.classList.remove('invisible');
      }
    }
	
	// 小工具：安全取得 created_at 的毫秒值
	function _toMillis(v){
	  if (!v) return 0;
	  if (typeof v.toMillis === 'function') return v.toMillis();
	  if (typeof v.toDate === 'function') return v.toDate().getTime();
	  if (v instanceof Date) return v.getTime();
	  if (typeof v === 'number') return v;
	  return 0;
	}


	async function fetchPage(forward = true) {
	  showLoading(true);
	  try {
		// 1) 蒐集查詢條件（不使用 orderBy、不用游標）
		const constraints = [ limit(2000) ]; // 視資料量調整
		if (qStatus.value !== '')   constraints.push(where('status', '==', Number(qStatus.value)));
		if (qCategory.value !== '') constraints.push(where('category', '==', Number(qCategory.value)));
		if (qTestPlan.value !== '') constraints.push(where('test_plan', '==', qTestPlan.value)); // test_plan 為 '0'/'1'（字串）
		if (qBugFound.value !== '') constraints.push(where('bug_found', '==', Number(qBugFound.value))); // bug_found 為數字 0/1


		const kw = (qKeyword?.value ?? '').trim();
		const kwIsNumber = kw !== '' && !Number.isNaN(Number(kw));
		const kwIsText   = kw !== '' && !kwIsNumber;

		if (kwIsNumber) {
		  constraints.push(where('issue_number', '==', Number(kw)));
		} 

		// 2) 一次撈回
		const qBase = query(collection(db, 'records'), ...constraints);
		const snap  = await getDocs(qBase);
		let rows    = snap.docs.map(d => ({ id: d.id, ...d.data() }));

		// 3) （可選）文字關鍵字再做一次前端包含過濾，縮小結果
		if (kwIsText) {
		  const low = kw.toLowerCase();
		  rows = rows.filter(r => {
			const featureMatch = (r.feature || '').toLowerCase().includes(low);
			const memoMatch    = (r.memo || '').toLowerCase().includes(low);
			const issueMatch   = (r.issue_number ?? '').toString().toLowerCase().includes(low);
			return featureMatch || memoMatch || issueMatch;
		  });
		}


		// 4) 前端排序：issue_number ↓、status ↓、created_at ↓
		rows.sort((a, b) => {
		  const n1 = Number(a.issue_number ?? 0);
		  const n2 = Number(b.issue_number ?? 0);
		  if (n1 !== n2) return n2 - n1; // issue_number 大的在前

		  const s1 = Number(a.status ?? 0);
		  const s2 = Number(b.status ?? 0);
		  if (s1 !== s2) return s2 - s1; // status 大的在前

		  return _toMillis(b.created_at) - _toMillis(a.created_at); // 新的在前
		});

		// 5) 快取 + 顯示第一頁
		_cacheRows = rows;
		_pageIndex = 0;

		const total = _cacheRows.length;
		const pageRows = _cacheRows.slice(0, pageSize);
		renderRows(pageRows);

		const totalPages = Math.max(1, Math.ceil(total / pageSize));
		pageInfo.textContent = `共 ${total} 筆（第 ${_pageIndex + 1} / ${totalPages} 頁）`;

	  } catch (err) {
		console.error('Query error:', err);
		showMsg('查詢錯誤：' + (err?.message || err), true);
		renderRows([]);
		pageInfo.textContent = '共 0 筆';
	  } finally {
		showLoading(false);
	  }
	}

    const statusChip = (v)=>{
      if(v === 1) return '<span class="chip chip-green">執行中</span>';
      if(v === 0) return '<span class="chip chip-gray">執行中止</span>';
      if(v === 2) return '<span class="chip chip-amber">完成</span>';
      return '';
    };
    const categoryChip = (v)=>{
      const map = {
        1: ['BUG','chip-red'],
        2: ['改善','chip-indigo'],
        3: ['優化','chip-indigo'],
        4: ['模組','chip-gray'],
        5: ['QA','chip-gray']
      };
      const item = map[v];
      return item ? `<span class="chip ${item[1]}">${item[0]}</span>` : '';
    };
	
	const toYN = (v) => (v === 1 || v === '1' || String(v).toUpperCase() === 'Y') ? 'Y' : 'N';
	
    function renderRows(rows){
      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.className = 'row';
        const link = r.issue_link ? `<a class="text-brand-700 underline font-medium" href="${r.issue_link}" target="_blank" rel="noopener">連結</a>` : '';
        tr.innerHTML = `
          <td class="px-3 py-2">${r.issue_number ?? ''}</td>
          <td class="px-3 py-2">${link}</td>
          <td class="px-3 py-2">${statusChip(r.status)}</td>
          <td class="px-3 py-2">${categoryChip(r.category)}</td>
          <td class="px-3 py-2">${r.feature ?? ''}</td>
          <td class="px-3 py-2">${toYN(r.test_plan)}</td>
          <td class="px-3 py-2">${toYN(r.bug_found)}</td>
          <td class="px-3 py-2">${toYN(r.verify_failed)}</td>
          <td class="px-3 py-2">${fmtDate(r.test_start_date)}</td>
          <td class="px-3 py-2">${fmtDate(r.eta_date)}</td>
          <td class="px-3 py-2">${fmtDate(r.completed_at)}</td>
          <td class="px-3 py-2">${r.test_cases ?? ''}</td>
          <td class="px-3 py-2 max-w-[420px] whitespace-pre-wrap">${r.memo ?? ''}</td>
          <td class="px-3 py-2">
            <div class="flex gap-2">
              <button class="btn-secondary text-xs" data-edit="${r.id}">編輯</button>
              <button class="btn-secondary text-xs" data-del="${r.id}">刪除</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }

      tbody.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-edit');
          const ref = doc(db, 'records', id);
          const snap = await getDoc(ref);
          if(snap.exists()){
            loadToForm(id, snap.data());
            window.scrollTo({top:0, behavior:'smooth'});
          }
        });
      });
      tbody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-del');
          if(confirm('確定刪除這筆資料？')){
            await deleteDoc(doc(db, 'records', id));
            await reload();
          }
        });
      });
    }

    function fmtDate(v){
      if(!v) return '';
      try{
        if(v.toDate) v = v.toDate();
        const yyyy = v.getFullYear();
        const mm = String(v.getMonth()+1).padStart(2,'0');
        const dd = String(v.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }catch(_){
        return '';
      }
    }

    function loadToForm(id, data){
      editingId = id;
      fields.status.value = data.status ?? '1';
      fields.completed_at.value = data.completed_at ? fmtDate(data.completed_at) : '';
      fields.issue_number.value = data.issue_number ?? '';
      fields.test_plan.value = data.test_plan ?? '0';
      fields.category.value = data.category ?? '';
      fields.feature.value = data.feature ?? '';
      fields.memo.value = data.memo ?? '';
      fields.test_start_date.value = data.test_start_date ? fmtDate(data.test_start_date) : '';
      fields.eta_date.value = data.eta_date ? fmtDate(data.eta_date) : '';
      fields.bug_found.value = data.bug_found ?? 0;
      fields.verify_failed.value = data.verify_failed ?? 0;
      fields.test_cases.value = data.test_cases ?? '';
      fields.file_count.value = data.file_count ?? '';
      fields.optimization_points.disabled = String(fields.bug_found.value) !== '1';
      fields.optimization_points.value = (data.optimization_points === 0 || data.optimization_points == null) ? '' : data.optimization_points;
      updateIssuePreview();
    }

    // Pagination & search
	btnNext.addEventListener('click', ()=>{
	  if (_cacheRows.length === 0) return;
	  const totalPages = Math.max(1, Math.ceil(_cacheRows.length / pageSize));
	  _pageIndex = Math.min(_pageIndex + 1, totalPages - 1);
	  const start = _pageIndex * pageSize;
	  renderRows(_cacheRows.slice(start, start + pageSize));
	  pageInfo.textContent = `共 ${_cacheRows.length} 筆（第 ${_pageIndex + 1} / ${totalPages} 頁）`;
	});

	btnPrev.addEventListener('click', ()=>{
	  if (_cacheRows.length === 0) return;
	  const totalPages = Math.max(1, Math.ceil(_cacheRows.length / pageSize));
	  _pageIndex = Math.max(_pageIndex - 1, 0);
	  const start = _pageIndex * pageSize;
	  renderRows(_cacheRows.slice(start, start + pageSize));
	  pageInfo.textContent = `共 ${_cacheRows.length} 筆（第 ${_pageIndex + 1} / ${totalPages} 頁）`;
	});
	
	// 清空查詢條件
	btnClear.addEventListener('click', () => {
	  // 清空輸入框
	  qKeyword.value = '';
	  qStatus.value = '';
	  qCategory.value = '';
	  qTestPlan.value = '';
	  qBugFound.value = '';

	  // 重載查詢結果
	  _pageIndex = 0;
	  _cacheRows = [];
	  reload();
	});
	
	// 「搜尋」維持原本行為：重置並重新查詢
	btnSearch.addEventListener('click', async () => {
		_pageIndex = 0;
		_cacheRows = [];
		await reload(); // 內部會呼叫 fetchPage()，並重建快取
	});

    async function reload(forward=true){
      await fetchPage(forward);
    }

	// 關鍵字查詢綁定 Enter 按鍵
	qKeyword.addEventListener('keydown', (e) => {
	  if (e.key === 'Enter') {
		e.preventDefault();
		btnSearch.click();
	  }
	});

    // Excel export (current table)
	btnExportExcel.addEventListener('click', () => {
	  // ---- Sheet 1：標題 & 全部資料 ----
	  // 先抓 thead 的文字，並移除最後一個「操作」
	  let headers = Array.from(document.querySelectorAll('#tableWrap thead th'))
		.map(th => th.innerText.trim());
	  if (headers[headers.length - 1] === '操作') {
		headers = headers.slice(0, -1);
	  }

	  // 對應欄位的純文字轉換（不要用 chip/HTML）
	  const statusText = (v) => {
		const n = Number(v);
		if (n === 1) return '執行中';
		if (n === 0) return '執行中止';
		if (n === 2) return '完成';
		return '';
	  };
	  const categoryText = (v) => {
		const map = {1:'BUG', 2:'改善', 3:'優化', 4:'模組', 5:'QA'};
		return map[Number(v)] || '';
	  };
	  const toYN = (v) => (v === 1 || v === '1' || String(v).toUpperCase() === 'Y') ? 'Y' : 'N';
	  const fmt = (v) => {
		if (!v) return '';
		try {
		  if (typeof v.toDate === 'function') v = v.toDate();
		  const yyyy = v.getFullYear();
		  const mm = String(v.getMonth()+1).padStart(2,'0');
		  const dd = String(v.getDate()).padStart(2,'0');
		  return `${yyyy}-${mm}-${dd}`;
		} catch { return ''; }
	  };

	  // 依照目前 thead 的欄位順序，組出每列資料
	  // 你表格 <thead> 的順序是（最後一欄「操作」在匯出時給空字串）：
	  // Issue# | 連結 | 狀態 | 類型 | 功能 | Test Plan | BUG | 驗證失敗 | 開始測試日期 | 預計交付日期 | 完成日期 | 測試案例 | Memo | 操作
	  const rowsAll = _cacheRows.map(r => ([
		r.issue_number ?? '',
		r.issue_link ?? '',
		statusText(r.status),
		categoryText(r.category),
		r.feature ?? '',
		toYN(r.test_plan),
		toYN(r.bug_found),
		toYN(r.verify_failed),
		fmt(r.test_start_date),
		fmt(r.eta_date),
		fmt(r.completed_at),
		r.test_cases ?? '',
		(r.memo ?? '').toString().replaceAll('\n',' '),
		'' // 操作欄（匯出不需要）
	  ]));

	  const ws1 = XLSX.utils.aoa_to_sheet([headers, ...rowsAll]);

	// ------------- Sheet 2：摘要（依「開始測試日期」分月統計 + 季度彙總，限定狀態=完成） -------------
	const monthly = new Map(); // key: 'YYYY-MM' -> {A,B,C,D,E,F,G}

	for (const r of _cacheRows) {
	  // 只統計「完成」
	  if (Number(r.status) !== 2) continue;

	  // 以開始測試日期分月；若沒填，改用 completed_at -> created_at
	  let d = r?.test_start_date || r?.completed_at || r?.created_at;
	  if (!d) continue;
	  d = (typeof d.toDate === 'function') ? d.toDate() : d;
	  if (!(d instanceof Date) || isNaN(d)) continue;

	  const y = d.getFullYear();
	  const m = d.getMonth() + 1; // 1~12
	  const key = `${y}-${String(m).padStart(2, '0')}`;

	  if (!monthly.has(key)) monthly.set(key, { A:0, B:0, C:0, D:0, E:0, F:0, G:0 });
	  const acc = monthly.get(key);

	  const bug   = Number(r.bug_found ?? 0);
	  const tp    = (r.test_plan === 1 || r.test_plan === '1') ? 1 : 0;
	  const opt   = Number(r.optimization_points ?? 0);
	  const cases = Number(r.test_cases ?? 0);
	  const vf    = Number(r.verify_failed ?? 0);
	  const files = Number(r.file_count ?? 0);

	  if (bug === 1) acc.A += 1;         // A: 發現BUG=1 的筆數
	  acc.B += Number.isFinite(opt) ? opt : 0; // B: 可優化項目數
	  if (tp === 1) acc.C += 1;          // C: Test Plan=1 的筆數
	  if (bug === 0 && tp === 0) acc.D += 1;   // D: BUG=0 且 TP=0 的筆數
	  acc.E += Number.isFinite(cases) ? cases : 0; // E: 測試案例總數
	  if (vf === 1) acc.F += 1;          // F: 驗證失敗=1 的筆數
	  acc.G += Number.isFinite(files) ? files : 0; // G: 檔案數總數
	}

	// 每月敘述
	const lines = [['Monthly Summary']]; // 標題列
	const sortedMonths = Array.from(monthly.entries()).sort((a,b) => a[0].localeCompare(b[0]));
	for (const [key, v] of sortedMonths) {
	  const monthNum = Number(key.slice(5)); // 'YYYY-MM' -> 取 MM
	  const text = `${monthNum}月 發現 ${v.B} 個可優化項目，開立 ${v.A} 張優化 issues｜ 產生 ${v.C} 份測試報告｜ ${v.D} 張驗證單，複驗 ${v.F} 張單｜ 建立 ${v.G} 個測試範本、${v.E} 項測試案例`;
	  lines.push([text]);
	}

	// 轉成「季度」彙總：以月 → 季度
	function quarterOf(month) { return Math.floor((month - 1) / 3) + 1; } // 1~12 → 1~4
	const quarterly = new Map(); // key: 'YYYY-Qn' -> {A..G}
	for (const [ym, v] of sortedMonths) {
	  const y = ym.slice(0, 4);
	  const m = Number(ym.slice(5));
	  const qKey = `${y}-Q${quarterOf(m)}`;
	  if (!quarterly.has(qKey)) quarterly.set(qKey, { A:0, B:0, C:0, D:0, E:0, F:0, G:0 });
	  const acc = quarterly.get(qKey);
	  acc.A += v.A; acc.B += v.B; acc.C += v.C; acc.D += v.D; acc.E += v.E; acc.F += v.F; acc.G += v.G;
	}

	// 季度敘述（接在月度後面）
	lines.push([''], ['Quarterly Summary']); // 空列 + 標題
	const sortedQuarters = Array.from(quarterly.entries()).sort((a,b) => a[0].localeCompare(b[0]));
	for (const [qKey, v] of sortedQuarters) {
	  const [year, qLabel] = qKey.split('-'); // e.g. 2025-Q1
	  const textQ = `${qLabel}: 發現 ${v.B} 個可優化項目，開立 ${v.A} 張優化 issues｜ 產生 ${v.C} 份測試報告｜ ${v.D} 張驗證單，複驗 ${v.F} 張單｜ 建立 ${v.G} 個測試範本、${v.E} 項測試案例`;
	  lines.push([`${year} ${textQ}`]);
	}

	const ws2 = XLSX.utils.aoa_to_sheet(lines);


	  // ------------- 輸出 -------------
	  const wb = XLSX.utils.book_new();
	  XLSX.utils.book_append_sheet(wb, ws1, '列表');
	  XLSX.utils.book_append_sheet(wb, ws2, '摘要');
	  XLSX.writeFile(wb, 'records.xlsx');
	});

    // ---------- Defaults on load ----------
    function formatDateInput(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function thisFriday(from = new Date()) {
      const d = new Date(from);
      const day = d.getDay();
      const map = {0:7,1:1,2:2,3:3,4:4,5:5,6:6};
      const dow = map[day];
      const delta = 5 - dow;
      d.setDate(d.getDate() + delta);
      return d;
    }

    function toggleOptimizationPoints() {
      const enabled = fields.bug_found.value === '1';
      fields.optimization_points.disabled = !enabled;
      if (!enabled) {
        fields.optimization_points.value = '';
      }

	  // 發現 BUG = 是 時的自動欄位處理
	  if (fields.bug_found.value === '1') {
		// 清空開始測試日期、預計交付日期
		fields.test_start_date.value = '';
		fields.eta_date.value = '';

		// 完成日期帶入今日
		const today = new Date();
		const yyyy = today.getFullYear();
		const mm = String(today.getMonth() + 1).padStart(2, '0');
		const dd = String(today.getDate()).padStart(2, '0');
		fields.completed_at.value = `${yyyy}-${mm}-${dd}`;
		// 預設完成
		fields.status.value = '2';
		
	  }else{
		const today = new Date();
		fields.completed_at.value = '';
	
		if (!fields.test_start_date.value) {
			fields.test_start_date.value = formatDateInput(today);
		}
		if (!fields.eta_date.value) {
			fields.eta_date.value = formatDateInput(thisFriday(today));
		}
		// 執行中
		fields.status.value = '1';
		
	  }
    }

    function setDefaultsIfEmpty() {
      if (!['0','1','2'].includes(String(fields.status.value))) {
        fields.status.value = '1';
      }
      if (!['1','0'].includes(String(fields.test_plan.value))) {
        fields.test_plan.value = '0';
      }
      const today = new Date();
      //if (!fields.completed_at.value) {
       // fields.completed_at.value = formatDateInput(today);
      //}
      if (!fields.test_start_date.value) {
        fields.test_start_date.value = formatDateInput(today);
      }
      if (!fields.eta_date.value) {
        fields.eta_date.value = formatDateInput(thisFriday(today));
      }
      toggleOptimizationPoints();
    }

    // 初次載入：套預設 + 立刻查詢
    setDefaultsIfEmpty();
    reload();
    fields.bug_found.addEventListener('change', toggleOptimizationPoints);
  </script>
</body>
</html>
