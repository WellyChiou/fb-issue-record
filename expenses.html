<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭記帳系統</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, getDoc, updateDoc, deleteDoc, doc, setDoc, query, orderBy, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDfHs1XXsCXGMSVF3NFJUtFMcslTzTd-EU",
            authDomain: "expenses-91280.firebaseapp.com",
            projectId: "expenses-91280",
            storageBucket: "expenses-91280.firebasestorage.app",
            messagingSenderId: "777956465315",
            appId: "1:777956465315:web:04f85f2b22f2468eb2fd16",
            measurementId: "G-1LE7YTKHGT"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 將 Firebase 實例設為全域變數
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseGetDoc = getDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseWhere = where;
        window.firebaseServerTimestamp = serverTimestamp;
        window.firebaseSignInAnonymously = signInAnonymously;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseSignOut = signOut;
        
        // 標記 Firebase 已載入
        window.firebaseLoaded = true;
        console.log('Firebase SDK 已載入完成');
    </script>
</head>
<body>
    <!-- 載入動畫 -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">載入中</div>
            <div class="loading-subtext" id="loadingSubtext">請稍候<span class="loading-dots"></span></div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-top">
            <h1>家庭記帳系統</h1>
                <div id="userInfo" class="user-info" style="display: none; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(15px); padding: 10px 18px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                    <div class="user-details">
                        <svg class="user-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                        </svg>
                        <span id="userEmail" class="user-email"></span>
                    </div>
                    <button id="btnSignOut" class="logout-btn" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);">登出</button>
                </div>
            </div>
            <div class="summary">
                <div class="summary-item">
                    <span class="label">本月收入</span>
                    <span class="amount income" id="monthlyIncome">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">本月支出</span>
                    <span class="amount expense" id="monthlyExpense">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">本月淨收入</span>
                    <span class="amount net-income" id="monthlyNetIncome">$0</span>
                </div>
                </div>
            
            <!-- 功能按鈕區域 -->
            <div class="function-buttons-section">
                <button class="btn btn-chart" onclick="expenseTracker.showChartsModal()">
                    📊 圖表分析
                </button>
                <button class="btn btn-primary" onclick="expenseTracker.showAssetPortfolio()">
                    📊 資產組合管理
                </button>
                <button class="btn btn-secondary" onclick="expenseTracker.showExchangeRates()">
                    💱 匯率管理
                </button>
            </div>
        </header>

        <main>
            <!-- 新增記錄區域 -->
            <section class="add-record">
                <h2>新增記帳記錄</h2>
                <form id="recordForm">
                    <div class="form-grid">
                    <div class="form-group">
                        <label for="member">家庭成員</label>
                        <select id="member" required>
                            <option value="">請選擇成員</option>
                            <option value="爸爸">爸爸</option>
                            <option value="媽媽">媽媽</option>
                            <option value="孩子">孩子</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="type">類型</label>
                        <select id="type" required>
                            <option value="">請選擇類型</option>
                            <option value="支出">支出</option>
                            <option value="收入">收入</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="mainCategory">類別</label>
                        <select id="mainCategory" required>
                            <option value="">請選擇類別</option>
                            <!-- 支出大項目 -->
                            <option value="食" data-type="支出">食</option>
                            <option value="衣" data-type="支出">衣</option>
                            <option value="住" data-type="支出">住</option>
                            <option value="行" data-type="支出">行</option>
                            <option value="育" data-type="支出">育</option>
                            <option value="樂" data-type="支出">樂</option>
                            <option value="醫療" data-type="支出">醫療</option>
                            <option value="其他支出" data-type="支出">其他支出</option>
                            <!-- 收入大項目 -->
                            <option value="薪資" data-type="收入">薪資</option>
                            <option value="投資" data-type="收入">投資</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="subCategory">細項</label>
                        <select id="subCategory" required>
                            <option value="">請先選擇類別</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">金額</label>
                        <input type="number" id="amount" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="currency">幣別</label>
                        <select id="currency" required>
                            <option value="TWD">台幣 (TWD)</option>
                            <option value="USD">美元 (USD)</option>
                            <option value="EUR">歐元 (EUR)</option>
                            <option value="JPY">日圓 (JPY)</option>
                            <option value="CNY">人民幣 (CNY)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="exchangeRateGroup" style="display: none;">
                        <label for="exchangeRate">匯率 (對台幣)</label>
                        <div class="exchange-rate-display">
                            <input type="number" id="exchangeRate" step="0.0001" readonly placeholder="正在取得匯率...">
                            <button type="button" id="refreshRateBtn" onclick="expenseTracker.fetchCurrentExchangeRate()" style="margin-left: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                🔄 更新匯率
                            </button>
                        </div>
                        <small class="exchange-rate-info" style="color: #666; font-size: 12px;">
                            匯率將自動從網路取得最新數據
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">描述</label>
                        <input type="text" id="description" placeholder="輸入描述...">
                    </div>
                    
                    <div class="form-group">
                        <label for="date">日期</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit">新增記錄</button>
                        <button type="button" onclick="expenseTracker.resetForm()" class="reset-btn">清空表單</button>
                    </div>
                </form>
            </section>


            <!-- 記錄列表區域 -->
            <section class="records">
                <h2>記帳記錄</h2>
                <div class="records-list" id="recordsList">
                    <!-- 記錄將動態生成 -->
                </div>
                
                <!-- 分頁控件 -->
                <div class="pagination" id="pagination">
                    <div class="page-size-selector">
                        <label for="pageSize">每頁顯示：</label>
                        <select id="pageSize">
                            <option value="5">5 筆</option>
                            <option value="10">10 筆</option>
                            <option value="20" selected>20 筆</option>
                            <option value="50">50 筆</option>
                        </select>
                    </div>
                    
                    <div class="page-controls">
                        <button id="prevPage" class="page-btn" disabled>上一頁</button>
                        <div class="page-info">
                            <span id="pageInfo">第 1 頁，共 1 頁</span>
                        </div>
                        <button id="nextPage" class="page-btn" disabled>下一頁</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 圖表彈窗 -->
    <div id="chartsModal" class="modal">
        <div class="modal-content charts-modal">
            <div class="modal-header">
                <h2>📊 圖表分析</h2>
                <span class="close" onclick="expenseTracker.hideChartsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 圖表篩選器 -->
                <div class="chart-filters">
                    <h3>圖表篩選</h3>
                    <div class="filter-group">
                        <label for="chartFilterType">類型：</label>
                        <select id="chartFilterType">
                            <option value="">所有類型</option>
                            <option value="收入">收入</option>
                            <option value="支出">支出</option>
                            <option value="資產">資產</option>
                        </select>
                        
                        <label for="chartFilterYear">年份：</label>
                        <select id="chartFilterYear">
                            <option value="">所有年份</option>
                        </select>
                        
                        <label for="chartFilterMonth">月份：</label>
                        <select id="chartFilterMonth">
                            <option value="">所有月份</option>
                            <option value="01">1月</option>
                            <option value="02">2月</option>
                            <option value="03">3月</option>
                            <option value="04">4月</option>
                            <option value="05">5月</option>
                            <option value="06">6月</option>
                            <option value="07">7月</option>
                            <option value="08">8月</option>
                            <option value="09">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="expense-section-title">支出統計</h2>
                <div class="chart-row expense-section">
                    <div class="chart-container">
                        <h3>支出類別分布</h3>
                        <canvas id="expenseCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>家庭成員支出分布</h3>
                        <canvas id="expenseMemberChart"></canvas>
                    </div>
                </div>
                
                <h2 class="income-section-title">收入統計</h2>
                <div class="chart-row income-section">
                    <div class="chart-container">
                        <h3>收入類別分布</h3>
                        <canvas id="incomeCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>家庭成員收入分布</h3>
                        <canvas id="incomeMemberChart"></canvas>
                    </div>
                </div>
                
                <h2 class="asset-section-title">資產統計</h2>
                <div class="chart-row asset-section">
                    <div class="chart-container">
                        <h3>資產類別分布</h3>
                        <canvas id="assetCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>家庭成員資產分布</h3>
                        <canvas id="assetMemberChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="expenseTracker.hideChartsModal()">關閉</button>
            </div>
        </div>
    </div>

    <!-- 匯率管理模態框 -->
    <div id="exchangeRateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>💱 匯率管理</h2>
                <span class="close" onclick="expenseTracker.hideExchangeRates()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="exchange-rate-section">
                    <h3>匯率管理 (對台幣)</h3>
                    <div class="rate-date-controls">
                        <div class="form-group">
                            <label for="rateDate">匯率日期</label>
                            <input type="date" id="rateDate">
                        </div>
                        <button class="btn btn-outline" onclick="expenseTracker.loadRatesForDate()">
                            📅 載入該日期匯率
                        </button>
                    </div>
                    <div class="exchange-rates-grid">
                        <div class="exchange-rate-item">
                            <label>美元 (USD)</label>
                            <input type="number" id="usdRate" step="0.0001" placeholder="30.0000">
                        </div>
                        <div class="exchange-rate-item">
                            <label>歐元 (EUR)</label>
                            <input type="number" id="eurRate" step="0.0001" placeholder="32.0000">
                        </div>
                        <div class="exchange-rate-item">
                            <label>日圓 (JPY)</label>
                            <input type="number" id="jpyRate" step="0.0001" placeholder="0.2000">
                        </div>
                        <div class="exchange-rate-item">
                            <label>人民幣 (CNY)</label>
                            <input type="number" id="cnyRate" step="0.0001" placeholder="4.2000">
                        </div>
                    </div>
                    <div class="exchange-rate-actions">
                        <button class="btn btn-primary" onclick="expenseTracker.fetchLatestRates()">
                            🔄 自動更新匯率
                        </button>
                        <button class="btn btn-secondary" onclick="expenseTracker.saveExchangeRates()">
                            💾 儲存匯率
                        </button>
                        <button class="btn btn-warning" onclick="expenseTracker.importHistoricalRates()">
                            📥 匯入歷史匯率
                        </button>
                        <button class="btn btn-info" onclick="expenseTracker.autoFillMissingRates()">
                            🔧 補足缺少匯率
                        </button>
                    </div>
                </div>
                
                <div class="exchange-rate-section">
                    <h3>歷史匯率查詢</h3>
                    <div class="history-rate-controls">
                        <div class="form-group">
                            <label for="historyDate">查詢日期</label>
                            <input type="date" id="historyDate">
                        </div>
                        <button class="btn btn-outline" onclick="expenseTracker.loadHistoryRates()">
                            📅 載入歷史匯率
                        </button>
                    </div>
                    <div id="historyRatesDisplay" class="history-rates-display" style="display: none;">
                        <h4>歷史匯率</h4>
                        <div class="exchange-rates-grid">
                            <div class="exchange-rate-item">
                                <label>美元 (USD)</label>
                                <span id="historyUsdRate">-</span>
                            </div>
                            <div class="exchange-rate-item">
                                <label>歐元 (EUR)</label>
                                <span id="historyEurRate">-</span>
                            </div>
                            <div class="exchange-rate-item">
                                <label>日圓 (JPY)</label>
                                <span id="historyJpyRate">-</span>
                            </div>
                            <div class="exchange-rate-item">
                                <label>人民幣 (CNY)</label>
                                <span id="historyCnyRate">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 更新股價 Loading 模態框 -->
    <div id="updateStocksLoadingModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>📈 更新股價 <span id="updateProgressBadge" style="font-size: 0.7em; color: #fff; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; margin-left: 10px; display: none;"></span> <span id="updateResultBadge" style="font-size: 0.7em; color: #fff; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; margin-left: 10px; display: none;"></span></h2>
                <span class="close" onclick="expenseTracker.hideUpdateStocksLoading()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="loading-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="updateProgressFill"></div>
                    </div>
                    <div class="progress-text" id="updateProgressText">準備中...</div>
                </div>
                
                <div class="stocks-update-list" id="stocksUpdateList">
                    <!-- 股票更新狀態將在這裡動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 資產組合管理模態框 -->
    <div id="assetPortfolioModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>📊 資產組合管理</h2>
                <span class="close" onclick="expenseTracker.hideAssetPortfolio()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="asset-portfolio-section">
                    <div class="portfolio-header">
                        <h3>我的資產組合 <span id="assetCountDisplay" style="font-size: 0.8em; color: #666; font-weight: normal;">(0 項)</span></h3>
                        <button class="btn btn-primary" onclick="expenseTracker.showAddAssetForm()">
                            ➕ 新增資產
                        </button>
                        <button class="btn btn-primary" onclick="expenseTracker.updateAllStockPrices()" id="updateAllStocksBtn">
                            📈 更新所有股價
                        </button>
                    </div>
                    
                    <div class="portfolio-summary">
                        <div class="summary-item">
                            <span class="label">總資產價值 (台幣)</span>
                            <span class="amount" id="portfolioTotalValue">$0</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">總成本 (台幣)</span>
                            <span class="amount" id="portfolioTotalCost">$0</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">總損益價值 (台幣)</span>
                            <span class="amount" id="portfolioTotalProfitLoss">$0</span>
                        </div>
                    </div>
                    
                    <div class="assets-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>取得最新價格</th>
                                    <th>資產名稱</th>
                                    <th>股票代碼</th>
                                    <th>類型</th>
                                    <th>數量</th>
                                    <th>購買平均成本價</th>
                                    <th>當前價格</th>
                                    <th>成本</th>
                                    <th>當前價值</th>
                                    <th>損益</th>
                                    <th>損益%</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="assetsTableBody">
                                <!-- 資產項目將在這裡動態生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增資產模態框 -->
    <div id="addAssetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>➕ 新增資產</h2>
                <span class="close" onclick="expenseTracker.hideAddAssetForm()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addAssetForm">
                    <div class="form-group">
                        <label for="assetName">資產名稱</label>
                        <input type="text" id="assetName" required placeholder="例如：AAPL 股票">
                    </div>
                    
                    <div class="form-group" id="stockCodeGroup" style="display: none;">
                        <label for="assetStockCode">股票代碼</label>
                        <input type="text" id="assetStockCode" placeholder="例如：AAPL、TSLA、2330">
                        <small style="color: #666; font-size: 12px;">
                            美股：AAPL、TSLA | 台股：2330、2317 | 港股：0700、9988
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="assetType">資產類型</label>
                        <select id="assetType" required>
                            <option value="">請選擇類型</option>
                            <option value="股票">股票</option>
                            <option value="基金">基金</option>
                            <option value="債券">債券</option>
                            <option value="加密貨幣">加密貨幣</option>
                            <option value="不動產">不動產</option>
                            <option value="存款">存款</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="assetQuantity">股數/數量</label>
                        <input type="text" id="assetQuantity" pattern="[0-9]+(\.[0-9]+)?" min="0" required placeholder="例如：1000" oninput="this.value = this.value.replace(/[^0-9.]/g, '')">
                    </div>
                    
                    <div class="form-group">
                        <label for="assetCurrency">幣別</label>
                        <select id="assetCurrency" required>
                            <option value="TWD">台幣 (TWD)</option>
                            <option value="USD">美元 (USD)</option>
                            <option value="EUR">歐元 (EUR)</option>
                            <option value="JPY">日圓 (JPY)</option>
                            <option value="CNY">人民幣 (CNY)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="assetCost">總成本</label>
                        <input type="number" id="assetCost" step="0.01" placeholder="例如：100000" required>
                        <small style="color: #666; font-size: 12px;">
                            實際投入的總金額（包含手續費等）
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="assetUnitPrice">購買平均成本價（自動計算）</label>
                        <input type="number" id="assetUnitPrice" step="0.0001" readonly placeholder="自動計算">
                        <small style="color: #666; font-size: 12px;">
                            購買平均成本價 = 總成本 ÷ 股數
                        </small>
                    </div>
                    
                    <div class="form-group" id="currentPriceGroup" style="display: none;">
                        <label for="assetCurrentPrice">當前價格 (選填)</label>
                        <input type="number" id="assetCurrentPrice" step="0.0001" placeholder="例如：160.00">
                        <button type="button" id="fetchCurrentPriceBtn" onclick="expenseTracker.fetchCurrentStockPrice()" style="margin-left: 10px; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            📈 
                        </button>
                        <small style="color: #666; font-size: 12px;">
                            留空將使用購買價格計算價值
                        </small>
                    </div>
                    
                    <div class="form-group" id="purchaseDateGroup" style="display: none;">
                        <label for="assetPurchaseDate">購買日期 (選填)</label>
                        <input type="date" id="assetPurchaseDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="assetDescription">描述</label>
                        <textarea id="assetDescription" placeholder="資產相關說明..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="expenseTracker.hideAddAssetForm()">取消</button>
                        <button type="submit" class="btn btn-primary">新增資產</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 資料轉移模態框 -->
    <div id="dataMigrationModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>🔄 資料轉移 - 資產記錄轉換</h2>
                <span class="close" onclick="expenseTracker.hideDataMigration()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="migration-section">
                    <div class="migration-info">
                        <h3>📋 轉移說明</h3>
                        <p>將現有的資產記錄轉換為資產組合管理格式，支援多幣別和詳細管理。</p>
                        <p><strong>注意：</strong>轉移後建議手動刪除原始資產記錄，避免重複計算。</p>
                        <div class="migration-stats">
                            <div class="stat-item">
                                <span class="label">可轉移的資產記錄</span>
                                <span class="amount" id="migratableCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="label">已存在的資產項目</span>
                                <span class="amount" id="existingAssetsCount">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="migration-options">
                        <h3>⚙️ 轉移選項</h3>
                        <div class="option-group">
                            <label>
                                <input type="checkbox" id="migrateAllAssets" checked>
                                轉移所有資產記錄
                            </label>
                        </div>
                        <div class="option-group">
                            <label>
                                <input type="checkbox" id="keepOriginalRecords">
                                保留原始記錄（轉移後可手動刪除）
                            </label>
                        </div>
                        <div class="option-group">
                            <label>
                                <input type="checkbox" id="mergeDuplicates">
                                合併重複項目（相同名稱和類型）
                            </label>
                        </div>
                    </div>
                    
                    <div class="migration-preview">
                        <h3>👀 轉移預覽</h3>
                        <div class="preview-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>原始記錄</th>
                                        <th>轉換後</th>
                                        <th>狀態</th>
                                    </tr>
                                </thead>
                                <tbody id="migrationPreviewBody">
                                    <!-- 預覽內容將在這裡動態生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="migration-actions">
                        <button class="btn btn-secondary" onclick="expenseTracker.hideDataMigration()">
                            取消
                        </button>
                        <button class="btn btn-primary" onclick="expenseTracker.startMigration()">
                            🚀 開始轉移
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <style>
            /* 損益顏色樣式 */
            .profit {
                color: #28a745;
                font-weight: bold;
            }
            
            .loss {
                color: #dc3545;
                font-weight: bold;
            }
            
            .btn-update {
                background: #28a745;
                color: white;
                border: none;
                padding: 2px 6px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
            }
            
            .btn-update:hover {
                background: #218838;
            }
            
            /* 表格樣式優化 */
            .assets-table table {
                width: 100%;
                border-collapse: collapse;
                font-size: 14px;
            }
            
            .assets-table th,
            .assets-table td {
                padding: 8px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
            
            .assets-table th {
                background-color: #f8f9fa;
                font-weight: bold;
            }
            
            .assets-table tr:hover {
                background-color: #f5f5f5;
            }
            
            /* 本月淨收入樣式 */
            .net-income.positive {
                color: #28a745;
                font-weight: bold;
            }
            
            .net-income.negative {
                color: #dc3545;
                font-weight: bold;
            }
            
            .net-income.positive::before {
                content: "+";
            }
            
            .net-income.negative::before {
                content: "-";
            }
            
            /* 美化操作按鈕 */
            .btn-edit, .btn-delete, .btn-update {
                background: none !important;
                border: none !important;
                padding: 4px 6px !important;
                margin: 1px !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 14px !important;
                transition: all 0.2s ease !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                min-width: 28px !important;
                height: 28px !important;
            }
            
            .btn-edit {
                color: #007bff !important;
                background-color: rgba(0, 123, 255, 0.1) !important;
            }
            
            .btn-edit:hover {
                background-color: rgba(0, 123, 255, 0.2) !important;
                transform: scale(1.05) !important;
            }
            
            .btn-delete {
                color: #dc3545 !important;
                background-color: rgba(220, 53, 69, 0.1) !important;
            }
            
            .btn-delete:hover {
                background-color: rgba(220, 53, 69, 0.2) !important;
                transform: scale(1.05) !important;
            }
            
            .btn-update {
                color: #28a745 !important;
                background-color: rgba(40, 167, 69, 0.1) !important;
            }
            
            .btn-update:hover {
                background-color: rgba(40, 167, 69, 0.2) !important;
                transform: scale(1.05) !important;
            }
            
            /* 操作欄位樣式 */
            .operation-cell {
                white-space: nowrap;
                padding: 8px !important;
            }
            
            .operation-cell .btn-group {
                display: flex;
                gap: 2px;
                align-items: center;
            }
        </style>

    <script>
        // ExpenseTracker 類別
        class ExpenseTracker {
            // 格式化數字，添加千分位分隔符（整數顯示）
            formatNumber(number) {
                return Math.round(number).toLocaleString('zh-TW');
            }

            constructor() {
                this.records = [];
                this.editingId = null;
                this.currentPage = 1;
                this.recordsPerPage = 20;
                this.currentUser = null;
                this.isFirebaseReady = false;
                
                // 載入動畫元素
                this.loadingOverlay = document.getElementById('loadingOverlay');
                this.loadingText = document.getElementById('loadingText');
                this.loadingSubtext = document.getElementById('loadingSubtext');
                
                // 匯率管理
                this.exchangeRates = {
                    'USD': 30.0,
                    'EUR': 32.0,
                    'JPY': 0.2,
                    'CNY': 4.2
                };
                
                // 資產組合
                this.assets = [];
                this.editingAssetId = null;
                
                this.categoryStructure = {
                    '食': ['外食', '食材', '飲料', '零食', '其他'],
                    '衣': ['服飾', '鞋子', '配件', '美容', '其他'],
                    '住': ['房貸', '租金', '水電瓦斯', '居家用品', '家具家電', '裝潢修繕', '網路費', '通訊', '其他'],
                    '行': ['交通費', '油費', '停車費', '大眾運輸', '交通工具保養', '其他'],
                    '育': ['學費', '書籍', '進修', '文具', '其他'],
                    '樂': ['娛樂', '旅遊', '運動', '社交', '其他'],
                    '醫療': ['診療', '藥品', '健檢', '醫療用品', '其他'],
                    '其他支出': ['投資', '教會奉獻', '保險', '稅務', '其他'],
                    '薪資': ['本薪', '獎金', '兼職', '其他'],
                    '投資': ['股票', '基金', '債券', '加密貨幣', '其他']
                };
                
                this.init();
            }

            // Firebase 初始化
            async initFirebase() {
                try {
                    console.log('開始初始化 Firebase...');
                    this.showLoading('初始化系統', '正在連接 Firebase...');
                    
                    // 等待 Firebase 載入
                    await this.waitForFirebase();
                    console.log('Firebase SDK 已載入');
                    
                    // 檢查 Firebase 實例是否正確初始化
                    if (!window.firebaseAuth || !window.firebaseDb) {
                        throw new Error('Firebase 實例未正確初始化');
                    }
                    
                    console.log('Firebase 實例檢查通過');
                    
                    // 使用 Promise 等待認證狀態
                    const authState = await this.waitForAuthStateWithPromise();
                    console.log('認證狀態檢查完成:', authState ? `已登入 ${authState.email}` : '未登入');
                    
                    if (authState) {
                        console.log('檢測到現有登入狀態:', authState.uid);
                        this.showLoading('載入用戶資料', '正在更新用戶資訊...');
                        console.log('使用者詳細資訊:', {
                            uid: authState.uid,
                            email: authState.email,
                            displayName: authState.displayName,
                            providerId: authState.providerData?.[0]?.providerId
                        });
                        
                        // 先更新使用者基本資料（無論啟用狀態如何）
                        console.log('開始執行 updateUserProfile...');
                        const updateSuccess = await this.updateUserProfile(authState);
                        console.log('updateUserProfile 執行結果:', updateSuccess);
                        if (!updateSuccess) {
                            console.error('❌ 使用者資料更新失敗！');
                            console.error('這可能是因為 Firebase 權限問題或網路問題');
                        } else {
                            console.log('✅ 使用者資料更新成功');
                        }
                        
                        // 然後檢查使用者啟用狀態
                        console.log('開始檢查使用者啟用狀態...');
                        const userStatus = await this.checkUserStatus(authState);
                        console.log('使用者狀態檢查結果:', userStatus);
                        console.log('isActive 值:', userStatus.isActive);
                        console.log('isActive 類型:', typeof userStatus.isActive);
                        
                        if (!userStatus.isActive) {
                            console.log('❌ 使用者尚未啟用，顯示未啟用訊息:', authState.email);
                            this.showInactiveUserMessage(authState);
                            return;
                        } else {
                            console.log('✅ 使用者已啟用，繼續載入應用程式');
                        }
                        
                        this.currentUser = authState;
                        this.isFirebaseReady = true;
                        
                        // 載入記錄
                        this.showLoading('載入記帳資料', '正在從資料庫讀取記錄...');
                        await this.loadRecordsFromFirebase();
                        
                        // 載入匯率
                        try {
                            await this.loadExchangeRatesFromFirebase();
                            console.log('匯率載入完成');
                        } catch (error) {
                            console.error('匯率載入失敗:', error);
                        }
                        
                        this.hideLoading();
                    } else {
                        console.log('未檢測到登入狀態，導向登入頁面');
                        window.location.href = 'enter_login.html';
                    }
                    
                    // 監聽認證狀態變化
                    window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
                        if (user) {
                            console.log('認證狀態變化 - 已登入:', user.uid);
                            this.showLoading('載入用戶資料', '正在更新用戶資訊...');
                            
                            // 先更新使用者基本資料（無論啟用狀態如何）
                            console.log('開始執行 updateUserProfile...');
                            this.updateUserProfile(user).then(async updateSuccess => {
                                console.log('updateUserProfile 執行結果:', updateSuccess);
                                if (!updateSuccess) {
                                    console.error('❌ 使用者資料更新失敗！');
                                    console.error('這可能是因為 Firebase 權限問題或網路問題');
                                } else {
                                    console.log('✅ 使用者資料更新成功');
                                }
                                
                                // 然後檢查使用者啟用狀態
                                const userStatus = await this.checkUserStatus(user);
                                if (!userStatus.isActive) {
                                    console.log('使用者尚未啟用:', user.email);
                                    this.hideLoading();
                                    this.showInactiveUserMessage(user);
                                    return;
                                }
                                
                                this.currentUser = user;
                                this.isFirebaseReady = true;
                                
                                // 顯示用戶資訊
                                this.showUserInfo(user);
                                
                                // 載入記錄
                                this.showLoading('載入記帳資料', '正在從資料庫讀取記錄...');
                                await this.loadRecordsFromFirebase();
                                
                                // 載入匯率
                                try {
                                    await this.loadExchangeRatesFromFirebase();
                                    console.log('匯率載入完成');
                                } catch (error) {
                                    console.error('匯率載入失敗:', error);
                                }
                                
                                this.hideLoading();
                            });
                        } else {
                            console.log('認證狀態變化 - 已登出，導向登入頁面');
                            window.location.href = 'enter_login.html';
                        }
                    });
                } catch (error) {
                    console.error('Firebase 初始化失敗:', error);
                    console.error('錯誤詳情:', {
                        message: error.message,
                        stack: error.stack,
                        firebaseAuth: !!window.firebaseAuth,
                        firebaseDb: !!window.firebaseDb
                    });
                    
                    // 顯示錯誤訊息給使用者
                    this.showFirebaseError(error);
                }
            }

            // 使用 Promise 等待認證狀態
            waitForAuthStateWithPromise() {
                return new Promise((resolve) => {
                    console.log('開始等待認證狀態...');
                    
                    // 先檢查當前是否有已登入的使用者
                    const currentUser = window.firebaseAuth.currentUser;
                    if (currentUser) {
                        console.log('檢測到當前已登入使用者:', currentUser.uid, currentUser.email);
                        resolve(currentUser);
                        return;
                    }
                    
                    console.log('當前無登入使用者，等待認證狀態變化...');
                    
                    const unsubscribe = window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
                        console.log('認證狀態變化:', user ? `已登入 ${user.email}` : '已登出');
                        unsubscribe(); // 取消監聽
                        resolve(user);
                    });
                    
                    // 設置超時，避免無限等待
                    setTimeout(() => {
                        console.log('認證狀態檢查超時');
                        unsubscribe();
                        resolve(null);
                    }, 10000); // 10秒超時
                });
            }

            // 更新使用者基本資料
            async updateUserProfile(user) {
                try {
                    console.log('開始更新使用者資料:', user.uid, user.email);
                    
                    // 確保Firebase函數已載入
                    if (!window.firebaseDoc || !window.firebaseSetDoc || !window.firebaseServerTimestamp || !window.firebaseGetDoc) {
                        console.error('Firebase函數未載入，無法更新使用者資料');
                        console.error('缺少的函數:', {
                            firebaseDoc: !!window.firebaseDoc,
                            firebaseSetDoc: !!window.firebaseSetDoc,
                            firebaseServerTimestamp: !!window.firebaseServerTimestamp,
                            firebaseGetDoc: !!window.firebaseGetDoc
                        });
                        return false;
                    }
                    
                    console.log('Firebase函數檢查通過');
                    const userRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                    console.log('使用者參考已建立:', userRef);
                    
                    // 先檢查使用者是否已存在
                    console.log('檢查使用者是否已存在...');
                    const existingUserDoc = await window.firebaseGetDoc(userRef);
                    const isNewUser = !existingUserDoc.exists();
                    console.log('使用者是否為新使用者:', isNewUser);
                    
                    // 準備使用者資料
                    const userData = {
                        uid: user.uid,
                        email: user.email ?? null,
                        displayName: user.displayName ?? null,
                        photoURL: user.photoURL ?? null,
                        providerId: user.providerData?.[0]?.providerId ?? null,
                        lastLoginAt: window.firebaseServerTimestamp()
                    };
                    
                    // 只有新使用者才設定 isActive
                    if (isNewUser) {
                        console.log('新使用者，設定預設狀態');
                        userData.isActive = false;  // 預設不啟用
                        userData.createdAt = window.firebaseServerTimestamp();
                    } else {
                        console.log('現有使用者，保持原有 isActive 狀態');
                        const existingData = existingUserDoc.data();
                        console.log('現有使用者狀態:', existingData?.isActive);
                    }
                    
                    console.log('準備寫入的使用者資料:', userData);
                    console.log('開始執行 setDoc 操作...');
                    
                    await window.firebaseSetDoc(userRef, userData, { merge: true });
                    console.log('✅ 使用者資料已成功更新:', user.uid);
                    return true;
                } catch (error) {
                    console.error('❌ 更新使用者資料失敗:', error);
                    console.error('錯誤詳情:', {
                        message: error.message,
                        code: error.code,
                        user: user ? user.uid : 'null'
                    });
                    return false;
                }
            }

            // 顯示Firebase錯誤訊息
            showFirebaseError(error) {
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">⚠️</div>
                                <h2>系統初始化失敗</h2>
                                <p>很抱歉，系統無法正常載入。請檢查以下項目：</p>
                                <div class="user-info">
                                    <p><strong>錯誤訊息:</strong> ${error.message}</p>
                                    <p><strong>可能原因:</strong></p>
                                    <ul style="text-align: left; margin: 10px 0;">
                                        <li>網路連線問題</li>
                                        <li>Firebase服務暫時無法使用</li>
                                        <li>瀏覽器快取問題</li>
                                        <li>Firebase配置錯誤</li>
                                    </ul>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="location.reload();" class="logout-btn" style="background: #3498db;">
                                        重新載入
                                    </button>
                                    <button onclick="window.location.href='enter_login.html';" class="logout-btn">
                                        返回登入
                                    </button>
                                </div>
                                <div style="margin-top: 20px; font-size: 0.9em; color: #999;">
                                    <p>如果問題持續發生，請聯繫技術支援</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // 檢查使用者啟用狀態
            async checkUserStatus(user) {
                try {
                    console.log('檢查使用者狀態:', user.uid);
                    
                    // 確保Firebase函數已載入
                    if (!window.firebaseDoc || !window.firebaseGetDoc) {
                        console.error('Firebase函數未載入');
                        return { isActive: false };
                    }
                    
                    // 直接讀取特定使用者的文件
                    const userRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                    const userDoc = await window.firebaseGetDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        console.log('找到使用者資料:', userData);
                        console.log('原始 isActive 值:', userData.isActive);
                        console.log('原始 isActive 類型:', typeof userData.isActive);
                        const result = {
                            isActive: userData.isActive || false
                        };
                        console.log('返回的結果:', result);
                        return result;
                    }
                    
                    console.log('未找到使用者資料，返回預設狀態');
                    return { isActive: false };
                } catch (error) {
                    console.error('檢查使用者狀態失敗:', error);
                    console.error('錯誤詳情:', {
                        message: error.message,
                        code: error.code,
                        userId: user.uid
                    });
                    
                    // 如果是權限錯誤，提供解決方案
                    if (error.code === 'permission-denied') {
                        console.error('🔒 權限被拒絕！請檢查 Firebase 安全規則');
                        console.error('建議的安全規則:');
                        console.error(`
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
                        `);
                    }
                    
                    return { isActive: false };
                }
            }

            // 顯示索引錯誤訊息
            showIndexError() {
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">🔍</div>
                                <h2>Firebase 索引設定</h2>
                                <p>系統需要建立 Firebase 索引才能正常運作。</p>
                                <div class="user-info">
                                    <p><strong>解決步驟:</strong></p>
                                    <ol style="text-align: left; margin: 10px 0;">
                                        <li>前往 <a href="https://console.firebase.google.com/project/expenses-91280/firestore/indexes" target="_blank">Firebase Console</a></li>
                                        <li>點擊「建立索引」</li>
                                        <li>設定集合: <code>records</code></li>
                                        <li>設定欄位: <code>userId</code> (升序), <code>date</code> (降序)</li>
                                        <li>等待索引建立完成（通常需要幾分鐘）</li>
                                        <li>重新整理此頁面</li>
                                    </ol>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="location.reload();" class="logout-btn" style="background: #3498db;">
                                        重新載入
                                    </button>
                                    <button onclick="window.location.href='enter_login.html';" class="logout-btn">
                                        返回登入
                                    </button>
                                </div>
                                <div style="margin-top: 20px; font-size: 0.9em; color: #999;">
                                    <p>如果問題持續發生，請聯繫技術支援</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // 顯示用戶資訊和登出按鈕
            showUserInfo(user) {
                const userInfo = document.getElementById('userInfo');
                const userEmail = document.getElementById('userEmail');
                const btnSignOut = document.getElementById('btnSignOut');
                
                if (userInfo && userEmail && btnSignOut) {
                    // 顯示用戶資訊
                    userInfo.style.display = 'flex';
                    userEmail.textContent = user.displayName || user.email;
                    
                    // 綁定登出按鈕事件
                    btnSignOut.onclick = async () => {
                        try {
                            console.log('開始登出...');
                            await window.firebaseSignOut(window.firebaseAuth);
                            console.log('登出成功');
                            window.location.href = 'enter_login.html';
                        } catch (error) {
                            console.error('登出失敗:', error);
                            this.showNotification('登出失敗，請重試', 'error');
                        }
                    };
                }
            }

            // 顯示未啟用使用者訊息
            // 顯示載入動畫
            showLoading(message = '載入中', submessage = '請稍候') {
                if (this.loadingText) this.loadingText.textContent = message;
                if (this.loadingSubtext) this.loadingSubtext.textContent = submessage;
                if (this.loadingOverlay) this.loadingOverlay.style.display = 'flex';
            }

            // 隱藏載入動畫
            hideLoading() {
                if (this.loadingOverlay) this.loadingOverlay.style.display = 'none';
            }

            showInactiveUserMessage(user) {
                // 隱藏所有輸入表單
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">⏳</div>
                                <h2>使用者尚未啟用</h2>
                                <p>親愛的 <strong>${user.displayName || user.email}</strong>，</p>
                                <p>您的帳號目前尚未啟用，請聯繫管理員進行啟用。</p>
                                <div class="user-info">
                                    <p><strong>Email:</strong> ${user.email}</p>
                                    <p><strong>狀態:</strong> 等待啟用</p>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="window.firebaseAuth.signOut(); window.location.href='enter_login.html';" class="logout-btn">
                                        登出
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // 等待 Firebase 載入
            waitForFirebase() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 50; // 5秒超時 (50 * 100ms)
                    
                    const checkFirebase = () => {
                        attempts++;
                        
                        // 首先檢查 firebaseLoaded 標記
                        if (window.firebaseLoaded) {
                            console.log(`Firebase SDK 載入完成，嘗試次數: ${attempts}`);
                            resolve();
                            return;
                        }
                        
                        // 檢查所有必要的Firebase函數
                        const requiredFunctions = [
                            'firebaseAuth', 'firebaseDb', 'firebaseCollection', 
                            'firebaseAddDoc', 'firebaseGetDocs', 'firebaseUpdateDoc', 
                            'firebaseDeleteDoc', 'firebaseDoc', 'firebaseSetDoc',
                            'firebaseQuery', 'firebaseOrderBy', 'firebaseWhere', 
                            'firebaseServerTimestamp', 'firebaseOnAuthStateChanged'
                        ];
                        
                        const loadedFunctions = requiredFunctions.filter(func => {
                            return window[func] && typeof window[func] === 'function';
                        });
                        
                        const missingFunctions = requiredFunctions.filter(func => !window[func]);
                        
                        console.log(`Firebase 載入檢查 (${attempts}/${maxAttempts}): 已載入 ${loadedFunctions.length}/${requiredFunctions.length} 個函數`);
                        
                        if (window.firebaseAuth && window.firebaseDb && loadedFunctions.length === requiredFunctions.length) {
                            console.log(`Firebase 載入成功，嘗試次數: ${attempts}`);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            console.error('Firebase 載入超時');
                            console.error('已載入的函數:', loadedFunctions);
                            console.error('缺少的函數:', missingFunctions);
                            reject(new Error(`Firebase SDK 載入超時，缺少函數: ${missingFunctions.join(', ')}`));
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    
                    checkFirebase();
                });
            }

            // 從 Firebase 載入記錄
            async loadRecordsFromFirebase() {
                try {
                    console.log('開始從 Firebase 載入記錄...');
                    const recordsRef = window.firebaseCollection(window.firebaseDb, 'records');
                    
                    // 使用 Firebase 原生查詢和排序（載入所有用戶的記錄）
                    const q = window.firebaseQuery(
                        recordsRef,
                        window.firebaseOrderBy('date', 'desc')
                    );
                    
                    const querySnapshot = await window.firebaseGetDocs(q);
                    this.records = [];
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        this.records.push({
                            id: doc.id,
                            type: data.type,
                            member: data.member,
                            mainCategory: data.mainCategory,
                            subCategory: data.subCategory,
                            amount: data.amount,
                            description: data.description,
                            date: data.date,
                            currency: data.currency
                        });
                    });
                    
                    console.log(`從 Firebase 載入了 ${this.records.length} 筆記錄（所有用戶，已按日期降序排列）`);
                    await this.updateDisplay();
                } catch (error) {
                    console.error('從 Firebase 載入記錄失敗:', error);
                    console.error('錯誤詳情:', {
                        message: error.message,
                        code: error.code,
                        userId: this.currentUser?.uid
                    });
                    
                    // 如果是索引錯誤，顯示提示而不是導向登入頁面
                    if (error.code === 'failed-precondition' && error.message.includes('index')) {
                        console.error('🔍 Firebase 索引問題，請檢查索引設定');
                        console.error('建議的索引設定:');
                        console.error('- 集合: records');
                        console.error('- 欄位: userId (升序), date (降序)');
                        
                        // 顯示錯誤訊息給使用者
                        this.showIndexError();
                    } else {
                        // 其他錯誤才導向登入頁面
                        window.location.href = 'enter_login.html';
                    }
                }
            }

            // 更新顯示
            async updateDisplay() {
                const filteredRecords = this.getCurrentFilteredRecords();
                this.displayRecords(filteredRecords);
                await this.updateSummary(filteredRecords);
            }

            // 顯示記錄
            displayRecords(records) {
                const recordsList = document.getElementById('recordsList');
                
                // 保存當前的篩選值，如果沒有設定則使用當前年月作為預設值
                const currentDate = new Date();
                const defaultYear = currentDate.getFullYear().toString();
                const defaultMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                
                const currentFilters = {
                    year: document.getElementById('tableFilterYear')?.value || defaultYear,
                    month: document.getElementById('tableFilterMonth')?.value || defaultMonth,
                    member: Array.from(document.getElementById('tableFilterMember')?.selectedOptions || []).map(option => option.value),
                    type: Array.from(document.getElementById('tableFilterType')?.selectedOptions || []).map(option => option.value),
                    mainCategory: Array.from(document.getElementById('tableFilterMainCategory')?.selectedOptions || []).map(option => option.value),
                    subCategory: Array.from(document.getElementById('tableFilterSubCategory')?.selectedOptions || []).map(option => option.value)
                };

                // 獲取所有可能的篩選選項（使用所有記錄，不是篩選後的記錄）
                const allMembers = [...new Set(this.records.map(r => r.member))];
                const allTypes = [...new Set(this.records.map(r => r.type))];
                const allMainCategories = [...new Set(this.records.map(r => r.mainCategory))];
                const allSubCategories = [...new Set(this.records.map(r => r.subCategory))];
                const allYears = [...new Set(this.records.map(r => r.date.split('-')[0]))].sort((a, b) => b - a);
                const allMonths = [...new Set(this.records.map(r => r.date.split('-')[1]))].sort((a, b) => a - b);

                // 生成篩選條件HTML
                const filterHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="margin-bottom: 10px;">
                            <h3 style="margin: 0; display: inline-block;">篩選條件</h3>
                            <button id="resetFilters" onclick="expenseTracker.resetFilters()" title="重置篩選條件" style="background: #6c757d; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 10px;">
                                🔄
                            </button>
                        </div>
                        <div class="filter-group">
                            <label for="tableFilterYear">年份：</label>
                            <select id="tableFilterYear" onchange="expenseTracker.handleTableFilterChange()" style="height: auto; min-height: auto;">
                                ${allYears.map(year => `<option value="${year}" ${currentFilters.year === year ? 'selected' : ''}>${year}</option>`).join('')}
                            </select>
                            
                            <label for="tableFilterMonth">月份：</label>
                            <select id="tableFilterMonth" onchange="expenseTracker.handleTableFilterChange()" style="height: auto; min-height: auto;">
                                ${allMonths.map(month => `<option value="${month}" ${currentFilters.month === month ? 'selected' : ''}>${month}月</option>`).join('')}
                            </select>
                            
                            <label for="tableFilterMember">家庭成員：</label>
                            <select id="tableFilterMember" onchange="expenseTracker.handleTableFilterChange()" multiple style="min-height: 80px;" onmousedown="expenseTracker.toggleOption(event)">
                                ${allMembers.map(member => `<option value="${member}" ${currentFilters.member && currentFilters.member.includes(member) ? 'selected' : ''}>${member}</option>`).join('')}
                            </select>
                            
                            <label for="tableFilterType">類型：</label>
                            <select id="tableFilterType" onchange="expenseTracker.handleTableFilterChange()" multiple style="min-height: 60px;" onmousedown="expenseTracker.toggleOption(event)">
                                ${allTypes.map(type => `<option value="${type}" ${currentFilters.type && currentFilters.type.includes(type) ? 'selected' : ''}>${type}</option>`).join('')}
                            </select>
                            
                            <label for="tableFilterMainCategory">類別：</label>
                            <select id="tableFilterMainCategory" onchange="expenseTracker.handleTableFilterChange()" multiple style="min-height: 100px;" onmousedown="expenseTracker.toggleOption(event)">
                                ${allMainCategories.map(cat => `<option value="${cat}" ${currentFilters.mainCategory && currentFilters.mainCategory.includes(cat) ? 'selected' : ''}>${cat}</option>`).join('')}
                            </select>
                            
                            <label for="tableFilterSubCategory">細項：</label>
                            <select id="tableFilterSubCategory" onchange="expenseTracker.handleTableFilterChange()" multiple style="min-height: 120px;" onmousedown="expenseTracker.toggleOption(event)">
                                ${allSubCategories.map(sub => `<option value="${sub}" ${currentFilters.subCategory && currentFilters.subCategory.includes(sub) ? 'selected' : ''}>${sub}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;
                
                if (records.length === 0) {
                    // 生成空表格HTML（保留標題）
                    const emptyTableHTML = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>家庭成員</th>
                                    <th>類型</th>
                                    <th>類別</th>
                                    <th>細項</th>
                                    <th>金額</th>
                                    <th>描述</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" style="padding: 40px; text-align: center; color: #999;">暫無記錄</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    recordsList.innerHTML = filterHTML + emptyTableHTML;
                    this.updatePagination(0);
                    return;
                }

                // 計算分頁
                const totalPages = Math.ceil(records.length / this.recordsPerPage);
                const startIndex = (this.currentPage - 1) * this.recordsPerPage;
                const endIndex = startIndex + this.recordsPerPage;
                const pageRecords = records.slice(startIndex, endIndex);

                // 生成表格HTML
                const tableHTML = `
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>家庭成員</th>
                                <th>類型</th>
                                <th>類別</th>
                                <th>細項</th>
                                <th>金額</th>
                                <th>描述</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pageRecords
                                .sort((a, b) => new Date(b.date) - new Date(a.date))
                                .map(record => {
                                    const amountClass = record.type === '收入' ? 'amount-income' : 
                                                       record.type === '支出' ? 'amount-expense' : 'amount-asset';
                                    const amountPrefix = record.type === '收入' ? '+' : 
                                                        record.type === '資產' ? '+' : '-';
                                    
                                    return `
                                        <tr>
                                            <td>${record.date}</td>
                                            <td>${record.member}</td>
                                            <td>${record.type}</td>
                                            <td>${record.mainCategory}</td>
                                            <td>${record.subCategory}</td>
                                            <td class="${amountClass}">${amountPrefix}$${this.formatNumber(record.amount)} (${record.currency || 'TWD'})</td>
                                            <td>${record.description || '-'}</td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="action-btn edit-btn" onclick="expenseTracker.editRecord('${record.id}')" title="編輯" style="padding: 2px 4px; font-size: 10px;"></button>
                                                    <button class="action-btn delete-btn" onclick="expenseTracker.deleteRecord('${record.id}')" title="刪除" style="padding: 2px 4px; font-size: 10px;"></button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                        </tbody>
                    </table>
                `;
                
                recordsList.innerHTML = filterHTML + tableHTML;
                this.updatePagination(records.length);
            }

            // 切換多選選項
            toggleOption(event) {
                event.preventDefault();
                const option = event.target;
                if (option.tagName === 'OPTION') {
                    option.selected = !option.selected;
                    // 觸發篩選更新
                    this.handleTableFilterToggle();
                }
            }

            // 顯示通知
            showNotification(message, type = 'success', duration = 3000) {
                const container = document.getElementById('notificationContainer');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    ${message}
                    <button class="close-btn" onclick="this.parentElement.remove()">×</button>
                `;
                
                container.appendChild(notification);
                
                // 觸發動畫
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                // 自動移除
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.classList.remove('show');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }

            // 更新摘要
            async updateSummary(filteredRecords) {
                // 按照幣別轉換為TWD金額進行統計計算
                let filteredIncome = 0;
                let filteredExpense = 0;
                
                for (const record of filteredRecords) {
                    const recordDate = new Date(record.date);
                    const rate = await this.getExchangeRateForDate(record.currency || 'TWD', recordDate);
                    
                    // 如果沒有找到歷史匯率，使用當前匯率作為備用
                    const finalRate = rate !== null ? rate : (this.exchangeRates[record.currency || 'TWD'] || 1);
                    const amountTWD = record.amount * finalRate;
                    
                    // 調試信息：顯示使用的匯率
                    if (record.currency && record.currency !== 'TWD') {
                        const rateSource = rate !== null ? '歷史匯率' : '當前匯率';
                        console.log(`💰 ${record.date} ${record.currency} ${record.amount} → TWD ${amountTWD.toFixed(2)} (${rateSource}: ${finalRate})`);
                    }
                    
                    if (record.type === '收入') {
                        filteredIncome += amountTWD;
                    } else if (record.type === '支出') {
                        filteredExpense += amountTWD;
                    }
                }
                
                const filteredNetIncome = filteredIncome - filteredExpense;
                
                // 更新顯示
                document.getElementById('monthlyIncome').textContent = '$' + this.formatNumber(filteredIncome);
                document.getElementById('monthlyExpense').textContent = '$' + this.formatNumber(filteredExpense);
                
                // 淨收入顯示
                const netIncomeElement = document.getElementById('monthlyNetIncome');
                netIncomeElement.textContent = '$' + this.formatNumber(Math.abs(filteredNetIncome));
                
                // 根據正負值設定顏色
                if (filteredNetIncome >= 0) {
                    netIncomeElement.className = 'amount net-income positive';
                } else {
                    netIncomeElement.className = 'amount net-income negative';
                }
                
                console.log(`篩選後統計: 收入 $${filteredIncome}, 支出 $${filteredExpense}, 淨收入 $${filteredNetIncome}`);
            }

            // 獲取當前篩選後的記錄
            getCurrentFilteredRecords() {
                // 獲取表格篩選器的值，如果沒有設定則使用當前年月作為預設值
                const currentDate = new Date();
                const defaultYear = currentDate.getFullYear().toString();
                const defaultMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                
                const yearFilter = document.getElementById('tableFilterYear')?.value || defaultYear;
                const monthFilter = document.getElementById('tableFilterMonth')?.value || defaultMonth;
                
                // 獲取多選的值
                const memberSelect = document.getElementById('tableFilterMember');
                const typeSelect = document.getElementById('tableFilterType');
                const mainCategorySelect = document.getElementById('tableFilterMainCategory');
                const subCategorySelect = document.getElementById('tableFilterSubCategory');
                
                const selectedMembers = Array.from(memberSelect?.selectedOptions || []).map(option => option.value);
                const selectedTypes = Array.from(typeSelect?.selectedOptions || []).map(option => option.value);
                const selectedMainCategories = Array.from(mainCategorySelect?.selectedOptions || []).map(option => option.value);
                const selectedSubCategories = Array.from(subCategorySelect?.selectedOptions || []).map(option => option.value);

                // 篩選記錄
                return this.records.filter(record => {
                    const recordYear = record.date.split('-')[0];
                    const recordMonth = record.date.split('-')[1];
                    
                    return (recordYear === yearFilter) &&
                           (recordMonth === monthFilter) &&
                           (selectedMembers.length === 0 || selectedMembers.includes(record.member)) &&
                           (selectedTypes.length === 0 || selectedTypes.includes(record.type)) &&
                           (selectedMainCategories.length === 0 || selectedMainCategories.includes(record.mainCategory)) &&
                           (selectedSubCategories.length === 0 || selectedSubCategories.includes(record.subCategory));
                });
            }

            // 包裝函數用於 HTML 事件處理
            async handleTableFilterChange() {
                await this.applyTableFilter(true);
            }
            
            async handleTableFilterToggle() {
                await this.applyTableFilter(true);
            }
            
            async handleUpdateDisplay() {
                await this.updateDisplay();
            }
            
            // 應用表格篩選
            async applyTableFilter(resetPage = true) {
                const filteredRecords = this.getCurrentFilteredRecords();

                // 只有在需要時才重置到第一頁
                if (resetPage) {
                    this.currentPage = 1;
                }
                this.displayRecords(filteredRecords);
                // 統計應該基於篩選後的記錄，與表格顯示保持一致
                await this.updateSummary(filteredRecords);
            }

            // 重置篩選條件
            async resetFilters() {
                // 取得當前年月作為預設值
                const currentDate = new Date();
                const defaultYear = currentDate.getFullYear().toString();
                const defaultMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                
                // 重置所有篩選選單到預設值
                const yearElement = document.getElementById('tableFilterYear');
                const monthElement = document.getElementById('tableFilterMonth');
                const memberElement = document.getElementById('tableFilterMember');
                const typeElement = document.getElementById('tableFilterType');
                const mainCategoryElement = document.getElementById('tableFilterMainCategory');
                const subCategoryElement = document.getElementById('tableFilterSubCategory');
                
                if (yearElement) yearElement.value = defaultYear;
                if (monthElement) monthElement.value = defaultMonth;
                
                // 重置多選欄位（清除所有選項）
                if (memberElement) {
                    Array.from(memberElement.options).forEach(option => option.selected = false);
                }
                if (typeElement) {
                    Array.from(typeElement.options).forEach(option => option.selected = false);
                }
                if (mainCategoryElement) {
                    Array.from(mainCategoryElement.options).forEach(option => option.selected = false);
                }
                if (subCategoryElement) {
                    Array.from(subCategoryElement.options).forEach(option => option.selected = false);
                }
                
                // 重新應用篩選
                await this.handleTableFilterChange();
            }

            // 更新分頁
            updatePagination(totalRecords) {
                const totalPages = Math.ceil(totalRecords / this.recordsPerPage);
                const pageInfo = document.getElementById('pageInfo');
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');
                
                // 更新頁面信息
                if (totalRecords === 0) {
                    pageInfo.textContent = '暫無記錄';
                } else {
                    const startRecord = (this.currentPage - 1) * this.recordsPerPage + 1;
                    const endRecord = Math.min(this.currentPage * this.recordsPerPage, totalRecords);
                    pageInfo.textContent = `第 ${this.currentPage} 頁，共 ${totalPages} 頁 (顯示 ${startRecord}-${endRecord} / ${totalRecords} 筆)`;
                }
                
                // 更新按鈕狀態
                prevBtn.disabled = this.currentPage <= 1;
                nextBtn.disabled = this.currentPage >= totalPages;
                
                // 如果當前頁超過總頁數，重置到第一頁
                if (this.currentPage > totalPages && totalPages > 0) {
                    this.currentPage = 1;
                    this.displayRecords(this.getCurrentFilteredRecords());
                }
            }

            // 顯示圖表彈窗
            showChartsModal() {
                console.log('顯示圖表彈窗');
                const modal = document.getElementById('chartsModal');
                if (modal) {
                    modal.style.display = 'block';
                    this.updateChartFilters();
                    this.updateCharts();
                } else {
                    console.error('找不到圖表彈窗元素');
                }
            }

            // 更新圖表篩選器
            updateChartFilters() {
                // 更新年份篩選器
                const chartFilterYear = document.getElementById('chartFilterYear');
                if (chartFilterYear) {
                    const allYears = [...new Set(this.records.map(r => r.date.split('-')[0]))].sort((a, b) => b - a);
                    chartFilterYear.innerHTML = '<option value="">所有年份</option>' + 
                        allYears.map(year => `<option value="${year}">${year}</option>`).join('');
                }
                
                // 更新月份篩選器
                const chartFilterMonth = document.getElementById('chartFilterMonth');
                if (chartFilterMonth) {
                    const allMonths = [...new Set(this.records.map(r => r.date.split('-')[1]))].sort((a, b) => a - b);
                    chartFilterMonth.innerHTML = '<option value="">所有月份</option>' + 
                        allMonths.map(month => {
                            const monthNames = ['', '1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                            return `<option value="${month}">${monthNames[parseInt(month)]}</option>`;
                        }).join('');
                }
            }

            // 隱藏圖表彈窗
            hideChartsModal() {
                console.log('隱藏圖表彈窗');
                const modal = document.getElementById('chartsModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // ========== 匯率管理功能 ==========
            
            // 每日匯率管理
            async getExchangeRateForDate(currency, date) {
                if (currency === 'TWD') {
                    return 1;
                }
                
                try {
                    const dateStr = this.formatDateForFirebase(date);
                    console.log(`🔍 查詢 ${currency} 在 ${dateStr} 的匯率`);
                    
                    const rateRef = window.firebaseDoc(window.firebaseDb, 'dailyExchangeRates', dateStr);
                    const rateDoc = await window.firebaseGetDoc(rateRef);
                    
                    console.log(`📄 文檔存在: ${rateDoc.exists()}`);
                    
                    if (rateDoc.exists()) {
                        const data = rateDoc.data();
                        console.log(`📊 文檔數據:`, data);
                        console.log(`💰 ${currency} 匯率:`, data.rates?.[currency]);
                        
                        // 如果找到該幣別的匯率，返回實際值
                        if (data.rates && data.rates[currency]) {
                            return data.rates[currency];
                        } else {
                            // 如果文檔存在但沒有該幣別的匯率，返回 null 表示未找到
                            console.log(`❌ 文檔存在但沒有 ${currency} 匯率`);
                            return null;
                        }
                    } else {
                        // 如果沒有該日期的匯率，返回 null 表示未找到
                        console.log(`❌ 沒有找到 ${dateStr} 的 ${currency} 匯率`);
                        return null;
                    }
                } catch (error) {
                    console.error('❌ 獲取歷史匯率失敗:', error);
                    console.error('🔍 查詢參數:', { currency, date, dateStr: this.formatDateForFirebase(date) });
                    return null;
                }
            }
            
            // 格式化日期為 Firebase 文檔 ID
            formatDateForFirebase(date) {
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            }
            
            // 保存每日匯率
            async saveDailyExchangeRates(rates, date = new Date()) {
                try {
                    const dateStr = this.formatDateForFirebase(date);
                    const rateRef = window.firebaseDoc(window.firebaseDb, 'dailyExchangeRates', dateStr);
                    
                    await window.firebaseSetDoc(rateRef, {
                        rates: rates,
                        date: dateStr,
                        updatedAt: window.firebaseServerTimestamp()
                    });
                    
                    console.log(`已保存 ${dateStr} 的匯率:`, rates);
                } catch (error) {
                    console.error('保存每日匯率失敗:', error);
                    throw error;
                }
            }
            
            // 從 API 取得匯率
            async fetchExchangeRateFromAPI(currency) {
                try {
                    // 使用免費的匯率 API (ExchangeRate-API)
                    const response = await fetch(`https://api.exchangerate-api.com/v4/latest/TWD`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // 計算對台幣的匯率 (API 回傳的是 1 TWD = ? 其他幣別)
                    // 我們需要的是 1 其他幣別 = ? TWD
                    const rate = 1 / data.rates[currency];
                    
                    if (!rate || rate <= 0) {
                        throw new Error(`無法取得 ${currency} 匯率`);
                    }
                    
                    return parseFloat(rate.toFixed(4));
                    
                } catch (error) {
                    console.error('API 取得匯率失敗:', error);
                    
                    // 備用方案：使用模擬數據
                    const mockRates = {
                        'USD': 30.5,
                        'EUR': 32.8,
                        'JPY': 0.21,
                        'CNY': 4.3
                    };
                    
                    if (mockRates[currency]) {
                        console.log(`使用模擬匯率: ${currency} = ${mockRates[currency]}`);
                        return mockRates[currency];
                    }
                    
                    throw error;
                }
            }
            
            // 手動更新匯率按鈕
            async fetchCurrentExchangeRate() {
                const currency = document.getElementById('currency').value;
                const exchangeRateInput = document.getElementById('exchangeRate');
                const refreshBtn = document.getElementById('refreshRateBtn');
                
                if (currency === 'TWD') {
                    this.showNotification('台幣不需要匯率轉換', 'info');
                    return;
                }
                
                // 顯示載入狀態
                refreshBtn.disabled = true;
                refreshBtn.textContent = '🔄 更新中...';
                exchangeRateInput.placeholder = '正在更新匯率...';
                
                try {
                    const rate = await this.fetchExchangeRateFromAPI(currency);
                    exchangeRateInput.value = rate.toFixed(4);
                    exchangeRateInput.placeholder = '匯率已更新';
                    
                    // 更新本地匯率快取
                    this.exchangeRates[currency] = rate;
                    
                    console.log(`已更新 ${currency} 匯率: ${rate}`);
                    this.showNotification(`${currency} 匯率已更新為 ${rate}`, 'success');
                    
                } catch (error) {
                    console.error('更新匯率失敗:', error);
                    exchangeRateInput.value = this.exchangeRates[currency] || 1;
                    exchangeRateInput.placeholder = '使用快取匯率';
                    this.showNotification(`無法取得 ${currency} 最新匯率，已使用快取數據`, 'warning');
                } finally {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = '🔄 更新匯率';
                }
            }
            
            showExchangeRates() {
                console.log('顯示匯率管理');
                const modal = document.getElementById('exchangeRateModal');
                if (modal) {
                    this.loadExchangeRates();
                    modal.style.display = 'block';
                    
                    // 設定匯率日期為今天（使用本地時間）
                    const today = new Date();
                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    console.log('📅 今天日期（本地時間）:', todayStr);
                    
                    const rateDateInput = document.getElementById('rateDate');
                    if (rateDateInput) {
                        rateDateInput.value = todayStr;
                        console.log('✅ 匯率日期已設定為:', rateDateInput.value);
                    }
                    
                    // 設定歷史查詢日期為前一天（使用本地時間）
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;
                    console.log('📅 昨天日期（本地時間）:', yesterdayStr);
                    
                    const historyDateInput = document.getElementById('historyDate');
                    if (historyDateInput) {
                        historyDateInput.value = yesterdayStr;
                        console.log('✅ 查詢日期已設定為:', historyDateInput.value);
                    }
                    
                    // 自動載入匯率日期的資料到編輯表單
                    setTimeout(() => {
                        this.loadRatesForDate();
                    }, 100); // 稍微延遲確保 DOM 元素已準備好
                }
            }
            
            hideExchangeRates() {
                console.log('隱藏匯率管理');
                const modal = document.getElementById('exchangeRateModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            // 載入指定日期的匯率
            async loadRatesForDate() {
                const dateInput = document.getElementById('rateDate');
                const loadButton = document.querySelector('button[onclick="expenseTracker.loadRatesForDate()"]');
                
                if (!dateInput.value) {
                    this.showNotification('請選擇匯率日期', 'warning');
                    return;
                }
                
                // 顯示 loading 狀態
                if (loadButton) {
                    loadButton.disabled = true;
                    loadButton.textContent = '🔄 載入中...';
                }
                
                // 顯示 loading 在輸入框
                const currencies = ['USD', 'EUR', 'JPY', 'CNY'];
                currencies.forEach(currency => {
                    const element = document.getElementById(`${currency.toLowerCase()}Rate`);
                    if (element) {
                        element.value = '';
                        element.placeholder = '載入中...';
                        element.disabled = true;
                    }
                });
                
                try {
                    const selectedDate = new Date(dateInput.value);
                    console.log(`🔍 載入 ${dateInput.value} 的匯率到編輯表單`);
                    
                    // 載入每個幣別的匯率
                    for (const currency of currencies) {
                        const rate = await this.getExchangeRateForDate(currency, selectedDate);
                        const element = document.getElementById(`${currency.toLowerCase()}Rate`);
                        if (element) {
                            if (rate !== null) {
                                element.value = rate.toFixed(4);
                                element.placeholder = `${currency} 匯率`;
                            } else {
                                element.value = '';
                                element.placeholder = '未找到該日期的匯率';
                            }
                            element.disabled = false;
                        }
                    }
                    
                    this.showNotification(`已載入 ${dateInput.value} 的匯率`, 'success');
                    
                } catch (error) {
                    console.error('載入匯率失敗:', error);
                    this.showNotification('載入匯率失敗', 'error');
                    
                    // 顯示錯誤狀態
                    currencies.forEach(currency => {
                        const element = document.getElementById(`${currency.toLowerCase()}Rate`);
                        if (element) {
                            element.value = '';
                            element.placeholder = '載入失敗';
                            element.disabled = false;
                        }
                    });
                } finally {
                    // 恢復按鈕狀態
                    if (loadButton) {
                        loadButton.disabled = false;
                        loadButton.textContent = '📅 載入該日期匯率';
                    }
                }
            }
            
            // 從Firebase載入匯率
            async loadExchangeRatesFromFirebase() {
                try {
                    console.log('從Firebase載入匯率...');
                    const exchangeRatesRef = window.firebaseCollection(window.firebaseDb, 'exchangeRates');
                    const q = window.firebaseQuery(exchangeRatesRef);
                    const querySnapshot = await window.firebaseGetDocs(q);
                    
                    if (!querySnapshot.empty) {
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            if (data.rates) {
                                // 如果資料是包裝在 rates 物件中
                                this.exchangeRates = {
                                    'USD': data.rates.USD || 30.0,
                                    'EUR': data.rates.EUR || 32.0,
                                    'JPY': data.rates.JPY || 0.2,
                                    'CNY': data.rates.CNY || 4.2
                                };
                            } else {
                                // 如果資料是直接存儲
                                this.exchangeRates = {
                                    'USD': data.USD || 30.0,
                                    'EUR': data.EUR || 32.0,
                                    'JPY': data.JPY || 0.2,
                                    'CNY': data.CNY || 4.2
                                };
                            }
                        });
                        console.log('從Firebase載入匯率成功:', this.exchangeRates);
                    } else {
                        console.log('Firebase中沒有匯率資料，使用預設值');
                    }
                } catch (error) {
                    console.error('從Firebase載入匯率失敗:', error);
                    throw error;
                }
            }

            async loadExchangeRates() {
                console.log('載入匯率資料:', this.exchangeRates);
                
                try {
                    // 從Firebase載入匯率
                    await this.loadExchangeRatesFromFirebase();
                } catch (error) {
                    console.error('從Firebase載入匯率失敗:', error);
                }
                
                // 載入當前匯率到表單
                const usdRateInput = document.getElementById('usdRate');
                const eurRateInput = document.getElementById('eurRate');
                const jpyRateInput = document.getElementById('jpyRate');
                const cnyRateInput = document.getElementById('cnyRate');
                
                if (usdRateInput) usdRateInput.value = this.exchangeRates.USD || 30.0;
                if (eurRateInput) eurRateInput.value = this.exchangeRates.EUR || 32.0;
                if (jpyRateInput) jpyRateInput.value = this.exchangeRates.JPY || 0.2;
                if (cnyRateInput) cnyRateInput.value = this.exchangeRates.CNY || 4.2;
                
                console.log('匯率表單已更新');
            }
            
            updateExchangeRate(currency) {
                const rateInput = document.getElementById(`${currency.toLowerCase()}Rate`);
                const newRate = parseFloat(rateInput.value);
                
                if (isNaN(newRate) || newRate <= 0) {
                    this.showNotification('請輸入有效的匯率', 'error');
                    return;
                }
                
                this.exchangeRates[currency] = newRate;
                console.log(`更新 ${currency} 匯率: ${newRate}`);
                this.showNotification(`${currency} 匯率已更新為 ${newRate}`, 'success');
            }
            
            async fetchLatestRates(event) {
                let button = null;
                let originalText = '🔄 自動更新匯率';
                
                try {
                    console.log('正在獲取最新匯率...');
                    
                    // 顯示載入狀態
                    button = event ? event.target : document.querySelector('button[onclick*="fetchLatestRates"]');
                    originalText = button ? button.textContent : '🔄 自動更新匯率';
                    if (button) {
                        button.disabled = true;
                        button.textContent = '🔄 更新中...';
                    }
                    
                    // 獲取所有幣別的最新匯率
                    const currencies = ['USD', 'EUR', 'JPY', 'CNY'];
                    const updatedRates = {};
                    
                    for (const currency of currencies) {
                        try {
                            const rate = await this.fetchExchangeRateFromAPI(currency);
                            updatedRates[currency] = rate;
                            console.log(`已獲取 ${currency} 匯率: ${rate}`);
                        } catch (error) {
                            console.error(`獲取 ${currency} 匯率失敗:`, error);
                            // 如果API失敗，保持現有匯率
                            updatedRates[currency] = this.exchangeRates[currency];
                        }
                    }
                    
                    // 更新匯率
                    Object.keys(updatedRates).forEach(currency => {
                        this.exchangeRates[currency] = updatedRates[currency];
                        const input = document.getElementById(`${currency.toLowerCase()}Rate`);
                        if (input) {
                            input.value = updatedRates[currency];
                        }
                    });
                    
                    // 保存今日匯率到每日匯率記錄
                    await this.saveDailyExchangeRates(updatedRates, new Date());
                    
                    this.showNotification('匯率已更新為最新數據', 'success');
                    
                } catch (error) {
                    console.error('獲取匯率失敗:', error);
                    this.showNotification('獲取匯率失敗，請稍後再試', 'error');
                } finally {
                    // 恢復按鈕狀態
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                }
            }
            
            async saveExchangeRates() {
                // 儲存匯率到 Firebase
                if (!this.isFirebaseReady) {
                    this.showNotification('系統尚未準備就緒', 'error');
                    return;
                }
                
                const dateInput = document.getElementById('rateDate');
                if (!dateInput.value) {
                    this.showNotification('請選擇匯率日期', 'warning');
                    return;
                }
                
                // 從表單中讀取最新的匯率值
                const usdRate = parseFloat(document.getElementById('usdRate').value) || 30.0;
                const eurRate = parseFloat(document.getElementById('eurRate').value) || 32.0;
                const jpyRate = parseFloat(document.getElementById('jpyRate').value) || 0.2;
                const cnyRate = parseFloat(document.getElementById('cnyRate').value) || 4.2;
                
                // 更新本地匯率資料
                const newRates = {
                    'USD': usdRate,
                    'EUR': eurRate,
                    'JPY': jpyRate,
                    'CNY': cnyRate
                };
                
                this.exchangeRates = newRates;
                
                console.log('準備儲存匯率:', this.exchangeRates);
                
                try {
                    // 保存當前匯率（向後兼容）
                    const exchangeRateRef = window.firebaseDoc(window.firebaseDb, 'exchangeRates', 'current');
                    await window.firebaseSetDoc(exchangeRateRef, {
                        rates: this.exchangeRates,
                        updatedAt: window.firebaseServerTimestamp()
                    });
                    
                    // 保存指定日期的匯率到每日匯率記錄
                    const selectedDate = new Date(dateInput.value);
                    await this.saveDailyExchangeRates(newRates, selectedDate);
                    
                    console.log('匯率已儲存到Firebase:', this.exchangeRates);
                    this.showNotification(`已儲存 ${dateInput.value} 的匯率`, 'success');
                    // 儲存成功後關閉視窗
                    this.hideExchangeRates();
                } catch (error) {
                    console.error('儲存匯率失敗:', error);
                    this.showNotification('儲存匯率失敗', 'error');
                }
            }
            
            // 一次性匯入歷史匯率（2019-01-01 到現在）
            async importHistoricalRates() {
                if (!this.isFirebaseReady) {
                    this.showNotification('系統尚未準備就緒', 'error');
                    return;
                }
                
                if (!confirm('確定要匯入 2019-01-01 到現在的歷史匯率嗎？這可能需要幾分鐘時間。')) {
                    return;
                }
                
                const startDate = new Date('2019-01-01');
                const endDate = new Date();
                const currencies = ['USD', 'EUR', 'JPY', 'CNY'];
                
                console.log('🚀 開始匯入歷史匯率...');
                console.log(`📅 日期範圍: ${startDate.toISOString().split('T')[0]} 到 ${endDate.toISOString().split('T')[0]}`);
                
                let successCount = 0;
                let errorCount = 0;
                let totalDays = 0;
                
                // 計算總天數
                const currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    totalDays++;
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                this.showNotification(`開始匯入 ${totalDays} 天的匯率資料...`, 'info');
                
                try {
                    // 逐日匯入匯率
                    const currentDate = new Date(startDate);
                    while (currentDate <= endDate) {
                        const dateStr = this.formatDateForFirebase(currentDate);
                        
                        try {
                            // 檢查是否已存在該日期的匯率
                            const existingRateRef = window.firebaseDoc(window.firebaseDb, 'dailyExchangeRates', dateStr);
                            const existingDoc = await window.firebaseGetDoc(existingRateRef);
                            
                            if (existingDoc.exists()) {
                                console.log(`⏭️ ${dateStr} 已存在，跳過`);
                                currentDate.setDate(currentDate.getDate() + 1);
                                continue;
                            }
                            
                            // 獲取該日期的匯率
                            const rates = {};
                            for (const currency of currencies) {
                                try {
                                    const rate = await this.fetchExchangeRateFromAPI(currency);
                                    rates[currency] = rate;
                                    console.log(`✅ ${dateStr} ${currency}: ${rate}`);
                                } catch (error) {
                                    console.log(`❌ ${dateStr} ${currency}: 獲取失敗，使用預設值`);
                                    rates[currency] = this.exchangeRates[currency] || 1;
                                }
                            }
                            
                            // 保存到 Firebase
                            await this.saveDailyExchangeRates(rates, currentDate);
                            successCount++;
                            
                            // 顯示進度
                            const progress = Math.round((successCount + errorCount) / totalDays * 100);
                            console.log(`📊 進度: ${progress}% (${successCount + errorCount}/${totalDays})`);
                            
                        } catch (error) {
                            console.error(`❌ ${dateStr} 匯入失敗:`, error);
                            errorCount++;
                        }
                        
                        currentDate.setDate(currentDate.getDate() + 1);
                        
                        // 避免過於頻繁的 API 調用
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    this.showNotification(`匯入完成！成功: ${successCount} 天，失敗: ${errorCount} 天`, 'success');
                    
                } catch (error) {
                    console.error('❌ 匯入歷史匯率失敗:', error);
                    this.showNotification('匯入歷史匯率失敗', 'error');
                }
            }
            
            // 自動補足缺少的匯率
            async autoFillMissingRates() {
                if (!this.isFirebaseReady) {
                    this.showNotification('系統尚未準備就緒', 'error');
                    return;
                }
                
                try {
                    console.log('🔍 查詢最大日期...');
                    
                    // 查詢 Firebase 中的最大日期
                    const dailyRatesRef = window.firebaseCollection(window.firebaseDb, 'dailyExchangeRates');
                    const q = window.firebaseQuery(dailyRatesRef);
                    const querySnapshot = await window.firebaseGetDocs(q);
                    
                    let maxDate = null;
                    querySnapshot.forEach((doc) => {
                        const dateStr = doc.id;
                        const date = new Date(dateStr);
                        if (!maxDate || date > maxDate) {
                            maxDate = date;
                        }
                    });
                    
                    if (!maxDate) {
                        this.showNotification('沒有找到任何匯率記錄', 'warning');
                        return;
                    }
                    
                    console.log(`📅 最大日期: ${this.formatDateForFirebase(maxDate)}`);
                    
                    // 從最大日期的下一天開始補足到今天
                    const startDate = new Date(maxDate);
                    startDate.setDate(startDate.getDate() + 1);
                    const endDate = new Date();
                    
                    if (startDate > endDate) {
                        this.showNotification('匯率資料已是最新', 'info');
                        return;
                    }
                    
                    const currencies = ['USD', 'EUR', 'JPY', 'CNY'];
                    let successCount = 0;
                    let errorCount = 0;
                    
                    console.log(`🚀 開始補足 ${this.formatDateForFirebase(startDate)} 到 ${this.formatDateForFirebase(endDate)} 的匯率...`);
                    
                    const currentDate = new Date(startDate);
                    while (currentDate <= endDate) {
                        const dateStr = this.formatDateForFirebase(currentDate);
                        
                        try {
                            // 獲取該日期的匯率
                            const rates = {};
                            for (const currency of currencies) {
                                try {
                                    const rate = await this.fetchExchangeRateFromAPI(currency);
                                    rates[currency] = rate;
                                } catch (error) {
                                    rates[currency] = this.exchangeRates[currency] || 1;
                                }
                            }
                            
                            // 保存到 Firebase
                            await this.saveDailyExchangeRates(rates, currentDate);
                            successCount++;
                            console.log(`✅ ${dateStr} 匯率已補足`);
                            
                        } catch (error) {
                            console.error(`❌ ${dateStr} 補足失敗:`, error);
                            errorCount++;
                        }
                        
                        currentDate.setDate(currentDate.getDate() + 1);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    this.showNotification(`補足完成！成功: ${successCount} 天，失敗: ${errorCount} 天`, 'success');
                    
                } catch (error) {
                    console.error('❌ 補足匯率失敗:', error);
                    this.showNotification('補足匯率失敗', 'error');
                }
            }
            
            // 調試函數：檢查 Firebase 中的每日匯率數據
            async debugDailyExchangeRates() {
                try {
                    console.log('🔍 檢查 Firebase 中的每日匯率數據...');
                    const dailyRatesRef = window.firebaseCollection(window.firebaseDb, 'dailyExchangeRates');
                    const q = window.firebaseQuery(dailyRatesRef);
                    const querySnapshot = await window.firebaseGetDocs(q);
                    
                    console.log(`📊 找到 ${querySnapshot.size} 筆每日匯率記錄:`);
                    
                    querySnapshot.forEach((doc) => {
                        console.log(`📅 日期: ${doc.id}`);
                        console.log(`📋 數據:`, doc.data());
                    });
                    
                    if (querySnapshot.empty) {
                        console.log('❌ Firebase 中沒有每日匯率記錄');
                    }
                } catch (error) {
                    console.error('❌ 檢查每日匯率數據失敗:', error);
                }
            }
            
            // 載入歷史匯率
            async loadHistoryRates() {
                const dateInput = document.getElementById('historyDate');
                const historyDisplay = document.getElementById('historyRatesDisplay');
                const loadButton = document.querySelector('button[onclick="expenseTracker.loadHistoryRates()"]');
                
                if (!dateInput.value) {
                    this.showNotification('請選擇查詢日期', 'warning');
                    return;
                }
                
                // 顯示 loading 狀態
                if (loadButton) {
                    loadButton.disabled = true;
                    loadButton.textContent = '🔄 載入中...';
                }
                
                // 顯示 loading 在匯率顯示區域
                const currencies = ['USD', 'EUR', 'JPY', 'CNY'];
                currencies.forEach(currency => {
                    const elementId = `history${currency.charAt(0)}${currency.slice(1).toLowerCase()}Rate`;
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = '載入中...';
                        element.style.color = '#666';
                    }
                });
                
                try {
                    const selectedDate = new Date(dateInput.value);
                    console.log(`🔍 載入歷史匯率 - 選擇的日期: ${dateInput.value}`);
                    console.log(`📅 轉換後的日期對象:`, selectedDate);
                    
                    // 先檢查 Firebase 中的數據
                    await this.debugDailyExchangeRates();
                    
                    // 載入每個幣別的歷史匯率
                    for (const currency of currencies) {
                        console.log(`🔄 開始載入 ${currency} 匯率...`);
                        const rate = await this.getExchangeRateForDate(currency, selectedDate);
                        console.log(`💰 獲得的 ${currency} 匯率: ${rate}`);
                        
                        const elementId = `history${currency.charAt(0)}${currency.slice(1).toLowerCase()}Rate`;
                        const element = document.getElementById(elementId);
                        console.log(`🎯 查找元素 ID: ${elementId}`);
                        console.log(`🎯 找到元素:`, element);
                        
                        if (element) {
                            if (rate !== null) {
                                element.textContent = rate.toFixed(4);
                                element.style.color = '#000';
                                console.log(`✅ 已設定 ${currency} 顯示值: ${rate.toFixed(4)}`);
                            } else {
                                element.textContent = '-';
                                element.style.color = '#999';
                                console.log(`❌ ${currency} 匯率未找到，顯示: -`);
                            }
                        } else {
                            console.error(`❌ 找不到元素 ${elementId}`);
                        }
                    }
                    
                    historyDisplay.style.display = 'block';
                    console.log(`📺 歷史匯率顯示區域已顯示:`, historyDisplay);
                    console.log(`📺 顯示區域的 display 樣式:`, historyDisplay.style.display);
                    this.showNotification(`已載入 ${dateInput.value} 的歷史匯率`, 'success');
                    
                } catch (error) {
                    console.error('載入歷史匯率失敗:', error);
                    this.showNotification('載入歷史匯率失敗', 'error');
                    
                    // 顯示錯誤狀態
                    currencies.forEach(currency => {
                        const elementId = `history${currency.charAt(0)}${currency.slice(1).toLowerCase()}Rate`;
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.textContent = '載入失敗';
                            element.style.color = '#dc3545';
                        }
                    });
                } finally {
                    // 恢復按鈕狀態
                    if (loadButton) {
                        loadButton.disabled = false;
                        loadButton.textContent = '📅 載入歷史匯率';
                    }
                }
            }
            
            // ========== 資產組合管理功能 ==========
            
            // 自動計算購買平均成本價
            calculateUnitPrice() {
                const quantity = parseFloat(document.getElementById('assetQuantity').value) || 0;
                const cost = parseFloat(document.getElementById('assetCost').value) || 0;
                const unitPriceInput = document.getElementById('assetUnitPrice');
                
                if (quantity > 0 && cost > 0) {
                    const unitPrice = cost / quantity;
                    unitPriceInput.value = unitPrice.toFixed(4);
                    unitPriceInput.style.backgroundColor = '#f0f8ff';
                } else {
                    unitPriceInput.value = '';
                    unitPriceInput.style.backgroundColor = '';
                }
            }
            
            showAssetPortfolio() {
                console.log('顯示資產組合管理');
                const modal = document.getElementById('assetPortfolioModal');
                if (modal) {
                    this.loadAssets();
                    modal.style.display = 'block';
                    
                    // 添加拖拉排序功能
                    this.initDragAndDrop();
                }
            }
            
            hideAssetPortfolio() {
                console.log('隱藏資產組合管理');
                const modal = document.getElementById('assetPortfolioModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            async loadAssets() {
                console.log('開始載入資產...');
                console.log('Firebase 準備狀態:', this.isFirebaseReady);
                console.log('當前使用者:', this.currentUser);
                
                if (!this.isFirebaseReady) {
                    this.showNotification('系統尚未準備就緒', 'error');
                    return;
                }
                
                if (!this.currentUser) {
                    this.showNotification('請先登入', 'error');
                    return;
                }
                
                try {
                    console.log('正在連接 Firebase assets 集合...');
                    
                    // 嘗試載入資產，如果集合不存在則創建空陣列
                    try {
                        const assetsRef = window.firebaseCollection(window.firebaseDb, 'assets');
                        console.log('Assets 集合參考:', assetsRef);
                        
                        const querySnapshot = await window.firebaseGetDocs(assetsRef);
                        console.log('查詢結果:', querySnapshot);
                        console.log('文件數量:', querySnapshot.size);
                        
                        this.assets = [];
                        querySnapshot.forEach(doc => {
                            console.log('處理文件:', doc.id, doc.data());
                            this.assets.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // 按 order 欄位排序，如果沒有 order 則按創建時間排序
                        this.assets.sort((a, b) => {
                            const orderA = a.order !== undefined ? a.order : 999999;
                            const orderB = b.order !== undefined ? b.order : 999999;
                            return orderA - orderB;
                        });
                        
                        console.log('載入的資產（已排序）:', this.assets);
                        
                    } catch (collectionError) {
                        console.log('Assets 集合可能不存在或無權限，使用空陣列:', collectionError);
                        this.assets = [];
                    }
                    
                    this.renderAssetsTable();
                    this.updatePortfolioSummary();
                    
                } catch (error) {
                    console.error('載入資產失敗:', error);
                    console.error('錯誤詳情:', {
                        message: error.message,
                        code: error.code,
                        stack: error.stack
                    });
                    
                    // 提供更詳細的錯誤訊息
                    let errorMessage = '載入資產失敗';
                    if (error.code === 'permission-denied') {
                        errorMessage = '權限不足，請檢查 Firebase 權限設定';
                    } else if (error.code === 'unavailable') {
                        errorMessage = '網路連線問題，請檢查網路連線';
                    } else if (error.message) {
                        errorMessage = `載入資產失敗: ${error.message}`;
                    }
                    
                    this.showNotification(errorMessage, 'error');
                }
            }
            
            // 初始化拖拉排序功能
            initDragAndDrop() {
                const tbody = document.getElementById('assetsTableBody');
                if (!tbody) return;
                
                // 清除舊的事件監聽器
                const existingRows = tbody.querySelectorAll('tr[data-asset-id]');
                existingRows.forEach(row => {
                    row.removeEventListener('dragstart', this.handleDragStart);
                    row.removeEventListener('dragend', this.handleDragEnd);
                    row.removeEventListener('dragover', this.handleDragOver);
                    row.removeEventListener('drop', this.handleDrop);
                });
                
                // 為每個資產行添加拖拉功能
                const rows = tbody.querySelectorAll('tr[data-asset-id]');
                rows.forEach(row => {
                    row.draggable = true;
                    row.classList.add('draggable-row');
                    
                    // 添加拖拉手把
                    const firstCell = row.querySelector('td:first-child');
                    if (firstCell && !firstCell.querySelector('.drag-handle')) {
                        const dragHandle = document.createElement('span');
                        dragHandle.className = 'drag-handle';
                        dragHandle.innerHTML = '⋮⋮';
                        dragHandle.title = '拖拉排序';
                        dragHandle.style.cursor = 'grab';
                        dragHandle.draggable = false; // 防止手把本身被拖拉
                        firstCell.insertBefore(dragHandle, firstCell.firstChild);
                    }
                    
                    // 綁定拖拉事件
                    row.addEventListener('dragstart', this.handleDragStart.bind(this));
                    row.addEventListener('dragend', this.handleDragEnd.bind(this));
                    row.addEventListener('dragover', this.handleDragOver.bind(this));
                    row.addEventListener('drop', this.handleDrop.bind(this));
                });
            }
            
            // 拖拉開始事件
            handleDragStart(e) {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
                e.target.classList.add('dragging');
                console.log('開始拖拉:', e.target.getAttribute('data-asset-id'));
                console.log('拖拉目標:', e.target);
            }
            
            // 拖拉結束事件
            handleDragEnd(e) {
                e.target.classList.remove('dragging');
                console.log('拖拉結束');
            }
            
            // 拖拉懸停事件
            handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                console.log('拖拉懸停:', e.target);
            }
            
            // 拖拉放置事件
            handleDrop(e) {
                e.preventDefault();
                const draggedRow = document.querySelector('.dragging');
                const targetRow = e.target.closest('tr[data-asset-id]');
                
                console.log('拖拉放置事件觸發');
                console.log('被拖拉的行:', draggedRow);
                console.log('目標行:', targetRow);
                console.log('事件目標:', e.target);
                
                if (draggedRow && targetRow && draggedRow !== targetRow) {
                    console.log('放置到:', targetRow.getAttribute('data-asset-id'));
                    this.handleRowDrop(draggedRow, targetRow);
                } else {
                    console.log('放置條件不滿足');
                }
            }
            
            // 處理行拖拉放置
            handleRowDrop(draggedRow, targetRow) {
                const tbody = document.getElementById('assetsTableBody');
                const draggedId = draggedRow.getAttribute('data-asset-id');
                const targetId = targetRow.getAttribute('data-asset-id');
                
                console.log('拖拉放置:', draggedId, '到', targetId);
                
                // 移除被拖拉的行
                draggedRow.remove();
                
                // 將拖拉的行插入到目標位置
                tbody.insertBefore(draggedRow, targetRow);
                
                console.log('DOM 更新完成');
                
                // 更新資產順序
                this.updateAssetOrder();
            }
            
            // 更新資產順序到 Firestore
            async updateAssetOrder() {
                const tbody = document.getElementById('assetsTableBody');
                const rows = tbody.querySelectorAll('tr[data-asset-id]');
                
                try {
                    // 批量更新順序
                    const updates = [];
                    rows.forEach((row, index) => {
                        const assetId = row.getAttribute('data-asset-id');
                        const asset = this.assets.find(a => a.id === assetId);
                        if (asset) {
                            updates.push({
                                id: assetId,
                                order: index
                            });
                        }
                    });
                    
                    // 更新 Firestore
                    for (const update of updates) {
                        const assetRef = window.firebaseDoc(window.firebaseDb, 'assets', update.id);
                        await window.firebaseUpdateDoc(assetRef, {
                            order: update.order,
                            updatedAt: window.firebaseServerTimestamp()
                        });
                    }
                    
                    console.log('✅ 資產順序已更新');
                    
                } catch (error) {
                    console.error('❌ 更新資產順序失敗:', error);
                    this.showNotification('更新順序失敗，請重試', 'error');
                }
            }
            
            renderAssetsTable() {
                const tbody = document.getElementById('assetsTableBody');
                if (!tbody) return;
                
                if (this.assets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">尚無資產記錄</td></tr>';
                    return;
                }
                
                const tableHTML = this.assets.map(asset => {
                    const purchasePrice = asset.purchasePrice || asset.unitPrice || 1;
                    const currentPrice = asset.currentPrice || purchasePrice;
                    const quantity = asset.quantity;
                    
                    // 計算損益
                    const costBasis = quantity * purchasePrice;
                    const currentValue = quantity * currentPrice;
                    const profitLoss = currentValue - costBasis;
                    const profitLossPercent = costBasis > 0 ? (profitLoss / costBasis) * 100 : 0;
                    
                    // 轉換為台幣（使用購買日期的匯率）
                    const purchaseDate = asset.purchaseDate ? new Date(asset.purchaseDate) : null;
                    const costBasisTWD = this.convertToTWD(costBasis, asset.currency, 1, purchaseDate);
                    const currentValueTWD = this.convertToTWD(currentValue, asset.currency);
                    const profitLossTWD = currentValueTWD - costBasisTWD;
                    
                    // 損益顏色
                    const pnlClass = profitLoss >= 0 ? 'profit' : 'loss';
                    const pnlSign = profitLoss >= 0 ? '+' : '';
                    
                    return `
                        <tr data-asset-id="${asset.id}">
                            <td class="operation-cell">
                                ${asset.type === '股票' && asset.stockCode ? 
                                    `<button onclick="expenseTracker.updateCurrentPrice('${asset.id}')" class="btn-update" title="取得最新價格" data-update-price="${asset.id}">📈 更新股價</button>` : 
                                    '<span style="color: #999;">-</span>'
                                }
                            </td>
                            <td>${asset.name}</td>
                            <td>${asset.stockCode || '-'}</td>
                            <td>${asset.type}</td>
                            <td>${this.formatNumber(quantity)}</td>
                            <td>${asset.currency} ${purchasePrice.toFixed(2)}</td>
                            <td>${asset.currency} ${currentPrice.toFixed(2)}</td>
                            <td>NT$ ${this.formatNumber(costBasisTWD)}</td>
                            <td>NT$ ${this.formatNumber(currentValueTWD)}</td>
                            <td class="${pnlClass}">${pnlSign}NT$ ${this.formatNumber(Math.abs(profitLossTWD))}</td>
                            <td class="${pnlClass}">${pnlSign}${profitLossPercent.toFixed(2)}%</td>
                            <td class="operation-cell">
                                <div class="btn-group">
                                    <button onclick="expenseTracker.editAsset('${asset.id}')" class="btn-edit" title="編輯">✏️</button>
                                    <button onclick="expenseTracker.deleteAsset('${asset.id}')" class="btn-delete" title="刪除">🗑️</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                tbody.innerHTML = tableHTML;
                
                // 重新初始化拖拉功能
                this.initDragAndDrop();
            }
            
            updatePortfolioSummary() {
                let totalValue = 0;
                let totalCost = 0;
                
                this.assets.forEach(asset => {
                    const quantity = parseFloat(asset.quantity) || 0;
                    const purchasePrice = parseFloat(asset.purchasePrice) || parseFloat(asset.unitPrice) || 0;
                    const currentPrice = parseFloat(asset.currentPrice) || purchasePrice;
                    
                    // 計算成本（台幣，使用購買日期的匯率）
                    const cost = quantity * purchasePrice;
                    const purchaseDate = asset.purchaseDate ? new Date(asset.purchaseDate) : null;
                    const costTWD = this.convertToTWD(cost, asset.currency, 1, purchaseDate);
                    totalCost += costTWD;
                    
                    // 計算當前價值（台幣，使用當前匯率）
                    const currentValue = quantity * currentPrice;
                    const currentValueTWD = this.convertToTWD(currentValue, asset.currency);
                    totalValue += currentValueTWD;
                });
                
                // 計算總損益
                const totalProfitLoss = totalValue - totalCost;
                
                // 更新顯示
                document.getElementById('portfolioTotalValue').textContent = '$' + this.formatNumber(totalValue);
                document.getElementById('portfolioTotalCost').textContent = '$' + this.formatNumber(totalCost);
                
                // 損益顯示（正數顯示綠色，負數顯示紅色）
                const profitLossElement = document.getElementById('portfolioTotalProfitLoss');
                if (profitLossElement) {
                    const sign = totalProfitLoss >= 0 ? '+' : '';
                    profitLossElement.textContent = sign + '$' + this.formatNumber(Math.abs(totalProfitLoss));
                    profitLossElement.className = totalProfitLoss >= 0 ? 'amount profit' : 'amount loss';
                }
                
                // 更新標題中的資產項目數
                const assetCountDisplay = document.getElementById('assetCountDisplay');
                if (assetCountDisplay) {
                    assetCountDisplay.textContent = `(${this.assets.length} 項)`;
                }
            }
            
            convertToTWD(quantity, currency, unitPrice = 1, date = null) {
                if (currency === 'TWD') {
                    return quantity * unitPrice;
                }
                
                // 如果沒有指定日期，使用當前匯率
                if (!date) {
                    const rate = this.exchangeRates[currency] || 1;
                    return quantity * unitPrice * rate;
                }
                
                // 使用指定日期的匯率（異步處理）
                this.getExchangeRateForDate(currency, date).then(rate => {
                    if (rate !== null) {
                        return quantity * unitPrice * rate;
                    } else {
                        // 如果沒有找到歷史匯率，使用當前匯率
                        console.log(`使用當前匯率作為備用: ${this.exchangeRates[currency]}`);
                        return quantity * unitPrice * (this.exchangeRates[currency] || 1);
                    }
                }).catch(error => {
                    console.error('獲取歷史匯率失敗，使用當前匯率:', error);
                    const rate = this.exchangeRates[currency] || 1;
                    return quantity * unitPrice * rate;
                });
                
                // 暫時使用當前匯率，避免阻塞
                const rate = this.exchangeRates[currency] || 1;
                return quantity * unitPrice * rate;
            }
            
            showAddAssetForm() {
                const modal = document.getElementById('addAssetModal');
                if (modal) {
                    // 確保是新增模式
                    this.editingAssetId = null;
                    
                    // 重置表單
                    document.getElementById('addAssetForm').reset();
                    
                    // 重置表單標題和按鈕文字
                    const modalTitle = document.querySelector('#addAssetModal .modal-header h2');
                    if (modalTitle) {
                        modalTitle.textContent = '➕ 新增資產';
                    }
                    
                    const submitBtn = document.querySelector('#addAssetForm button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = '新增資產';
                    }
                    
                    // 隱藏所有動態欄位
                    document.getElementById('currentPriceGroup').style.display = 'none';
                    document.getElementById('purchaseDateGroup').style.display = 'none';
                    document.getElementById('stockCodeGroup').style.display = 'none';
                    document.getElementById('exchangeRateGroup').style.display = 'none';
                    
                    modal.style.display = 'block';
                }
            }
            
            hideAddAssetForm() {
                const modal = document.getElementById('addAssetModal');
                if (modal) {
                    modal.style.display = 'none';
                    document.getElementById('addAssetForm').reset();
                    
                    // 重置編輯模式
                    this.editingAssetId = null;
                    
                    // 重置表單標題和按鈕文字
                    const modalTitle = document.querySelector('#addAssetModal .modal-header h2');
                    if (modalTitle) {
                        modalTitle.textContent = '➕ 新增資產';
                    }
                    
                    const submitBtn = document.querySelector('#addAssetForm button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = '新增資產';
                    }
                    
                    // 重置購買平均成本價欄位樣式
                    const unitPriceInput = document.getElementById('assetUnitPrice');
                    if (unitPriceInput) {
                        unitPriceInput.style.backgroundColor = '';
                    }
                    
                    // 隱藏所有動態欄位
                    document.getElementById('currentPriceGroup').style.display = 'none';
                    document.getElementById('purchaseDateGroup').style.display = 'none';
                    document.getElementById('stockCodeGroup').style.display = 'none';
                    document.getElementById('exchangeRateGroup').style.display = 'none';
                }
            }
            
            async addAsset() {
                // 提交前確保購買平均成本價已計算
                this.calculateUnitPrice();
                
                const quantity = parseFloat(document.getElementById('assetQuantity').value);
                const cost = parseFloat(document.getElementById('assetCost').value);
                const unitPrice = parseFloat(document.getElementById('assetUnitPrice').value);
                
                // 驗證必要欄位
                if (!quantity || quantity <= 0 || !cost || cost <= 0 || !unitPrice || unitPrice <= 0) {
                    this.showNotification('請確認股數、總成本和購買平均成本價都已正確填寫且大於0', 'error');
                    return;
                }
                
                const formData = {
                    name: document.getElementById('assetName').value,
                    type: document.getElementById('assetType').value,
                    quantity: quantity,
                    currency: document.getElementById('assetCurrency').value,
                    cost: cost, // 新增總成本欄位
                    purchasePrice: unitPrice,
                    currentPrice: parseFloat(document.getElementById('assetCurrentPrice').value) || null,
                    purchaseDate: document.getElementById('assetPurchaseDate').value || null,
                    stockCode: document.getElementById('assetStockCode').value || null,
                    description: document.getElementById('assetDescription').value,
                    updatedAt: window.firebaseServerTimestamp()
                };
                
                try {
                    if (this.editingAssetId) {
                        // 編輯模式：更新現有資產
                        const assetRef = window.firebaseDoc(window.firebaseDb, 'assets', this.editingAssetId);
                        await window.firebaseUpdateDoc(assetRef, formData);
                        
                        console.log('資產更新成功');
                        this.showNotification('資產更新成功', 'success');
                        
                        // 清除編輯模式
                        this.editingAssetId = null;
                    } else {
                        // 新增模式：建立新資產
                        formData.createdAt = window.firebaseServerTimestamp();
                        formData.order = this.assets.length; // 新資產排在最後
                        const assetsRef = window.firebaseCollection(window.firebaseDb, 'assets');
                        await window.firebaseAddDoc(assetsRef, formData);
                        
                        console.log('資產新增成功');
                        this.showNotification('資產新增成功', 'success');
                    }
                    
                    // 重新載入資產列表
                    await this.loadAssets();
                    
                    // 關閉表單
                    this.hideAddAssetForm();
                    
                } catch (error) {
                    console.error('資產操作失敗:', error);
                    this.showNotification('資產操作失敗', 'error');
                }
            }
            
            editAsset(assetId) {
                console.log('編輯資產 ID:', assetId);
                console.log('當前資產列表:', this.assets);
                
                const asset = this.assets.find(a => a.id === assetId);
                console.log('找到的資產:', asset);
                
                if (!asset) {
                    this.showNotification('找不到要編輯的資產', 'error');
                    return;
                }
                
                // 設定編輯模式
                this.editingAssetId = assetId;
                
                // 先顯示表單（不重置）
                const modal = document.getElementById('addAssetModal');
                if (modal) {
                    modal.style.display = 'block';
                }
                
                // 預填表單資料
                document.getElementById('assetName').value = asset.name || '';
                document.getElementById('assetType').value = asset.type || '';
                document.getElementById('assetQuantity').value = asset.quantity || '';
                document.getElementById('assetCurrency').value = asset.currency || 'TWD';
                document.getElementById('assetCost').value = asset.cost || (asset.purchasePrice * asset.quantity) || '';
                document.getElementById('assetUnitPrice').value = asset.purchasePrice || asset.unitPrice || '';
                document.getElementById('assetCurrentPrice').value = asset.currentPrice || '';
                document.getElementById('assetPurchaseDate').value = asset.purchaseDate || '';
                document.getElementById('assetStockCode').value = asset.stockCode || '';
                document.getElementById('assetDescription').value = asset.description || '';
                
                console.log('表單預填完成');
                
                // 觸發類型變更事件以顯示/隱藏相關欄位
                const typeEvent = new Event('change');
                document.getElementById('assetType').dispatchEvent(typeEvent);
                
                // 觸發幣別變更事件以顯示/隱藏匯率欄位
                const currencyEvent = new Event('change');
                document.getElementById('assetCurrency').dispatchEvent(currencyEvent);
                
                // 更新表單標題
                const modalTitle = document.querySelector('#addAssetModal .modal-header h2');
                if (modalTitle) {
                    modalTitle.textContent = '✏️ 編輯資產';
                }
                
                // 更新提交按鈕文字
                const submitBtn = document.querySelector('#addAssetForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = '更新資產';
                }
                
                console.log('編輯資產:', asset);
            }
            
            async deleteAsset(assetId) {
                if (!confirm('確定要刪除此資產嗎？')) {
                    return;
                }
                
                try {
                    const assetRef = window.firebaseDoc(window.firebaseDb, 'assets', assetId);
                    await window.firebaseDeleteDoc(assetRef);
                    
                    console.log('資產刪除成功');
                    this.showNotification('資產刪除成功', 'success');
                    
                    this.loadAssets();
                } catch (error) {
                    console.error('刪除資產失敗:', error);
                    this.showNotification('刪除資產失敗', 'error');
                }
            }

            // ========== 股票價格功能 ==========
            
            // 股票價格更新功能
            async fetchCurrentStockPrice() {
                const assetName = document.getElementById('assetName').value;
                const assetType = document.getElementById('assetType').value;
                const stockCode = document.getElementById('assetStockCode').value;
                const currentPriceInput = document.getElementById('assetCurrentPrice');
                const fetchBtn = document.getElementById('fetchCurrentPriceBtn');
                
                if (assetType !== '股票') {
                    this.showNotification('此功能僅適用於股票', 'warning');
                    return;
                }
                
                if (!assetName) {
                    this.showNotification('請先輸入股票名稱', 'error');
                    return;
                }
                
                if (!stockCode) {
                    this.showNotification('請先輸入股票代碼', 'error');
                    return;
                }
                
                // 顯示載入狀態
                fetchBtn.disabled = true;
                fetchBtn.textContent = '📈 取得中...';
                
                try {
                    // 根據股票代碼取得價格
                    const stockData = await this.getStockPrice(stockCode);
                    currentPriceInput.value = stockData.price.toFixed(2);
                    
                    // 同時更新幣別欄位
                    const currencySelect = document.getElementById('assetCurrency');
                    currencySelect.value = stockData.currency;
                    
                    // 觸發幣別變更事件
                    const currencyEvent = new Event('change');
                    currencySelect.dispatchEvent(currencyEvent);
                    
                    console.log(`取得 ${stockCode} (${assetName}) 最新價格: ${stockData.price.toFixed(2)} ${stockData.currency}`);
                    this.showNotification(`${stockCode} (${assetName}) 最新價格: ${stockData.price.toFixed(2)} ${stockData.currency}`, 'success');
                    
                } catch (error) {
                    console.error('取得股票價格失敗:', error);
                    this.showNotification(`取得 ${stockCode} 價格失敗，請手動輸入`, 'error');
                } finally {
                    fetchBtn.disabled = false;
                    fetchBtn.textContent = '📈 取得最新價格';
                }
            }
            
            // 根據股票代碼取得價格
            async getStockPrice(stockCode) {
                try {
                    // 嘗試取得真實股票價格
                    const realPrice = await this.fetchRealStockPrice(stockCode);
                    if (realPrice) {
                        console.log(`取得 ${stockCode} 真實價格: ${realPrice.price.toFixed(2)} ${realPrice.currency}`);
                        return realPrice;
                    }
                } catch (error) {
                    console.warn(`取得 ${stockCode} 真實價格失敗:`, error.message);
                }
                
                // 如果真實 API 失敗，拋出錯誤而不是使用固定價格
                throw new Error(`無法取得 ${stockCode} 的價格資料，請手動輸入當前價格`);
            }
            
            // 取得真實股票價格 - 多 API 支援
            async fetchRealStockPrice(stockCode) {
                console.log(`🔍 開始查詢 ${stockCode} 的價格...`);
                
                // 優先使用 Yahoo Finance API
                try {
                    console.log(`嘗試 Yahoo Finance API`);
                    const result = await this.tryYahooFinance(stockCode);
                    if (result) {
                        console.log(`✅ Yahoo Finance 成功: ${stockCode} = ${result.price} ${result.currency}`);
                        return result;
                    }
                } catch (error) {
                    console.warn(`❌ Yahoo Finance 失敗:`, error.message);
                }
                
                // 備用 API
                const apis = [
                    () => this.tryYahooFinance(stockCode),
                    () => this.tryFinancialModelingPrep(stockCode),
                    () => this.tryMarketStack(stockCode),
                    () => this.tryAlphaVantage(stockCode),
                    () => this.tryIEXCloud(stockCode)
                ];
                
                for (let i = 0; i < apis.length; i++) {
                    try {
                        console.log(`嘗試備用 API ${i + 1}/${apis.length}`);
                        const result = await apis[i]();
                        if (result) {
                            console.log(`✅ 備用 API ${i + 1} 成功: ${stockCode} = ${result.price} ${result.currency}`);
                            return result;
                        }
                    } catch (error) {
                        console.warn(`❌ 備用 API ${i + 1} 失敗:`, error.message);
                        if (i === apis.length - 1) {
                            throw new Error(`所有 API 都失敗: ${error.message}`);
                        }
                        continue;
                    }
                }
            }
            
            // Yahoo Finance API (透過 allorigins.win 代理)
            async tryYahooFinance(stockCode) {
                console.log(`📊 Yahoo Finance: ${stockCode}`);
                
                try {
                    // 根據股票代碼自動添加市場後綴
                    let yahooSymbol = stockCode;
                    
                    // 常見美國ETF列表
                    const usEtfSymbols = ["SPY", "VOO", "VTI", "IVV", "QQQ", "SCHD", "JEPI", "VT", "ARKK", "ARKQ", "ARKW", "ARKG", "ARKF", "XLF", "XLK", "XLE", "XLI", "XLV", "XLY", "XLP", "XLU", "XLRE", "XLB", "XLC", "XLNX"];
                    
                    // 檢測股票代碼類型並添加相應的市場後綴
                    if (/^\d{4}[A-Za-z]?$/.test(stockCode)) {
                        // 台股：4位數字或4位數字+字母（如00692B）
                        yahooSymbol = `${stockCode}.TW`;
                        console.log(`台股代碼: ${stockCode} -> ${yahooSymbol}`);
                    } else if (usEtfSymbols.includes(stockCode.toUpperCase())) {
                        // 美國ETF：直接使用代碼
                        yahooSymbol = stockCode;
                        console.log(`美國ETF: ${stockCode} -> ${yahooSymbol}`);
                    } else if (/^[A-Za-z]{1,5}$/.test(stockCode)) {
                        // 美國股票：直接使用代碼
                        yahooSymbol = stockCode;
                        console.log(`美國股票: ${stockCode} -> ${yahooSymbol}`);
                    } else if (/^\d{4}$/.test(stockCode)) {
                        // 4位純數字：可能是台股
                        yahooSymbol = `${stockCode}.TW`;
                        console.log(`4位數字台股: ${stockCode} -> ${yahooSymbol}`);
                    } else {
                        // 其他情況：預設為美股
                        yahooSymbol = stockCode;
                        console.log(`預設美股: ${stockCode} -> ${yahooSymbol}`);
                    }
                    
                    const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=1d&range=1mo`;
                    console.log(`Yahoo Finance API URL: ${apiUrl}`);
                    
                    // 使用 allorigins.win 的 raw 端點
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`;
                    console.log(`CORS 代理 URL: ${proxyUrl}`);
                    
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`代理請求失敗: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Yahoo Finance 回應:', data);
                    
                    // 解析 Yahoo Finance 回應
                    if (data.chart && data.chart.result && data.chart.result.length > 0) {
                        const result = data.chart.result[0];
                        const meta = result.meta;
                        
                        if (meta && meta.regularMarketPrice) {
                            const price = meta.regularMarketPrice;
                            const currency = meta.currency || 'USD';
                            const symbol = meta.symbol || stockCode;
                            
                            console.log(`✅ Yahoo Finance 解析成功: ${price} ${currency}`);
                            return {
                                price: price,
                                currency: currency,
                                symbol: symbol
                            };
                        } else {
                            throw new Error('無法從 Yahoo Finance 回應中提取價格數據');
                        }
                    } else {
                        throw new Error('Yahoo Finance 回應格式異常');
                    }
                    
                } catch (error) {
                    console.error(`Yahoo Finance 代理失敗:`, error);
                    throw error;
                }
            }
            
            // 解析 Google Finance 回應
            parseGoogleFinanceResponse(html, stockCode) {
                // 解析 HTML 中的價格數據
                // Google Finance 使用 JSON-LD 結構化數據
                const jsonLdMatch = html.match(/<script type="application\/ld\+json">(.*?)<\/script>/s);
                if (jsonLdMatch) {
                    try {
                        const jsonData = JSON.parse(jsonLdMatch[1]);
                        console.log('Google Finance JSON 數據:', jsonData);
                        
                        if (jsonData.price) {
                            const price = parseFloat(jsonData.price);
                            const currency = this.getCurrencyByMarket(stockCode);
                            console.log(`✅ Google Finance 解析成功: ${price} ${currency}`);
                            return { price, currency };
                        }
                    } catch (jsonError) {
                        console.warn('JSON 解析失敗:', jsonError);
                    }
                }
                
                // 備用解析方法：從 HTML 中提取價格
                const priceMatch = html.match(/"price":"([^"]+)"/);
                if (priceMatch) {
                    const price = parseFloat(priceMatch[1]);
                    const currency = this.getCurrencyByMarket(stockCode);
                    console.log(`✅ Google Finance 備用解析成功: ${price} ${currency}`);
                    return { price, currency };
                }
                
                // 另一個備用解析方法
                const pricePattern = /data-last-price="([^"]+)"/;
                const priceMatch2 = html.match(pricePattern);
                if (priceMatch2) {
                    const price = parseFloat(priceMatch2[1]);
                    const currency = this.getCurrencyByMarket(stockCode);
                    console.log(`✅ Google Finance 第二備用解析成功: ${price} ${currency}`);
                    return { price, currency };
                }
                
                // 嘗試從頁面標題或內容中提取價格
                const titleMatch = html.match(/<title[^>]*>([^<]*\$[0-9.]+[^<]*)<\/title>/i);
                if (titleMatch) {
                    const priceMatch3 = titleMatch[1].match(/\$([0-9.]+)/);
                    if (priceMatch3) {
                        const price = parseFloat(priceMatch3[1]);
                        const currency = this.getCurrencyByMarket(stockCode);
                        console.log(`✅ Google Finance 標題解析成功: ${price} ${currency}`);
                        return { price, currency };
                    }
                }
                
                throw new Error('無法從 Google Finance 解析價格數據');
            }
            
            // Yahoo Finance API
            async tryYahooFinance(stockCode) {
                console.log(`📊 Yahoo Finance: ${stockCode}`);
                
                // 嘗試不同的後綴
                const suffixes = [];
                
                if (/^[A-Za-z]/.test(stockCode)) {
                    suffixes.push(''); // 美股無後綴
                } else if (/^\d{4}[A-Za-z]?$/.test(stockCode)) {
                    suffixes.push('.TWO', '.TW'); // 台股：先試 .TWO (ETF/債券)，再試 .TW (一般股票)
                } else {
                    suffixes.push('.TWO', '.TW'); // 其他情況
                }
                
                for (const suffix of suffixes) {
                    const yahooCode = stockCode + suffix;
                    console.log(`嘗試 Yahoo Finance: ${stockCode} -> ${yahooCode}`);
                    
                    const proxyServices = [
                        `https://cors-anywhere.herokuapp.com/https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`,
                        `https://api.allorigins.win/get?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`)}`,
                        `https://corsproxy.io/?https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`,
                        `https://thingproxy.freeboard.io/fetch/https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`
                    ];
                    
                    for (const proxyUrl of proxyServices) {
                        try {
                            const response = await fetch(proxyUrl);
                            if (!response.ok) continue;
                            
                            let data;
                            if (proxyUrl.includes('allorigins.win')) {
                                const proxyData = await response.json();
                                data = JSON.parse(proxyData.contents);
                            } else {
                                data = await response.json();
                            }
                            
                            if (!data.chart?.result?.[0]) continue;
                            
                            const result = data.chart.result[0];
                            const meta = result.meta;
                            const currentPrice = meta.regularMarketPrice || result.indicators.quote[0].close.slice(-1)[0];
                            const currency = meta.currency || this.getCurrencyByMarket(stockCode);
                            
                            if (currentPrice && currentPrice > 0) {
                                console.log(`✅ Yahoo Finance 成功: ${yahooCode} = ${currentPrice} ${currency}`);
                                return { price: currentPrice, currency };
                            }
                        } catch (error) {
                            continue;
                        }
                    }
                }
                throw new Error('Yahoo Finance API 失敗');
            }
            
            // Financial Modeling Prep API (免費版，無需 API Key)
            async tryFinancialModelingPrep(stockCode) {
                console.log(`💰 Financial Modeling Prep: ${stockCode}`);
                
                try {
                    // 免費 API，無需 API Key
                    const url = `https://financialmodelingprep.com/api/v3/quote/${stockCode}`;
                    console.log(`FMP URL: ${url}`);
                    
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                    console.log(`FMP 回應狀態: ${response.status}`);
                    
                    if (!response.ok) throw new Error(`FMP 請求失敗: ${response.status}`);
                    
                    const proxyData = await response.json();
                    console.log(`FMP 代理回應:`, proxyData);
                    
                    const data = JSON.parse(proxyData.contents);
                    console.log(`FMP 資料:`, data);
                    
                    if (data && data.length > 0 && data[0].price) {
                        const price = data[0].price;
                        const currency = this.getCurrencyByMarket(stockCode);
                        console.log(`FMP 成功: ${stockCode} = ${price} ${currency}`);
                        return { price, currency };
                    } else {
                        throw new Error('FMP 無有效價格資料');
                    }
                } catch (error) {
                    console.error(`FMP 錯誤:`, error.message);
                    throw new Error(`Financial Modeling Prep API 失敗: ${error.message}`);
                }
            }
            
            // MarketStack API (免費版，無需 API Key)
            async tryMarketStack(stockCode) {
                console.log(`📊 MarketStack: ${stockCode}`);
                
                try {
                    // 免費 API，無需 API Key
                    const url = `http://api.marketstack.com/v1/eod/latest?access_key=free&symbols=${stockCode}`;
                    console.log(`MarketStack URL: ${url}`);
                    
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                    console.log(`MarketStack 回應狀態: ${response.status}`);
                    
                    if (!response.ok) throw new Error(`MarketStack 請求失敗: ${response.status}`);
                    
                    const proxyData = await response.json();
                    console.log(`MarketStack 代理回應:`, proxyData);
                    
                    const data = JSON.parse(proxyData.contents);
                    console.log(`MarketStack 資料:`, data);
                    
                    if (data.data && data.data.length > 0 && data.data[0].close) {
                        const price = data.data[0].close;
                        const currency = this.getCurrencyByMarket(stockCode);
                        console.log(`MarketStack 成功: ${stockCode} = ${price} ${currency}`);
                        return { price, currency };
                    } else {
                        throw new Error('MarketStack 無有效價格資料');
                    }
                } catch (error) {
                    console.error(`MarketStack 錯誤:`, error.message);
                    throw new Error(`MarketStack API 失敗: ${error.message}`);
                }
            }
            
            // Alpha Vantage API (需要 API Key)
            async tryAlphaVantage(stockCode) {
                console.log(`📈 Alpha Vantage: ${stockCode} (需要 API Key)`);
                throw new Error('Alpha Vantage 需要 API Key，請申請後使用');
            }
            
            // IEX Cloud API (需要 API Token)
            async tryIEXCloud(stockCode) {
                console.log(`🏦 IEX Cloud: ${stockCode} (需要 API Token)`);
                throw new Error('IEX Cloud 需要 API Token，請申請後使用');
            }
            
            
            // 根據股票代碼判斷幣別
            getCurrencyByMarket(stockCode) {
                // 美股：第一碼為英文字母
                if (/^[A-Za-z]/.test(stockCode)) {
                    return 'USD';
                }
                // 台股：4位數字 或 4位數字+字母（如00937B）
                else if (/^\d{4}[A-Za-z]?$/.test(stockCode)) {
                    return 'TWD';
                }
                // 其他情況預設為台幣
                else {
                    return 'TWD';
                }
            }
            
            // 固定價格備用方案
            getFixedPrice(stockCode) {
                // 不再提供固定價格，直接拋出錯誤
                throw new Error(`無法取得 ${stockCode} 的價格資料，請手動輸入當前價格`);
            }
            
            // 更新單一資產的當前價格
            async updateCurrentPrice(assetId) {
                const asset = this.assets.find(a => a.id === assetId);
                if (!asset) return;
                
                if (asset.type !== '股票') {
                    this.showNotification('此功能僅適用於股票', 'warning');
                    return;
                }
                
                if (!asset.stockCode) {
                    this.showNotification('此股票沒有股票代碼，無法自動更新價格', 'warning');
                    return;
                }
                
                // 找到對應的按鈕並顯示 loading 狀態
                const updateBtn = document.querySelector(`[data-update-price="${assetId}"]`);
                let originalButtonContent = '';
                if (updateBtn) {
                    originalButtonContent = updateBtn.innerHTML;
                    updateBtn.disabled = true;
                    updateBtn.innerHTML = '🔄 取得中...';
                    updateBtn.style.opacity = '0.6';
                    updateBtn.style.cursor = 'not-allowed';
                    updateBtn.style.backgroundColor = '#f0f0f0';
                    updateBtn.style.color = '#999';
                }
                
                try {
                    console.log(`🔄 開始更新 ${asset.stockCode} (${asset.name}) 的價格...`);
                    
                    // 根據股票代碼取得最新價格
                    const stockData = await this.getStockPrice(asset.stockCode);
                    
                    const assetRef = window.firebaseDoc(window.firebaseDb, 'assets', assetId);
                    await window.firebaseUpdateDoc(assetRef, {
                        currentPrice: stockData.price,
                        currency: stockData.currency, // 同時更新幣別
                        updatedAt: window.firebaseServerTimestamp()
                    });
                    
                    console.log(`✅ 更新 ${asset.stockCode} (${asset.name}) 價格: ${stockData.price.toFixed(2)} ${stockData.currency}`);
                    this.showNotification(`${asset.stockCode} (${asset.name}) 價格已更新為 ${stockData.price.toFixed(2)} ${stockData.currency}`, 'success');
                    
                    // 重新載入資產
                    await this.loadAssets();
                    
                } catch (error) {
                    console.error('❌ 更新價格失敗:', error);
                    this.showNotification(`更新價格失敗: ${error.message}`, 'error');
                } finally {
                    // 恢復按鈕狀態
                    if (updateBtn) {
                        updateBtn.disabled = false;
                        updateBtn.innerHTML = originalButtonContent;
                        updateBtn.style.opacity = '1';
                        updateBtn.style.cursor = 'pointer';
                        updateBtn.style.backgroundColor = '';
                        updateBtn.style.color = '';
                    }
                }
            }

            // 更新所有股價
            async updateAllStockPrices() {
                const stockAssets = this.assets.filter(asset => 
                    asset.type === '股票' && asset.stockCode
                );
                
                if (stockAssets.length === 0) {
                    this.showNotification('沒有找到可更新的股票', 'warning');
                    return;
                }
                
                // 顯示 loading 模態框
                this.showUpdateStocksLoading(stockAssets);
                
                let successCount = 0;
                let failCount = 0;
                
                try {
                    console.log(`🔄 開始批量更新 ${stockAssets.length} 支股票...`);
                    
                    for (let i = 0; i < stockAssets.length; i++) {
                        const asset = stockAssets[i];
                        
                        // 更新進度條
                        const progress = ((i + 1) / stockAssets.length) * 100;
                        this.updateProgress(progress, `正在更新 ${asset.name} (${asset.stockCode})...`);
                        
                        // 更新股票狀態為「更新中」
                        this.updateStockStatus(asset.id, 'updating', `正在取得價格...`);
                        
                        try {
                            console.log(`🔄 正在更新 ${asset.stockCode} (${asset.name})...`);
                            
                            // 更新狀態為正在嘗試
                            this.updateStockStatus(asset.id, 'updating', `嘗試取得價格...`);
                            
                            // 根據股票代碼取得最新價格
                            const stockData = await this.getStockPriceWithProgress(asset.stockCode, asset.id);
                            
                            // 更新狀態為正在儲存
                            this.updateStockStatus(asset.id, 'updating', `正在儲存資料...`);
                            
                            const assetRef = window.firebaseDoc(window.firebaseDb, 'assets', asset.id);
                            await window.firebaseUpdateDoc(assetRef, {
                                currentPrice: stockData.price,
                                currency: stockData.currency,
                                updatedAt: window.firebaseServerTimestamp()
                            });
                            
                            successCount++;
                            this.updateStockStatus(asset.id, 'success', `成功: ${stockData.price.toFixed(2)} ${stockData.currency}`);
                            console.log(`✅ 更新 ${asset.stockCode} 成功`);
                            
                        } catch (error) {
                            failCount++;
                            this.updateStockStatus(asset.id, 'fail', `失敗: ${error.message}`);
                            console.error(`❌ 更新 ${asset.stockCode} 失敗:`, error.message);
                        }
                        
                        // 更新進度標籤
                        this.updateProgressBadge(successCount + failCount, stockAssets.length);
                        
                        // 添加小延遲避免 API 限制
                        if (i < stockAssets.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                    
                    // 更新完成
                    this.updateProgress(100, '更新完成！');
                    this.showUpdateResultInTitle(successCount, failCount);
                    
                    // 重新載入資產
                    await this.loadAssets();
                    
                } catch (error) {
                    console.error('❌ 批量更新失敗:', error);
                    this.updateProgress(0, '更新失敗');
                }
            }

            // 帶進度顯示的股票價格取得
            async getStockPriceWithProgress(stockCode, assetId) {
                try {
                    // 嘗試取得真實股票價格
                    const realPrice = await this.fetchRealStockPriceWithProgress(stockCode, assetId);
                    if (realPrice) {
                        console.log(`取得 ${stockCode} 真實價格: ${realPrice.price.toFixed(2)} ${realPrice.currency}`);
                        return realPrice;
                    }
                } catch (error) {
                    console.warn(`取得 ${stockCode} 真實價格失敗:`, error.message);
                }
                
                // 如果真實 API 失敗，拋出錯誤而不是使用固定價格
                throw new Error(`無法取得 ${stockCode} 的價格資料，請手動輸入當前價格`);
            }

            // 帶進度顯示的真實股票價格取得
            async fetchRealStockPriceWithProgress(stockCode, assetId) {
                console.log(`🔍 開始查詢 ${stockCode} 的價格...`);
                
                // 優先使用 Yahoo Finance API
                try {
                    this.updateStockStatus(assetId, 'updating', '嘗試 Yahoo Finance API');
                    console.log(`嘗試 Yahoo Finance API`);
                    const result = await this.tryYahooFinance(stockCode);
                    if (result) {
                        console.log(`✅ Yahoo Finance 成功: ${stockCode} = ${result.price} ${result.currency}`);
                        return result;
                    }
                } catch (error) {
                    console.warn(`❌ Yahoo Finance 失敗:`, error.message);
                }
                
                // 備用 API
                const apis = [
                    () => this.tryYahooFinance(stockCode),
                    () => this.tryFinancialModelingPrep(stockCode),
                    () => this.tryMarketStack(stockCode),
                    () => this.tryAlphaVantage(stockCode),
                    () => this.tryIEXCloud(stockCode)
                ];
                
                for (let i = 0; i < apis.length; i++) {
                    try {
                        // 更新狀態顯示嘗試次數
                        this.updateStockStatus(assetId, 'updating', `第 ${i + 1} 次嘗試 (備用 API ${i + 1}/${apis.length})`);
                        
                        console.log(`嘗試備用 API ${i + 1}/${apis.length}`);
                        const result = await apis[i]();
                        if (result) {
                            console.log(`✅ 備用 API ${i + 1} 成功: ${stockCode} = ${result.price} ${result.currency}`);
                            return result;
                        }
                    } catch (error) {
                        console.warn(`❌ 備用 API ${i + 1} 失敗:`, error.message);
                        if (i === apis.length - 1) {
                            throw new Error(`所有 API 都失敗: ${error.message}`);
                        }
                        continue;
                    }
                }
            }

            // 顯示更新股價 Loading 模態框
            showUpdateStocksLoading(stockAssets) {
                const modal = document.getElementById('updateStocksLoadingModal');
                if (!modal) return;
                
                // 重置狀態
                document.getElementById('updateProgressFill').style.width = '0%';
                document.getElementById('updateProgressText').textContent = '準備中...';
                document.getElementById('updateProgressBadge').style.display = 'none';
                document.getElementById('updateResultBadge').style.display = 'none';
                
                // 初始化進度標籤
                this.updateProgressBadge(0, stockAssets.length);
                
                // 生成股票列表
                const stocksList = document.getElementById('stocksUpdateList');
                stocksList.innerHTML = stockAssets.map(asset => `
                    <div class="stock-update-item" id="stock-${asset.id}">
                        <div class="stock-info">
                            <div class="stock-name">${asset.name}</div>
                            <div class="stock-code">${asset.stockCode}</div>
                        </div>
                        <div class="update-status status-updating">等待中...</div>
                    </div>
                `).join('');
                
                modal.style.display = 'block';
            }

            // 隱藏更新股價 Loading 模態框
            hideUpdateStocksLoading() {
                const modal = document.getElementById('updateStocksLoadingModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // 更新進度條
            updateProgress(percentage, text) {
                const progressFill = document.getElementById('updateProgressFill');
                const progressText = document.getElementById('updateProgressText');
                
                if (progressFill) {
                    progressFill.style.width = `${percentage}%`;
                }
                if (progressText) {
                    progressText.textContent = text;
                }
            }

            // 更新股票狀態
            updateStockStatus(assetId, status, message) {
                const stockItem = document.getElementById(`stock-${assetId}`);
                if (!stockItem) return;
                
                // 移除所有狀態類別
                stockItem.classList.remove('updating', 'success', 'fail');
                
                // 添加新的狀態類別
                stockItem.classList.add(status);
                
                // 更新狀態文字
                const statusElement = stockItem.querySelector('.update-status');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = `update-status status-${status}`;
                }
            }

            // 更新進度標籤
            updateProgressBadge(current, total) {
                const progressBadge = document.getElementById('updateProgressBadge');
                if (progressBadge) {
                    progressBadge.style.display = 'inline-block';
                    progressBadge.innerHTML = `${current}/${total}`;
                    
                    // 根據進度設置不同的背景色
                    const percentage = (current / total) * 100;
                    if (percentage === 0) {
                        progressBadge.style.background = 'rgba(255,255,255,0.2)'; // 初始狀態
                    } else if (percentage < 50) {
                        progressBadge.style.background = 'rgba(255, 193, 7, 0.8)'; // 黃色
                    } else if (percentage < 100) {
                        progressBadge.style.background = 'rgba(0, 123, 255, 0.8)'; // 藍色
                    } else {
                        progressBadge.style.background = 'rgba(40, 167, 69, 0.8)'; // 綠色
                    }
                }
            }

            // 在標題中顯示更新結果
            showUpdateResultInTitle(successCount, failCount) {
                const resultBadge = document.getElementById('updateResultBadge');
                if (resultBadge) {
                    resultBadge.style.display = 'inline-block';
                    resultBadge.innerHTML = `✅ ${successCount} 成功 ❌ ${failCount} 失敗`;
                    
                    // 根據結果設置不同的背景色
                    if (failCount === 0) {
                        resultBadge.style.background = 'rgba(40, 167, 69, 0.8)'; // 綠色
                    } else if (successCount === 0) {
                        resultBadge.style.background = 'rgba(220, 53, 69, 0.8)'; // 紅色
                    } else {
                        resultBadge.style.background = 'rgba(255, 193, 7, 0.8)'; // 黃色
                    }
                }
            }

            // ========== 資料轉移功能 ==========
            
            showDataMigration() {
                console.log('顯示資料轉移');
                const modal = document.getElementById('dataMigrationModal');
                if (modal) {
                    this.prepareMigrationData();
                    modal.style.display = 'block';
                }
            }
            
            hideDataMigration() {
                console.log('隱藏資料轉移');
                const modal = document.getElementById('dataMigrationModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            prepareMigrationData() {
                // 獲取所有資產記錄
                const assetRecords = this.records.filter(r => r.type === '資產');
                console.log('找到資產記錄:', assetRecords);
                
                // 更新統計資訊
                document.getElementById('migratableCount').textContent = assetRecords.length;
                document.getElementById('existingAssetsCount').textContent = this.assets.length;
                
                // 生成轉移預覽
                this.generateMigrationPreview(assetRecords);
            }
            
            generateMigrationPreview(assetRecords) {
                const tbody = document.getElementById('migrationPreviewBody');
                if (!tbody) return;
                
                if (assetRecords.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">沒有可轉移的資產記錄</td></tr>';
                    return;
                }
                
                const previewHTML = assetRecords.map(record => {
                    const convertedAsset = this.convertRecordToAsset(record);
                    const status = this.checkMigrationStatus(convertedAsset);
                    
                    return `
                        <tr>
                            <td>
                                <div class="original-record">
                                    <strong>${record.subCategory}</strong><br>
                                    <small>${record.description || '無描述'}</small><br>
                                    <small>金額: $${this.formatNumber(record.amount)} (${record.currency || 'TWD'})</small>
                                </div>
                            </td>
                            <td>
                                <div class="converted-asset">
                                    <strong>${convertedAsset.name}</strong><br>
                                    <small>類型: ${convertedAsset.type}</small><br>
                                    <small>數量: ${convertedAsset.quantity}</small><br>
                                    <small>幣別: ${convertedAsset.currency}</small>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge ${status.class}">${status.text}</span>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                tbody.innerHTML = previewHTML;
            }
            
            convertRecordToAsset(record) {
                return {
                    name: record.description || record.subCategory,
                    type: this.mapSubCategoryToType(record.subCategory),
                    quantity: record.amount,
                    currency: record.currency || 'TWD',
                    unitPrice: 1,
                    description: record.description || '',
                    member: record.member || '',
                    migratedAt: new Date()
                };
            }
            
            mapSubCategoryToType(subCategory) {
                const typeMapping = {
                    '存款': '存款',
                    '股票': '股票',
                    '基金': '基金',
                    '債券': '債券',
                    '加密貨幣': '加密貨幣',
                    '房屋': '不動產',
                    '土地': '不動產',
                    '店面': '不動產',
                    '停車位': '不動產'
                };
                
                return typeMapping[subCategory] || '其他';
            }
            
            checkMigrationStatus(convertedAsset) {
                // 檢查是否已存在相同名稱和類型的資產
                const existing = this.assets.find(asset => 
                    asset.name === convertedAsset.name && 
                    asset.type === convertedAsset.type
                );
                
                if (existing) {
                    return { class: 'warning', text: '重複' };
                } else {
                    return { class: 'success', text: '可轉移' };
                }
            }
            
            async startMigration() {
                const assetRecords = this.records.filter(r => r.type === '資產');
                const migrateAll = document.getElementById('migrateAllAssets').checked;
                const keepOriginal = document.getElementById('keepOriginalRecords').checked;
                const mergeDuplicates = document.getElementById('mergeDuplicates').checked;
                
                if (assetRecords.length === 0) {
                    this.showNotification('沒有可轉移的資產記錄', 'warning');
                    return;
                }
                
                if (!confirm(`確定要轉移 ${assetRecords.length} 筆資產記錄嗎？`)) {
                    return;
                }
                
                try {
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const record of assetRecords) {
                        try {
                            const convertedAsset = this.convertRecordToAsset(record);
                            
                            // 檢查重複
                            if (mergeDuplicates) {
                                const existing = this.assets.find(asset => 
                                    asset.name === convertedAsset.name && 
                                    asset.type === convertedAsset.type
                                );
                                
                                if (existing) {
                                    // 合併數量
                                    const updatedAsset = {
                                        ...existing,
                                        quantity: existing.quantity + convertedAsset.quantity,
                                        updatedAt: window.firebaseServerTimestamp()
                                    };
                                    
                                    const assetRef = window.firebaseDoc(window.firebaseDb, 'assets', existing.id);
                                    await window.firebaseUpdateDoc(assetRef, updatedAsset);
                                    
                                    console.log(`合併資產: ${convertedAsset.name}`);
                                    continue;
                                }
                            }
                            
                            // 新增資產
                            const assetsRef = window.firebaseCollection(window.firebaseDb, 'assets');
                            await window.firebaseAddDoc(assetsRef, {
                                ...convertedAsset,
                                createdAt: window.firebaseServerTimestamp()
                            });
                            
                            successCount++;
                            console.log(`轉移成功: ${convertedAsset.name}`);
                            
                        } catch (error) {
                            console.error(`轉移失敗: ${record.subCategory}`, error);
                            errorCount++;
                        }
                    }
                    
                    // 顯示結果
                    this.showNotification(`轉移完成！\n成功: ${successCount} 筆\n失敗: ${errorCount} 筆`, 'success');
                    
                    // 重新載入資產
                    await this.loadAssets();
                    
                    // 關閉模態框
                    this.hideDataMigration();
                    
                } catch (error) {
                    console.error('轉移過程發生錯誤:', error);
                    this.showNotification('轉移過程發生錯誤，請稍後再試', 'error');
                }
            }

            // 更新圖表
            updateCharts() {
                const chartTypeFilter = document.getElementById('chartFilterType').value;
                const chartYearFilter = document.getElementById('chartFilterYear').value;
                const chartMonthFilter = document.getElementById('chartFilterMonth').value;
                
                // 根據圖表篩選器過濾記錄
                const filteredRecords = this.records.filter(record => {
                    const recordDate = new Date(record.date);
                    const recordYear = recordDate.getFullYear().toString();
                    const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                    
                    return (!chartTypeFilter || record.type === chartTypeFilter) &&
                           (!chartYearFilter || recordYear === chartYearFilter) &&
                           (!chartMonthFilter || recordMonth === chartMonthFilter);
                });
                
                // 控制圖表顯示/隱藏
                this.toggleChartSections(chartTypeFilter);
                
                // 分別處理收入、支出和資產的數據
                const incomeRecords = filteredRecords.filter(r => r.type === '收入');
                const expenseRecords = filteredRecords.filter(r => r.type === '支出');
                const assetRecords = filteredRecords.filter(r => r.type === '資產');
                
                // 更新支出類別圖表
                const expenseCategoryData = this.getCategoryData(expenseRecords);
                this.expenseCategoryChart.data.labels = expenseCategoryData.labels;
                this.expenseCategoryChart.data.datasets[0].data = expenseCategoryData.data;
                
                // 如果沒有支出資料，顯示提示
                if (expenseCategoryData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.expenseCategoryChart.data.labels = [`${filterText}暫無支出資料`];
                    this.expenseCategoryChart.data.datasets[0].data = [1];
                    this.expenseCategoryChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.expenseCategoryChart.data.datasets[0].backgroundColor = [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56', '#9966FF', '#FF9F40', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56', '#9966FF'
                    ];
                }
                
                this.expenseCategoryChart.update();

                // 更新支出成員圖表
                const expenseMemberData = this.getMemberData(expenseRecords);
                this.expenseMemberChart.data.labels = expenseMemberData.labels;
                this.expenseMemberChart.data.datasets[0].data = expenseMemberData.data;
                
                // 如果沒有支出資料，顯示提示
                if (expenseMemberData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.expenseMemberChart.data.labels = [`${filterText}暫無支出資料`];
                    this.expenseMemberChart.data.datasets[0].data = [1];
                    this.expenseMemberChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.expenseMemberChart.data.datasets[0].backgroundColor = [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c'
                    ];
                }
                
                this.expenseMemberChart.update();

                // 更新收入類別圖表
                const incomeCategoryData = this.getCategoryData(incomeRecords);
                this.incomeCategoryChart.data.labels = incomeCategoryData.labels;
                this.incomeCategoryChart.data.datasets[0].data = incomeCategoryData.data;
                
                // 如果沒有收入資料，顯示提示
                if (incomeCategoryData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.incomeCategoryChart.data.labels = [`${filterText}暫無收入資料`];
                    this.incomeCategoryChart.data.datasets[0].data = [1];
                    this.incomeCategoryChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.incomeCategoryChart.data.datasets[0].backgroundColor = [
                        '#27ae60', '#2ecc71', '#16a085', '#1abc9c', '#27ae60', '#2ecc71', '#16a085', '#1abc9c', '#27ae60', '#2ecc71'
                    ];
                }
                
                this.incomeCategoryChart.update();

                // 更新收入成員圖表
                const incomeMemberData = this.getMemberData(incomeRecords);
                this.incomeMemberChart.data.labels = incomeMemberData.labels;
                this.incomeMemberChart.data.datasets[0].data = incomeMemberData.data;
                
                // 如果沒有收入資料，顯示提示
                if (incomeMemberData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.incomeMemberChart.data.labels = [`${filterText}暫無收入資料`];
                    this.incomeMemberChart.data.datasets[0].data = [1];
                    this.incomeMemberChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.incomeMemberChart.data.datasets[0].backgroundColor = [
                        '#27ae60', '#2ecc71', '#16a085', '#1abc9c'
                    ];
                }
                
                this.incomeMemberChart.update();

                // 更新資產類別圖表
                const assetCategoryData = this.getCategoryData(assetRecords);
                this.assetCategoryChart.data.labels = assetCategoryData.labels;
                this.assetCategoryChart.data.datasets[0].data = assetCategoryData.data;
                
                // 如果沒有資產資料，顯示提示
                if (assetCategoryData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.assetCategoryChart.data.labels = [`${filterText}暫無資產資料`];
                    this.assetCategoryChart.data.datasets[0].data = [1];
                    this.assetCategoryChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.assetCategoryChart.data.datasets[0].backgroundColor = [
                        '#f39c12', '#e67e22', '#d35400', '#e74c3c', '#c0392b', '#f39c12', '#e67e22', '#d35400', '#e74c3c', '#c0392b'
                    ];
                }
                
                this.assetCategoryChart.update();

                // 更新資產成員圖表
                const assetMemberData = this.getMemberData(assetRecords);
                this.assetMemberChart.data.labels = assetMemberData.labels;
                this.assetMemberChart.data.datasets[0].data = assetMemberData.data;
                
                // 如果沒有資產資料，顯示提示
                if (assetMemberData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.assetMemberChart.data.labels = [`${filterText}暫無資產資料`];
                    this.assetMemberChart.data.datasets[0].data = [1];
                    this.assetMemberChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.assetMemberChart.data.datasets[0].backgroundColor = [
                        '#f39c12', '#e67e22', '#d35400', '#c0392b'
                    ];
                }
                
                this.assetMemberChart.update();
            }

            // 控制圖表區域顯示/隱藏
            toggleChartSections(typeFilter) {
                // 控制支出統計區域
                const expenseTitle = document.querySelector('.expense-section-title');
                const expenseSection = document.querySelector('.expense-section');
                if (expenseTitle && expenseSection) {
                    const showExpense = !typeFilter || typeFilter === '支出';
                    expenseTitle.style.display = showExpense ? 'block' : 'none';
                    expenseSection.style.display = showExpense ? 'flex' : 'none';
                }
                
                // 控制收入統計區域
                const incomeTitle = document.querySelector('.income-section-title');
                const incomeSection = document.querySelector('.income-section');
                if (incomeTitle && incomeSection) {
                    const showIncome = !typeFilter || typeFilter === '收入';
                    incomeTitle.style.display = showIncome ? 'block' : 'none';
                    incomeSection.style.display = showIncome ? 'flex' : 'none';
                }
                
                // 控制資產統計區域
                const assetTitle = document.querySelector('.asset-section-title');
                const assetSection = document.querySelector('.asset-section');
                if (assetTitle && assetSection) {
                    const showAsset = !typeFilter || typeFilter === '資產';
                    assetTitle.style.display = showAsset ? 'block' : 'none';
                    assetSection.style.display = showAsset ? 'flex' : 'none';
                }
            }

            // 獲取篩選文字
            getFilterText(typeFilter, yearFilter, monthFilter) {
                let text = '';
                if (typeFilter) text += `${typeFilter} `;
                if (yearFilter) text += `${yearFilter}年 `;
                if (monthFilter) {
                    const monthNames = ['', '1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                    text += `${monthNames[parseInt(monthFilter)]} `;
                }
                return text;
            }

            // 獲取類別數據
            getCategoryData(records) {
                const categoryMap = {};
                records.forEach(record => {
                    const categoryKey = `${record.mainCategory} - ${record.subCategory}`;
                    categoryMap[categoryKey] = (categoryMap[categoryKey] || 0) + record.amount;
                });

                return {
                    labels: Object.keys(categoryMap),
                    data: Object.values(categoryMap)
                };
            }

            // 獲取成員數據
            getMemberData(records) {
                const memberMap = {};
                records.forEach(record => {
                    memberMap[record.member] = (memberMap[record.member] || 0) + record.amount;
                });

                return {
                    labels: Object.keys(memberMap),
                    data: Object.values(memberMap)
                };
            }

            // 初始化圖表
            initCharts() {
                console.log('初始化圖表');
                
                // 支出類別圓餅圖
                this.expenseCategoryChart = new Chart(document.getElementById('expenseCategoryChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40',
                                '#FF6384',
                                '#C9CBCF',
                                '#4BC0C0',
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#9966FF',
                                '#FF9F40',
                                '#C9CBCF',
                                '#4BC0C0',
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#9966FF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 支出成員圓餅圖
                this.expenseMemberChart = new Chart(document.getElementById('expenseMemberChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#667eea',
                                '#764ba2',
                                '#f093fb',
                                '#f5576c'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 收入類別圓餅圖
                this.incomeCategoryChart = new Chart(document.getElementById('incomeCategoryChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#27ae60',
                                '#2ecc71',
                                '#16a085',
                                '#1abc9c',
                                '#27ae60',
                                '#2ecc71',
                                '#16a085',
                                '#1abc9c',
                                '#27ae60',
                                '#2ecc71'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 收入成員圓餅圖
                this.incomeMemberChart = new Chart(document.getElementById('incomeMemberChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#27ae60',
                                '#2ecc71',
                                '#16a085',
                                '#1abc9c'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 資產類別圓餅圖
                this.assetCategoryChart = new Chart(document.getElementById('assetCategoryChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#f39c12',
                                '#e67e22',
                                '#d35400',
                                '#e74c3c',
                                '#c0392b',
                                '#f39c12',
                                '#e67e22',
                                '#d35400',
                                '#e74c3c',
                                '#c0392b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 資產成員圓餅圖
                this.assetMemberChart = new Chart(document.getElementById('assetMemberChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#f39c12',
                                '#e67e22',
                                '#d35400',
                                '#c0392b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 初始化表單事件監聽器
            initFormEventListeners() {
                console.log('初始化表單事件監聽器');
                
                // 表單提交事件
                document.getElementById('recordForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addRecord();
                });
                
                // 新增資產表單事件監聽器
                document.getElementById('addAssetForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addAsset();
                });
                
                // 監聽股數和總成本變更，自動計算購買平均成本價
                document.getElementById('assetQuantity').addEventListener('input', this.calculateUnitPrice.bind(this));
                document.getElementById('assetCost').addEventListener('input', this.calculateUnitPrice.bind(this));
                
                // 幣別選擇變化時顯示/隱藏匯率欄位
                document.getElementById('currency').addEventListener('change', async (e) => {
                    const currency = e.target.value;
                    const exchangeRateGroup = document.getElementById('exchangeRateGroup');
                    const exchangeRateInput = document.getElementById('exchangeRate');
                    const refreshBtn = document.getElementById('refreshRateBtn');
                    
                    if (currency === 'TWD') {
                        exchangeRateGroup.style.display = 'none';
                    } else {
                        exchangeRateGroup.style.display = 'block';
                        
                        // 顯示載入狀態
                        exchangeRateInput.value = '';
                        exchangeRateInput.placeholder = '正在取得匯率...';
                        refreshBtn.disabled = true;
                        refreshBtn.textContent = '🔄 取得中...';
                        
                        try {
                            // 自動取得當前匯率
                            const rate = await this.fetchExchangeRateFromAPI(currency);
                            exchangeRateInput.value = rate;
                            exchangeRateInput.placeholder = '匯率已更新';
                            
                            // 更新本地匯率快取
                            this.exchangeRates[currency] = rate;
                            
                            console.log(`已取得 ${currency} 匯率: ${rate}`);
                        } catch (error) {
                            console.error('取得匯率失敗:', error);
                            exchangeRateInput.value = this.exchangeRates[currency] || 1;
                            exchangeRateInput.placeholder = '使用快取匯率';
                            this.showNotification(`無法取得 ${currency} 最新匯率，已使用快取數據`, 'warning');
                        } finally {
                            refreshBtn.disabled = false;
                            refreshBtn.textContent = '🔄 更新匯率';
                        }
                    }
                });
                
                // 資產類型選擇變化時顯示/隱藏相關欄位
                document.getElementById('assetType').addEventListener('change', (e) => {
                    const assetType = e.target.value;
                    const currentPriceGroup = document.getElementById('currentPriceGroup');
                    const purchaseDateGroup = document.getElementById('purchaseDateGroup');
                    const stockCodeGroup = document.getElementById('stockCodeGroup');
                    
                    if (assetType === '股票') {
                        currentPriceGroup.style.display = 'block';
                        purchaseDateGroup.style.display = 'block';
                        stockCodeGroup.style.display = 'block';
                    } else if (assetType === '基金') {
                        currentPriceGroup.style.display = 'block';
                        purchaseDateGroup.style.display = 'block';
                        stockCodeGroup.style.display = 'none';
                    } else {
                        currentPriceGroup.style.display = 'none';
                        purchaseDateGroup.style.display = 'none';
                        stockCodeGroup.style.display = 'none';
                    }
                });
                
                // 類別選擇變化時更新細項選項
                const mainCategorySelect = document.getElementById('mainCategory');
                if (mainCategorySelect) {
                    mainCategorySelect.addEventListener('change', () => {
                        this.updateSubCategoryOptions();
                    });
                }

                // 類型選擇變化時更新類別選項
                const typeSelect = document.getElementById('type');
                if (typeSelect) {
                    typeSelect.addEventListener('change', () => {
                        this.updateMainCategoryOptions();
                    });
                }

                // 分頁事件監聽器
                const pageSizeSelect = document.getElementById('pageSize');
                if (pageSizeSelect) {
                    pageSizeSelect.addEventListener('change', async (e) => {
                        this.recordsPerPage = parseInt(e.target.value);
                        this.currentPage = 1;
                        await this.handleTableFilterChange();
                    });
                }

                // 上一頁按鈕
                const prevPageBtn = document.getElementById('prevPage');
                if (prevPageBtn) {
                    prevPageBtn.addEventListener('click', async () => {
                        if (this.currentPage > 1) {
                            this.currentPage--;
                            await this.handleTableFilterChange();
                        }
                    });
                }

                // 下一頁按鈕
                const nextPageBtn = document.getElementById('nextPage');
                if (nextPageBtn) {
                    nextPageBtn.addEventListener('click', async () => {
                        const filteredRecords = this.getCurrentFilteredRecords();
                        const totalPages = Math.ceil(filteredRecords.length / this.recordsPerPage);
                        if (this.currentPage < totalPages) {
                            this.currentPage++;
                            await this.handleTableFilterChange();
                        }
                    });
                }

                // 圖表篩選事件監聽器
                const chartFilterType = document.getElementById('chartFilterType');
                if (chartFilterType) {
                    chartFilterType.addEventListener('change', () => {
                        this.updateCharts();
                    });
                }

                const chartFilterYear = document.getElementById('chartFilterYear');
                if (chartFilterYear) {
                    chartFilterYear.addEventListener('change', () => {
                        this.updateCharts();
                    });
                }

                const chartFilterMonth = document.getElementById('chartFilterMonth');
                if (chartFilterMonth) {
                    chartFilterMonth.addEventListener('change', () => {
                        this.updateCharts();
                    });
                }
            }

            // 更新細項選項
            updateSubCategoryOptions() {
                const mainCategory = document.getElementById('mainCategory').value;
                const subCategorySelect = document.getElementById('subCategory');
                
                // 清空小項目選項
                subCategorySelect.innerHTML = '<option value="">請選擇細項</option>';
                
                if (mainCategory && this.categoryStructure[mainCategory]) {
                    this.categoryStructure[mainCategory].forEach(subCategory => {
                        const option = document.createElement('option');
                        option.value = subCategory;
                        option.textContent = subCategory;
                        subCategorySelect.appendChild(option);
                    });
                }
            }

            // 更新主類別選項
            updateMainCategoryOptions() {
                const type = document.getElementById('type').value;
                const mainCategorySelect = document.getElementById('mainCategory');
                const options = mainCategorySelect.querySelectorAll('option');
                
                // 重置大項目選擇
                mainCategorySelect.value = '';
                document.getElementById('subCategory').innerHTML = '<option value="">請先選擇類別</option>';
                
                // 顯示/隱藏選項
                options.forEach(option => {
                    if (option.value === '') {
                        option.style.display = 'block';
                    } else {
                        const optionType = option.getAttribute('data-type');
                        option.style.display = (!type || optionType === type) ? 'block' : 'none';
                    }
                });
            }

            // 新增記錄
            async addRecord() {
                const formData = {
                    type: document.getElementById('type').value,
                    member: document.getElementById('member').value,
                    mainCategory: document.getElementById('mainCategory').value,
                    subCategory: document.getElementById('subCategory').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    currency: document.getElementById('currency').value,
                    exchangeRate: parseFloat(document.getElementById('exchangeRate').value) || 1,
                    description: document.getElementById('description').value,
                    date: document.getElementById('date').value
                };

                console.log('準備新增記錄:', formData);

                try {
                    if (this.editingId) {
                        // 編輯模式
                        await this.updateRecordInFirebase(this.editingId, formData);
                        this.editingId = null;
                        document.querySelector('#recordForm button[type="submit"]').textContent = '新增記錄';
                    } else {
                        // 新增模式
                        await this.addRecordToFirebase(formData);
                    }

                    this.resetForm();
                    await this.handleUpdateDisplay();
                } catch (error) {
                    console.error('儲存記錄失敗:', error);
                    this.showNotification('儲存失敗，請重試', 'error');
                }
            }

            // 新增記錄到 Firebase
            async addRecordToFirebase(formData) {
                console.log('開始寫入 Firebase...');
                
                // 確保Firebase函數已載入
                if (!window.firebaseCollection || !window.firebaseAddDoc || !window.firebaseServerTimestamp) {
                    console.error('Firebase函數未載入，無法新增記錄');
                    throw new Error('Firebase函數未載入');
                }

                const recordsRef = window.firebaseCollection(window.firebaseDb, 'records');
                const docRef = await window.firebaseAddDoc(recordsRef, {
                    userId: this.currentUser.uid,
                    ...formData,
                    createdAt: window.firebaseServerTimestamp(),
                    updatedAt: window.firebaseServerTimestamp()
                });
                
                // 添加到本地陣列
                this.records.push({
                    id: docRef.id,
                    ...formData
                });
                
                console.log('記錄已新增到 Firebase:', docRef.id);
                this.showNotification('記錄已成功新增！', 'success');
            }

            // 更新 Firebase 記錄
            async updateRecordInFirebase(recordId, formData) {
                const recordRef = window.firebaseDoc(window.firebaseDb, 'records', recordId);
                await window.firebaseUpdateDoc(recordRef, {
                    ...formData,
                    updatedAt: window.firebaseServerTimestamp()
                });
                
                // 更新本地陣列
                const index = this.records.findIndex(record => record.id === recordId);
                if (index !== -1) {
                    this.records[index] = { ...formData, id: recordId };
                }
                
                console.log('記錄已更新到 Firebase:', recordId);
                this.showNotification('記錄已成功修改！', 'success');
            }

            // 編輯記錄
            async editRecord(recordId) {
                console.log('編輯記錄:', recordId);
                
                const record = this.records.find(r => r.id === recordId);
                if (!record) {
                    console.error('找不到要編輯的記錄');
                    return;
                }
                
                // 填入表單資料
                document.getElementById('type').value = record.type;
                document.getElementById('member').value = record.member;
                document.getElementById('mainCategory').value = record.mainCategory;
                document.getElementById('amount').value = record.amount;
                document.getElementById('description').value = record.description;
                document.getElementById('date').value = record.date;
                document.getElementById('currency').value = record.currency || 'TWD';
                
                // 更新細項選項
                this.updateSubCategoryOptions();
                document.getElementById('subCategory').value = record.subCategory;
                
                // 設定編輯狀態
                this.editingId = recordId;
                
                // 更新按鈕文字
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = '更新記錄';
                }
                
                // 滾動到表單
                document.querySelector('.add-record').scrollIntoView({ behavior: 'smooth' });
                
                console.log('記錄已載入表單，準備編輯');
            }

            // 刪除記錄
            async deleteRecord(recordId) {
                console.log('刪除記錄:', recordId);
                
                if (!confirm('確定要刪除這筆記錄嗎？')) {
                    return;
                }
                
                try {
                    // 確保Firebase函數已載入
                    if (!window.firebaseDoc || !window.firebaseDeleteDoc) {
                        console.error('Firebase函數未載入，無法刪除記錄');
                        throw new Error('Firebase函數未載入');
                    }
                    
                    const recordRef = window.firebaseDoc(window.firebaseDb, 'records', recordId);
                    await window.firebaseDeleteDoc(recordRef);
                    
                    // 從本地陣列移除
                    this.records = this.records.filter(record => record.id !== recordId);
                    
                    console.log('記錄已刪除:', recordId);
                    this.showNotification('記錄已成功刪除！', 'success');
                    
                    // 更新顯示
                    await this.handleUpdateDisplay();
                    
                } catch (error) {
                    console.error('刪除記錄失敗:', error);
                    this.showNotification('刪除失敗，請重試', 'error');
                }
            }

            // 清空表單
            resetForm() {
                // 清空所有表單欄位
                document.getElementById('member').value = '';
                document.getElementById('type').value = '';
                document.getElementById('mainCategory').value = '';
                document.getElementById('subCategory').innerHTML = '<option value="">請先選擇類別</option>';
                document.getElementById('amount').value = '';
                document.getElementById('description').value = '';
                document.getElementById('currency').value = 'TWD';
                
                // 設定今天的日期為預設值
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                
                // 重置編輯狀態
                this.editingId = null;
                
                // 更新按鈕文字
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = '新增記錄';
                }
                
                console.log('表單已清空，日期已設定為今日');
            }

            // 初始化
            init() {
                // 設定今天的日期為預設值
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                
                this.initFirebase();
                
                // 等待 DOM 載入完成後初始化事件監聽器
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.initFormEventListeners();
                        this.initCharts();
                    });
                } else {
                    this.initFormEventListeners();
                    this.initCharts();
                }
            }
        }

        // 創建 ExpenseTracker 實例
        const expenseTracker = new ExpenseTracker();
    </script>

    <!-- 通知容器 -->
    <div id="notificationContainer" style="position: fixed; bottom: 20px; left: 20px; z-index: 10000; max-width: 300px;"></div>
</body>
</html>
