<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­è¨˜å¸³ç³»çµ±</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, getDoc, updateDoc, deleteDoc, doc, setDoc, query, orderBy, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDfHs1XXsCXGMSVF3NFJUtFMcslTzTd-EU",
            authDomain: "expenses-91280.firebaseapp.com",
            projectId: "expenses-91280",
            storageBucket: "expenses-91280.firebasestorage.app",
            messagingSenderId: "777956465315",
            appId: "1:777956465315:web:04f85f2b22f2468eb2fd16",
            measurementId: "G-1LE7YTKHGT"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // å°‡ Firebase å¯¦ä¾‹è¨­ç‚ºå…¨åŸŸè®Šæ•¸
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseGetDoc = getDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseWhere = where;
        window.firebaseServerTimestamp = serverTimestamp;
        window.firebaseSignInAnonymously = signInAnonymously;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        
        // æ¨™è¨˜ Firebase å·²è¼‰å…¥
        window.firebaseLoaded = true;
        console.log('Firebase SDK å·²è¼‰å…¥å®Œæˆ');
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>å®¶åº­è¨˜å¸³ç³»çµ±</h1>
            <div class="summary">
                <div class="summary-item">
                    <span class="label">ç¸½æ”¶å…¥</span>
                    <span class="amount income" id="totalIncome">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">ç¸½æ”¯å‡º</span>
                    <span class="amount expense" id="totalExpense">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">ç¾æœ‰è³‡ç”¢</span>
                    <span class="amount asset" id="totalAssets">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">ç¸½è³‡ç”¢</span>
                    <span class="amount balance" id="totalNetWorth">$0</span>
                </div>
            </div>
            <button class="charts-btn" onclick="expenseTracker.showChartsModal()">ğŸ“Š åœ–è¡¨åˆ†æ</button>
        </header>

        <main>
            <!-- æ–°å¢è¨˜éŒ„å€åŸŸ -->
            <section class="add-record">
                <h2>æ–°å¢è¨˜å¸³è¨˜éŒ„</h2>
                <form id="recordForm">
                    <div class="form-grid">
                    <div class="form-group">
                        <label for="member">å®¶åº­æˆå“¡</label>
                        <select id="member" required>
                            <option value="">è«‹é¸æ“‡æˆå“¡</option>
                            <option value="çˆ¸çˆ¸">çˆ¸çˆ¸</option>
                            <option value="åª½åª½">åª½åª½</option>
                            <option value="å­©å­">å­©å­</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="type">é¡å‹</label>
                        <select id="type" required>
                            <option value="">è«‹é¸æ“‡é¡å‹</option>
                            <option value="æ”¯å‡º">æ”¯å‡º</option>
                            <option value="æ”¶å…¥">æ”¶å…¥</option>
                            <option value="è³‡ç”¢">è³‡ç”¢</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="mainCategory">é¡åˆ¥</label>
                        <select id="mainCategory" required>
                            <option value="">è«‹å…ˆé¸æ“‡é¡å‹</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="subCategory">ç´°é …</label>
                        <select id="subCategory" required>
                            <option value="">è«‹å…ˆé¸æ“‡é¡åˆ¥</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">é‡‘é¡</label>
                        <input type="number" id="amount" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">æè¿°</label>
                        <input type="text" id="description" placeholder="è¼¸å…¥æè¿°...">
                    </div>
                    
                    <div class="form-group">
                        <label for="date">æ—¥æœŸ</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit">æ–°å¢è¨˜éŒ„</button>
                        <button type="button" onclick="expenseTracker.resetForm()" class="reset-btn">æ¸…ç©ºè¡¨å–®</button>
                    </div>
                </form>
            </section>


            <!-- è¨˜éŒ„åˆ—è¡¨å€åŸŸ -->
            <section class="records">
                <h2>è¨˜å¸³è¨˜éŒ„</h2>
                <div class="records-list" id="recordsList">
                    <!-- è¨˜éŒ„å°‡å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <!-- åˆ†é æ§ä»¶ -->
                <div class="pagination" id="pagination">
                    <div class="page-size-selector">
                        <label for="pageSize">æ¯é é¡¯ç¤ºï¼š</label>
                        <select id="pageSize">
                            <option value="5">5 ç­†</option>
                            <option value="10">10 ç­†</option>
                            <option value="20" selected>20 ç­†</option>
                            <option value="50">50 ç­†</option>
                        </select>
                    </div>
                    
                    <div class="page-controls">
                        <button id="prevPage" class="page-btn" disabled>ä¸Šä¸€é </button>
                        <div class="page-info">
                            <span id="pageInfo">ç¬¬ 1 é ï¼Œå…± 1 é </span>
                        </div>
                        <button id="nextPage" class="page-btn" disabled>ä¸‹ä¸€é </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- åœ–è¡¨å½ˆçª— -->
    <div id="chartsModal" class="modal">
        <div class="modal-content charts-modal">
            <div class="modal-header">
                <h2>ğŸ“Š åœ–è¡¨åˆ†æ</h2>
                <span class="close" onclick="expenseTracker.hideChartsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- åœ–è¡¨ç¯©é¸å™¨ -->
                <div class="chart-filters">
                    <h3>åœ–è¡¨ç¯©é¸</h3>
                    <div class="filter-group">
                        <label for="chartFilterType">é¡å‹ï¼š</label>
                        <select id="chartFilterType">
                            <option value="">æ‰€æœ‰é¡å‹</option>
                            <option value="æ”¶å…¥">æ”¶å…¥</option>
                            <option value="æ”¯å‡º">æ”¯å‡º</option>
                            <option value="è³‡ç”¢">è³‡ç”¢</option>
                        </select>
                        
                        <label for="chartFilterYear">å¹´ä»½ï¼š</label>
                        <select id="chartFilterYear">
                            <option value="">æ‰€æœ‰å¹´ä»½</option>
                        </select>
                        
                        <label for="chartFilterMonth">æœˆä»½ï¼š</label>
                        <select id="chartFilterMonth">
                            <option value="">æ‰€æœ‰æœˆä»½</option>
                            <option value="01">1æœˆ</option>
                            <option value="02">2æœˆ</option>
                            <option value="03">3æœˆ</option>
                            <option value="04">4æœˆ</option>
                            <option value="05">5æœˆ</option>
                            <option value="06">6æœˆ</option>
                            <option value="07">7æœˆ</option>
                            <option value="08">8æœˆ</option>
                            <option value="09">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="expense-section-title">æ”¯å‡ºçµ±è¨ˆ</h2>
                <div class="chart-row expense-section">
                    <div class="chart-container">
                        <h3>æ”¯å‡ºé¡åˆ¥åˆ†å¸ƒ</h3>
                        <canvas id="expenseCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>å®¶åº­æˆå“¡æ”¯å‡ºåˆ†å¸ƒ</h3>
                        <canvas id="expenseMemberChart"></canvas>
                    </div>
                </div>
                
                <h2 class="income-section-title">æ”¶å…¥çµ±è¨ˆ</h2>
                <div class="chart-row income-section">
                    <div class="chart-container">
                        <h3>æ”¶å…¥é¡åˆ¥åˆ†å¸ƒ</h3>
                        <canvas id="incomeCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>å®¶åº­æˆå“¡æ”¶å…¥åˆ†å¸ƒ</h3>
                        <canvas id="incomeMemberChart"></canvas>
                    </div>
                </div>
                
                <h2 class="asset-section-title">è³‡ç”¢çµ±è¨ˆ</h2>
                <div class="chart-row asset-section">
                    <div class="chart-container">
                        <h3>è³‡ç”¢é¡åˆ¥åˆ†å¸ƒ</h3>
                        <canvas id="assetCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>å®¶åº­æˆå“¡è³‡ç”¢åˆ†å¸ƒ</h3>
                        <canvas id="assetMemberChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="expenseTracker.hideChartsModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        // ExpenseTracker é¡åˆ¥
        class ExpenseTracker {
            // æ ¼å¼åŒ–æ•¸å­—ï¼Œæ·»åŠ åƒåˆ†ä½åˆ†éš”ç¬¦ï¼ˆæ•´æ•¸é¡¯ç¤ºï¼‰
            formatNumber(number) {
                return Math.round(number).toLocaleString('zh-TW');
            }

            constructor() {
                this.records = [];
                this.editingId = null;
                this.currentPage = 1;
                this.recordsPerPage = 20;
                this.currentUser = null;
                this.isFirebaseReady = false;
                
                this.init();
            }

            // Firebase åˆå§‹åŒ–
            async initFirebase() {
                try {
                    console.log('é–‹å§‹åˆå§‹åŒ– Firebase...');
                    
                    // ç­‰å¾… Firebase è¼‰å…¥
                    await this.waitForFirebase();
                    console.log('Firebase SDK å·²è¼‰å…¥');
                    
                    // æª¢æŸ¥ Firebase å¯¦ä¾‹æ˜¯å¦æ­£ç¢ºåˆå§‹åŒ–
                    if (!window.firebaseAuth || !window.firebaseDb) {
                        throw new Error('Firebase å¯¦ä¾‹æœªæ­£ç¢ºåˆå§‹åŒ–');
                    }
                    
                    console.log('Firebase å¯¦ä¾‹æª¢æŸ¥é€šé');
                    
                    // ä½¿ç”¨ Promise ç­‰å¾…èªè­‰ç‹€æ…‹
                    const authState = await this.waitForAuthStateWithPromise();
                    console.log('èªè­‰ç‹€æ…‹æª¢æŸ¥å®Œæˆ:', authState ? `å·²ç™»å…¥ ${authState.email}` : 'æœªç™»å…¥');
                    
                    if (authState) {
                        console.log('æª¢æ¸¬åˆ°ç¾æœ‰ç™»å…¥ç‹€æ…‹:', authState.uid);
                        console.log('ä½¿ç”¨è€…è©³ç´°è³‡è¨Š:', {
                            uid: authState.uid,
                            email: authState.email,
                            displayName: authState.displayName,
                            providerId: authState.providerData?.[0]?.providerId
                        });
                        
                        // æª¢æŸ¥ä½¿ç”¨è€…å•Ÿç”¨ç‹€æ…‹
                        console.log('é–‹å§‹æª¢æŸ¥ä½¿ç”¨è€…å•Ÿç”¨ç‹€æ…‹...');
                        const userStatus = await this.checkUserStatus(authState);
                        console.log('ä½¿ç”¨è€…ç‹€æ…‹æª¢æŸ¥çµæœ:', userStatus);
                        console.log('isActive å€¼:', userStatus.isActive);
                        console.log('isActive é¡å‹:', typeof userStatus.isActive);
                        
                        if (!userStatus.isActive) {
                            console.log('âŒ ä½¿ç”¨è€…å°šæœªå•Ÿç”¨ï¼Œé¡¯ç¤ºæœªå•Ÿç”¨è¨Šæ¯:', authState.email);
                            this.showInactiveUserMessage(authState);
                            return;
                        } else {
                            console.log('âœ… ä½¿ç”¨è€…å·²å•Ÿç”¨ï¼Œç¹¼çºŒè¼‰å…¥æ‡‰ç”¨ç¨‹å¼');
                        }
                        
                        this.currentUser = authState;
                        this.isFirebaseReady = true;
                        
                        // è¨˜éŒ„/æ›´æ–°ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™
                        this.updateUserProfile(authState);
                        
                        // è¼‰å…¥è¨˜éŒ„
                        this.loadRecordsFromFirebase();
                    } else {
                        console.log('æœªæª¢æ¸¬åˆ°ç™»å…¥ç‹€æ…‹ï¼Œå°å‘ç™»å…¥é é¢');
                        window.location.href = 'expenses_login.html';
                    }
                    
                    // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
                    window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
                        if (user) {
                            console.log('èªè­‰ç‹€æ…‹è®ŠåŒ– - å·²ç™»å…¥:', user.uid);
                            
                            // æª¢æŸ¥ä½¿ç”¨è€…å•Ÿç”¨ç‹€æ…‹
                            this.checkUserStatus(user).then(userStatus => {
                                if (!userStatus.isActive) {
                                    console.log('ä½¿ç”¨è€…å°šæœªå•Ÿç”¨:', user.email);
                                    this.showInactiveUserMessage(user);
                                    return;
                                }
                                
                                this.currentUser = user;
                                this.isFirebaseReady = true;
                                
                                // è¨˜éŒ„/æ›´æ–°ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™
                                this.updateUserProfile(user);
                                
                                // è¼‰å…¥è¨˜éŒ„
                                this.loadRecordsFromFirebase();
                            });
                        } else {
                            console.log('èªè­‰ç‹€æ…‹è®ŠåŒ– - å·²ç™»å‡ºï¼Œå°å‘ç™»å…¥é é¢');
                            window.location.href = 'expenses_login.html';
                        }
                    });
                } catch (error) {
                    console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                    console.error('éŒ¯èª¤è©³æƒ…:', {
                        message: error.message,
                        stack: error.stack,
                        firebaseAuth: !!window.firebaseAuth,
                        firebaseDb: !!window.firebaseDb
                    });
                    
                    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ä½¿ç”¨è€…
                    this.showFirebaseError(error);
                }
            }

            // ä½¿ç”¨ Promise ç­‰å¾…èªè­‰ç‹€æ…‹
            waitForAuthStateWithPromise() {
                return new Promise((resolve) => {
                    console.log('é–‹å§‹ç­‰å¾…èªè­‰ç‹€æ…‹...');
                    
                    // å…ˆæª¢æŸ¥ç•¶å‰æ˜¯å¦æœ‰å·²ç™»å…¥çš„ä½¿ç”¨è€…
                    const currentUser = window.firebaseAuth.currentUser;
                    if (currentUser) {
                        console.log('æª¢æ¸¬åˆ°ç•¶å‰å·²ç™»å…¥ä½¿ç”¨è€…:', currentUser.uid, currentUser.email);
                        resolve(currentUser);
                        return;
                    }
                    
                    console.log('ç•¶å‰ç„¡ç™»å…¥ä½¿ç”¨è€…ï¼Œç­‰å¾…èªè­‰ç‹€æ…‹è®ŠåŒ–...');
                    
                    const unsubscribe = window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
                        console.log('èªè­‰ç‹€æ…‹è®ŠåŒ–:', user ? `å·²ç™»å…¥ ${user.email}` : 'å·²ç™»å‡º');
                        unsubscribe(); // å–æ¶ˆç›£è½
                        resolve(user);
                    });
                    
                    // è¨­ç½®è¶…æ™‚ï¼Œé¿å…ç„¡é™ç­‰å¾…
                    setTimeout(() => {
                        console.log('èªè­‰ç‹€æ…‹æª¢æŸ¥è¶…æ™‚');
                        unsubscribe();
                        resolve(null);
                    }, 10000); // 10ç§’è¶…æ™‚
                });
            }

            // æ›´æ–°ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™
            async updateUserProfile(user) {
                try {
                    // ç¢ºä¿Firebaseå‡½æ•¸å·²è¼‰å…¥
                    if (!window.firebaseDoc || !window.firebaseSetDoc || !window.firebaseServerTimestamp || !window.firebaseGetDoc) {
                        console.error('Firebaseå‡½æ•¸æœªè¼‰å…¥ï¼Œç„¡æ³•æ›´æ–°ä½¿ç”¨è€…è³‡æ–™');
                        return;
                    }
                    
                    const userRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                    
                    // å…ˆæª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²å­˜åœ¨
                    const existingUserDoc = await window.firebaseGetDoc(userRef);
                    const isNewUser = !existingUserDoc.exists();
                    
                    // æº–å‚™ä½¿ç”¨è€…è³‡æ–™
                    const userData = {
                        uid: user.uid,
                        email: user.email ?? null,
                        displayName: user.displayName ?? null,
                        photoURL: user.photoURL ?? null,
                        providerId: user.providerData?.[0]?.providerId ?? null,
                        lastLoginAt: window.firebaseServerTimestamp()
                    };
                    
                    // åªæœ‰æ–°ä½¿ç”¨è€…æ‰è¨­å®š isActive
                    if (isNewUser) {
                        console.log('æ–°ä½¿ç”¨è€…ï¼Œè¨­å®šé è¨­ç‹€æ…‹');
                        userData.isActive = false;  // é è¨­ä¸å•Ÿç”¨
                        userData.createdAt = window.firebaseServerTimestamp();
                    } else {
                        console.log('ç¾æœ‰ä½¿ç”¨è€…ï¼Œä¿æŒåŸæœ‰ isActive ç‹€æ…‹');
                    }
                    
                    await window.firebaseSetDoc(userRef, userData, { merge: true });
                    console.log('ä½¿ç”¨è€…è³‡æ–™å·²æ›´æ–°:', user.uid);
                } catch (error) {
                    console.error('æ›´æ–°ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
                }
            }

            // é¡¯ç¤ºFirebaseéŒ¯èª¤è¨Šæ¯
            showFirebaseError(error) {
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">âš ï¸</div>
                                <h2>ç³»çµ±åˆå§‹åŒ–å¤±æ•—</h2>
                                <p>å¾ˆæŠ±æ­‰ï¼Œç³»çµ±ç„¡æ³•æ­£å¸¸è¼‰å…¥ã€‚è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š</p>
                                <div class="user-info">
                                    <p><strong>éŒ¯èª¤è¨Šæ¯:</strong> ${error.message}</p>
                                    <p><strong>å¯èƒ½åŸå› :</strong></p>
                                    <ul style="text-align: left; margin: 10px 0;">
                                        <li>ç¶²è·¯é€£ç·šå•é¡Œ</li>
                                        <li>Firebaseæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨</li>
                                        <li>ç€è¦½å™¨å¿«å–å•é¡Œ</li>
                                        <li>Firebaseé…ç½®éŒ¯èª¤</li>
                                    </ul>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="location.reload();" class="logout-btn" style="background: #3498db;">
                                        é‡æ–°è¼‰å…¥
                                    </button>
                                    <button onclick="window.location.href='expenses_login.html';" class="logout-btn">
                                        è¿”å›ç™»å…¥
                                    </button>
                                </div>
                                <div style="margin-top: 20px; font-size: 0.9em; color: #999;">
                                    <p>å¦‚æœå•é¡ŒæŒçºŒç™¼ç”Ÿï¼Œè«‹è¯ç¹«æŠ€è¡“æ”¯æ´</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // æª¢æŸ¥ä½¿ç”¨è€…å•Ÿç”¨ç‹€æ…‹
            async checkUserStatus(user) {
                try {
                    console.log('æª¢æŸ¥ä½¿ç”¨è€…ç‹€æ…‹:', user.uid);
                    
                    // ç¢ºä¿Firebaseå‡½æ•¸å·²è¼‰å…¥
                    if (!window.firebaseDoc || !window.firebaseGetDoc) {
                        console.error('Firebaseå‡½æ•¸æœªè¼‰å…¥');
                        return { isActive: false };
                    }
                    
                    // ç›´æ¥è®€å–ç‰¹å®šä½¿ç”¨è€…çš„æ–‡ä»¶
                    const userRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                    const userDoc = await window.firebaseGetDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        console.log('æ‰¾åˆ°ä½¿ç”¨è€…è³‡æ–™:', userData);
                        console.log('åŸå§‹ isActive å€¼:', userData.isActive);
                        console.log('åŸå§‹ isActive é¡å‹:', typeof userData.isActive);
                        const result = {
                            isActive: userData.isActive || false
                        };
                        console.log('è¿”å›çš„çµæœ:', result);
                        return result;
                    }
                    
                    console.log('æœªæ‰¾åˆ°ä½¿ç”¨è€…è³‡æ–™ï¼Œè¿”å›é è¨­ç‹€æ…‹');
                    return { isActive: false };
                } catch (error) {
                    console.error('æª¢æŸ¥ä½¿ç”¨è€…ç‹€æ…‹å¤±æ•—:', error);
                    console.error('éŒ¯èª¤è©³æƒ…:', {
                        message: error.message,
                        code: error.code,
                        userId: user.uid
                    });
                    
                    // å¦‚æœæ˜¯æ¬Šé™éŒ¯èª¤ï¼Œæä¾›è§£æ±ºæ–¹æ¡ˆ
                    if (error.code === 'permission-denied') {
                        console.error('ğŸ”’ æ¬Šé™è¢«æ‹’çµ•ï¼è«‹æª¢æŸ¥ Firebase å®‰å…¨è¦å‰‡');
                        console.error('å»ºè­°çš„å®‰å…¨è¦å‰‡:');
                        console.error(`
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
                        `);
                    }
                    
                    return { isActive: false };
                }
            }

            // é¡¯ç¤ºç´¢å¼•éŒ¯èª¤è¨Šæ¯
            showIndexError() {
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">ğŸ”</div>
                                <h2>Firebase ç´¢å¼•è¨­å®š</h2>
                                <p>ç³»çµ±éœ€è¦å»ºç«‹ Firebase ç´¢å¼•æ‰èƒ½æ­£å¸¸é‹ä½œã€‚</p>
                                <div class="user-info">
                                    <p><strong>è§£æ±ºæ­¥é©Ÿ:</strong></p>
                                    <ol style="text-align: left; margin: 10px 0;">
                                        <li>å‰å¾€ <a href="https://console.firebase.google.com/project/expenses-91280/firestore/indexes" target="_blank">Firebase Console</a></li>
                                        <li>é»æ“Šã€Œå»ºç«‹ç´¢å¼•ã€</li>
                                        <li>è¨­å®šé›†åˆ: <code>records</code></li>
                                        <li>è¨­å®šæ¬„ä½: <code>userId</code> (å‡åº), <code>date</code> (é™åº)</li>
                                        <li>ç­‰å¾…ç´¢å¼•å»ºç«‹å®Œæˆï¼ˆé€šå¸¸éœ€è¦å¹¾åˆ†é˜ï¼‰</li>
                                        <li>é‡æ–°æ•´ç†æ­¤é é¢</li>
                                    </ol>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="location.reload();" class="logout-btn" style="background: #3498db;">
                                        é‡æ–°è¼‰å…¥
                                    </button>
                                    <button onclick="window.location.href='expenses_login.html';" class="logout-btn">
                                        è¿”å›ç™»å…¥
                                    </button>
                                </div>
                                <div style="margin-top: 20px; font-size: 0.9em; color: #999;">
                                    <p>å¦‚æœå•é¡ŒæŒçºŒç™¼ç”Ÿï¼Œè«‹è¯ç¹«æŠ€è¡“æ”¯æ´</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // é¡¯ç¤ºæœªå•Ÿç”¨ä½¿ç”¨è€…è¨Šæ¯
            showInactiveUserMessage(user) {
                // éš±è—æ‰€æœ‰è¼¸å…¥è¡¨å–®
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">â³</div>
                                <h2>ä½¿ç”¨è€…å°šæœªå•Ÿç”¨</h2>
                                <p>è¦ªæ„›çš„ <strong>${user.displayName || user.email}</strong>ï¼Œ</p>
                                <p>æ‚¨çš„å¸³è™Ÿç›®å‰å°šæœªå•Ÿç”¨ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡é€²è¡Œå•Ÿç”¨ã€‚</p>
                                <div class="user-info">
                                    <p><strong>Email:</strong> ${user.email}</p>
                                    <p><strong>ç‹€æ…‹:</strong> ç­‰å¾…å•Ÿç”¨</p>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="window.firebaseAuth.signOut(); window.location.href='expenses_login.html';" class="logout-btn">
                                        ç™»å‡º
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // ç­‰å¾… Firebase è¼‰å…¥
            waitForFirebase() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 50; // 5ç§’è¶…æ™‚ (50 * 100ms)
                    
                    const checkFirebase = () => {
                        attempts++;
                        
                        // é¦–å…ˆæª¢æŸ¥ firebaseLoaded æ¨™è¨˜
                        if (window.firebaseLoaded) {
                            console.log(`Firebase SDK è¼‰å…¥å®Œæˆï¼Œå˜—è©¦æ¬¡æ•¸: ${attempts}`);
                            resolve();
                            return;
                        }
                        
                        // æª¢æŸ¥æ‰€æœ‰å¿…è¦çš„Firebaseå‡½æ•¸
                        const requiredFunctions = [
                            'firebaseAuth', 'firebaseDb', 'firebaseCollection', 
                            'firebaseAddDoc', 'firebaseGetDocs', 'firebaseUpdateDoc', 
                            'firebaseDeleteDoc', 'firebaseDoc', 'firebaseSetDoc',
                            'firebaseQuery', 'firebaseOrderBy', 'firebaseWhere', 
                            'firebaseServerTimestamp', 'firebaseOnAuthStateChanged'
                        ];
                        
                        const loadedFunctions = requiredFunctions.filter(func => {
                            return window[func] && typeof window[func] === 'function';
                        });
                        
                        const missingFunctions = requiredFunctions.filter(func => !window[func]);
                        
                        console.log(`Firebase è¼‰å…¥æª¢æŸ¥ (${attempts}/${maxAttempts}): å·²è¼‰å…¥ ${loadedFunctions.length}/${requiredFunctions.length} å€‹å‡½æ•¸`);
                        
                        if (window.firebaseAuth && window.firebaseDb && loadedFunctions.length === requiredFunctions.length) {
                            console.log(`Firebase è¼‰å…¥æˆåŠŸï¼Œå˜—è©¦æ¬¡æ•¸: ${attempts}`);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            console.error('Firebase è¼‰å…¥è¶…æ™‚');
                            console.error('å·²è¼‰å…¥çš„å‡½æ•¸:', loadedFunctions);
                            console.error('ç¼ºå°‘çš„å‡½æ•¸:', missingFunctions);
                            reject(new Error(`Firebase SDK è¼‰å…¥è¶…æ™‚ï¼Œç¼ºå°‘å‡½æ•¸: ${missingFunctions.join(', ')}`));
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    
                    checkFirebase();
                });
            }

            // å¾ Firebase è¼‰å…¥è¨˜éŒ„
            async loadRecordsFromFirebase() {
                try {
                    console.log('é–‹å§‹å¾ Firebase è¼‰å…¥è¨˜éŒ„...');
                    const recordsRef = window.firebaseCollection(window.firebaseDb, 'records');
                    
                    // ä½¿ç”¨ Firebase åŸç”ŸæŸ¥è©¢å’Œæ’åºï¼ˆéœ€è¦è¤‡åˆç´¢å¼•ï¼‰
                    const q = window.firebaseQuery(
                        recordsRef,
                        window.firebaseWhere('userId', '==', this.currentUser.uid),
                        window.firebaseOrderBy('date', 'desc')
                    );
                    
                    const querySnapshot = await window.firebaseGetDocs(q);
                    this.records = [];
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        this.records.push({
                            id: doc.id,
                            type: data.type,
                            member: data.member,
                            mainCategory: data.mainCategory,
                            subCategory: data.subCategory,
                            amount: data.amount,
                            description: data.description,
                            date: data.date
                        });
                    });
                    
                    console.log(`å¾ Firebase è¼‰å…¥äº† ${this.records.length} ç­†è¨˜éŒ„ï¼ˆå·²æŒ‰æ—¥æœŸé™åºæ’åˆ—ï¼‰`);
                    this.updateDisplay();
                } catch (error) {
                    console.error('å¾ Firebase è¼‰å…¥è¨˜éŒ„å¤±æ•—:', error);
                    console.error('éŒ¯èª¤è©³æƒ…:', {
                        message: error.message,
                        code: error.code,
                        userId: this.currentUser?.uid
                    });
                    
                    // å¦‚æœæ˜¯ç´¢å¼•éŒ¯èª¤ï¼Œé¡¯ç¤ºæç¤ºè€Œä¸æ˜¯å°å‘ç™»å…¥é é¢
                    if (error.code === 'failed-precondition' && error.message.includes('index')) {
                        console.error('ğŸ” Firebase ç´¢å¼•å•é¡Œï¼Œè«‹æª¢æŸ¥ç´¢å¼•è¨­å®š');
                        console.error('å»ºè­°çš„ç´¢å¼•è¨­å®š:');
                        console.error('- é›†åˆ: records');
                        console.error('- æ¬„ä½: userId (å‡åº), date (é™åº)');
                        
                        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ä½¿ç”¨è€…
                        this.showIndexError();
                    } else {
                        // å…¶ä»–éŒ¯èª¤æ‰å°å‘ç™»å…¥é é¢
                        window.location.href = 'expenses_login.html';
                    }
                }
            }

            // æ›´æ–°é¡¯ç¤º
            updateDisplay() {
                this.displayRecords(this.records);
                this.updateSummary(this.records);
            }

            // é¡¯ç¤ºè¨˜éŒ„
            displayRecords(records) {
                const recordsList = document.getElementById('recordsList');
                
                if (records.length === 0) {
                    recordsList.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: #999;">æš«ç„¡è¨˜éŒ„</div>';
                    return;
                }

                // è¨ˆç®—åˆ†é 
                const totalPages = Math.ceil(records.length / this.recordsPerPage);
                const startIndex = (this.currentPage - 1) * this.recordsPerPage;
                const endIndex = startIndex + this.recordsPerPage;
                const pageRecords = records.slice(startIndex, endIndex);

                let html = `
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ
                                    <div class="date-filter-container">
                                        <select class="filter-dropdown" onchange="expenseTracker.applyTableFilter(true)">
                                            <option value="">å…¨éƒ¨</option>
                                        </select>
                                        <select class="filter-dropdown" onchange="expenseTracker.applyTableFilter(true)">
                                            <option value="">å…¨éƒ¨</option>
                                        </select>
                                    </div>
                                </th>
                                <th>å®¶åº­æˆå“¡
                                    <select class="filter-dropdown" onchange="expenseTracker.applyTableFilter(true)">
                                        <option value="">å…¨éƒ¨</option>
                                    </select>
                                </th>
                                <th>é¡å‹
                                    <select class="filter-dropdown" onchange="expenseTracker.applyTableFilter(true)">
                                        <option value="">å…¨éƒ¨</option>
                                    </select>
                                </th>
                                <th>é¡åˆ¥
                                    <select class="filter-dropdown" onchange="expenseTracker.applyTableFilter(true)">
                                        <option value="">å…¨éƒ¨</option>
                                    </select>
                                </th>
                                <th>ç´°é …
                                    <select class="filter-dropdown" onchange="expenseTracker.applyTableFilter(true)">
                                        <option value="">å…¨éƒ¨</option>
                                    </select>
                                </th>
                                <th>é‡‘é¡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                pageRecords.forEach(record => {
                    const amountClass = record.type === 'æ”¶å…¥' ? 'amount-income' : 
                                       record.type === 'æ”¯å‡º' ? 'amount-expense' : 'amount-asset';
                    
                    html += `
                        <tr>
                            <td>${record.date}</td>
                            <td>${record.member}</td>
                            <td>${record.type}</td>
                            <td>${record.mainCategory}</td>
                            <td>${record.subCategory}</td>
                            <td class="${amountClass}">$${this.formatNumber(record.amount)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn edit-btn" onclick="expenseTracker.editRecord('${record.id}')" title="ç·¨è¼¯"></button>
                                    <button class="action-btn delete-btn" onclick="expenseTracker.deleteRecord('${record.id}')" title="åˆªé™¤"></button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                recordsList.innerHTML = html;
            }

            // æ›´æ–°æ‘˜è¦
            updateSummary(records) {
                const totalIncome = records.filter(r => r.type === 'æ”¶å…¥').reduce((sum, r) => sum + r.amount, 0);
                const totalExpense = records.filter(r => r.type === 'æ”¯å‡º').reduce((sum, r) => sum + r.amount, 0);
                const totalAssets = records.filter(r => r.type === 'è³‡ç”¢').reduce((sum, r) => sum + r.amount, 0);
                const totalNetWorth = totalIncome - totalExpense + totalAssets;

                document.getElementById('totalIncome').textContent = '$' + this.formatNumber(totalIncome);
                document.getElementById('totalExpense').textContent = '$' + this.formatNumber(totalExpense);
                document.getElementById('totalAssets').textContent = '$' + this.formatNumber(totalAssets);
                document.getElementById('totalNetWorth').textContent = '$' + this.formatNumber(totalNetWorth);
            }

            // é¡¯ç¤ºåœ–è¡¨å½ˆçª—
            showChartsModal() {
                console.log('é¡¯ç¤ºåœ–è¡¨å½ˆçª—');
                const modal = document.getElementById('chartsModal');
                if (modal) {
                    modal.style.display = 'block';
                    // åˆå§‹åŒ–åœ–è¡¨
                    this.initCharts();
                } else {
                    console.error('æ‰¾ä¸åˆ°åœ–è¡¨å½ˆçª—å…ƒç´ ');
                }
            }

            // éš±è—åœ–è¡¨å½ˆçª—
            hideChartsModal() {
                console.log('éš±è—åœ–è¡¨å½ˆçª—');
                const modal = document.getElementById('chartsModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // åˆå§‹åŒ–åœ–è¡¨
            initCharts() {
                console.log('åˆå§‹åŒ–åœ–è¡¨');
                // é€™è£¡å¯ä»¥æ·»åŠ åœ–è¡¨åˆå§‹åŒ–é‚è¼¯
                // æš«æ™‚é¡¯ç¤ºæç¤ºè¨Šæ¯
                const chartContainers = document.querySelectorAll('.chart-container');
                chartContainers.forEach(container => {
                    const canvas = container.querySelector('canvas');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#999';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('åœ–è¡¨åŠŸèƒ½é–‹ç™¼ä¸­...', canvas.width / 2, canvas.height / 2);
                    }
                });
            }

            // åˆå§‹åŒ–è¡¨å–®äº‹ä»¶ç›£è½å™¨
            initFormEventListeners() {
                console.log('åˆå§‹åŒ–è¡¨å–®äº‹ä»¶ç›£è½å™¨');
                
                // é¡åˆ¥é¸æ“‡è®ŠåŒ–æ™‚æ›´æ–°ç´°é …é¸é …
                const mainCategorySelect = document.getElementById('mainCategory');
                if (mainCategorySelect) {
                    mainCategorySelect.addEventListener('change', (e) => {
                        this.updateSubCategoryOptions(e.target.value);
                    });
                }

                // é¡å‹é¸æ“‡è®ŠåŒ–æ™‚æ›´æ–°é¡åˆ¥é¸é …
                const typeSelect = document.getElementById('type');
                if (typeSelect) {
                    typeSelect.addEventListener('change', (e) => {
                        this.updateMainCategoryOptions(e.target.value);
                    });
                }
            }

            // æ›´æ–°ç´°é …é¸é …
            updateSubCategoryOptions(mainCategory) {
                console.log('æ›´æ–°ç´°é …é¸é …:', mainCategory);
                const subCategorySelect = document.getElementById('subCategory');
                if (!subCategorySelect) return;

                // æ¸…ç©ºç¾æœ‰é¸é …
                subCategorySelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡é¡åˆ¥</option>';

                if (!mainCategory) return;

                // æ ¹æ“šä¸»é¡åˆ¥è¨­å®šç´°é …é¸é …
                const subCategories = {
                    'é£Ÿ': ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'é»å¿ƒ', 'é£²æ–™', 'é£Ÿæ', 'å¤–é£Ÿ'],
                    'è¡£': ['æœè£', 'é‹å­', 'é…ä»¶', 'ä¿é¤Šå“', 'åŒ–å¦å“'],
                    'ä½': ['æˆ¿ç§Ÿ', 'æ°´é›»è²»', 'ç“¦æ–¯è²»', 'ç¶²è·¯è²»', 'ç®¡ç†è²»', 'å®¶å…·', 'å®¶é›»'],
                    'è¡Œ': ['æ²¹è²»', 'åœè»Šè²»', 'å¤§çœ¾é‹è¼¸', 'è¨ˆç¨‹è»Š', 'æ©Ÿè»Šä¿é¤Š', 'æ±½è»Šä¿é¤Š', 'ä¿éšª'],
                    'è‚²': ['å­¸è²»', 'æ›¸ç±', 'æ–‡å…·', 'è£œç¿’è²»', 'æ•™è‚²ç”¨å“'],
                    'æ¨‚': ['é›»å½±', 'KTV', 'æ—…éŠ', 'é‹å‹•', 'éŠæˆ²', 'å¨›æ¨‚ç”¨å“'],
                    'é†«ç™‚': ['æ›è™Ÿè²»', 'è—¥è²»', 'å¥æª¢', 'é†«ç™‚ç”¨å“'],
                    'å…¶ä»–æ”¯å‡º': ['é›œè²»', 'ç¦®é‡‘', 'ææ¬¾', 'å…¶ä»–'],
                    'è–ªè³‡': ['æœˆè–ª', 'çé‡‘', 'åŠ ç­è²»', 'æ´¥è²¼'],
                    'æŠ•è³‡': ['è‚¡ç¥¨', 'åŸºé‡‘', 'å‚µåˆ¸', 'å¤–åŒ¯', 'å…¶ä»–æŠ•è³‡'],
                    'å‹•ç”¢': ['ç¾é‡‘', 'å­˜æ¬¾', 'è‚¡ç¥¨', 'åŸºé‡‘', 'å‚µåˆ¸', 'å¤–åŒ¯', 'å…¶ä»–'],
                    'ä¸å‹•ç”¢': ['æˆ¿å±‹', 'åœŸåœ°', 'å…¶ä»–ä¸å‹•ç”¢']
                };

                const options = subCategories[mainCategory] || [];
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    subCategorySelect.appendChild(optionElement);
                });

                console.log(`å·²æ·»åŠ  ${options.length} å€‹ç´°é …é¸é …`);
            }

            // æ›´æ–°ä¸»é¡åˆ¥é¸é …
            updateMainCategoryOptions(type) {
                console.log('æ›´æ–°ä¸»é¡åˆ¥é¸é …:', type);
                const mainCategorySelect = document.getElementById('mainCategory');
                const subCategorySelect = document.getElementById('subCategory');
                
                if (!mainCategorySelect) return;

                // æ¸…ç©ºç¾æœ‰é¸é …
                mainCategorySelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡é¡å‹</option>';
                
                // åŒæ™‚æ¸…ç©ºç´°é …é¸é …
                if (subCategorySelect) {
                    subCategorySelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡é¡åˆ¥</option>';
                }

                if (!type) return;

                // æ ¹æ“šé¡å‹è¨­å®šä¸»é¡åˆ¥é¸é …
                const categories = {
                    'æ”¯å‡º': [
                        { value: 'é£Ÿ', text: 'é£Ÿ' },
                        { value: 'è¡£', text: 'è¡£' },
                        { value: 'ä½', text: 'ä½' },
                        { value: 'è¡Œ', text: 'è¡Œ' },
                        { value: 'è‚²', text: 'è‚²' },
                        { value: 'æ¨‚', text: 'æ¨‚' },
                        { value: 'é†«ç™‚', text: 'é†«ç™‚' },
                        { value: 'å…¶ä»–æ”¯å‡º', text: 'å…¶ä»–æ”¯å‡º' }
                    ],
                    'æ”¶å…¥': [
                        { value: 'è–ªè³‡', text: 'è–ªè³‡' },
                        { value: 'æŠ•è³‡', text: 'æŠ•è³‡' }
                    ],
                    'è³‡ç”¢': [
                        { value: 'å‹•ç”¢', text: 'å‹•ç”¢' },
                        { value: 'ä¸å‹•ç”¢', text: 'ä¸å‹•ç”¢' }
                    ]
                };

                const options = categories[type] || [];
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    optionElement.setAttribute('data-type', type);
                    mainCategorySelect.appendChild(optionElement);
                });

                console.log(`å·²æ·»åŠ  ${options.length} å€‹ä¸»é¡åˆ¥é¸é …`);
            }

            // åˆå§‹åŒ–
            init() {
                this.initFirebase();
                // ç­‰å¾… DOM è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.initFormEventListeners();
                    });
                } else {
                    this.initFormEventListeners();
                }
            }
        }

        // å‰µå»º ExpenseTracker å¯¦ä¾‹
        const expenseTracker = new ExpenseTracker();
    </script>
</body>
</html>
