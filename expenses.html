<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭記帳系統</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, getDoc, updateDoc, deleteDoc, doc, setDoc, query, orderBy, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDfHs1XXsCXGMSVF3NFJUtFMcslTzTd-EU",
            authDomain: "expenses-91280.firebaseapp.com",
            projectId: "expenses-91280",
            storageBucket: "expenses-91280.firebasestorage.app",
            messagingSenderId: "777956465315",
            appId: "1:777956465315:web:04f85f2b22f2468eb2fd16",
            measurementId: "G-1LE7YTKHGT"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 將 Firebase 實例設為全域變數
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseGetDoc = getDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseWhere = where;
        window.firebaseServerTimestamp = serverTimestamp;
        window.firebaseSignInAnonymously = signInAnonymously;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        
        // 標記 Firebase 已載入
        window.firebaseLoaded = true;
        console.log('Firebase SDK 已載入完成');
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>家庭記帳系統</h1>
            <div class="summary">
                <div class="summary-item">
                    <span class="label">總收入</span>
                    <span class="amount income" id="totalIncome">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">總支出</span>
                    <span class="amount expense" id="totalExpense">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">現有資產</span>
                    <span class="amount asset" id="totalAssets">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">總資產</span>
                    <span class="amount balance" id="totalNetWorth">$0</span>
                </div>
            </div>
            <button class="charts-btn" onclick="expenseTracker.showChartsModal()">📊 圖表分析</button>
        </header>

        <main>
            <!-- 新增記錄區域 -->
            <section class="add-record">
                <h2>新增記帳記錄</h2>
                <form id="recordForm">
                    <div class="form-grid">
                    <div class="form-group">
                        <label for="member">家庭成員</label>
                        <select id="member" required>
                            <option value="">請選擇成員</option>
                            <option value="爸爸">爸爸</option>
                            <option value="媽媽">媽媽</option>
                            <option value="孩子">孩子</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="type">類型</label>
                        <select id="type" required>
                            <option value="">請選擇類型</option>
                            <option value="支出">支出</option>
                            <option value="收入">收入</option>
                            <option value="資產">資產</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="mainCategory">類別</label>
                        <select id="mainCategory" required>
                            <option value="">請選擇類別</option>
                            <!-- 支出大項目 -->
                            <option value="食" data-type="支出">食</option>
                            <option value="衣" data-type="支出">衣</option>
                            <option value="住" data-type="支出">住</option>
                            <option value="行" data-type="支出">行</option>
                            <option value="育" data-type="支出">育</option>
                            <option value="樂" data-type="支出">樂</option>
                            <option value="醫療" data-type="支出">醫療</option>
                            <option value="其他支出" data-type="支出">其他支出</option>
                            <!-- 收入大項目 -->
                            <option value="薪資" data-type="收入">薪資</option>
                            <option value="投資" data-type="收入">投資</option>
                            <!-- 資產大項目 -->
                            <option value="動產" data-type="資產">動產</option>
                            <option value="不動產" data-type="資產">不動產</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="subCategory">細項</label>
                        <select id="subCategory" required>
                            <option value="">請先選擇類別</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">金額</label>
                        <input type="number" id="amount" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">描述</label>
                        <input type="text" id="description" placeholder="輸入描述...">
                    </div>
                    
                    <div class="form-group">
                        <label for="date">日期</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit">新增記錄</button>
                        <button type="button" onclick="expenseTracker.resetForm()" class="reset-btn">清空表單</button>
                    </div>
                </form>
            </section>


            <!-- 記錄列表區域 -->
            <section class="records">
                <h2>記帳記錄</h2>
                <div class="records-list" id="recordsList">
                    <!-- 記錄將動態生成 -->
                </div>
                
                <!-- 分頁控件 -->
                <div class="pagination" id="pagination">
                    <div class="page-size-selector">
                        <label for="pageSize">每頁顯示：</label>
                        <select id="pageSize">
                            <option value="5">5 筆</option>
                            <option value="10">10 筆</option>
                            <option value="20" selected>20 筆</option>
                            <option value="50">50 筆</option>
                        </select>
                    </div>
                    
                    <div class="page-controls">
                        <button id="prevPage" class="page-btn" disabled>上一頁</button>
                        <div class="page-info">
                            <span id="pageInfo">第 1 頁，共 1 頁</span>
                        </div>
                        <button id="nextPage" class="page-btn" disabled>下一頁</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 圖表彈窗 -->
    <div id="chartsModal" class="modal">
        <div class="modal-content charts-modal">
            <div class="modal-header">
                <h2>📊 圖表分析</h2>
                <span class="close" onclick="expenseTracker.hideChartsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 圖表篩選器 -->
                <div class="chart-filters">
                    <h3>圖表篩選</h3>
                    <div class="filter-group">
                        <label for="chartFilterType">類型：</label>
                        <select id="chartFilterType">
                            <option value="">所有類型</option>
                            <option value="收入">收入</option>
                            <option value="支出">支出</option>
                            <option value="資產">資產</option>
                        </select>
                        
                        <label for="chartFilterYear">年份：</label>
                        <select id="chartFilterYear">
                            <option value="">所有年份</option>
                        </select>
                        
                        <label for="chartFilterMonth">月份：</label>
                        <select id="chartFilterMonth">
                            <option value="">所有月份</option>
                            <option value="01">1月</option>
                            <option value="02">2月</option>
                            <option value="03">3月</option>
                            <option value="04">4月</option>
                            <option value="05">5月</option>
                            <option value="06">6月</option>
                            <option value="07">7月</option>
                            <option value="08">8月</option>
                            <option value="09">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="expense-section-title">支出統計</h2>
                <div class="chart-row expense-section">
                    <div class="chart-container">
                        <h3>支出類別分布</h3>
                        <canvas id="expenseCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>家庭成員支出分布</h3>
                        <canvas id="expenseMemberChart"></canvas>
                    </div>
                </div>
                
                <h2 class="income-section-title">收入統計</h2>
                <div class="chart-row income-section">
                    <div class="chart-container">
                        <h3>收入類別分布</h3>
                        <canvas id="incomeCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>家庭成員收入分布</h3>
                        <canvas id="incomeMemberChart"></canvas>
                    </div>
                </div>
                
                <h2 class="asset-section-title">資產統計</h2>
                <div class="chart-row asset-section">
                    <div class="chart-container">
                        <h3>資產類別分布</h3>
                        <canvas id="assetCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>家庭成員資產分布</h3>
                        <canvas id="assetMemberChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="expenseTracker.hideChartsModal()">關閉</button>
            </div>
        </div>
    </div>

    <script>
        // ExpenseTracker 類別
        class ExpenseTracker {
            // 格式化數字，添加千分位分隔符（整數顯示）
            formatNumber(number) {
                return Math.round(number).toLocaleString('zh-TW');
            }

            constructor() {
                this.records = [];
                this.editingId = null;
                this.currentPage = 1;
                this.recordsPerPage = 20;
                this.currentUser = null;
                this.isFirebaseReady = false;
                
                this.categoryStructure = {
                    '食': ['外食', '食材', '飲料', '零食', '其他'],
                    '衣': ['服飾', '鞋子', '配件', '美容', '其他'],
                    '住': ['房貸', '租金', '水電瓦斯', '居家用品', '家具家電', '裝潢修繕', '網路費', '通訊', '其他'],
                    '行': ['交通費', '油費', '停車費', '大眾運輸', '交通工具保養', '其他'],
                    '育': ['學費', '書籍', '進修', '文具', '其他'],
                    '樂': ['娛樂', '旅遊', '運動', '社交', '其他'],
                    '醫療': ['診療', '藥品', '健檢', '醫療用品', '其他'],
                    '其他支出': ['投資', '教會奉獻', '保險', '稅務', '其他'],
                    '薪資': ['本薪', '獎金', '兼職', '其他'],
                    '投資': ['股票', '基金', '債券', '加密貨幣', '其他'],
                    '動產': ['存款', '股票', '基金', '債券', '加密貨幣', '其他'],
                    '不動產': ['房屋', '土地', '店面', '停車位', '其他']
                };
                
                this.init();
            }

            // Firebase 初始化
            async initFirebase() {
                try {
                    console.log('開始初始化 Firebase...');
                    
                    // 等待 Firebase 載入
                    await this.waitForFirebase();
                    console.log('Firebase SDK 已載入');
                    
                    // 檢查 Firebase 實例是否正確初始化
                    if (!window.firebaseAuth || !window.firebaseDb) {
                        throw new Error('Firebase 實例未正確初始化');
                    }
                    
                    console.log('Firebase 實例檢查通過');
                    
                    // 使用 Promise 等待認證狀態
                    const authState = await this.waitForAuthStateWithPromise();
                    console.log('認證狀態檢查完成:', authState ? `已登入 ${authState.email}` : '未登入');
                    
                    if (authState) {
                        console.log('檢測到現有登入狀態:', authState.uid);
                        console.log('使用者詳細資訊:', {
                            uid: authState.uid,
                            email: authState.email,
                            displayName: authState.displayName,
                            providerId: authState.providerData?.[0]?.providerId
                        });
                        
                        // 檢查使用者啟用狀態
                        console.log('開始檢查使用者啟用狀態...');
                        const userStatus = await this.checkUserStatus(authState);
                        console.log('使用者狀態檢查結果:', userStatus);
                        console.log('isActive 值:', userStatus.isActive);
                        console.log('isActive 類型:', typeof userStatus.isActive);
                        
                        if (!userStatus.isActive) {
                            console.log('❌ 使用者尚未啟用，顯示未啟用訊息:', authState.email);
                            this.showInactiveUserMessage(authState);
                            return;
                        } else {
                            console.log('✅ 使用者已啟用，繼續載入應用程式');
                        }
                        
                        this.currentUser = authState;
                        this.isFirebaseReady = true;
                        
                        // 記錄/更新使用者基本資料
                        this.updateUserProfile(authState);
                        
                        // 載入記錄
                        this.loadRecordsFromFirebase();
                    } else {
                        console.log('未檢測到登入狀態，導向登入頁面');
                        window.location.href = 'expenses_login.html';
                    }
                    
                    // 監聽認證狀態變化
                    window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
                        if (user) {
                            console.log('認證狀態變化 - 已登入:', user.uid);
                            
                            // 檢查使用者啟用狀態
                            this.checkUserStatus(user).then(userStatus => {
                                if (!userStatus.isActive) {
                                    console.log('使用者尚未啟用:', user.email);
                                    this.showInactiveUserMessage(user);
                                    return;
                                }
                                
                                this.currentUser = user;
                                this.isFirebaseReady = true;
                                
                                // 記錄/更新使用者基本資料
                                this.updateUserProfile(user);
                                
                                // 載入記錄
                                this.loadRecordsFromFirebase();
                            });
                        } else {
                            console.log('認證狀態變化 - 已登出，導向登入頁面');
                            window.location.href = 'expenses_login.html';
                        }
                    });
                } catch (error) {
                    console.error('Firebase 初始化失敗:', error);
                    console.error('錯誤詳情:', {
                        message: error.message,
                        stack: error.stack,
                        firebaseAuth: !!window.firebaseAuth,
                        firebaseDb: !!window.firebaseDb
                    });
                    
                    // 顯示錯誤訊息給使用者
                    this.showFirebaseError(error);
                }
            }

            // 使用 Promise 等待認證狀態
            waitForAuthStateWithPromise() {
                return new Promise((resolve) => {
                    console.log('開始等待認證狀態...');
                    
                    // 先檢查當前是否有已登入的使用者
                    const currentUser = window.firebaseAuth.currentUser;
                    if (currentUser) {
                        console.log('檢測到當前已登入使用者:', currentUser.uid, currentUser.email);
                        resolve(currentUser);
                        return;
                    }
                    
                    console.log('當前無登入使用者，等待認證狀態變化...');
                    
                    const unsubscribe = window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
                        console.log('認證狀態變化:', user ? `已登入 ${user.email}` : '已登出');
                        unsubscribe(); // 取消監聽
                        resolve(user);
                    });
                    
                    // 設置超時，避免無限等待
                    setTimeout(() => {
                        console.log('認證狀態檢查超時');
                        unsubscribe();
                        resolve(null);
                    }, 10000); // 10秒超時
                });
            }

            // 更新使用者基本資料
            async updateUserProfile(user) {
                try {
                    // 確保Firebase函數已載入
                    if (!window.firebaseDoc || !window.firebaseSetDoc || !window.firebaseServerTimestamp || !window.firebaseGetDoc) {
                        console.error('Firebase函數未載入，無法更新使用者資料');
                        return;
                    }
                    
                    const userRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                    
                    // 先檢查使用者是否已存在
                    const existingUserDoc = await window.firebaseGetDoc(userRef);
                    const isNewUser = !existingUserDoc.exists();
                    
                    // 準備使用者資料
                    const userData = {
                        uid: user.uid,
                        email: user.email ?? null,
                        displayName: user.displayName ?? null,
                        photoURL: user.photoURL ?? null,
                        providerId: user.providerData?.[0]?.providerId ?? null,
                        lastLoginAt: window.firebaseServerTimestamp()
                    };
                    
                    // 只有新使用者才設定 isActive
                    if (isNewUser) {
                        console.log('新使用者，設定預設狀態');
                        userData.isActive = false;  // 預設不啟用
                        userData.createdAt = window.firebaseServerTimestamp();
                    } else {
                        console.log('現有使用者，保持原有 isActive 狀態');
                    }
                    
                    await window.firebaseSetDoc(userRef, userData, { merge: true });
                    console.log('使用者資料已更新:', user.uid);
                } catch (error) {
                    console.error('更新使用者資料失敗:', error);
                }
            }

            // 顯示Firebase錯誤訊息
            showFirebaseError(error) {
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">⚠️</div>
                                <h2>系統初始化失敗</h2>
                                <p>很抱歉，系統無法正常載入。請檢查以下項目：</p>
                                <div class="user-info">
                                    <p><strong>錯誤訊息:</strong> ${error.message}</p>
                                    <p><strong>可能原因:</strong></p>
                                    <ul style="text-align: left; margin: 10px 0;">
                                        <li>網路連線問題</li>
                                        <li>Firebase服務暫時無法使用</li>
                                        <li>瀏覽器快取問題</li>
                                        <li>Firebase配置錯誤</li>
                                    </ul>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="location.reload();" class="logout-btn" style="background: #3498db;">
                                        重新載入
                                    </button>
                                    <button onclick="window.location.href='expenses_login.html';" class="logout-btn">
                                        返回登入
                                    </button>
                                </div>
                                <div style="margin-top: 20px; font-size: 0.9em; color: #999;">
                                    <p>如果問題持續發生，請聯繫技術支援</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // 檢查使用者啟用狀態
            async checkUserStatus(user) {
                try {
                    console.log('檢查使用者狀態:', user.uid);
                    
                    // 確保Firebase函數已載入
                    if (!window.firebaseDoc || !window.firebaseGetDoc) {
                        console.error('Firebase函數未載入');
                        return { isActive: false };
                    }
                    
                    // 直接讀取特定使用者的文件
                    const userRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                    const userDoc = await window.firebaseGetDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        console.log('找到使用者資料:', userData);
                        console.log('原始 isActive 值:', userData.isActive);
                        console.log('原始 isActive 類型:', typeof userData.isActive);
                        const result = {
                            isActive: userData.isActive || false
                        };
                        console.log('返回的結果:', result);
                        return result;
                    }
                    
                    console.log('未找到使用者資料，返回預設狀態');
                    return { isActive: false };
                } catch (error) {
                    console.error('檢查使用者狀態失敗:', error);
                    console.error('錯誤詳情:', {
                        message: error.message,
                        code: error.code,
                        userId: user.uid
                    });
                    
                    // 如果是權限錯誤，提供解決方案
                    if (error.code === 'permission-denied') {
                        console.error('🔒 權限被拒絕！請檢查 Firebase 安全規則');
                        console.error('建議的安全規則:');
                        console.error(`
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
                        `);
                    }
                    
                    return { isActive: false };
                }
            }

            // 顯示索引錯誤訊息
            showIndexError() {
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">🔍</div>
                                <h2>Firebase 索引設定</h2>
                                <p>系統需要建立 Firebase 索引才能正常運作。</p>
                                <div class="user-info">
                                    <p><strong>解決步驟:</strong></p>
                                    <ol style="text-align: left; margin: 10px 0;">
                                        <li>前往 <a href="https://console.firebase.google.com/project/expenses-91280/firestore/indexes" target="_blank">Firebase Console</a></li>
                                        <li>點擊「建立索引」</li>
                                        <li>設定集合: <code>records</code></li>
                                        <li>設定欄位: <code>userId</code> (升序), <code>date</code> (降序)</li>
                                        <li>等待索引建立完成（通常需要幾分鐘）</li>
                                        <li>重新整理此頁面</li>
                                    </ol>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="location.reload();" class="logout-btn" style="background: #3498db;">
                                        重新載入
                                    </button>
                                    <button onclick="window.location.href='expenses_login.html';" class="logout-btn">
                                        返回登入
                                    </button>
                                </div>
                                <div style="margin-top: 20px; font-size: 0.9em; color: #999;">
                                    <p>如果問題持續發生，請聯繫技術支援</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // 顯示未啟用使用者訊息
            showInactiveUserMessage(user) {
                // 隱藏所有輸入表單
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">⏳</div>
                                <h2>使用者尚未啟用</h2>
                                <p>親愛的 <strong>${user.displayName || user.email}</strong>，</p>
                                <p>您的帳號目前尚未啟用，請聯繫管理員進行啟用。</p>
                                <div class="user-info">
                                    <p><strong>Email:</strong> ${user.email}</p>
                                    <p><strong>狀態:</strong> 等待啟用</p>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="window.firebaseAuth.signOut(); window.location.href='expenses_login.html';" class="logout-btn">
                                        登出
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // 等待 Firebase 載入
            waitForFirebase() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 50; // 5秒超時 (50 * 100ms)
                    
                    const checkFirebase = () => {
                        attempts++;
                        
                        // 首先檢查 firebaseLoaded 標記
                        if (window.firebaseLoaded) {
                            console.log(`Firebase SDK 載入完成，嘗試次數: ${attempts}`);
                            resolve();
                            return;
                        }
                        
                        // 檢查所有必要的Firebase函數
                        const requiredFunctions = [
                            'firebaseAuth', 'firebaseDb', 'firebaseCollection', 
                            'firebaseAddDoc', 'firebaseGetDocs', 'firebaseUpdateDoc', 
                            'firebaseDeleteDoc', 'firebaseDoc', 'firebaseSetDoc',
                            'firebaseQuery', 'firebaseOrderBy', 'firebaseWhere', 
                            'firebaseServerTimestamp', 'firebaseOnAuthStateChanged'
                        ];
                        
                        const loadedFunctions = requiredFunctions.filter(func => {
                            return window[func] && typeof window[func] === 'function';
                        });
                        
                        const missingFunctions = requiredFunctions.filter(func => !window[func]);
                        
                        console.log(`Firebase 載入檢查 (${attempts}/${maxAttempts}): 已載入 ${loadedFunctions.length}/${requiredFunctions.length} 個函數`);
                        
                        if (window.firebaseAuth && window.firebaseDb && loadedFunctions.length === requiredFunctions.length) {
                            console.log(`Firebase 載入成功，嘗試次數: ${attempts}`);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            console.error('Firebase 載入超時');
                            console.error('已載入的函數:', loadedFunctions);
                            console.error('缺少的函數:', missingFunctions);
                            reject(new Error(`Firebase SDK 載入超時，缺少函數: ${missingFunctions.join(', ')}`));
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    
                    checkFirebase();
                });
            }

            // 從 Firebase 載入記錄
            async loadRecordsFromFirebase() {
                try {
                    console.log('開始從 Firebase 載入記錄...');
                    const recordsRef = window.firebaseCollection(window.firebaseDb, 'records');
                    
                    // 使用 Firebase 原生查詢和排序（需要複合索引）
                    const q = window.firebaseQuery(
                        recordsRef,
                        window.firebaseWhere('userId', '==', this.currentUser.uid),
                        window.firebaseOrderBy('date', 'desc')
                    );
                    
                    const querySnapshot = await window.firebaseGetDocs(q);
                    this.records = [];
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        this.records.push({
                            id: doc.id,
                            type: data.type,
                            member: data.member,
                            mainCategory: data.mainCategory,
                            subCategory: data.subCategory,
                            amount: data.amount,
                            description: data.description,
                            date: data.date
                        });
                    });
                    
                    console.log(`從 Firebase 載入了 ${this.records.length} 筆記錄（已按日期降序排列）`);
                    this.updateDisplay();
                } catch (error) {
                    console.error('從 Firebase 載入記錄失敗:', error);
                    console.error('錯誤詳情:', {
                        message: error.message,
                        code: error.code,
                        userId: this.currentUser?.uid
                    });
                    
                    // 如果是索引錯誤，顯示提示而不是導向登入頁面
                    if (error.code === 'failed-precondition' && error.message.includes('index')) {
                        console.error('🔍 Firebase 索引問題，請檢查索引設定');
                        console.error('建議的索引設定:');
                        console.error('- 集合: records');
                        console.error('- 欄位: userId (升序), date (降序)');
                        
                        // 顯示錯誤訊息給使用者
                        this.showIndexError();
                    } else {
                        // 其他錯誤才導向登入頁面
                        window.location.href = 'expenses_login.html';
                    }
                }
            }

            // 更新顯示
            updateDisplay() {
                this.displayRecords(this.records);
                this.updateSummary(this.records);
            }

            // 顯示記錄
            displayRecords(records) {
                const recordsList = document.getElementById('recordsList');
                
                if (records.length === 0) {
                    recordsList.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: #999;">暫無記錄</div>';
                    this.updatePagination(0);
                    return;
                }

                // 獲取所有可能的篩選選項（使用所有記錄，不是篩選後的記錄）
                const allMembers = [...new Set(this.records.map(r => r.member))];
                const allTypes = [...new Set(this.records.map(r => r.type))];
                const allMainCategories = [...new Set(this.records.map(r => r.mainCategory))];
                const allSubCategories = [...new Set(this.records.map(r => r.subCategory))];
                const allYears = [...new Set(this.records.map(r => r.date.split('-')[0]))].sort((a, b) => b - a);
                const allMonths = [...new Set(this.records.map(r => r.date.split('-')[1]))].sort((a, b) => a - b);

                // 計算分頁
                const totalPages = Math.ceil(records.length / this.recordsPerPage);
                const startIndex = (this.currentPage - 1) * this.recordsPerPage;
                const endIndex = startIndex + this.recordsPerPage;
                const pageRecords = records.slice(startIndex, endIndex);

                // 生成表格HTML
                const tableHTML = `
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>
                                    日期
                                    <div class="date-filter-container">
                                        <select id="tableFilterYear" onchange="expenseTracker.applyTableFilter(true)">
                                            <option value="">全部年份</option>
                                            ${allYears.map(year => `<option value="${year}">${year}</option>`).join('')}
                                        </select>
                                        <select id="tableFilterMonth" onchange="expenseTracker.applyTableFilter(true)">
                                            <option value="">全部月份</option>
                                            ${allMonths.map(month => `<option value="${month}">${month}月</option>`).join('')}
                                        </select>
                                    </div>
                                </th>
                                <th>
                                    家庭成員
                                    <select class="filter-dropdown" id="tableFilterMember" onchange="expenseTracker.applyTableFilter(true)">
                                        <option value="">全部成員</option>
                                        ${allMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                                    </select>
                                </th>
                                <th>
                                    類型
                                    <select class="filter-dropdown" id="tableFilterType" onchange="expenseTracker.applyTableFilter(true)">
                                        <option value="">全部類型</option>
                                        ${allTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                                    </select>
                                </th>
                                <th>
                                    類別
                                    <select class="filter-dropdown" id="tableFilterMainCategory" onchange="expenseTracker.applyTableFilter(true)">
                                        <option value="">全部類別</option>
                                        ${allMainCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                    </select>
                                </th>
                                <th>
                                    細項
                                    <select class="filter-dropdown" id="tableFilterSubCategory" onchange="expenseTracker.applyTableFilter(true)">
                                        <option value="">全部細項</option>
                                        ${allSubCategories.map(sub => `<option value="${sub}">${sub}</option>`).join('')}
                                    </select>
                                </th>
                                <th>金額</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pageRecords
                                .sort((a, b) => new Date(b.date) - new Date(a.date))
                                .map(record => {
                                    const amountClass = record.type === '收入' ? 'amount-income' : 
                                                       record.type === '支出' ? 'amount-expense' : 'amount-asset';
                                    const amountPrefix = record.type === '收入' ? '+' : 
                                                        record.type === '資產' ? '+' : '-';
                                    
                                    return `
                                        <tr>
                                            <td>${record.date}</td>
                                            <td>${record.member}</td>
                                            <td>${record.type}</td>
                                            <td>${record.mainCategory}</td>
                                            <td>${record.subCategory}</td>
                                            <td class="${amountClass}">${amountPrefix}$${this.formatNumber(record.amount)}</td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="action-btn edit-btn" onclick="expenseTracker.editRecord('${record.id}')" title="編輯"></button>
                                                    <button class="action-btn delete-btn" onclick="expenseTracker.deleteRecord('${record.id}')" title="刪除"></button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                        </tbody>
                    </table>
                `;
                
                recordsList.innerHTML = tableHTML;
                this.updatePagination(records.length);
            }

            // 更新摘要
            updateSummary(records) {
                const totalIncome = records.filter(r => r.type === '收入').reduce((sum, r) => sum + r.amount, 0);
                const totalExpense = records.filter(r => r.type === '支出').reduce((sum, r) => sum + r.amount, 0);
                const totalAssets = records.filter(r => r.type === '資產').reduce((sum, r) => sum + r.amount, 0);
                const totalNetWorth = totalIncome - totalExpense + totalAssets;

                document.getElementById('totalIncome').textContent = '$' + this.formatNumber(totalIncome);
                document.getElementById('totalExpense').textContent = '$' + this.formatNumber(totalExpense);
                document.getElementById('totalAssets').textContent = '$' + this.formatNumber(totalAssets);
                document.getElementById('totalNetWorth').textContent = '$' + this.formatNumber(totalNetWorth);
            }

            // 獲取當前篩選後的記錄
            getCurrentFilteredRecords() {
                // 獲取表格篩選器的值
                const yearFilter = document.getElementById('tableFilterYear')?.value || '';
                const monthFilter = document.getElementById('tableFilterMonth')?.value || '';
                const memberFilter = document.getElementById('tableFilterMember')?.value || '';
                const typeFilter = document.getElementById('tableFilterType')?.value || '';
                const mainCategoryFilter = document.getElementById('tableFilterMainCategory')?.value || '';
                const subCategoryFilter = document.getElementById('tableFilterSubCategory')?.value || '';

                // 篩選記錄
                return this.records.filter(record => {
                    const recordYear = record.date.split('-')[0];
                    const recordMonth = record.date.split('-')[1];
                    
                    return (!yearFilter || recordYear === yearFilter) &&
                           (!monthFilter || recordMonth === monthFilter) &&
                           (!memberFilter || record.member === memberFilter) &&
                           (!typeFilter || record.type === typeFilter) &&
                           (!mainCategoryFilter || record.mainCategory === mainCategoryFilter) &&
                           (!subCategoryFilter || record.subCategory === subCategoryFilter);
                });
            }

            // 應用表格篩選
            applyTableFilter(resetPage = true) {
                const filteredRecords = this.getCurrentFilteredRecords();

                // 只有在需要時才重置到第一頁
                if (resetPage) {
                    this.currentPage = 1;
                }
                this.displayRecords(filteredRecords);
                this.updateSummary(filteredRecords);
            }

            // 更新分頁
            updatePagination(totalRecords) {
                const totalPages = Math.ceil(totalRecords / this.recordsPerPage);
                const pageInfo = document.getElementById('pageInfo');
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');
                
                // 更新頁面信息
                if (totalRecords === 0) {
                    pageInfo.textContent = '暫無記錄';
                } else {
                    const startRecord = (this.currentPage - 1) * this.recordsPerPage + 1;
                    const endRecord = Math.min(this.currentPage * this.recordsPerPage, totalRecords);
                    pageInfo.textContent = `第 ${this.currentPage} 頁，共 ${totalPages} 頁 (顯示 ${startRecord}-${endRecord} / ${totalRecords} 筆)`;
                }
                
                // 更新按鈕狀態
                prevBtn.disabled = this.currentPage <= 1;
                nextBtn.disabled = this.currentPage >= totalPages;
                
                // 如果當前頁超過總頁數，重置到第一頁
                if (this.currentPage > totalPages && totalPages > 0) {
                    this.currentPage = 1;
                    this.displayRecords(this.getCurrentFilteredRecords());
                }
            }

            // 顯示圖表彈窗
            showChartsModal() {
                console.log('顯示圖表彈窗');
                const modal = document.getElementById('chartsModal');
                if (modal) {
                    modal.style.display = 'block';
                    this.updateChartFilters();
                    this.updateCharts();
                } else {
                    console.error('找不到圖表彈窗元素');
                }
            }

            // 更新圖表篩選器
            updateChartFilters() {
                // 更新年份篩選器
                const chartFilterYear = document.getElementById('chartFilterYear');
                if (chartFilterYear) {
                    const allYears = [...new Set(this.records.map(r => r.date.split('-')[0]))].sort((a, b) => b - a);
                    chartFilterYear.innerHTML = '<option value="">所有年份</option>' + 
                        allYears.map(year => `<option value="${year}">${year}</option>`).join('');
                }
            }

            // 隱藏圖表彈窗
            hideChartsModal() {
                console.log('隱藏圖表彈窗');
                const modal = document.getElementById('chartsModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // 更新圖表
            updateCharts() {
                const chartTypeFilter = document.getElementById('chartFilterType').value;
                const chartYearFilter = document.getElementById('chartFilterYear').value;
                const chartMonthFilter = document.getElementById('chartFilterMonth').value;
                
                // 根據圖表篩選器過濾記錄
                const filteredRecords = this.records.filter(record => {
                    const recordDate = new Date(record.date);
                    const recordYear = recordDate.getFullYear().toString();
                    const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                    
                    return (!chartTypeFilter || record.type === chartTypeFilter) &&
                           (!chartYearFilter || recordYear === chartYearFilter) &&
                           (!chartMonthFilter || recordMonth === chartMonthFilter);
                });
                
                // 控制圖表顯示/隱藏
                this.toggleChartSections(chartTypeFilter);
                
                // 分別處理收入、支出和資產的數據
                const incomeRecords = filteredRecords.filter(r => r.type === '收入');
                const expenseRecords = filteredRecords.filter(r => r.type === '支出');
                const assetRecords = filteredRecords.filter(r => r.type === '資產');
                
                // 更新支出類別圖表
                const expenseCategoryData = this.getCategoryData(expenseRecords);
                this.expenseCategoryChart.data.labels = expenseCategoryData.labels;
                this.expenseCategoryChart.data.datasets[0].data = expenseCategoryData.data;
                
                // 如果沒有支出資料，顯示提示
                if (expenseCategoryData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.expenseCategoryChart.data.labels = [`${filterText}暫無支出資料`];
                    this.expenseCategoryChart.data.datasets[0].data = [1];
                    this.expenseCategoryChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.expenseCategoryChart.data.datasets[0].backgroundColor = [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56', '#9966FF', '#FF9F40', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56', '#9966FF'
                    ];
                }
                
                this.expenseCategoryChart.update();

                // 更新支出成員圖表
                const expenseMemberData = this.getMemberData(expenseRecords);
                this.expenseMemberChart.data.labels = expenseMemberData.labels;
                this.expenseMemberChart.data.datasets[0].data = expenseMemberData.data;
                
                // 如果沒有支出資料，顯示提示
                if (expenseMemberData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.expenseMemberChart.data.labels = [`${filterText}暫無支出資料`];
                    this.expenseMemberChart.data.datasets[0].data = [1];
                    this.expenseMemberChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.expenseMemberChart.data.datasets[0].backgroundColor = [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c'
                    ];
                }
                
                this.expenseMemberChart.update();

                // 更新收入類別圖表
                const incomeCategoryData = this.getCategoryData(incomeRecords);
                this.incomeCategoryChart.data.labels = incomeCategoryData.labels;
                this.incomeCategoryChart.data.datasets[0].data = incomeCategoryData.data;
                
                // 如果沒有收入資料，顯示提示
                if (incomeCategoryData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.incomeCategoryChart.data.labels = [`${filterText}暫無收入資料`];
                    this.incomeCategoryChart.data.datasets[0].data = [1];
                    this.incomeCategoryChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.incomeCategoryChart.data.datasets[0].backgroundColor = [
                        '#27ae60', '#2ecc71', '#16a085', '#1abc9c', '#27ae60', '#2ecc71', '#16a085', '#1abc9c', '#27ae60', '#2ecc71'
                    ];
                }
                
                this.incomeCategoryChart.update();

                // 更新收入成員圖表
                const incomeMemberData = this.getMemberData(incomeRecords);
                this.incomeMemberChart.data.labels = incomeMemberData.labels;
                this.incomeMemberChart.data.datasets[0].data = incomeMemberData.data;
                
                // 如果沒有收入資料，顯示提示
                if (incomeMemberData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.incomeMemberChart.data.labels = [`${filterText}暫無收入資料`];
                    this.incomeMemberChart.data.datasets[0].data = [1];
                    this.incomeMemberChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.incomeMemberChart.data.datasets[0].backgroundColor = [
                        '#27ae60', '#2ecc71', '#16a085', '#1abc9c'
                    ];
                }
                
                this.incomeMemberChart.update();

                // 更新資產類別圖表
                const assetCategoryData = this.getCategoryData(assetRecords);
                this.assetCategoryChart.data.labels = assetCategoryData.labels;
                this.assetCategoryChart.data.datasets[0].data = assetCategoryData.data;
                
                // 如果沒有資產資料，顯示提示
                if (assetCategoryData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.assetCategoryChart.data.labels = [`${filterText}暫無資產資料`];
                    this.assetCategoryChart.data.datasets[0].data = [1];
                    this.assetCategoryChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.assetCategoryChart.data.datasets[0].backgroundColor = [
                        '#f39c12', '#e67e22', '#d35400', '#e74c3c', '#c0392b', '#f39c12', '#e67e22', '#d35400', '#e74c3c', '#c0392b'
                    ];
                }
                
                this.assetCategoryChart.update();

                // 更新資產成員圖表
                const assetMemberData = this.getMemberData(assetRecords);
                this.assetMemberChart.data.labels = assetMemberData.labels;
                this.assetMemberChart.data.datasets[0].data = assetMemberData.data;
                
                // 如果沒有資產資料，顯示提示
                if (assetMemberData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter);
                    this.assetMemberChart.data.labels = [`${filterText}暫無資產資料`];
                    this.assetMemberChart.data.datasets[0].data = [1];
                    this.assetMemberChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // 恢復原始顏色
                    this.assetMemberChart.data.datasets[0].backgroundColor = [
                        '#f39c12', '#e67e22', '#d35400', '#c0392b'
                    ];
                }
                
                this.assetMemberChart.update();
            }

            // 控制圖表區域顯示/隱藏
            toggleChartSections(typeFilter) {
                // 控制支出統計區域
                const expenseTitle = document.querySelector('.expense-section-title');
                const expenseSection = document.querySelector('.expense-section');
                if (expenseTitle && expenseSection) {
                    const showExpense = !typeFilter || typeFilter === '支出';
                    expenseTitle.style.display = showExpense ? 'block' : 'none';
                    expenseSection.style.display = showExpense ? 'flex' : 'none';
                }
                
                // 控制收入統計區域
                const incomeTitle = document.querySelector('.income-section-title');
                const incomeSection = document.querySelector('.income-section');
                if (incomeTitle && incomeSection) {
                    const showIncome = !typeFilter || typeFilter === '收入';
                    incomeTitle.style.display = showIncome ? 'block' : 'none';
                    incomeSection.style.display = showIncome ? 'flex' : 'none';
                }
                
                // 控制資產統計區域
                const assetTitle = document.querySelector('.asset-section-title');
                const assetSection = document.querySelector('.asset-section');
                if (assetTitle && assetSection) {
                    const showAsset = !typeFilter || typeFilter === '資產';
                    assetTitle.style.display = showAsset ? 'block' : 'none';
                    assetSection.style.display = showAsset ? 'flex' : 'none';
                }
            }

            // 獲取篩選文字
            getFilterText(typeFilter, yearFilter, monthFilter) {
                let text = '';
                if (typeFilter) text += `${typeFilter} `;
                if (yearFilter) text += `${yearFilter}年 `;
                if (monthFilter) {
                    const monthNames = ['', '1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                    text += `${monthNames[parseInt(monthFilter)]} `;
                }
                return text;
            }

            // 獲取類別數據
            getCategoryData(records) {
                const categoryMap = {};
                records.forEach(record => {
                    const categoryKey = `${record.mainCategory} - ${record.subCategory}`;
                    categoryMap[categoryKey] = (categoryMap[categoryKey] || 0) + record.amount;
                });

                return {
                    labels: Object.keys(categoryMap),
                    data: Object.values(categoryMap)
                };
            }

            // 獲取成員數據
            getMemberData(records) {
                const memberMap = {};
                records.forEach(record => {
                    memberMap[record.member] = (memberMap[record.member] || 0) + record.amount;
                });

                return {
                    labels: Object.keys(memberMap),
                    data: Object.values(memberMap)
                };
            }

            // 初始化圖表
            initCharts() {
                console.log('初始化圖表');
                
                // 支出類別圓餅圖
                this.expenseCategoryChart = new Chart(document.getElementById('expenseCategoryChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40',
                                '#FF6384',
                                '#C9CBCF',
                                '#4BC0C0',
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#9966FF',
                                '#FF9F40',
                                '#C9CBCF',
                                '#4BC0C0',
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#9966FF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 支出成員圓餅圖
                this.expenseMemberChart = new Chart(document.getElementById('expenseMemberChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#667eea',
                                '#764ba2',
                                '#f093fb',
                                '#f5576c'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 收入類別圓餅圖
                this.incomeCategoryChart = new Chart(document.getElementById('incomeCategoryChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#27ae60',
                                '#2ecc71',
                                '#16a085',
                                '#1abc9c',
                                '#27ae60',
                                '#2ecc71',
                                '#16a085',
                                '#1abc9c',
                                '#27ae60',
                                '#2ecc71'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 收入成員圓餅圖
                this.incomeMemberChart = new Chart(document.getElementById('incomeMemberChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#27ae60',
                                '#2ecc71',
                                '#16a085',
                                '#1abc9c'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 資產類別圓餅圖
                this.assetCategoryChart = new Chart(document.getElementById('assetCategoryChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#f39c12',
                                '#e67e22',
                                '#d35400',
                                '#e74c3c',
                                '#c0392b',
                                '#f39c12',
                                '#e67e22',
                                '#d35400',
                                '#e74c3c',
                                '#c0392b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 資產成員圓餅圖
                this.assetMemberChart = new Chart(document.getElementById('assetMemberChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#f39c12',
                                '#e67e22',
                                '#d35400',
                                '#c0392b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 初始化表單事件監聽器
            initFormEventListeners() {
                console.log('初始化表單事件監聽器');
                
                // 表單提交事件
                document.getElementById('recordForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addRecord();
                });
                
                // 類別選擇變化時更新細項選項
                const mainCategorySelect = document.getElementById('mainCategory');
                if (mainCategorySelect) {
                    mainCategorySelect.addEventListener('change', () => {
                        this.updateSubCategoryOptions();
                    });
                }

                // 類型選擇變化時更新類別選項
                const typeSelect = document.getElementById('type');
                if (typeSelect) {
                    typeSelect.addEventListener('change', () => {
                        this.updateMainCategoryOptions();
                    });
                }

                // 分頁事件監聽器
                const pageSizeSelect = document.getElementById('pageSize');
                if (pageSizeSelect) {
                    pageSizeSelect.addEventListener('change', (e) => {
                        this.recordsPerPage = parseInt(e.target.value);
                        this.currentPage = 1;
                        this.applyTableFilter(true);
                    });
                }

                // 上一頁按鈕
                const prevPageBtn = document.getElementById('prevPage');
                if (prevPageBtn) {
                    prevPageBtn.addEventListener('click', () => {
                        if (this.currentPage > 1) {
                            this.currentPage--;
                            this.applyTableFilter(false);
                        }
                    });
                }

                // 下一頁按鈕
                const nextPageBtn = document.getElementById('nextPage');
                if (nextPageBtn) {
                    nextPageBtn.addEventListener('click', () => {
                        const filteredRecords = this.getCurrentFilteredRecords();
                        const totalPages = Math.ceil(filteredRecords.length / this.recordsPerPage);
                        if (this.currentPage < totalPages) {
                            this.currentPage++;
                            this.applyTableFilter(false);
                        }
                    });
                }

                // 圖表篩選事件監聽器
                const chartFilterType = document.getElementById('chartFilterType');
                if (chartFilterType) {
                    chartFilterType.addEventListener('change', () => {
                        this.updateCharts();
                    });
                }

                const chartFilterYear = document.getElementById('chartFilterYear');
                if (chartFilterYear) {
                    chartFilterYear.addEventListener('change', () => {
                        this.updateCharts();
                    });
                }

                const chartFilterMonth = document.getElementById('chartFilterMonth');
                if (chartFilterMonth) {
                    chartFilterMonth.addEventListener('change', () => {
                        this.updateCharts();
                    });
                }
            }

            // 更新細項選項
            updateSubCategoryOptions() {
                const mainCategory = document.getElementById('mainCategory').value;
                const subCategorySelect = document.getElementById('subCategory');
                
                // 清空小項目選項
                subCategorySelect.innerHTML = '<option value="">請選擇細項</option>';
                
                if (mainCategory && this.categoryStructure[mainCategory]) {
                    this.categoryStructure[mainCategory].forEach(subCategory => {
                        const option = document.createElement('option');
                        option.value = subCategory;
                        option.textContent = subCategory;
                        subCategorySelect.appendChild(option);
                    });
                }
            }

            // 更新主類別選項
            updateMainCategoryOptions() {
                const type = document.getElementById('type').value;
                const mainCategorySelect = document.getElementById('mainCategory');
                const options = mainCategorySelect.querySelectorAll('option');
                
                // 重置大項目選擇
                mainCategorySelect.value = '';
                document.getElementById('subCategory').innerHTML = '<option value="">請先選擇類別</option>';
                
                // 顯示/隱藏選項
                options.forEach(option => {
                    if (option.value === '') {
                        option.style.display = 'block';
                    } else {
                        const optionType = option.getAttribute('data-type');
                        option.style.display = (!type || optionType === type) ? 'block' : 'none';
                    }
                });
            }

            // 新增記錄
            async addRecord() {
                const formData = {
                    type: document.getElementById('type').value,
                    member: document.getElementById('member').value,
                    mainCategory: document.getElementById('mainCategory').value,
                    subCategory: document.getElementById('subCategory').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    description: document.getElementById('description').value,
                    date: document.getElementById('date').value
                };

                console.log('準備新增記錄:', formData);

                try {
                    if (this.editingId) {
                        // 編輯模式
                        await this.updateRecordInFirebase(this.editingId, formData);
                        this.editingId = null;
                        document.querySelector('#recordForm button[type="submit"]').textContent = '新增記錄';
                    } else {
                        // 新增模式
                        await this.addRecordToFirebase(formData);
                    }

                    this.resetForm();
                    this.updateDisplay();
                } catch (error) {
                    console.error('儲存記錄失敗:', error);
                    alert('儲存失敗，請重試');
                }
            }

            // 新增記錄到 Firebase
            async addRecordToFirebase(formData) {
                console.log('開始寫入 Firebase...');
                
                // 確保Firebase函數已載入
                if (!window.firebaseCollection || !window.firebaseAddDoc || !window.firebaseServerTimestamp) {
                    console.error('Firebase函數未載入，無法新增記錄');
                    throw new Error('Firebase函數未載入');
                }

                const recordsRef = window.firebaseCollection(window.firebaseDb, 'records');
                const docRef = await window.firebaseAddDoc(recordsRef, {
                    userId: this.currentUser.uid,
                    ...formData,
                    createdAt: window.firebaseServerTimestamp(),
                    updatedAt: window.firebaseServerTimestamp()
                });
                
                // 添加到本地陣列
                this.records.push({
                    id: docRef.id,
                    ...formData
                });
                
                console.log('記錄已新增到 Firebase:', docRef.id);
            }

            // 更新 Firebase 記錄
            async updateRecordInFirebase(recordId, formData) {
                const recordRef = window.firebaseDoc(window.firebaseDb, 'records', recordId);
                await window.firebaseUpdateDoc(recordRef, {
                    ...formData,
                    updatedAt: window.firebaseServerTimestamp()
                });
                
                // 更新本地陣列
                const index = this.records.findIndex(record => record.id === recordId);
                if (index !== -1) {
                    this.records[index] = { ...formData, id: recordId };
                }
                
                console.log('記錄已更新到 Firebase:', recordId);
            }

            // 編輯記錄
            async editRecord(recordId) {
                console.log('編輯記錄:', recordId);
                
                const record = this.records.find(r => r.id === recordId);
                if (!record) {
                    console.error('找不到要編輯的記錄');
                    return;
                }
                
                // 填入表單資料
                document.getElementById('type').value = record.type;
                document.getElementById('member').value = record.member;
                document.getElementById('mainCategory').value = record.mainCategory;
                document.getElementById('amount').value = record.amount;
                document.getElementById('description').value = record.description;
                document.getElementById('date').value = record.date;
                
                // 更新細項選項
                this.updateSubCategoryOptions();
                document.getElementById('subCategory').value = record.subCategory;
                
                // 設定編輯狀態
                this.editingId = recordId;
                
                // 更新按鈕文字
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = '更新記錄';
                }
                
                // 滾動到表單
                document.querySelector('.add-record').scrollIntoView({ behavior: 'smooth' });
                
                console.log('記錄已載入表單，準備編輯');
            }

            // 刪除記錄
            async deleteRecord(recordId) {
                console.log('刪除記錄:', recordId);
                
                if (!confirm('確定要刪除這筆記錄嗎？')) {
                    return;
                }
                
                try {
                    // 確保Firebase函數已載入
                    if (!window.firebaseDoc || !window.firebaseDeleteDoc) {
                        console.error('Firebase函數未載入，無法刪除記錄');
                        throw new Error('Firebase函數未載入');
                    }
                    
                    const recordRef = window.firebaseDoc(window.firebaseDb, 'records', recordId);
                    await window.firebaseDeleteDoc(recordRef);
                    
                    // 從本地陣列移除
                    this.records = this.records.filter(record => record.id !== recordId);
                    
                    console.log('記錄已刪除:', recordId);
                    
                    // 更新顯示
                    this.updateDisplay();
                    
                } catch (error) {
                    console.error('刪除記錄失敗:', error);
                    alert('刪除失敗，請重試');
                }
            }

            // 清空表單
            resetForm() {
                // 清空所有表單欄位
                document.getElementById('member').value = '';
                document.getElementById('type').value = '';
                document.getElementById('mainCategory').value = '';
                document.getElementById('subCategory').innerHTML = '<option value="">請先選擇類別</option>';
                document.getElementById('amount').value = '';
                document.getElementById('description').value = '';
                
                // 設定今天的日期為預設值
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                
                // 重置編輯狀態
                this.editingId = null;
                
                // 更新按鈕文字
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = '新增記錄';
                }
                
                console.log('表單已清空，日期已設定為今日');
            }

            // 初始化
            init() {
                // 設定今天的日期為預設值
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                
                this.initFirebase();
                
                // 等待 DOM 載入完成後初始化事件監聽器
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.initFormEventListeners();
                        this.initCharts();
                    });
                } else {
                    this.initFormEventListeners();
                    this.initCharts();
                }
            }
        }

        // 創建 ExpenseTracker 實例
        const expenseTracker = new ExpenseTracker();
    </script>
</body>
</html>
